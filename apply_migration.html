<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Aplicar Migration</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Aplicando Migration...</h1>
    <pre id="output"></pre>

    <script type="module">
        const output = document.getElementById('output');
        
        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }

        async function applyMigration() {
            try {
                log('üìù Iniciando aplica√ß√£o da migration...');
                
                const supabaseUrl = 'https://dwcmrbrhyuflhtymbhll.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3Y21yYnJoeXVmbGh0eW1iaGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk4NzY1NjcsImV4cCI6MjA0NTQ1MjU2N30.YYbZfQP3vFDqTGXDcpECTwKmQrRaKRPPTy5MRcXVCmE';
                
                const { createClient } = supabase;
                const client = createClient(supabaseUrl, supabaseKey);
                
                log('üîÑ Executando SQL...');
                
                const { data, error } = await client.rpc('exec_sql', {
                    sql_query: `
CREATE OR REPLACE FUNCTION public.get_feed_posts(
    p_user_id UUID,
    p_filter_type TEXT DEFAULT 'all',
    p_limit INTEGER DEFAULT 50,
    p_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    id UUID,
    user_id UUID,
    celebrated_person_name TEXT,
    person_name TEXT,
    mentioned_user_id UUID,
    content TEXT,
    story TEXT,
    photo_url TEXT,
    type TEXT,
    highlight_type TEXT,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    CASE p_filter_type
        WHEN 'all' THEN
            RETURN QUERY
            SELECT p.id, p.user_id, p.celebrated_person_name, p.person_name,
                   p.mentioned_user_id, p.content, p.story, p.photo_url,
                   p.type, p.highlight_type, p.created_at, p.updated_at
            FROM posts p
            WHERE p.community_id IS NULL
            ORDER BY p.created_at DESC
            LIMIT p_limit OFFSET p_offset;
        
        WHEN 'following' THEN
            RETURN QUERY
            SELECT p.id, p.user_id, p.celebrated_person_name, p.person_name,
                   p.mentioned_user_id, p.content, p.story, p.photo_url,
                   p.type, p.highlight_type, p.created_at, p.updated_at
            FROM posts p
            INNER JOIN follows f ON f.following_id = p.user_id
            WHERE f.follower_id = p_user_id
              AND p.community_id IS NULL
            ORDER BY p.created_at DESC
            LIMIT p_limit OFFSET p_offset;
        
        WHEN 'recommended' THEN
            RETURN QUERY
            SELECT p.id, p.user_id, p.celebrated_person_name, p.person_name,
                   p.mentioned_user_id, p.content, p.story, p.photo_url,
                   p.type, p.highlight_type, p.created_at, p.updated_at
            FROM posts p
            WHERE p.community_id IS NULL
            ORDER BY p.created_at DESC
            LIMIT p_limit OFFSET p_offset;
        
        ELSE
            RETURN QUERY
            SELECT p.id, p.user_id, p.celebrated_person_name, p.person_name,
                   p.mentioned_user_id, p.content, p.story, p.photo_url,
                   p.type, p.highlight_type, p.created_at, p.updated_at
            FROM posts p
            WHERE p.community_id IS NULL
            ORDER BY p.created_at DESC
            LIMIT p_limit OFFSET p_offset;
    END CASE;
END;
$$;
                    `
                });
                
                if (error) {
                    log('‚ùå Erro: ' + JSON.stringify(error, null, 2));
                    return;
                }
                
                log('‚úÖ Migration aplicada com sucesso!');
                log('üìä Resultado: ' + JSON.stringify(data, null, 2));
                
            } catch (err) {
                log('‚ùå Erro: ' + err.message);
                console.error(err);
            }
        }

        applyMigration();
    </script>
</body>
</html>

