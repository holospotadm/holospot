<!DOCTYPE html>
<!-- HoloSpot - Vers√£o est√°vel restaurada (commit 72e4e42) -->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoloSpot - Colocando os holofotes nos outros</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Fallback para Chart.js se o primeiro CDN falhar
        if (typeof Chart === 'undefined') {
            console.log('üîÑ Tentando CDN alternativo para Chart.js...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.min.js';
            script.onload = function() {
                console.log('‚úÖ Chart.js carregado via CDN alternativo');
            };
            script.onerror = function() {
                console.error('‚ùå Falha ao carregar Chart.js via CDN alternativo');
            };
            document.head.appendChild(script);
        } else {
            console.log('‚úÖ Chart.js carregado com sucesso');
        }
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKK75JRY5W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HKK75JRY5W');
        
        function trackEvent(eventName, parameters = {}) {
            gtag('event', eventName, parameters);
            console.log('üìä Event tracked:', eventName, parameters);
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem 0.5rem 2rem;
            box-shadow: none;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: none;
            border-radius: 0;
            margin-bottom: -10px;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .header-content {
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0;
        }

        /* Layout mobile - duas linhas */
        @media (max-width: 768px) {
            /* Reorganiza elementos para mobile */
            .header-content {
                display: grid;
                grid-template-areas: 
                    "logo notifications"
                    "user-section logout";
                grid-template-columns: 1fr auto;
                gap: 1rem;
                align-items: center;
            }

            .logo {
                grid-area: logo;
                grid-column: 1 / -1;
                justify-self: center !important;
                align-self: center;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                justify-content: center;
            }

            .notifications {
                grid-area: notifications;
                justify-self: end;
            }

            .user-section {
                grid-area: user-section;
                justify-self: start;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .logout-btn {
                grid-area: logout;
                justify-self: end;
            }

            .header-actions {
                display: contents;
            }
        }

        /* Layout desktop - uma linha */
        @media (min-width: 769px) {
            .header-top {
                display: contents;
            }

            .header-bottom {
                display: contents;
            }

            .user-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            /* Aproxima abas do header apenas no desktop */
            .nav-tabs {
                top: 140px !important;
            }

            /* Reorganiza header para desktop */
            .header-content {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                grid-template-areas: none !important;
                align-items: center !important;
                gap: 2rem;
                height: auto;
            }

            /* User info na esquerda */
            .user-section {
                grid-column: 1;
                grid-area: unset !important;
                justify-self: start !important;
                align-self: center;
                order: 1;
            }

            /* Logo no centro */
            .logo {
                grid-column: 2;
                grid-area: unset !important;
                justify-self: center !important;
                align-self: center;
                order: 2;
            }

            /* Notifica√ß√µes e bot√£o sair na direita */
            .header-actions {
                grid-column: 3;
                grid-area: unset !important;
                justify-self: end;
                align-self: center;
                display: flex;
                align-items: center;
                gap: 1rem;
                order: 3;
            }

            .notifications {
                order: 1;
            }

            .logout-btn {
                order: 2;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo span {
            background: linear-gradient(135deg, #FFB700, #E55A2B) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFF 30%, transparent 70%);
            border-radius: 50%;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 215, 0, 0.3) 45deg, transparent 90deg, rgba(255, 215, 0, 0.3) 135deg, transparent 180deg, rgba(255, 215, 0, 0.3) 225deg, transparent 270deg, rgba(255, 215, 0, 0.3) 315deg, transparent 360deg);
            border-radius: 50%;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            background: rgba(255, 183, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 10000;
        }

        .notifications:hover {
            background: rgba(255, 183, 0, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .notification-header span {
            font-weight: 600;
            color: #333;
        }

        .mark-all-read-btn {
            background: linear-gradient(135deg, #FFB700 0%, #FF8C00 100%);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 183, 0, 0.3);
            width: 100%;
            margin: 0.5rem 0;
        }

        .mark-all-read-btn:hover {
            background: linear-gradient(135deg, #e6a600 0%, #e67e00 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 183, 0, 0.4);
        }

        .mark-all-read-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: rgba(255, 183, 0, 0.05);
            border-left: 3px solid #FFB700;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            line-height: 1.2;
            margin: 0;
            padding: 0;
        }

        .user-username {
            font-size: 0.85rem;
            color: #666;
            margin-top: 3px;
            margin-bottom: 0;
            padding: 0;
            line-height: 1.1;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff3742;
            transform: translateY(-1px);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: bold;
            color: #FFB700;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .google-login-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .google-login-btn:hover {
            border-color: #4285f4;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.2);
            transform: translateY(-2px);
        }

        /* Main App */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 2rem 2rem;
            display: none;
        }

        .app-container.active {
            display: block;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0;
            padding: 0.5rem 0.5rem;
            margin-bottom: 2rem;
            box-shadow: none;
            overflow-x: auto;
            margin-top: -10px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-tab {
            flex: 1;
            padding: 0.5rem 1rem;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            min-width: 120px;
            text-indent: -2px;
        }

        /* Aba de busca pequena */
        .nav-tab[data-tab="buscar"] {
            flex: 0 0 auto;
            min-width: 40px;
            padding: 0.5rem 0.5rem;
            font-size: 0.9rem;
            text-indent: 1px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .nav-tab:not(.active):hover {
            background: rgba(255, 183, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Feed Filter Dropdown */
        .feed-filter-dropdown {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            min-width: 180px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .filter-option {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .filter-option:hover {
            background: linear-gradient(135deg, rgba(255, 183, 0, 0.1), rgba(229, 90, 43, 0.1));
        }

        .filter-option.active {
            background: linear-gradient(135deg, rgba(255, 183, 0, 0.2), rgba(229, 90, 43, 0.2));
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Posts */
        .posts-container {
            display: grid;
            gap: 1.5rem;
        }

        .post {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-author {
            flex: 1;
        }

        .post-author-name {
            font-weight: 600;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.2;
        }

        .post-author-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 3px;
        }

        .post-author-username {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .post-time-separator {
            color: #999;
            font-size: 0.8rem;
        }

        .post-time {
            color: #666;
            font-size: 0.75rem;
        }

        .follow-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .follow-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .follow-btn.following {
            background: #28a745;
        }

        .post-content {
            margin-bottom: 1rem;
        }

        .post-person {
            font-weight: 600;
            color: #e65100;
            margin-bottom: 0.5rem;
        }

        .post-type {
            display: inline-block;
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .post-story {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .post-image {
            width: 100%;
            height: auto;
            max-width: 100%;
            object-fit: contain;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .post-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: none;
            border: none;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .reaction-btn:hover {
            background: rgba(255, 183, 0, 0.1);
            transform: translateY(-1px);
        }

        .reaction-btn.active {
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
        }

        /* Feedback Section */
        .feedback-section {
            margin-top: 1rem;
        }

        .feedback-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .feedback-btn.feedback-given {
            background: #28a745;
            cursor: not-allowed;
        }

        .feedback-btn.feedback-given:hover {
            transform: none;
            box-shadow: none;
        }

        /* Create Post Form */
        .create-post-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
        }

        .form-input:focus {
            outline: none;
            border-color: #FFB700;
            box-shadow: 0 0 0 3px rgba(255, 183, 0, 0.1);
        }

        .highlight-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .highlight-type {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .highlight-type:hover {
            border-color: #FFB700;
            transform: translateY(-2px);
        }

        .highlight-type.selected {
            border-color: #FFB700;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
        }

        .highlight-type-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .highlight-type-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .highlight-type-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .photo-upload-section {
            margin-bottom: 1.5rem;
        }

        .photo-upload-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .photo-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .photo-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .photo-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            object-fit: cover;
        }

        .remove-photo-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reaction-btn:disabled {
            cursor: not-allowed !important;
            opacity: 1 !important;
            background-color: transparent !important;
            color: inherit !important;
            border-color: transparent !important;
        }

        .reaction-btn.disabled {
            cursor: not-allowed !important;
            opacity: 1 !important;
            background-color: transparent !important;
            color: inherit !important;
            border-color: transparent !important;
        }

        /* Profile & Impact Tabs */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Desktop: Force 5 columns for metrics */
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.8rem;
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* Desktop: Smaller padding for compact layout */
        @media (min-width: 1024px) {
            .stat-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        /* Gradient borders for clickable stat cards */
        #postsCreatedCard,
        #peopleHighlightedCard,
        #postsReceivedCard,
        #peopleWhoHighlightedCard {
            border: 2px solid transparent !important;
            background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box !important;
        }

        #postsReceivedCard,
        #peopleWhoHighlightedCard {
            background: linear-gradient(#f8f9fa, #f8f9fa) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box !important;
        }

        /* Modal stat cards styling to match profile tab exactly */
        
        /* Cards Seguindo/Seguidores: background laranja com texto branco */
        #modalFollowingCard,
        #modalFollowersCard {
            background: linear-gradient(135deg, #ff9800, #f57c00) !important;
            color: white !important;
        }

        #modalFollowingCard .stat-number,
        #modalFollowersCard .stat-number {
            color: white !important;
            font-size: 2rem !important;
            font-weight: bold !important;
        }

        #modalFollowingCard .stat-label,
        #modalFollowersCard .stat-label {
            color: white !important;
        }

        /* Cards Posts Criados/Holofotes Recebidos: background branco com borda gradiente e n√∫meros laranjas */
        #modalPostsCreatedCard,
        #modalHolofotesCard {
            border: 2px solid transparent !important;
            background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box !important;
        }

        #modalPostsCreatedCard .stat-number,
        #modalHolofotesCard .stat-number {
            color: #e65100 !important;
            font-size: 2rem !important;
            font-weight: bold !important;
        }

        #modalPostsCreatedCard .stat-label,
        #modalHolofotesCard .stat-label {
            color: #666 !important;
        }

        /* Hover effect only for clickable stat cards */
        #postsCreatedCard:hover,
        #peopleHighlightedCard:hover,
        #postsReceivedCard:hover,
        #peopleWhoHighlightedCard:hover {
            /* Hover effects are now handled by inline styles for better control */
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 0.5rem;
        }

        /* .stat-label CSS removido - estava sobrescrevendo estilos inline dos cards */

        .evolution-chart {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .insight-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .streak-container {
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
            text-align: right;
        }

        /* Following/Followers */
        .follow-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .follow-stat {
            text-align: center;
            cursor: pointer;
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .follow-stat:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .follow-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .follow-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50000;
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            max-height: 70vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        /* Header espec√≠fico para modal de feedbacks */
        #feedbacksModal .modal-header {
            background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 24px;
            max-height: calc(70vh - 80px);
            overflow-y: auto;
        }

        .follow-list {
            margin: 0;
        }

        .follow-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            transition: all 0.2s ease;
        }

        .follow-item:last-child {
            border-bottom: none;
        }

        .follow-item:hover {
            background: #f9fafb;
            margin: 0 -24px;
            padding: 12px 24px;
            border-radius: 8px;
        }

        .follow-item img {
            margin-right: 12px;
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s ease;
        }

        .follow-item:hover img {
            border-color: #FFB700;
        }

        .follow-item span {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Feedback Modal */
        .feedback-modal {
            background: white;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            max-height: 70vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            position: relative;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            max-height: 70vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .feedback-modal-header {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .feedback-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .feedback-modal-body {
            padding: 24px;
        }

        .feedback-modal-body p {
            margin: 0 0 1rem 0;
            color: #555;
        }

        .feedback-modal-footer {
            padding: 16px 24px;
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid #e9ecef;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: none;
            outline: none;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 90, 43, 0.3);
        }

        .holofote-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
            position: relative;
        }

        .holofote-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: #FF8C00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .app-container {
                padding: 1rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                top: 200px !important;
            }

            .nav-tab {
                min-width: auto;
                flex: 1;
                padding: 0.5rem 0;
                font-size: 0.75rem;
                font-weight: 500;
                text-align: center !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .follow-stats {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            
            /* Reorganizar APENAS a aba Perfil no mobile */
            @supports (display: grid) {
                body #perfilTab .stats-grid:first-of-type {
                    display: grid !important;
                    grid-template-columns: repeat(3, 1fr) !important;
                    gap: 1rem !important;
                }
                
                /* Posts Criados e Pessoas Destacadas ficam na primeira linha */
                body #perfilTab .stats-grid:first-of-type #postsCreatedCard {
                    grid-column: 1 / 3 !important;
                }
                
                body #perfilTab .stats-grid:first-of-type #peopleHighlightedCard {
                    grid-column: 3 / 4 !important;
                }
                
                /* Segunda linha com 3 cards */
                body #perfilTab .stats-grid:first-of-type .stat-card:nth-child(3) {
                    grid-column: 1 / 2 !important;
                }
                
                body #perfilTab .stats-grid:first-of-type .stat-card:nth-child(4) {
                    grid-column: 2 / 3 !important;
                }
                
                body #perfilTab .stats-grid:first-of-type .stat-card:nth-child(5) {
                    grid-column: 3 / 4 !important;
                }
                
                /* Grid de m√©tricas recebidas */
                body #perfilTab .stats-grid:last-of-type {
                    display: grid !important;
                    grid-template-columns: repeat(3, 1fr) !important;
                    gap: 1rem !important;
                }
                
                /* Holofotes e Pessoas em 2 colunas */
                body #perfilTab .stats-grid:last-of-type #postsReceivedCard {
                    grid-column: 1 / 3 !important;
                }
                
                body #perfilTab .stats-grid:last-of-type #peopleWhoHighlightedCard {
                    grid-column: 3 / 4 !important;
                }
                
                /* Feedbacks, Coment√°rios e Rea√ß√µes Recebidas em 3 colunas */
                body #perfilTab .stats-grid:last-of-type .stat-card:nth-child(3) {
                    grid-column: 1 / 2 !important;
                }
                
                body #perfilTab .stats-grid:last-of-type .stat-card:nth-child(4) {
                    grid-column: 2 / 3 !important;
                }
                
                body #perfilTab .stats-grid:last-of-type .stat-card:nth-child(5) {
                    grid-column: 3 / 4 !important;
                }
            }

            .highlight-types {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            /* Modal Suas Conquistas - Mover link para o final */
            .progress-link-top {
                display: none !important;
            }
            
            .progress-link-bottom {
                display: block !important;
                margin-top: 10px !important;
                margin-bottom: 30px !important;
            }
            
            #badgesContainer {
                margin-bottom: 0 !important;
            }
            
            /* Modal Conquistas em Andamento - Diminuir t√≠tulo */
            .progress-modal-title {
                font-size: 1.2rem !important;
            }
        }

        /* Hidden file input */
        #photoUpload {
            display: none;
        }

        /* Sistema de Men√ß√µes */
        .textarea-container {
            position: relative;
        }

        .mentions-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }

        .mention-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .mention-item:last-child {
            border-bottom: none;
        }

        .mention-item:hover,
        .mention-item.selected {
            background-color: #f3f4f6;
        }

        .mention-item img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #e5e7eb;
        }

        .mention-info {
            flex: 1;
        }

        .mention-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.95rem;
        }

        .mention-username {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        /* que das men√ß√µes nos posts */
        .mention-highlight {
            color: #FFB700;
            font-weight: 500;
            text-decoration: none;
        }

        .mention-highlight:hover {
            text-decoration: underline;
        }

        /* Bot√£o de Impacto */
        .impact-button-container {
            margin: 2rem 0;
            text-align: center;
        }

        .impact-btn {
            background: linear-gradient(135deg, #FFD700, #E55A2B, #8B5CF6);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .impact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        /* Bot√£o de Conquistas */
        .achievements-btn {
            background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .achievements-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        /* Modal de Impacto - Using unified modal-overlay */
        .modal-overlay--impact {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-container {
            background: white;
            border-radius: 20px;
            max-width: 95vw;
            max-height: 90vh;
            width: 900px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB700, #E55A2B);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .modal-container {
                width: 95vw;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 1rem 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
        }

        /* Dashboard de Insights Estrat√©gicos */
        .insights-dashboard {
            margin-top: 2rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            text-align: center;
        }

        .insight-card.compact {
            padding: 0.8rem;
            min-height: auto;
            text-align: center;
        }

        /* Chart.js style tooltip */
        .tooltip-container {
            position: relative;
            cursor: pointer;
            display: inline-block;
        }
        
        /* Anima√ß√£o de loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .simple-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 50000;
            transition: opacity 0.3s ease;
            pointer-events: none;
            min-width: 200px;
        }
        
        .simple-tooltip::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        
        .tooltip-container:hover .simple-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .insight-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        .insight-icon {
            font-size: 1.2rem;
        }

        .insight-title {
            font-weight: 600;
            color: #333;
            font-size: 1.0rem;
        }

        .insight-chart {
            position: relative;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .insight-progress {
            margin: 1rem 0;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #E55A2B;
            margin: 0.5rem 0;
        }

        .insight-description {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .insight-network {
            margin: 1rem 0;
        }

        .network-size {
            font-size: 2rem;
            font-weight: bold;
            color: #E55A2B;
        }

        .network-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .insight-altruism {
            margin: 1rem 0;
        }

        .altruism-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #E55A2B;
        }

        .altruism-message {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .insight-chart-large {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* Responsive adjustments for insights */
        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .insight-card {
                padding: 0.8rem;
            }
            
            .insight-value {
                font-size: 1.3rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }    
            .network-size {
                font-size: 1.6rem;
            }
            
            .altruism-value {
                font-size: 1.5rem;
            }
        }

        /* Estilos espec√≠ficos para modais de coment√°rios */
        #commentsReceivedModal .modal-header {
            background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981) !important;
        }

        /* Outros modais de coment√°rios que possam existir */
        .comments-modal-header {
            background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981) !important;
        }

        .comments-send-button {
            background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981) !important;
        }

        /* Sistema de Busca */
        #buscarTab {
            display: none;
        }
        
        #buscarTab.active {
            display: block !important;
        }
        


        .search-results-page {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .search-section {
            padding: 15px 0;
        }

        .search-section:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        .search-section h4 {
            margin: 0 0 10px 15px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-left: 3px solid transparent;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
            border-left-color: #FFB700;
        }

        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .result-content {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .result-meta {
            color: #999;
            font-size: 12px;
        }

        .search-empty {
            padding: 30px 15px;
            text-align: center;
            color: #666;
        }

        .search-loading {
            padding: 20px 15px;
            text-align: center;
            color: #666;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .search-container {
                min-width: 200px;
                margin-left: 10px;
            }
            
            .search-results {
                left: -50px;
                right: -50px;
            }
        }

        /* ===== NOVO: ESTILOS PARA P√ÅGINA COMPLETA DE PERFIL ===== */
        .full-profile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            z-index: 10000;
            overflow-y: auto;
            overflow-x: hidden;
            display: none; /* Inicialmente oculto */
            scrollbar-gutter: stable;
        }

        .full-profile-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem 0.5rem 2rem;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 10001;
            box-shadow: none;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }

        .profile-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .profile-logo span {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .profile-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .profile-logo-icon::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFF 30%, transparent 70%);
            border-radius: 50%;
        }

        .profile-logo-icon::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 215, 0, 0.3) 45deg, transparent 90deg, rgba(255, 215, 0, 0.3) 135deg, transparent 180deg, rgba(255, 215, 0, 0.3) 225deg, transparent 270deg, rgba(255, 215, 0, 0.3) 315deg, transparent 360deg);
            border-radius: 50%;
            animation: rotate 3s linear infinite;
        }

        .full-profile-content {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .profile-header-expanded {
            background: transparent;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profile-info-expanded h2 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1.8rem;
        }

        .profile-info-expanded p {
            margin: 0 0 1rem 0;
            color: #666;
            font-size: 1.1rem;
        }

        .follow-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .follow-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .stats-expanded {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 183, 0, 0.2);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 183, 0, 0.4);
        }

        #fullProfileContainer .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        /* .stat-label CSS removido - estava sobrescrevendo estilos inline dos cards */

        .profile-sections {
            display: grid;
            gap: 2rem;
        }

        .section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid rgba(255, 183, 0, 0.1);
        }

        .section h3 {
            margin: 0 0 1.5rem 0;
            color: #333;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        /* Responsividade para p√°gina completa */
        @media (max-width: 768px) {
            .full-profile-content {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 10px;
            }
            
            .profile-header-expanded {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem;
            }
            
            .profile-avatar-large {
                width: 100px;
                height: 100px;
            }
            
            .stats-expanded {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem;
            }
            
            .stat-item {
                padding: 1rem;
            }
            
            #fullProfileContainer .stat-number {
                font-size: 1.5rem;
            }
            
            .section {
                padding: 1.5rem;
            }
            
            .profile-logo {
                font-size: 1.3rem;
            }
            
            .profile-logo-icon {
                width: 35px;
                height: 35px;
            }
        }

        @media (max-width: 480px) {
            .full-profile-header {
                padding: 0.75rem 0.5rem 0.5rem 0.5rem;
            }
            
            .full-profile-content {
                margin: 1rem !important;
                margin-right: 1rem !important;
                padding: 1rem;
                border-radius: 8px;
                width: calc(100% - 2rem) !important;
                max-width: calc(100% - 2rem) !important;
            }
            
            .profile-logo {
                font-size: 1.1rem;
            }
            
            .profile-logo-icon {
                width: 30px;
                height: 30px;
            }
            
            .profile-header-expanded {
                padding: 0.75rem;
                gap: 1rem;
            }
            
            .profile-avatar-large {
                width: 80px;
                height: 80px;
            }
            
            .profile-info-expanded h2 {
                font-size: 1.3rem;
            }
            
            .profile-info-expanded p {
                font-size: 0.9rem;
            }
            
            .stats-expanded {
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.75rem 0.5rem;
            }
            
            #fullProfileContainer .stat-number {
                font-size: 1.3rem;
            }
            
            .section {
                padding: 0.75rem;
            }
            
            .section h3 {
                font-size: 1rem;
            }
            
            /* Grids da p√°gina de perfil din√¢mica */
            #fullProfileContent > div {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Header do perfil - reduzir espa√ßo inferior */
            #fullProfileContent > div > div:nth-child(1) {
                margin-bottom: 1.5rem !important;
                padding: 0 1rem !important;
            }
            
            /* Reduzir espa√ßo entre foto e nome */
            #fullProfileContent > div > div:nth-child(1) > div:first-child {
                margin-bottom: 0.75rem !important;
            }
            
            #fullProfileContent > div > div:nth-child(2) {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                padding: 0 1rem !important;
            }
            
            /* Bot√µes (3¬∫ elemento) v√£o para o topo */
            #fullProfileContent > div > div:nth-child(2) > div:nth-child(3) {
                order: -1;
                grid-column: 1 / -1;
                display: grid !important;
                flex-direction: row !important;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            
            #fullProfileContent > div > div:nth-child(2) > div:nth-child(3) > button {
                flex: none !important;
            }
            
            /* Card de n√≠vel - ajustar margens */
            #fullProfileContent > div > div:nth-child(3) {
                margin-bottom: 0.75rem !important;
                margin-left: 1rem !important;
                margin-right: 1rem !important;
            }
            
            #fullProfileContent > div > div:nth-child(4) {
                grid-template-columns: repeat(3, minmax(90px, 1fr)) !important;
                gap: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                padding: 0 1rem !important;
            }
            
            #fullProfileContent > div > div:nth-child(4) > div {
                padding: 1rem 0.5rem !important;
            }
            
            #fullProfileContent > div > div:nth-child(4) > div > div:first-child {
                font-size: 1.5rem !important;
            }
            
            #fullProfileContent > div > div:nth-child(4) > div > div:last-child {
                font-size: 0.75rem !important;
            }
            
            /* Bot√£o Voltar para o Feed - aumentar espa√ßo superior */
            #fullProfileContent > div > div:nth-child(5) {
                margin-top: 3rem !important;
                padding: 0 1rem !important;
            }
        }

        /* CSS para p√°gina √∫nica de post */
        .single-post-page-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            z-index: 10000;
            overflow-y: auto;
            display: none; /* Inicialmente oculto */
        }

        .single-post-page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem 0.5rem 2rem;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 10001;
            box-shadow: none;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .post-page-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .single-post-page-content {
            max-width: 800px;
            margin: 1rem auto 2rem auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: calc(100vh - 120px);
        }

        /* Ajustes espec√≠ficos para conte√∫do do post na p√°gina √∫nica */
        .single-post-page-content .post-container {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .single-post-page-content .post-header {
            margin-bottom: 1.5rem;
        }

        .single-post-page-content .post-content {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .single-post-page-content .post-actions {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
            margin-top: 2rem;
        }

        .single-post-page-content .comments-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        /* Responsivo para p√°gina de post */
        @media (max-width: 768px) {
            .single-post-page-content {
                margin: 0.5rem;
                padding: 1.5rem;
                min-height: calc(100vh - 100px);
            }
            
            .post-page-logo {
                font-size: 1.3rem;
            }

            .single-post-page-content .post-content {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .single-post-page-header {
                padding: 0.75rem 1rem 0.5rem 1rem;
            }
            
            .post-page-logo {
                font-size: 1.2rem;
            }
            
            .single-post-page-content {
                margin: 0.25rem;
                padding: 1rem;
                min-height: calc(100vh - 80px);
            }

            .single-post-page-content .post-content {
                font-size: 0.95rem;
            }

            .single-post-page-content .post-header {
                margin-bottom: 1rem;
            }

            .single-post-page-content .post-actions,
            .single-post-page-content .comments-section {
                margin-top: 1.5rem;
                padding-top: 1.5rem;
            }
        }

        /* Anima√ß√µes para toast de compartilhamento */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <img src="./holospot_logo_cropped-Photoroom.png" style="width: 220px; height: auto;">
            </div>
            <p class="login-subtitle">Colocando os holofotes nos outros</p>
            <button id="loginBtn" class="google-login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <!-- User section (esquerda no desktop) -->
            <div class="user-section">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <div class="user-info">
                    <div id="userName" class="user-name">Carregando...</div>
                    <div id="userUsername" class="user-username">@carregando</div>
                </div>
            </div>

            <!-- Logo (centro no desktop) -->
            <div class="logo" id="mainLogo" style="cursor: pointer; transition: all 0.2s ease;">
                <img src="./holospot_logo_cropped-Photoroom.png" style="width: 180px; height: auto;">
            </div>

            <!-- Actions (direita no desktop) -->
            <div class="header-actions">
                <div class="notifications" id="notificationsBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-item">
                            <div class="notification-text">Voc√™ tem novas men√ß√µes!</div>
                            <div class="notification-time">h√° 2 minutos</div>
                        </div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">Sair</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="inicio" id="inicioNavTab">
            <span id="feedEmojiDropdown" style="cursor: pointer; display: inline-flex; align-items: center; gap: 2px;">
                <span id="feedEmoji">üåç</span>
                <svg id="inicioDropdownIcon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </span>
            <span style="margin-left: 2px;">Feed</span>
        </div>
        <div class="nav-tab" data-tab="destacar"><img src="./holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar</div>
        <div class="nav-tab" data-tab="perfil">üë§ Perfil</div>
        <div class="nav-tab" data-tab="buscar">üîç</div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">

        <!-- Tab Contents -->
        <div id="inicioTab" class="tab-content active">
            <div id="postsContainer" class="posts-container">
                <!-- Posts will be loaded here -->
            </div>
        </div>

        <div id="destacarTab" class="tab-content">
            <div class="create-post-form">
                <h2 style="margin-bottom: 1.5rem; color: #e65100;"><img src="./holofote.png" style="width: 20px; height: 20px; margin-right: 6px; vertical-align: middle;"> Destacar Algu√©m</h2>
                
                <div class="form-group">
                    <label class="form-label">Nome da pessoa</label>
                    <div class="textarea-container">
                        <input type="text" id="personName" class="form-input" placeholder="Digite o nome ou use @ para mencionar algu√©m...">
                        <div id="mentionsAutocomplete" class="mentions-autocomplete" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Que tipo de destaque √© esse?</label>
                    <div class="highlight-types">
                        <div class="highlight-type" data-type="gratidao">
                            <div class="highlight-type-emoji">üôè</div>
                            <div class="highlight-type-name">Gratid√£o</div>
                            <div class="highlight-type-desc">Agradecer por algo</div>
                        </div>
                        <div class="highlight-type" data-type="memoria">
                            <div class="highlight-type-emoji">üí≠</div>
                            <div class="highlight-type-name">Mem√≥ria</div>
                            <div class="highlight-type-desc">Lembrar momentos especiais</div>
                        </div>
                        <div class="highlight-type" data-type="conquista">
                            <div class="highlight-type-emoji">üèÜ</div>
                            <div class="highlight-type-name">Conquista</div>
                            <div class="highlight-type-desc">Celebrar vit√≥rias</div>
                        </div>
                        <div class="highlight-type" data-type="inspiracao">
                            <div class="highlight-type-emoji">‚ú®</div>
                            <div class="highlight-type-name">Inspira√ß√£o</div>
                            <div class="highlight-type-desc">Reconhecer exemplo</div>
                        </div>
                        <div class="highlight-type" data-type="apoio">
                            <div class="highlight-type-emoji">ü§ù</div>
                            <div class="highlight-type-name">Apoio</div>
                            <div class="highlight-type-desc">Valorizar suporte</div>
                        </div>
                        <div class="highlight-type" data-type="admiracao">
                            <div class="highlight-type-emoji">üåü</div>
                            <div class="highlight-type-name">Admira√ß√£o</div>
                            <div class="highlight-type-desc">Expressar respeito</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Conte sua hist√≥ria</label>
                    <textarea id="storyText" class="form-input" rows="4" placeholder="Por que essa pessoa merece destaque? O que ela fez de especial?"></textarea>
                </div>

                <div class="photo-upload-section">
                    <button type="button" class="photo-upload-btn" onclick="document.getElementById('photoUpload').click()">
                        üì∑ Adicionar Foto
                    </button>
                    <input type="file" id="photoUpload" accept="image/*" onchange="handlePhotoUpload(event)">
                    
                    <div id="photoPreview" class="photo-preview" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <br>
                        <button type="button" class="remove-photo-btn" onclick="removePhoto()">‚ùå Remover Foto</button>
                    </div>
                </div>

                <button id="createPostBtn" class="submit-btn" onclick="createPost()">
                    <img src="./holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa
                </button>
            </div>
        </div>

        <div id="perfilTab" class="tab-content">
            <!-- Bot√£o Settings no canto direito -->
            <div style="position: relative;">
                <button onclick="openSettingsModal()" style="
                    position: absolute;
                    top: -60px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 48px;
                    height: 48px;
                    font-size: 1.5rem;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s ease;
                    z-index: 10;
                " onmouseover="this.style.transform='scale(1.1) rotate(90deg)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';">
                    ‚öôÔ∏è
                </button>
            </div>
            
            <div class="follow-stats">
                <div class="follow-stat" onclick="showFollowingModal()">
                    <div class="follow-number" id="followingCount">0</div>
                    <div class="follow-label">Seguindo</div>
                </div>
                <div class="follow-stat" onclick="showFollowersModal()">
                    <div class="follow-number" id="followersCount">0</div>
                    <div class="follow-label">Seguidores</div>
                </div>
            </div>
            
            <div class="stats-grid">
                <!-- Posts Criados -->
                <div class="stat-card" id="postsCreatedCard" style="cursor: pointer; transition: transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPostsCount">0</div>
                    <div class="stat-label">Posts Criados</div>
                </div>
                <!-- Pessoas Destacadas -->
                <div class="stat-card" id="peopleHighlightedCard" style="cursor: pointer; transition: transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPeopleHighlighted">0</div>
                    <div class="stat-label">Pessoas Destacadas</div>
                </div>
                <!-- Feedbacks Dados -->
                <div class="stat-card">
                    <div class="stat-number" id="userFeedbacksGiven">0</div>
                    <div class="stat-label">Feedbacks Dados</div>
                </div>
                <!-- Coment√°rios Escritos -->
                <div class="stat-card">
                    <div class="stat-number" id="userCommentsGiven">0</div>
                    <div class="stat-label">Coment√°rios Escritos</div>
                </div>
                <!-- Rea√ß√µes Dadas -->
                <div class="stat-card">
                    <div class="stat-number" id="userReactionsGiven">0</div>
                    <div class="stat-label">Rea√ß√µes Dadas</div>
                </div>
            </div>

            <!-- Streak de Engajamento -->
            <div class="evolution-chart">
                <h3 class="chart-title">üî• Streak de Engajamento</h3>
                <div style="margin-bottom: 1rem; margin-top: 1.5rem;">
                    <strong>Dias consecutivos ativo: <span id="userStreakDisplay">0 dias</span></strong>
                    
                    <!-- Barra 7 dias -->
                    <div class="progress-bar" style="margin-top: 0.5rem;">
                        <div class="progress-fill" id="engagementStreakProgress7" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText7">0/7</div>
                    
                    <!-- Barra 30 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress30" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText30">0/30</div>
                    
                    <!-- Barra 182 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress182" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText182">0/182</div>
                    
                    <!-- Barra 365 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress365" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText365">0/365</div>
                </div>
            </div>

            <!-- M√âTRICAS RECEBIDAS -->
            <div class="stats-grid">
                <!-- Holofotes Recebidos (abaixo de Posts Criados) -->
                <div class="stat-card" id="postsReceivedCard" style="cursor: pointer; transition: transform 0.2s ease; background-color: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userHolofotesReceived">0</div>
                    <div class="stat-label">Holofotes Recebidos</div>
                </div>
                <!-- Pessoas que te Destacaram (abaixo de Pessoas Destacadas) -->
                <div class="stat-card" id="peopleWhoHighlightedCard" style="cursor: pointer; transition: transform 0.2s ease; background-color: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPeopleWhoHighlighted">0</div>
                    <div class="stat-label">Pessoas que te Destacaram</div>
                </div>
                <!-- Feedbacks Recebidos (abaixo de Feedbacks Dados) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userFeedbacksReceived">0</div>
                    <div class="stat-label">Feedbacks Recebidos</div>
                </div>
                <!-- Coment√°rios Recebidos (abaixo de Coment√°rios Escritos) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userCommentsReceived">0</div>
                    <div class="stat-label">Coment√°rios Recebidos</div>
                </div>
                <!-- Rea√ß√µes Recebidas (abaixo de Rea√ß√µes Dadas) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userReactionsReceived">0</div>
                    <div class="stat-label">Rea√ß√µes Recebidas</div>
                </div>
            </div>

            <!-- Bot√£o para abrir modal de Impacto -->
            <div class="impact-button-container">
                <button id="impactBtn" class="impact-btn">üìä Ver Impacto Detalhado</button>
            </div>
            
            <!-- Bot√£o para abrir modal de Conquistas -->
            <div class="achievements-button-container" style="margin-top: 1rem; text-align: center;">
                <button id="achievementsBtn" class="achievements-btn">üèÜ Ver Suas Conquistas</button>
            </div>
        </div>
    </div>
    <!-- Modal de Impacto -->
    <div id="impactModal" class="modal-overlay modal-overlay--impact" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üìä Impacto Detalhado</h2>
                <button class="close-btn" onclick="closeImpactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="insights-grid">
                    <!-- Reciprocidade Real -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">ü§ù</span>
                            <span class="insight-title">Reciprocidade Real</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="reciprocityChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="reciprocityValue">0%</div>
                        <div class="insight-description">reciprocidade entre voc√™ e seus seguidores</div>
                    </div>

                    <!-- √çndice de Altru√≠smo -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">üíù</span>
                            <span class="insight-title">√çndice de Altru√≠smo</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="altruismChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="altruismValue">0:0</div>
                        <div class="insight-description">balan√ßo dar vs receber</div>
                        <div class="insight-message" id="altruismMessage" style="font-style: italic; font-size: 0.9em; color: #666; margin-top: 0.5rem;"></div>
                    </div>

                    <!-- Alcance Efetivo -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">‚ö°</span>
                            <span class="insight-title">Alcance Efetivo</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="reachChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="reachValue">0%</div>
                        <div class="insight-description">posts que geram intera√ß√£o</div>
                    </div>
                </div>

                <!-- Evolu√ß√£o Temporal -->
                <div class="evolution-chart">
                    <h3 class="chart-title">üìà Evolu√ß√£o (√öltimos 30 dias)</h3>
                    <div class="insight-chart-large">
                        <canvas id="evolutionChart" width="800" height="300"></canvas>
                    </div>
                </div>

                <div class="insights-grid">
                    <!-- Taxa de Engajamento -->
                    <div class="insight-card compact">
                        <div class="insight-header">
                            <span class="insight-icon">üéØ</span>
                            <span class="insight-title">Taxa de Engajamento</span>
                        </div>
                        <div class="insight-value" id="engagementValue">0.0/post</div>
                        <div class="insight-description">m√©dia de intera√ß√µes por post</div>
                    </div>

                    <!-- Impacto M√©dio -->
                    <div class="insight-card compact">
                        <div class="insight-header">
                            <span class="insight-icon">üåê</span>
                            <span class="insight-title">Impacto M√©dio</span>
                        </div>
                        <div class="insight-value" id="impactValue">0.0</div>
                        <div class="insight-description">m√©dia de pessoas alcan√ßadas por post</div>
                    </div>

                    <!-- Rede de Engajamento -->
                    <div class="insight-card compact" id="networkCard">
                        <div class="insight-header">
                            <span class="insight-icon">üîó</span>
                            <span class="insight-title">Rede de Engajamento</span>
                        </div>
                        <div class="insight-value" id="networkSize" onmouseover="showTooltip(event)" onmouseout="hideTooltip()">6</div>
                        <div class="insight-description">pessoas conectadas</div>
                    </div>
                </div>

                <!-- Insights Personalizados -->
                <div class="evolution-chart">
                    <h3 class="chart-title" style="margin-bottom: 1.5rem;">üí° Insights Personalizados</h3>
                    <div id="personalizedInsights" style="color: #666; line-height: 1.6;">
                        üìä Analisando seus dados...
                    </div>
                </div>
            </div>
        </div>

        <div id="buscarTab" class="tab-content">
            <div class="create-post-form">
                <h2 style="margin-bottom: 1.5rem; color: #e65100;">üîç Buscar</h2>
                
                <div class="form-group">
                    <label class="form-label">O que voc√™ est√° procurando?</label>
                    <div class="textarea-container">
                        <input type="text" id="searchInput" class="form-input" placeholder="Digite para buscar posts e perfis..." autocomplete="off">
                    </div>
                </div>
                
                <div id="searchResults" class="search-results-page" style="display: none;"></div>
            </div>
        </div>
    </div>
    <!-- Modal de Feedbacks Recebidos -->
    <div id="feedbacksModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üì¨ Feedback</h2>
                <button class="close-btn" onclick="closeFeedbacksModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalFeedbacksContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Feedbacks ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Conquistas -->
    <div id="achievementsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üèÜ Suas Conquistas</h2>
                <button class="close-btn" onclick="closeAchievementsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="achievementsContent">
                    <!-- Loading inicial -->
                    <div id="achievementsLoading" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 16px;">‚è≥</div>
                        <div>Carregando suas conquistas...</div>
                    </div>
                    
                    <!-- Conte√∫do real ser√° carregado aqui -->
                    <div id="achievementsData" style="display: none;">
                        <!-- Se√ß√£o de Pontos e N√≠vel -->
                        <div class="gamification-section">
                            <h3 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <span>üöÄ</span> Seu Progresso
                            </h3>
                            <div class="level-progress-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <div id="userLevel" style="font-size: 24px; font-weight: bold; cursor: pointer; text-decoration: underline;" onclick="openLevelsModal()">N√≠vel 1</div>
                                        <div id="userLevelName" style="opacity: 0.9;">Novato</div>
                                    </div>
                                    <div id="userLevelIcon" style="font-size: 48px;">üå±</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span id="userPoints">0 pontos</span>
                                        <span id="pointsToNext">50 para pr√≥ximo n√≠vel</span>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px;">
                                        <div id="levelProgressBar" style="background: rgba(255,255,255,0.8); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center; font-size: 14px; opacity: 0.9;">
                                    Ranking: <span id="userRanking">#-</span> de <span id="totalUsers">-</span> usu√°rios
                                </div>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o de Badges -->
                        <div class="gamification-section">
                            <h3 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                                <span style="display: flex; align-items: center; gap: 10px;">
                                    <span>üéñÔ∏è</span> Seus Emblemas
                                </span>
                                <a href="#" onclick="openProgressModal()" class="progress-link-top" style="font-size: 14px; color: #667eea; text-decoration: none; font-weight: normal;">
                                    ver conquistas em andamento ‚Üí
                                </a>
                            </h3>
                            <div id="badgesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                <!-- Badges ser√£o carregados aqui -->
                            </div>
                            <a href="#" onclick="openProgressModal()" class="progress-link-bottom" style="font-size: 14px; color: #667eea; text-decoration: none; font-weight: normal; display: none; text-align: center; margin-top: 20px;">
                                ver conquistas em andamento ‚Üí
                            </a>
                            <div id="noBadges" style="text-align: center; padding: 40px; color: #666; display: none;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üéØ</div>
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhuma conquista ainda</div>
                                <div style="font-size: 14px;">Continue interagindo para desbloquear seus primeiros badges!</div>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o de Atividade Recente -->
                        <div class="gamification-section">
                            <h3 style="color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <span>‚ö°</span> Atividades Recentes
                            </h3>
                            <div id="recentActivity" style="max-height: 200px; overflow-y: auto;">
                                <!-- Atividades recentes ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de N√≠veis -->
    <div id="levelsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%; max-height: 75vh;">
            <div class="modal-header">
                <h2 style="margin: 0; color: white;">üìä N√≠veis do HoloSpot</h2>
                <button class="modal-close" onclick="closeLevelsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="levelsContent">
                    <div style="margin-bottom: 20px; text-align: center; color: #666;">
                        <p>Avance atrav√©s dos n√≠veis ganhando pontos com suas atividades!</p>
                    </div>
                    <div id="levelsContainer" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- N√≠veis ser√£o carregados aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Conquistas em Andamento -->
    <div id="progressModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 550px; width: 90%; max-height: 75vh;">
            <div class="modal-header">
                <h2 class="progress-modal-title" style="margin: 0; color: white;">üéØ Conquistas em Andamento</h2>
                <button class="modal-close" onclick="closeProgressModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="progressContent">
                    <div class="loading-spinner" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                        <div style="font-size: 18px; color: #e65100;">Carregando conquistas...</div>
                    </div>
                    <div id="progressData" style="display: none;">
                        <div style="margin-bottom: 20px; text-align: center; color: #666;">
                            <p>Seus pr√≥ximos emblemas para conquistar!</p>
                        </div>
                        <div id="progressContainer" style="display: flex; flex-direction: column; gap: 20px;">
                            <!-- Conquistas em andamento ser√£o carregadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Container para p√°gina completa de perfil (inicialmente oculto) -->
    <div id="fullProfileContainer" class="full-profile-container" style="display: none;">
        <div class="full-profile-header">
            <div class="profile-logo" onclick="ProfileRouter.closeFullProfile()" style="cursor: pointer;">
                <img src="./holospot_logo_cropped-Photoroom.png" style="width: 180px; height: auto;">
            </div>
        </div>
        <div id="fullProfileContent" class="full-profile-content">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>

    <!-- NOVO: Container para p√°gina √∫nica de post (inicialmente oculto) -->
    <div id="singlePostPageContainer" class="single-post-page-container" style="display: none;">
        <div class="single-post-page-header">
            <div class="post-page-logo" onclick="PostRouter.closeSinglePostPage()" style="cursor: pointer;">
                <img src="./holospot_logo_cropped-Photoroom.png" style="width: 180px; height: auto;">
            </div>
        </div>
        <div id="singlePostPageContent" class="single-post-page-content">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://dwcmrbrhyuflhtymbhll.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3Y21yYnJoeXVmbGh0eW1iaGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDU0NDgsImV4cCI6MjA3MTkyMTQ0OH0.55BtZc5dcwTlF7TXNMuoD0Sa6bUO2WkB-r1itj5t2tw';
        
        // SECURITY FIX: Using ANON_KEY instead of SERVICE_KEY for client-side operations
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ACCESSIBILITY: ESC key gerenciado pelo sistema de pilha de modais

        // Fun√ß√£o para timeout agressivo
        function withTimeout(promise, timeoutMs = 10000) {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(`Timeout ap√≥s ${timeoutMs}ms`)), timeoutMs)
                )
            ]);
        }

        // Fun√ß√£o para obter usu√°rio atual
        async function getCurrentUser() {
            try {
                if (currentUser) {
                    return currentUser;
                }
                
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                
                return user;
            } catch (error) {
                console.error('‚ùå Erro ao obter usu√°rio atual:', error);
                return null;
            }
        }
        
        let currentUser = null;
        let posts = [];
        let notifications = [];
        let following = [];
        
        // ===== SISTEMA DE PILHA DE MODAIS PARA ESC =====
        const modalStack = [];
        let globalEscHandler = null;
        
        function addModalToStack(modalId, closeFunction) {
            // Remover modal da pilha se j√° existir
            const existingIndex = modalStack.findIndex(m => m.id === modalId);
            if (existingIndex !== -1) {
                modalStack.splice(existingIndex, 1);
            }
            
            // Adicionar modal no topo da pilha
            modalStack.push({ id: modalId, close: closeFunction });
            console.log('üìö Modal adicionado √† pilha:', modalId, '| Pilha atual:', modalStack.map(m => m.id));
            
            // Configurar handler ESC global se n√£o existir
            if (!globalEscHandler) {
                globalEscHandler = (e) => {
                    if (e.key === 'Escape' && modalStack.length > 0) {
                        // Fechar o modal do topo da pilha
                        const topModal = modalStack[modalStack.length - 1];
                        console.log('üîë ESC pressionado - fechando modal:', topModal.id);
                        topModal.close();
                    }
                };
                document.addEventListener('keydown', globalEscHandler);
                console.log('üéØ Handler ESC global configurado');
            }
        }
        
        function removeModalFromStack(modalId) {
            const index = modalStack.findIndex(m => m.id === modalId);
            if (index !== -1) {
                modalStack.splice(index, 1);
                console.log('üìö Modal removido da pilha:', modalId, '| Pilha atual:', modalStack.map(m => m.id));
            }
            
            // Se n√£o h√° mais modais, remover handler ESC global
            if (modalStack.length === 0 && globalEscHandler) {
                document.removeEventListener('keydown', globalEscHandler);
                globalEscHandler = null;
                console.log('üéØ Handler ESC global removido - pilha vazia');
            }
        }
        let followers = [];
        let selectedPhotoFile = null;
        let selectedHighlightType = null;

        // üöÄ SISTEMA DE CACHE INTELIGENTE
        let feedbacksCache = new Map(); // Cache global para feedbacks
        let commentsCache = new Map();  // Cache global para coment√°rios  
        let profilesCache = new Map();  // Cache global para perfis de usu√°rios
        let reactionsCache = new Map(); // Cache global para rea√ß√µes

        // Sistema de Men√ß√µes
        let mentionUsers = [];
        
        // üöÄ FUN√á√ïES DE CACHE INTELIGENTE
        
        // Adicionar feedback ao cache em tempo real
        function addFeedbackToCache(postId, feedback) {
            if (!feedbacksCache.has(postId)) {
                feedbacksCache.set(postId, []);
            }
            feedbacksCache.get(postId).push(feedback);
            console.log('‚úÖ Feedback adicionado ao cache:', postId);
        }
        
        // Invalidar cache de feedbacks quando necess√°rio
        function invalidateFeedbackCache(postId = null) {
            if (postId) {
                feedbacksCache.delete(postId);
                console.log('üîÑ Cache de feedback invalidado para post:', postId);
            } else {
                feedbacksCache.clear();
                console.log('üîÑ Cache completo de feedbacks invalidado');
            }
        }
        
        // Adicionar coment√°rio ao cache em tempo real
        function addCommentToCache(postId, comment) {
            if (!commentsCache.has(postId)) {
                commentsCache.set(postId, []);
            }
            commentsCache.get(postId).push(comment);
            console.log('‚úÖ Coment√°rio adicionado ao cache:', postId);
        }
        
        // Invalidar cache de coment√°rios quando necess√°rio
        function invalidateCommentCache(postId = null) {
            if (postId) {
                commentsCache.delete(postId);
                console.log('üîÑ Cache de coment√°rio invalidado para post:', postId);
            } else {
                commentsCache.clear();
                console.log('üîÑ Cache completo de coment√°rios invalidado');
            }
        }
        
        // Atualizar m√©tricas em tempo real
        function updateMetricsRealTime() {
            // Atualizar contadores sem recarregar p√°gina
            updateStats();
            console.log('üìä M√©tricas atualizadas em tempo real');
        }
        
        // Re-renderizar posts em tempo real
        function reRenderPostsRealTime() {
            renderPosts();
            console.log('üîÑ Posts re-renderizados em tempo real');
        }
        let currentMentionQuery = '';
        let selectedMentionIndex = -1;
        let mentionStartPos = -1;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ HoloSpot v8 iniciando...');
                
                // Inicializar estado de loading
                window.isLoadingPosts = false;
                
                // Check if user is already logged in
                console.log('üîç Verificando sess√£o...');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Erro ao verificar sess√£o:', error);
                    showLogin();
                    return;
                }
                
                if (session) {
                    console.log('‚úÖ Usu√°rio logado encontrado:', session.user.email);
                    currentUser = session.user;
                    showApp();
                    
                    try {
                        console.log('üìä Carregando dados do usu√°rio...');
                        await loadUserData();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                    }
                    
                    try {
                        console.log('üìù Carregando posts...');
                        await loadPosts();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar posts:', error);
                    }
                    
                    try {
                        console.log('üîî Carregando notifica√ß√µes...');
                        await loadNotifications();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar notifica√ß√µes:', error);
                    }
                    
                    try {
                        console.log('üìà Atualizando estat√≠sticas...');
                        updateStats();
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar estat√≠sticas:', error);
                    }
                } else {
                    console.log('üë§ Nenhum usu√°rio logado, mostrando tela de login');
                    showLogin();
                }

                // Setup event listeners
                console.log('üéØ Configurando event listeners...');
                setupEventListeners();
                console.log('‚úÖ HoloSpot v8 carregado com sucesso!');
                
            } catch (error) {
                console.error('üí• ERRO CR√çTICO na inicializa√ß√£o:', error);
                alert('Erro ao carregar o HoloSpot. Recarregue a p√°gina.');
            }
        });

        function setupEventListeners() {
            try {
                console.log('üéØ Configurando event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', handleLogin);
                    console.log('‚úÖ Login button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Login button n√£o encontrado');
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                    console.log('‚úÖ Logout button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Logout button n√£o encontrado');
                }
                
                // Logo clic√°vel para refresh
                const mainLogo = document.getElementById('mainLogo');
                if (mainLogo) {
                    mainLogo.addEventListener('click', handleLogoRefresh);
                    console.log('‚úÖ Logo refresh listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Logo principal n√£o encontrado');
                }
                
                // Tab navigation
                const navTabs = document.querySelectorAll('.nav-tab');
                if (navTabs.length > 0) {
                    navTabs.forEach(tab => {
                        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                    });
                    console.log(`‚úÖ ${navTabs.length} tab listeners configurados`);
                } else {
                    console.warn('‚ö†Ô∏è Nav tabs n√£o encontradas');
                }

                // Highlight type selection
                const highlightTypes = document.querySelectorAll('.highlight-type');
                if (highlightTypes.length > 0) {
                    highlightTypes.forEach(type => {
                        type.addEventListener('click', () => selectHighlightType(type.dataset.type));
                    });
                    console.log(`‚úÖ ${highlightTypes.length} highlight type listeners configurados`);
                } else {
                    console.warn('‚ö†Ô∏è Highlight types n√£o encontrados');
                }

                // Notifications
                const notificationsBtn = document.getElementById('notificationsBtn');
                if (notificationsBtn) {
                    notificationsBtn.addEventListener('click', toggleNotifications);
                    console.log('‚úÖ Notifications button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Notifications button n√£o encontrado');
                }
                
                // Close notifications when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications')) {
                        const dropdown = document.getElementById('notificationDropdown');
                        if (dropdown) {
                            dropdown.style.display = 'none';
                        }
                    }
                });
                console.log('‚úÖ Outside click listener configurado');

                // Event listeners j√° configurados via onclick no HTML
                console.log('‚úÖ Event listeners configurados via onclick no HTML');
                
                // Configurar pull-to-refresh para mobile
                setupPullToRefresh();
                
            } catch (error) {
                console.error('‚ùå Erro ao configurar event listeners:', error);
            }
        }

        function setupPullToRefresh() {
            let startY = 0;
            let currentY = 0;
            let pullDistance = 0;
            let isPulling = false;
            let isRefreshing = false;
            
            const threshold = 80; // Dist√¢ncia m√≠nima para ativar refresh
            const maxPull = 120; // Dist√¢ncia m√°xima de pull
            
            // Detectar in√≠cio do touch
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    startY = e.touches[0].clientY;
                    isPulling = false;
                }
            }, { passive: true });
            
            // Detectar movimento do touch
            document.addEventListener('touchmove', (e) => {
                if (startY > 0 && window.scrollY === 0 && !isRefreshing) {
                    currentY = e.touches[0].clientY;
                    pullDistance = Math.min(currentY - startY, maxPull);
                    
                    if (pullDistance > 10) {
                        isPulling = true;
                        
                        // Feedback visual
                        const header = document.querySelector('.header');
                        if (header && pullDistance > 0) {
                            const opacity = Math.min(pullDistance / threshold, 1);
                            header.style.transform = `translateY(${pullDistance * 0.5}px)`;
                            header.style.opacity = 0.5 + (opacity * 0.5);
                        }
                        
                        // Prevenir scroll padr√£o quando puxando
                        if (pullDistance > 20) {
                            e.preventDefault();
                        }
                    }
                }
            }, { passive: false });
            
            // Detectar fim do touch
            document.addEventListener('touchend', async () => {
                if (isPulling && pullDistance > threshold && !isRefreshing) {
                    isRefreshing = true;
                    console.log('üì± Pull-to-refresh ativado');
                    
                    // Feedback visual de refresh
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.transform = 'translateY(20px)';
                        header.style.transition = 'all 0.3s ease';
                    }
                    
                    try {
                        // Executar refresh
                        await handleLogoRefresh();
                    } catch (error) {
                        console.error('‚ùå Erro no pull-to-refresh:', error);
                    }
                    
                    // Restaurar visual
                    setTimeout(() => {
                        if (header) {
                            header.style.transform = '';
                            header.style.opacity = '';
                            header.style.transition = '';
                        }
                        isRefreshing = false;
                    }, 500);
                }
                
                // Reset
                startY = 0;
                currentY = 0;
                pullDistance = 0;
                isPulling = false;
                
                // Restaurar header se n√£o est√° refreshing
                if (!isRefreshing) {
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.transform = '';
                        header.style.opacity = '';
                    }
                }
            }, { passive: true });
            
            console.log('‚úÖ Pull-to-refresh configurado para mobile');
        }

        function selectHighlightType(type) {
            // Remove previous selection
            document.querySelectorAll('.highlight-type').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked type
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            selectedHighlightType = type;
        }

        async function handleLogin() {
            try {
                console.log('üîê Iniciando login...');
                trackEvent('login_attempt');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://holospot.vercel.app'
                    }
                });
                
                if (error) {
                    console.error('‚ùå Erro no login:', error);
                    alert('Erro no login: ' + error.message);
                }
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                alert('Erro no login: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                console.log('üö™ Fazendo logout...');
                await supabase.auth.signOut();
                currentUser = null;
                
                // Limpar completamente o conte√∫do da p√°gina
                clearAllPageContent();
                
                showLogin();
                console.log('‚úÖ Logout realizado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro no logout:', error);
            }
        }

        function clearAllPageContent() {
            // Limpar todos os containers de conte√∫do de todas as abas
            const postsContainer = document.getElementById('postsContainer');
            if (postsContainer) postsContainer.innerHTML = '';
            
            // Limpar conte√∫do de todas as abas
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tabContent => {
                // Resetar classes ativas
                tabContent.classList.remove('active');
                
                // Limpar conte√∫do espec√≠fico de cada aba
                const containers = tabContent.querySelectorAll('div[id*="Container"], div[id*="Content"]');
                containers.forEach(container => {
                    container.innerHTML = '';
                });
            });
            
            // Reativar apenas a aba in√≠cio
            const inicioTabContent = document.getElementById('inicioTab');
            if (inicioTabContent) inicioTabContent.classList.add('active');
            
            // Limpar dados globais
            posts = [];
            following = [];
            followers = [];
            
            // Fechar todos os modais abertos
            const modals = document.querySelectorAll('.modal, .modal-overlay');
            modals.forEach(modal => {
                if (modal.style.display !== 'none') {
                    modal.style.display = 'none';
                }
            });
            
            // Limpar caches
            if (typeof profilesCache !== 'undefined' && profilesCache.clear) {
                profilesCache.clear();
            }
            if (typeof commentsCache !== 'undefined' && commentsCache.clear) {
                commentsCache.clear();
            }
            if (typeof feedbacksCache !== 'undefined' && feedbacksCache.clear) {
                feedbacksCache.clear();
            }
            
            // Resetar abas de navega√ß√£o para in√≠cio
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            const inicioTab = document.querySelector('.nav-tab[data-tab="inicio"]');
            if (inicioTab) inicioTab.classList.add('active');
            
            // Limpar formul√°rios
            const forms = document.querySelectorAll('form, input, textarea');
            forms.forEach(form => {
                if (form.tagName === 'FORM') {
                    form.reset();
                } else if (form.tagName === 'INPUT' || form.tagName === 'TEXTAREA') {
                    form.value = '';
                }
            });
            
            console.log('üßπ Conte√∫do de todas as abas limpo completamente');
        }

        async function handleLogoRefresh() {
            try {
                console.log('üîÑ Refresh completo iniciado pelo logo...');
                
                // Mostrar loading visual
                const mainLogo = document.getElementById('mainLogo');
                if (mainLogo) {
                    mainLogo.style.opacity = '0.5';
                    mainLogo.style.transform = 'scale(0.95)';
                }
                
                // Limpar caches
                feedbacksCache.clear();
                commentsCache.clear();
                profilesCache.clear();
                reactionsCache.clear();
                
                // Marcar como carregando ANTES de renderizar
                window.isLoadingPosts = true;
                
                // Recarregar todos os dados
                await Promise.all([
                    loadPosts(),
                    loadUserData(),
                    loadNotifications()
                ]);
                
                // Atualizar interface (isLoadingPosts j√° foi setado para false dentro de loadPosts)
                await renderPosts();
                updateStats();
                
                // Restaurar visual do logo
                if (mainLogo) {
                    mainLogo.style.opacity = '1';
                    mainLogo.style.transform = 'scale(1)';
                }
                
                console.log('‚úÖ Refresh completo finalizado');
                
            } catch (error) {
                console.error('‚ùå Erro no refresh:', error);
                
                // Restaurar visual do logo mesmo com erro
                const mainLogo = document.getElementById('mainLogo');
                if (mainLogo) {
                    mainLogo.style.opacity = '1';
                    mainLogo.style.transform = 'scale(1)';
                }
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            
            // Ocultar header e navega√ß√£o quando mostrar login
            const header = document.querySelector('.header');
            const navTabs = document.querySelector('.nav-tabs');
            if (header) header.style.display = 'none';
            if (navTabs) navTabs.style.display = 'none';
        }

        // ===== SINCRONIZA√á√ÉO DE REA√á√ïES LOCAIS =====
        async function syncLocalReactions() {
            console.log('üîÑ Sincronizando rea√ß√µes locais com o servidor...');
            
            const localReactions = [];
            
            // Encontrar todas as rea√ß√µes locais
            posts.forEach(post => {
                if (Array.isArray(post.reactions)) {
                    post.reactions.forEach(reaction => {
                        if (reaction.id.toString().startsWith('local-')) {
                            localReactions.push({ post, reaction });
                        }
                    });
                }
            });
            
            if (localReactions.length === 0) {
                console.log('‚úÖ Nenhuma rea√ß√£o local para sincronizar');
                return;
            }
            
            console.log(`üîÑ Encontradas ${localReactions.length} rea√ß√µes locais para sincronizar`);
            
            for (const { post, reaction } of localReactions) {
                try {
                    const { data, error } = await supabase
                        .from('reactions')
                        .insert({
                            post_id: reaction.post_id,
                            user_id: reaction.user_id,
                            type: reaction.type
                        })
                        .select()
                        .single();
                    
                    if (!error && data) {
                        // Substituir rea√ß√£o local pela do servidor
                        const index = post.reactions.findIndex(r => r.id === reaction.id);
                        if (index !== -1) {
                            post.reactions[index] = data;
                            console.log(`‚úÖ Rea√ß√£o local sincronizada: ${reaction.type} no post ${reaction.post_id}`);
                        }
                    }
                    
                } catch (syncError) {
                    console.warn(`‚ö†Ô∏è Erro ao sincronizar rea√ß√£o ${reaction.type}:`, syncError.message);
                }
            }
            
            console.log('‚úÖ Sincroniza√ß√£o de rea√ß√µes locais conclu√≠da');
        }

        // ===== CONFIGURAR SINCRONIZA√á√ÉO DE REDE =====
        function setupNetworkSync() {
            // Sincronizar quando a conex√£o for restaurada
            window.addEventListener('online', () => {
                console.log('üåê Conex√£o restaurada, sincronizando rea√ß√µes locais...');
                showToast('Conex√£o restaurada. Sincronizando dados...');
                setTimeout(() => {
                    syncLocalReactions();
                }, 1000);
            });
            
            // Avisar quando a conex√£o for perdida
            window.addEventListener('offline', () => {
                console.log('üìµ Conex√£o perdida, modo offline ativado');
                showToast('Conex√£o perdida. Suas a√ß√µes ser√£o salvas localmente.');
            });
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Mostrar header e navega√ß√£o quando mostrar app
            const header = document.querySelector('.header');
            const navTabs = document.querySelector('.nav-tabs');
            if (header) header.style.display = 'block';
            if (navTabs) navTabs.style.display = 'flex';
            
            // Configurar sincroniza√ß√£o de rede
            setupNetworkSync();
            
            // Update user info in header
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.user_metadata.name || currentUser.email || 'Usu√°rio';
                document.getElementById('userUsername').textContent = '@' + (currentUser.email?.split('@')[0] || 'usuario');
                document.getElementById('userAvatar').src = currentUser.user_metadata.avatar_url || '';
                console.log('‚úÖ Usu√°rio logado:', currentUser.email);
                
                // Carregar dados de gamifica√ß√£o no carregamento inicial
                console.log('üéÆ Carregando dados de gamifica√ß√£o no in√≠cio...');
                loadUserGamificationData().catch(error => {
                    console.error('‚ùå Erro ao carregar gamifica√ß√£o inicial:', error);
                });
            }
            
            // Inicializar sistema de men√ß√µes
            loadMentionUsers().then(() => {
                setupMentionsSystem();
            });
            
            // Inicializar sistema de busca
            setupSearchSystem();
        }

        function switchTab(tabName) {
            console.log('üîÑ switchTab chamada para:', tabName);
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                console.log('‚úÖ Aba ativada:', tabName);
            } else {
                console.error('‚ùå Aba n√£o encontrada:', tabName);
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabContent = document.getElementById(`${tabName}Tab`);
            if (tabContent) {
                tabContent.classList.add('active');
                console.log('‚úÖ Conte√∫do da aba ativado:', `${tabName}Tab`);
            } else {
                console.error('‚ùå Conte√∫do da aba n√£o encontrado:', `${tabName}Tab`);
            }
            
            // Reconfigurar event listeners quando mudar para aba perfil
            if (tabName === 'perfil') {
                // Aguardar um pequeno delay para garantir que o DOM esteja pronto
                setTimeout(() => {
                    setupStatCardListeners();
                    console.log('üîÑ Event listeners dos cards reconfigurados na aba perfil');
                    
                    // Aplicar grid layout mobile via JavaScript
                    console.log('üì± window.innerWidth:', window.innerWidth);
                    if (window.innerWidth <= 768) {
                        console.log('‚úÖ Mobile detectado, aplicando grid layout...');
                        const allGrids = document.querySelectorAll('#perfilTab .stats-grid');
                        console.log('üìã Total de .stats-grid encontrados:', allGrids.length);
                        const firstGrid = allGrids[0];
                        const lastGrid = allGrids[1];
                        
                        if (firstGrid) {
                            firstGrid.style.display = 'grid';
                            firstGrid.style.gridTemplateColumns = 'repeat(6, 1fr)';
                            firstGrid.style.gap = '0.5rem';
                            
                            // Garantir box-sizing em todos os cards
                            const allCards = firstGrid.querySelectorAll('.stat-card');
                            allCards.forEach(card => {
                                card.style.boxSizing = 'border-box';
                                card.style.textAlign = 'center';
                                
                                // Ajustar tamanho dos textos
                                const statNumber = card.querySelector('.stat-number');
                                const statLabel = card.querySelector('.stat-label');
                                if (statNumber) statNumber.style.fontSize = '1.75rem';
                                if (statLabel) statLabel.style.fontSize = '0.85rem';
                            });
                            
                            const postsCard = firstGrid.querySelector('#postsCreatedCard');
                            const peopleCard = firstGrid.querySelector('#peopleHighlightedCard');
                            const feedbackCard = firstGrid.querySelector('.stat-card:nth-child(3)');
                            const commentsCard = firstGrid.querySelector('.stat-card:nth-child(4)');
                            const reactionsCard = firstGrid.querySelector('.stat-card:nth-child(5)');
                            
                            // Linha 1: Posts e Pessoas em 2 colunas (ocupam 3 colunas cada do grid de 6)
                            if (postsCard) {
                                postsCard.style.gridColumn = '1 / 4';
                                postsCard.style.gridRow = '1';
                            }
                            if (peopleCard) {
                                peopleCard.style.gridColumn = '4 / 7';
                                peopleCard.style.gridRow = '1';
                            }
                            // Linha 2: Feedbacks, Coment√°rios e Rea√ß√µes em 3 colunas (ocupam 2 colunas cada)
                            if (feedbackCard) {
                                feedbackCard.style.gridColumn = '1 / 3';
                                feedbackCard.style.gridRow = '2';
                            }
                            if (commentsCard) {
                                commentsCard.style.gridColumn = '3 / 5';
                                commentsCard.style.gridRow = '2';
                            }
                            if (reactionsCard) {
                                reactionsCard.style.gridColumn = '5 / 7';
                                reactionsCard.style.gridRow = '2';
                            }
                            
                            console.log('‚úÖ Grid layout aplicado no primeiro stats-grid');
                        } else {
                            console.error('‚ùå firstGrid n√£o encontrado');
                        }
                        
                        if (lastGrid) {
                            lastGrid.style.display = 'grid';
                            lastGrid.style.gridTemplateColumns = 'repeat(6, 1fr)';
                            lastGrid.style.gap = '0.5rem';
                            
                            // Garantir box-sizing em todos os cards
                            const allCardsLast = lastGrid.querySelectorAll('.stat-card');
                            allCardsLast.forEach(card => {
                                card.style.boxSizing = 'border-box';
                                card.style.textAlign = 'center';
                                
                                // Ajustar tamanho dos textos
                                const statNumber = card.querySelector('.stat-number');
                                const statLabel = card.querySelector('.stat-label');
                                if (statNumber) statNumber.style.fontSize = '1.75rem';
                                if (statLabel) statLabel.style.fontSize = '0.85rem';
                            });
                            
                            const holofotesCard = lastGrid.querySelector('#postsReceivedCard');
                            const peopleWhoCard = lastGrid.querySelector('#peopleWhoHighlightedCard');
                            const feedbackRecCard = lastGrid.querySelector('.stat-card:nth-child(3)');
                            const commentsRecCard = lastGrid.querySelector('.stat-card:nth-child(4)');
                            const reactionsRecCard = lastGrid.querySelector('.stat-card:nth-child(5)');
                            
                            // Linha 1: Holofotes e Pessoas em 2 colunas (ocupam 3 colunas cada do grid de 6)
                            if (holofotesCard) {
                                holofotesCard.style.gridColumn = '1 / 4';
                                holofotesCard.style.gridRow = '1';
                            }
                            if (peopleWhoCard) {
                                peopleWhoCard.style.gridColumn = '4 / 7';
                                peopleWhoCard.style.gridRow = '1';
                            }
                            // Linha 2: Feedbacks, Coment√°rios e Rea√ß√µes em 3 colunas (ocupam 2 colunas cada)
                            if (feedbackRecCard) {
                                feedbackRecCard.style.gridColumn = '1 / 3';
                                feedbackRecCard.style.gridRow = '2';
                            }
                            if (commentsRecCard) {
                                commentsRecCard.style.gridColumn = '3 / 5';
                                commentsRecCard.style.gridRow = '2';
                            }
                            if (reactionsRecCard) {
                                reactionsRecCard.style.gridColumn = '5 / 7';
                                reactionsRecCard.style.gridRow = '2';
                            }
                            
                            console.log('‚úÖ Grid layout aplicado no segundo stats-grid');
                        } else {
                            console.error('‚ùå lastGrid n√£o encontrado');
                        }
                    } else {
                        console.log('‚ÑπÔ∏è Desktop detectado, grid layout n√£o aplicado');
                    }
                }, 100);
            }
            
            // Configurar sistema de busca quando mudar para aba buscar
            if (tabName === 'buscar') {
                setTimeout(() => {
                    setupSearchSystem();
                    console.log('üîç Sistema de busca configurado na aba buscar');
                    
                    // Reposicionar elemento se necess√°rio
                    const buscarTab = document.getElementById('buscarTab');
                    if (buscarTab) {
                        // MOVER ELEMENTO PARA LOCAL CORRETO
                        const appContainer = document.getElementById('appContainer');
                        if (appContainer && buscarTab.parentElement?.id !== 'appContainer') {
                            console.log('üîÑ MOVENDO buscarTab para appContainer');
                            appContainer.appendChild(buscarTab);
                        }
                        
                        console.log('‚úÖ buscarTab reposicionado corretamente');
                    }
                }, 100);
            }
            
            console.log('üì± Aba alterada para:', tabName);
        }

        // Fun√ß√µes do Modal de Impacto
        function openImpactModal() {
            console.log('üöÄ openImpactModal chamada');
            const modal = document.getElementById('impactModal');
            console.log('üìã Modal encontrado:', modal);
            if (modal) {
                console.log('‚úÖ Abrindo modal de impacto...');
                modal.style.display = 'flex';
                loadImpactDataInModal();
            } else {
                console.error('‚ùå Modal impactModal n√£o encontrado no DOM');
            }
        }

        function closeImpactModal() {
            const modal = document.getElementById('impactModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Fun√ß√µes do Modal de Conquistas
        function openAchievementsModal() {
            console.log('üèÜ openAchievementsModal chamada');
            const modal = document.getElementById('achievementsModal');
            console.log('üìã Modal encontrado:', modal);
            if (modal) {
                console.log('‚úÖ Abrindo modal de conquistas...');
                modal.style.display = 'flex';
                loadUserGamificationData();
            } else {
                console.error('‚ùå Modal achievementsModal n√£o encontrado no DOM');
            }
        }

        function closeAchievementsModal() {
            const modal = document.getElementById('achievementsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ===== FUN√á√ïES DO MODAL DE N√çVEIS =====
        function openLevelsModal() {
            console.log('üìä openLevelsModal chamada');
            const modal = document.getElementById('levelsModal');
            if (modal) {
                console.log('üìã Modal encontrado:', modal);
                modal.style.display = 'flex';
                console.log('‚úÖ Abrindo modal de n√≠veis...');
                loadLevelsData();
            } else {
                console.error('‚ùå Modal levelsModal n√£o encontrado no DOM');
            }
        }

        function closeLevelsModal() {
            const modal = document.getElementById('levelsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadLevelsData() {
            console.log('üìä Carregando dados dos n√≠veis...');
            try {
                const { data: levels, error } = await supabase
                    .from('levels')
                    .select('*')
                    .order('id');

                if (error) throw error;

                console.log('üìä N√≠veis carregados:', levels);
                populateLevelsUI(levels);
            } catch (error) {
                console.error('‚ùå Erro ao carregar n√≠veis:', error);
            }
        }

        function populateLevelsUI(levels) {
            const container = document.getElementById('levelsContainer');
            if (!container) return;

            container.innerHTML = '';

            levels.forEach(level => {
                const levelCard = document.createElement('div');
                levelCard.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 12px;
                    background: linear-gradient(135deg, ${level.color}20 0%, ${level.color}10 100%);
                    transition: all 0.3s ease;
                `;

                // Determinar o texto dos pontos baseado na nova estrutura
                let pointsText;
                if (level.id === 1) {
                    pointsText = 'N√≠vel inicial';
                } else if (level.max_points) {
                    pointsText = `${level.min_points || level.points_required} - ${level.max_points} pontos`;
                } else {
                    pointsText = `${level.min_points || level.points_required}+ pontos`;
                }

                levelCard.innerHTML = `
                    <div style="font-size: 28px; margin-right: 12px;">${level.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 4px;">
                            N√≠vel ${level.id} - ${level.name}
                        </div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 4px;">
                            ${level.benefits}
                        </div>
                        <div style="color: ${level.color}; font-weight: bold; font-size: 13px;">
                            ${pointsText}
                        </div>
                    </div>
                `;

                container.appendChild(levelCard);
            });
        }

        // ===== FUN√á√ïES DO MODAL DE CONQUISTAS EM ANDAMENTO =====
        function openProgressModal() {
            console.log('üéØ openProgressModal chamada');
            const modal = document.getElementById('progressModal');
            if (modal) {
                console.log('üìã Modal encontrado:', modal);
                modal.style.display = 'flex';
                console.log('‚úÖ Abrindo modal de conquistas em andamento...');
                loadProgressData();
            } else {
                console.error('‚ùå Modal progressModal n√£o encontrado no DOM');
            }
        }

        function closeProgressModal() {
            const modal = document.getElementById('progressModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadProgressData() {
            console.log('üéØ Carregando conquistas em andamento...');
            
            const loadingSpinner = document.querySelector('#progressContent .loading-spinner');
            const progressData = document.getElementById('progressData');
            
            if (loadingSpinner) loadingSpinner.style.display = 'block';
            if (progressData) progressData.style.display = 'none';

            try {
                const currentUser = await getCurrentUser();
                if (!currentUser) throw new Error('Usu√°rio n√£o encontrado');

                // Buscar dados de gamifica√ß√£o do usu√°rio
                const { data: gamificationData, error: gamError } = await supabase
                    .rpc('get_user_gamification_data', { p_user_id: currentUser.id });

                if (gamError) throw gamError;

                // Buscar todos os badges dispon√≠veis
                const { data: allBadges, error: badgesError } = await supabase
                    .from('badges')
                    .select('*')
                    .order('rarity', { ascending: false });

                if (badgesError) throw badgesError;

                console.log('üéØ Dados carregados:', { gamificationData, allBadges });
                
                // Calcular progresso dos badges
                const progressBadges = await calculateBadgeProgress(currentUser.id, allBadges, gamificationData.badges || []);
                
                populateProgressUI(progressBadges);
                
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (progressData) progressData.style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar conquistas em andamento:', error);
                if (loadingSpinner) {
                    loadingSpinner.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                        <div style="font-size: 18px; color: #f44336;">Erro ao carregar conquistas</div>
                    `;
                }
            }
        }

        async function calculateBadgeProgress(userId, allBadges, earnedBadges) {
            const earnedBadgeIds = earnedBadges.map(b => b.name);
            const unearned = allBadges.filter(badge => !earnedBadgeIds.includes(badge.name));
            
            const progressBadges = [];
            
            for (const badge of unearned) {
                const progress = await calculateSingleBadgeProgress(userId, badge);
                if (progress.percentage > 0) {
                    progressBadges.push({
                        ...badge,
                        progress: progress.percentage,
                        current: progress.current,
                        required: progress.required,
                        description_progress: progress.description
                    });
                }
            }
            
            // Definir ordem de dificuldade dos tipos de rarity (mais simples primeiro)
            const rarityOrder = {
                'common': 1,      // Mais simples
                'rare': 2,        // Simples
                'epic': 3,        // M√©dio
                'legendary': 4    // Mais dif√≠cil
            };
            
            // Agrupar por rarity
            const grouped = progressBadges.reduce((groups, badge) => {
                const rarity = badge.rarity;
                if (!groups[rarity]) {
                    groups[rarity] = [];
                }
                groups[rarity].push(badge);
                return groups;
            }, {});
            
            // Ordenar dentro de cada grupo (mais pr√≥ximo primeiro) e entre grupos (mais simples primeiro)
            const sortedBadges = [];
            
            // Ordenar grupos por dificuldade (common ‚Üí rare ‚Üí epic ‚Üí legendary)
            const sortedGroupKeys = Object.keys(grouped).sort((a, b) => {
                return (rarityOrder[a] || 999) - (rarityOrder[b] || 999);
            });
            
            // Para cada grupo, ordenar por progresso descendente e adicionar ao resultado
            sortedGroupKeys.forEach(groupKey => {
                const groupBadges = grouped[groupKey].sort((a, b) => b.progress - a.progress);
                sortedBadges.push(...groupBadges);
            });
            
            return sortedBadges.slice(0, 10); // M√°ximo 10 badges
        }

        async function calculateSingleBadgeProgress(userId, badge) {
            try {
                let current = 0;
                let required = badge.condition_value;
                let description = '';

                switch (badge.condition_type) {
                    case 'posts_count':
                        const { count: postsCount } = await supabase
                            .from('posts')
                            .select('*', { count: 'exact', head: true })
                            .eq('user_id', userId);
                        current = postsCount || 0;
                        description = `${current}/${required} posts criados`;
                        break;
                        
                    case 'reactions_given':
                        const { count: reactionsCount } = await supabase
                            .from('reactions')
                            .select('*', { count: 'exact', head: true })
                            .eq('user_id', userId);
                        current = reactionsCount || 0;
                        description = `${current}/${required} rea√ß√µes dadas`;
                        break;
                        
                    case 'comments_written':
                        const { count: commentsCount } = await supabase
                            .from('comments')
                            .select('*', { count: 'exact', head: true })
                            .eq('user_id', userId);
                        current = commentsCount || 0;
                        description = `${current}/${required} coment√°rios escritos`;
                        break;
                        
                    case 'unique_people_highlighted':
                        const { data: uniqueHighlights } = await supabase
                            .from('posts')
                            .select('mentioned_user_id')
                            .eq('user_id', userId)
                            .not('mentioned_user_id', 'is', null);
                        const uniqueCount = new Set(uniqueHighlights?.map(h => h.mentioned_user_id) || []).size;
                        current = uniqueCount;
                        description = `${current}/${required} pessoas diferentes destacadas`;
                        break;
                        
                    default:
                        return { percentage: 0, current: 0, required, description: 'N√£o implementado' };
                }

                const percentage = Math.min(Math.round((current / required) * 100), 100);
                return { percentage, current, required, description };
                
            } catch (error) {
                console.error('Erro ao calcular progresso do badge:', badge.name, error);
                return { percentage: 0, current: 0, required: badge.condition_value, description: 'Erro no c√°lculo' };
            }
        }

        function populateProgressUI(progressBadges) {
            const container = document.getElementById('progressContainer');
            if (!container) return;

            container.innerHTML = '';

            if (progressBadges.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üéâ</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Parab√©ns!</div>
                        <div style="font-size: 14px;">Voc√™ est√° muito pr√≥ximo de conquistar todos os emblemas dispon√≠veis!</div>
                    </div>
                `;
                return;
            }

            progressBadges.forEach(badge => {
                const rarityColors = {
                    'common': '#4CAF50',
                    'rare': '#2196F3', 
                    'epic': '#9C27B0',
                    'legendary': '#FF9800'
                };

                const badgeCard = document.createElement('div');
                badgeCard.style.cssText = `
                    padding: 16px;
                    border: 2px solid ${rarityColors[badge.rarity] || '#e0e0e0'};
                    border-radius: 12px;
                    background: linear-gradient(135deg, ${rarityColors[badge.rarity] || '#f5f5f5'}20 0%, ${rarityColors[badge.rarity] || '#f5f5f5'}10 100%);
                `;

                badgeCard.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <div style="font-size: 28px; margin-right: 12px;">${badge.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 15px; color: #333; margin-bottom: 4px;">
                                ${badge.name}
                            </div>
                            <div style="color: #666; font-size: 13px;">
                                ${badge.description}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: ${rarityColors[badge.rarity] || '#666'}; text-transform: capitalize; font-weight: 500;">
                                ${badge.rarity}
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; color: #666;">
                            <span>${badge.description_progress}</span>
                            <span style="font-weight: bold; color: ${rarityColors[badge.rarity] || '#666'}; font-size: 15px;">${badge.progress}%</span>
                        </div>
                        <div style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                            <div style="background: ${rarityColors[badge.rarity] || '#666'}; height: 100%; border-radius: 10px; width: ${badge.progress}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;

                container.appendChild(badgeCard);
            });
        }

        // Carregar dados de gamifica√ß√£o do usu√°rio
        async function loadUserGamificationData() {
            try {
                console.log('üéÆ Carregando dados de gamifica√ß√£o...');
                
                const loadingDiv = document.getElementById('achievementsLoading');
                const dataDiv = document.getElementById('achievementsData');
                
                // Mostrar loading
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (dataDiv) dataDiv.style.display = 'none';
                
                // Obter usu√°rio atual
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                // Chamar fun√ß√£o do backend para obter dados de gamifica√ß√£o
                const { data, error } = await supabase.rpc('get_user_gamification_data', {
                    p_user_id: user.id
                });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar dados de gamifica√ß√£o:', error);
                    throw error;
                }
                
                console.log('üéØ Dados de gamifica√ß√£o recebidos:', data);
                
                // Esconder loading e mostrar dados
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (dataDiv) dataDiv.style.display = 'block';
                
                // Preencher dados na interface
                populateGamificationUI(data);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar gamifica√ß√£o:', error);
                
                // Mostrar erro
                const loadingDiv = document.getElementById('achievementsLoading');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Erro ao carregar conquistas</div>
                            <div style="font-size: 14px;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // Preencher interface com dados de gamifica√ß√£o
        function populateGamificationUI(data) {
            console.log('üé® Preenchendo interface com dados:', data);
            
            // Atualizar elementos de n√≠vel (usando dados diretos da SQL)
            const userLevel = document.getElementById('userLevel');
            const userLevelName = document.getElementById('userLevelName');
            const userLevelIcon = document.getElementById('userLevelIcon');
            const userPoints = document.getElementById('userPoints');
            const pointsToNext = document.getElementById('pointsToNext');
            const levelProgressBar = document.getElementById('levelProgressBar');
            
            // Usar dados diretamente como v√™m da fun√ß√£o SQL (sem remapeamento)
            console.log('üîç Dados diretos da SQL:', data);
            
            // Atualizar streak display
            const userStreakElement = document.getElementById('userStreakDisplay');
            if (userStreakElement && data.stats && data.stats.streak_days !== undefined) {
                const streakDays = data.stats.streak_days;
                if (streakDays === 1) {
                    userStreakElement.textContent = '1 dia';
                } else {
                    userStreakElement.textContent = streakDays + ' dias';
                }
                console.log(`üî• Streak atualizado na UI: ${streakDays} ${streakDays === 1 ? 'dia' : 'dias'}`);
            }
            
            if (userLevel) userLevel.textContent = `N√≠vel ${data.current_level?.id || 1}`;
            if (userLevelName) userLevelName.textContent = data.current_level?.name || 'Novato';
            if (userLevelIcon) userLevelIcon.textContent = getLevelIcon(data.current_level?.id || 1);
            if (userPoints) userPoints.textContent = `${data.total_points || 0} pontos`;
            
            // Progresso para pr√≥ximo n√≠vel
            if (data.next_level && data.progress !== null) {
                const progressPercentage = data.progress;
                const pointsNeeded = data.next_level.min_points - data.total_points;
                if (pointsToNext) pointsToNext.textContent = `${pointsNeeded} para pr√≥ximo n√≠vel`;
                if (levelProgressBar) levelProgressBar.style.width = `${progressPercentage}%`;
            } else {
                if (pointsToNext) pointsToNext.textContent = 'N√≠vel m√°ximo atingido!';
                if (levelProgressBar) levelProgressBar.style.width = '100%';
            }
            
            // Dados de ranking
            if (data.ranking) {
                const userRanking = document.getElementById('userRanking');
                const totalUsers = document.getElementById('totalUsers');
                
                if (userRanking) userRanking.textContent = `#${data.ranking.position}`;
                if (totalUsers) totalUsers.textContent = data.ranking.total_users;
            }
            
            // Badges
            const badgesContainer = document.getElementById('badgesContainer');
            const noBadges = document.getElementById('noBadges');
            
            if (data.badges && data.badges.length > 0) {
                if (badgesContainer) {
                    badgesContainer.innerHTML = data.badges.map(badge => `
                        <div class="badge-card" style="background: white; border: 2px solid ${getBadgeRarityColor(badge.rarity)}; border-radius: 12px; padding: 15px; text-align: center; transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 32px; margin-bottom: 8px;">${badge.icon}</div>
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${badge.name}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${badge.description}</div>
                            <div style="font-size: 10px; color: ${getBadgeRarityColor(badge.rarity)}; font-weight: bold; text-transform: uppercase;">${badge.rarity}</div>
                            <div style="font-size: 10px; color: #999; margin-top: 4px;">${formatDate(badge.earned_at)}</div>
                        </div>
                    `).join('');
                }
                if (noBadges) noBadges.style.display = 'none';
            } else {
                if (badgesContainer) badgesContainer.innerHTML = '';
                if (noBadges) noBadges.style.display = 'block';
            }
            
            // Atividade recente
            const recentActivity = document.getElementById('recentActivity');
            if (data.recent_activity && data.recent_activity.length > 0) {
                console.log('‚úÖ Renderizando', data.recent_activity.length, 'atividades recentes');
                if (recentActivity) {
                    recentActivity.innerHTML = data.recent_activity.map(activity => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div>
                                <div style="font-weight: 500; color: #333;">${getActionTypeLabel(activity.action_type, activity)}</div>
                                <div style="font-size: 12px; color: #666;">${formatDate(activity.created_at)}</div>
                            </div>
                            <div style="color: #4CAF50; font-weight: bold;">+${activity.points_earned} pts</div>
                        </div>
                    `).join('');
                }
            } else {
                console.log('‚ö†Ô∏è Nenhuma atividade recente encontrada');
                if (recentActivity) {
                    recentActivity.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Nenhuma atividade recente</div>';
                }
            }
        }

        // Fun√ß√£o para obter √≠cone do n√≠vel
        function getLevelIcon(levelId) {
            const icons = {
                1: 'üå±', // Novato - crescimento inicial
                2: 'üîç', // Iniciante - explorando/descobrindo
                3: '‚ö°', // Ativo - energia/atividade
                4: 'ü§ù', // Engajado - conex√£o/engajamento
                5: 'üì¢', // Influente - voz/influ√™ncia
                6: 'üéñÔ∏è', // L√≠der - lideran√ßa/conquista
                7: 'üî¨', // Especialista - expertise/conhecimento
                8: 'üéì', // Mestre - maestria/educa√ß√£o
                9: 'üèÜ', // Lenda - trof√©u/lenda
                10: 'üíé' // Hall da Fama - precioso/raro
            };
            return icons[levelId] || 'üå±';
        }

        // Fun√ß√µes auxiliares
        function getBadgeRarityColor(rarity) {
            const colors = {
                'common': '#4CAF50',
                'rare': '#2196F3', 
                'epic': '#9C27B0',
                'legendary': '#FF9800'
            };
            return colors[rarity] || '#666';
        }

        function getActionTypeLabel(actionType, activity = null) {
            // Caso especial para badges - mostrar raridade em ingl√™s min√∫sculo
            if (actionType === 'badge_earned' && activity && activity.reaction_type) {
                return `Conquista de Emblema (${activity.reaction_type})`;
            }
            
            // Caso especial para streak bonus - mostrar dias do milestone
            if (actionType === 'streak_bonus_retroactive' && activity && activity.reference_type) {
                const match = activity.reference_type.match(/milestone_(\d+)/);
                if (match) {
                    const days = match[1];
                    return `B√¥nus de Streak - ${days} dias`;
                }
                return 'B√¥nus de Streak';
            }
            
            // Caso especial para streak bonus correction - mostrar dias do milestone
            if (actionType === 'streak_bonus_correction' && activity && activity.reference_type) {
                const match = activity.reference_type.match(/milestone_(\d+)/);
                if (match) {
                    const days = match[1];
                    return `Corre√ß√£o de B√¥nus de Streak - ${days} dias`;
                }
                return 'Corre√ß√£o de B√¥nus de Streak';
            }
            
            const labels = {
                // Novos tipos que v√™m da SQL
                'post': 'Post criado',
                'comment': 'Coment√°rio escrito', 
                'reaction': 'Rea√ß√£o dada',
                'feedback_given': 'Feedback dado', // Eu dei feedback
                'feedback_received': 'Feedback recebido', // Eu recebi feedback
                'badge_earned': 'Conquista de Emblema', // Fallback caso n√£o tenha raridade
                'streak_bonus_retroactive': 'B√¥nus de Streak', // Fallback caso n√£o tenha reference_type
                'streak_bonus_correction': 'Corre√ß√£o de B√¥nus de Streak', // Nova corre√ß√£o
                
                // Tipos antigos (manter compatibilidade)
                'post_created': 'Post criado',
                'holofote_given': 'Holofote dado',
                'holofote_received': 'Holofote recebido',
                'comment_given': 'Coment√°rio escrito',
                'comment_received': 'Coment√°rio recebido',
                'reaction_given': 'Rea√ß√£o dada',
                'reaction_received': 'Rea√ß√£o recebida'
            };
            return labels[actionType] || actionType;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadImpactDataInModal() {
            try {
                console.log('üìä Carregando Dashboard de Insights no modal...');
                
                // Aguardar Chart.js carregar se necess√°rio
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 10) {
                    console.log(`üîÑ Aguardando Chart.js carregar... (tentativa ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                // Atualizar Dashboard de Insights no modal
                await updateDashboardInsights();
                
                console.log('‚úÖ Dashboard de Insights carregado no modal');
            } catch (error) {
                console.error('‚ùå Erro ao carregar Dashboard de Insights:', error);
            }
        }

        // Fun√ß√µes do Modal de Feedbacks
        function openFeedbacksModal() {
            const modal = document.getElementById('feedbacksModal');
            if (modal) {
                modal.style.display = 'flex';
                loadFeedbacksInModal();
            }
        }

        function closeFeedbacksModal() {
            const modal = document.getElementById('feedbacksModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadFeedbacksInModal() {
            const feedbacksContainer = document.getElementById('modalFeedbacksContent');
            feedbacksContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>Carregando feedbacks...</p></div>';
            try {
                console.log('üîÑ Carregando feedbacks no modal...');
                
                // Primeiro, vamos tentar buscar feedbacks com diferentes estruturas poss√≠veis
                let feedbacks = [];
                let error = null;
                
                // Tentar primeira estrutura (to_user_id)
                try {
                    const { data: feedbacksData, error: feedbacksError } = await supabase
                        .from('feedbacks')
                        .select(`
                            *,
                            from_user:from_user_id(name, username, avatar_url),
                            post:post_id(content, highlight_type)
                        `)
                        .eq('to_user_id', currentUser.id)
                        .order('created_at', { ascending: false });
                    
                    if (!feedbacksError && feedbacksData) {
                        feedbacks = feedbacksData;
                    } else {
                        throw feedbacksError;
                    }
                } catch (firstError) {
                    console.log('Tentando estrutura alternativa...');
                    
                    // Tentar segunda estrutura (mentioned_user_id)
                    try {
                        const { data: feedbacksData2, error: feedbacksError2 } = await supabase
                            .from('feedbacks')
                            .select(`
                                *,
                                author:author_id(name, username, avatar_url),
                                post:post_id(content, highlight_type)
                            `)
                            .eq('mentioned_user_id', currentUser.id)
                            .order('created_at', { ascending: false });
                        
                        if (!feedbacksError2 && feedbacksData2) {
                            feedbacks = feedbacksData2;
                        } else {
                            throw feedbacksError2;
                        }
                    } catch (secondError) {
                        console.log('Tentando buscar todos os feedbacks...');
                        
                        // Tentar buscar todos e filtrar
                        const { data: allFeedbacks, error: allError } = await supabase
                            .from('feedbacks')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (allError) throw allError;
                        
                        // Filtrar feedbacks relacionados ao usu√°rio atual
                        feedbacks = allFeedbacks.filter(feedback => 
                            feedback.to_user_id === currentUser.id || 
                            feedback.mentioned_user_id === currentUser.id ||
                            feedback.user_id === currentUser.id
                        );
                    }
                }

                const feedbacksContainer = document.getElementById('modalFeedbacksContent');
                
                if (!feedbacks || feedbacks.length === 0) {
                    feedbacksContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>üì≠ Nenhum feedback recebido ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Continue destacando pessoas para receber feedbacks!</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">Debug: Estrutura da tabela pode estar diferente</p>
                        </div>
                    `;
                    return;
                }

                console.log('Feedbacks encontrados:', feedbacks);

                const feedbacksHtml = feedbacks.map(feedback => {
                    // Tentar diferentes campos para o remetente
                    const sender = feedback.from_user || feedback.author || {};
                    const senderName = sender.name || feedback.sender_name || 'Usu√°rio';
                    const senderUsername = sender.username || feedback.sender_username || 'usuario';
                    const senderAvatar = sender.avatar_url || '/default-avatar.png';
                    
                    // Tentar diferentes campos para a mensagem
                    const message = feedback.message || feedback.feedback_text || feedback.content || 'Feedback sem conte√∫do';
                    
                    return `
                        <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #FFB700; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <img src="${senderAvatar}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${senderName}</div>
                                    <div style="font-size: 12px; color: #666;">@${senderUsername}</div>
                                </div>
                                <div style="margin-left: auto; font-size: 11px; color: #999;">
                                    ${formatDateShort(feedback.created_at)}
                                </div>
                            </div>
                            <div style="color: #555; line-height: 1.5; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                "${message}"
                            </div>
                        </div>
                    `;
                }).join('');

                feedbacksContainer.innerHTML = feedbacksHtml;
                console.log('‚úÖ Feedbacks carregados no modal:', feedbacks.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks:', error);
                document.getElementById('modalFeedbacksContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar feedbacks</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                        <p style="font-size: 12px; color: #999;">Verifique a estrutura da tabela feedbacks</p>
                    </div>
                `;
            }
        }

        // Fun√ß√µes do Modal de Posts
        function openPostsModal() {
            console.log('üîç [DEBUG] openPostsModal CHAMADA!');
            
            let modal = document.getElementById('postsModal');
            
            // Se modal n√£o existe, recriar
            if (!modal) {
                console.log('üîß [DEBUG] Modal postsModal n√£o encontrado, recriando...');
                modal = document.createElement('div');
                modal.id = 'postsModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.onclick = () => closeModal();
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>üìù Seus Posts</h2>
                            <button class="close-btn" onclick="closePostsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="modalPostsContent" style="max-height: 400px; overflow-y: auto;">
                                <!-- Posts ser√£o carregados aqui -->
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                console.log('‚úÖ [DEBUG] Modal postsModal recriado');
            }
            
            if (currentUser && currentUser.id) {
                console.log('üîç [DEBUG] Usu√°rio v√°lido encontrado, abrindo modal...');
                modal.style.display = 'flex';
                addModalToStack('postsModal', closePostsModal);
                loadPostsInModal(currentUser.id);
            } else {
                console.error('‚ùå [DEBUG] currentUser n√£o est√° definido ou n√£o tem ID');
            }
        }

        function closePostsModal() {
            const modal = document.getElementById('postsModal');
            if (modal) {
                modal.style.display = 'none';
                removeModalFromStack('postsModal');
            }
        }

        async function getFeedbacksForAuthorPost(post) {
            // Fun√ß√£o removida - agora s√≥ usamos o modal clic√°vel
            return '';
        }

        async function loadPostsInModal(targetUserId = null) {
            const postsContainer = document.getElementById("modalPostsContent");
            postsContainer.innerHTML = 
'<div style="text-align: center; padding: 40px; color: #666;"><p>Carregando posts...</p></div>';
            try {
                const userId = targetUserId || currentUser?.id;
                console.log('üìù Carregando posts no modal para usu√°rio:', userId);
                console.log('üîç targetUserId recebido:', targetUserId);
                console.log('üîç currentUser.id:', currentUser?.id);
                console.log('üîç S√£o diferentes?', targetUserId !== currentUser?.id);
                
                if (!userId) {
                    console.error('‚ùå userId n√£o est√° definido em loadPostsInModal');
                    throw new Error('Usu√°rio n√£o identificado');
                }
                
                // Recarregar posts do usu√°rio especificado
                const { data: userPosts, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar posts do usu√°rio:', error);
                    throw error;
                }
                
                console.log('üìä Posts do usu√°rio encontrados:', userPosts?.length || 0);
                
                const postsContainer = document.getElementById('modalPostsContent');
                
                if (!postsContainer) {
                    console.error('‚ùå Container modalPostsContent n√£o encontrado');
                    throw new Error('Container do modal n√£o encontrado');
                }
                
                if (!userPosts || userPosts.length === 0) {
                    postsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                            <p>üìù Nenhum post criado ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Comece destacando algu√©m especial!</p>
                        </div>
                    `;
                    return;
                }

                // Recarregar rea√ß√µes para os posts do usu√°rio
                const postIds = userPosts.map(p => p.id);
                let allReactions = [];
                
                if (postIds.length > 0) {
                    try {
                        const { data: reactionsData } = await supabase
                            .from('reactions')
                            .select('*')
                            .in('post_id', postIds);
                        allReactions = reactionsData || [];
                    } catch (reactionError) {
                        console.log('Erro ao carregar rea√ß√µes:', reactionError);
                    }
                }

                // OTIMIZA√á√ÉO: Carregar comments e feedbacks em lote
                console.log('üîç Carregando comments e feedbacks em lote...');
                let allComments = [];
                let allFeedbacks = [];
                
                if (postIds.length > 0) {
                    try {
                        const [commentsResult, feedbacksResult] = await Promise.all([
                            supabase.from('comments').select('id, post_id').in('post_id', postIds),
                            supabase.from('feedbacks').select('id, post_id').in('post_id', postIds)
                        ]);
                        
                        allComments = commentsResult.data || [];
                        allFeedbacks = feedbacksResult.data || [];
                        
                        console.log(`‚úÖ Carregados ${allComments.length} comments e ${allFeedbacks.length} feedbacks em lote`);
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar comments/feedbacks em lote:', error);
                    }
                }

                // Buscar dados dos autores dos posts (incluindo avatar)
                const authorIds = [...new Set(userPosts.map(p => p.user_id))];
                let authorsData = [];
                
                if (authorIds.length > 0) {
                    try {
                        const { data: profiles, error } = await supabase
                            .from('profiles')
                            .select('id, name, email, avatar_url')
                            .in('id', authorIds);
                        
                        if (!error && profiles) {
                            authorsData = profiles;
                            console.log('‚úÖ Dados dos autores com avatar carregados:', authorsData);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao buscar dados dos autores:', error);
                    }
                }

                // Usar o mesmo c√≥digo do renderPosts do in√≠cio
                const postsHtml = [];
                for (const post of userPosts) {
                    // Adicionar rea√ß√µes ao post
                    post.reactions = allReactions.filter(r => r.post_id === post.id);
                    
                    // Buscar dados do verdadeiro autor do post
                    const postAuthor = authorsData.find(author => author.id === post.user_id);
                    
                    // Se n√£o encontrou o autor nos dados buscados, usar currentUser como fallback (caso seja o pr√≥prio usu√°rio)
                    if (postAuthor) {
                        post.user_data = {
                            name: postAuthor.name || postAuthor.email?.split('@')[0] || 'Usu√°rio',
                            email: postAuthor.email,
                            avatar_url: postAuthor.avatar_url || '' // Agora tem avatar_url do profiles
                        };
                    } else if (post.user_id === currentUser.id) {
                        post.user_data = {
                            name: currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Usu√°rio',
                            email: currentUser.email,
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        };
                    } else {
                        // Fallback para autor desconhecido
                        post.user_data = {
                            name: 'Usu√°rio',
                            email: '',
                            avatar_url: ''
                        };
                    }
                    
                    const typeEmojis = {
                        'gratidao': 'üôè', 'gratitude': 'üôè',
                        'memoria': 'üí≠', 'memory': 'üí≠',
                        'conquista': 'üèÜ', 'achievement': 'üèÜ',
                        'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                        'apoio': 'ü§ù', 'support': 'ü§ù',
                        'admiracao': 'üåü', 'admiration': 'üåü'
                    };

                    const typeNames = {
                        'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                        'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                        'conquista': 'Conquista', 'achievement': 'Conquista',
                        'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                        'apoio': 'Apoio', 'support': 'Apoio',
                        'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                    };
                    
                    // OTIMIZA√á√ÉO: Usar dados em lote ao inv√©s de consultas individuais
                    const feedbacksCount = allFeedbacks.filter(f => f.post_id === post.id).length;
                    const commentsCount = allComments.filter(c => c.post_id === post.id).length;
                    
                    const feedbacksSection = await getFeedbacksForAuthorPost(post);
                    
                    const postHtml = `
                        <div class="post" style="position: relative;">
                            <button class="share-btn" onclick="sharePost('${post.id}')" style="
                                position: absolute;
                                top: 1rem;
                                right: 1rem;
                                background: rgba(255, 255, 255, 0.9);
                                border: 1px solid #ddd;
                                border-radius: 50%;
                                width: 36px;
                                height: 36px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                font-size: 16px;
                                transition: all 0.2s ease;
                                z-index: 10;
                                backdrop-filter: blur(5px);
                            " onmouseover="this.style.background='rgba(229, 90, 43, 0.1)'; this.style.borderColor='#e55a2b'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.borderColor='#ddd'; this.style.transform='scale(1)';">
                                üîó
                            </button>
                            <div class="post-header">
                                <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                                <div class="post-author">
                                    <div class="post-author-name">
                                    ${post.user_data?.name || 'Usu√°rio'}
                                </div>
                                    <div class="post-author-meta">
                                        <span class="post-author-username">@${post.user_data?.email?.split('@')[0] || 'usuario'}</span>
                                        <span class="post-time-separator">‚Ä¢</span>
                                        <span class="post-time">${formatDateShort(post.created_at)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="post-content">
                                <div class="post-person">
                                Holofotes para: 
                                ${post.mentioned_user_id ? `
                                    ${post.mentioned_user_id === currentUser.id ? 
                                        `<span>${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}</span>` :
                                        `<span onclick="openUserProfileByIdKeepingModals('${post.mentioned_user_id}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            ${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}
                                        </span>`
                                    }
                                ` : `${post.celebrated_person_name || post.person_name}`}
                            </div>
                                ${post.type || post.highlight_type ? `
                                    <div class="post-type">
                                        ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                    </div>
                                ` : ''}
                                ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post" style="height: auto; object-fit: contain;">` : ''}
                                <div class="post-story">${post.content || post.story}</div>
                            </div>
                            
                            <div class="post-reactions">
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                                </button>
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                                </button>
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                                </button>
                            </div>
                            
                            <div class="post-footer">
                                <span class="comments-display" id="comments-${post.id}" ${commentsCount > 0 ? `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"` : `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üí¨ ${commentsCount}
                                </span>
                                <span class="feedback-display" ${feedbacksCount > 0 ? `onclick="openPostFeedbackModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #e55a2b, #ffb700); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: not-allowed; font-size: 14px; font-weight: 600; transition: all 0.2s ease; opacity: 0.6;"`}>
                                    üîÑ ${feedbacksCount}
                                </span>
                            </div>
                            
                            ${feedbacksSection}
                        </div>
                    `;
                    
                    postsHtml.push(postHtml);
                }

                postsContainer.innerHTML = postsHtml.join('');
                console.log('‚úÖ Posts carregados no modal');
                
                // ‚úÖ OTIMIZA√á√ÉO: Coment√°rios j√° foram processados no HTML acima
                // N√£o precisamos fazer consultas individuais adicionais
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar posts:', error);
                document.getElementById('modalPostsContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar posts</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Fun√ß√µes do Modal de Feedbacks de Post Espec√≠fico
        function openPostFeedbackModal(postId, source = 'seus_posts') {
            console.log('üì¨ Abrindo modal de feedbacks para post:', postId, 'origem:', source);
            
            // Definir t√≠tulo baseado na origem
            const modalTitle = 'üì¨ Feedback';
            
            // Criar modal
            const modal = document.createElement('div');
            modal.id = 'postFeedbackModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 50000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 25px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 70vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%); color: white; padding: 20px; margin: -25px -25px 20px -25px; border-radius: 15px 15px 0 0;">
                        <h3 style="margin: 0; color: white; font-size: 18px;">${modalTitle}</h3>
                        <button onclick="closePostFeedbackModal()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: white;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
                    </div>
                    <div id="postFeedbackContent" style="min-height: 100px;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                            <p>Carregando feedbacks...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar feedbacks
            loadPostFeedbacks(postId, source);
            
            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePostFeedbackModal();
                }
            });
        }

        function closePostFeedbackModal() {
            const modal = document.getElementById('postFeedbackModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Fun√ß√£o para enviar feedback (usada no modal Holofotes Recebidos)
        async function sendFeedback(postId) {
            try {
                const textarea = document.getElementById('newFeedbackText');
                const feedbackText = textarea.value.trim();
                
                if (!feedbackText) {
                    alert('Por favor, escreva um feedback antes de enviar.');
                    return;
                }
                
                console.log('üì§ Enviando feedback para post:', postId);
                
                // Salvar feedback no banco
                const feedbackData = {
                    post_id: postId,
                    mentioned_user_id: currentUser.id,
                    feedback_text: feedbackText,
                    created_at: new Date().toISOString()
                };
                
                const { data: savedFeedback, error } = await supabase
                    .from('feedbacks')
                    .insert([feedbackData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao salvar feedback:', error);
                    alert('Erro ao enviar feedback. Tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Feedback salvo no banco');
                
                // Recarregar feedbacks no modal
                loadPostFeedbacks(postId, 'holofotes_recebidos');
                
                // Atualizar contador de feedbacks
                updateFeedbackCounter(postId);
                
                // Atualizar m√©tricas do usu√°rio
                updateSimpleMetrics();
                
                alert('‚úÖ Feedback enviado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar feedback:', error);
                alert('Erro ao enviar feedback. Tente novamente.');
            }
        }

        async function loadPostFeedbacks(postId, source = 'seus_posts') {
            const feedbackContent = document.getElementById('postFeedbackContent');
            feedbackContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div><p>Carregando feedbacks...</p></div>';
            try {
                console.log('üì¨ Carregando feedbacks para post:', postId, 'origem:', source);
                
                // Buscar todos os feedbacks do post (n√£o filtrar por author_id)
                const { data: feedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('*')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                const feedbackContent = document.getElementById('postFeedbackContent');
                
                if (!feedbacks || feedbacks.length === 0) {
                    // Se for modal "Holofotes Recebidos", permitir escrever feedback
                    if (source === 'holofotes_recebidos') {
                        feedbackContent.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                                <p style="font-size: 16px; margin-bottom: 15px;">Seja o primeiro a dar feedback!</p>
                                <div style="margin-top: 20px;">
                                    <textarea id="newFeedbackText" placeholder="Escreva seu feedback aqui..." style="
                                        width: 100%;
                                        min-height: 80px;
                                        padding: 12px;
                                        border: 2px solid #ddd;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        resize: vertical;
                                        margin-bottom: 10px;
                                    "></textarea>
                                    <button onclick="sendFeedback('${postId}')" style="
                                        background: linear-gradient(135deg, #e55a2b, #ffb700);
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 20px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        transition: transform 0.2s ease;
                                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        üì§ Enviar Feedback
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        feedbackContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                                <p style="font-size: 16px; margin-bottom: 5px;">Nenhum feedback recebido</p>
                                <p style="font-size: 14px; color: #999;">Este post ainda n√£o recebeu feedbacks</p>
                            </div>
                        `;
                    }
                    return;
                }

                console.log('üìä Feedbacks encontrados:', feedbacks);
                console.log('üîç Mentioned User IDs dos feedbacks:', feedbacks.map(f => f.mentioned_user_id));

                // Buscar dados dos usu√°rios que deram feedback
                const userIds = [...new Set(feedbacks.map(f => f.mentioned_user_id).filter(Boolean))];
                console.log('üë• User IDs para buscar:', userIds);
                
                let users = [];
                
                if (userIds.length > 0) {
                    // Tentar tabela 'profiles' com colunas corretas
                    try {
                        const { data: profilesData, error: profilesError } = await supabase
                            .from('profiles')
                            .select('id, name, email')
                            .filter('id', 'in', `(${userIds.join(',')})`);
                        
                        if (!profilesError && profilesData) {
                            users = profilesData;
                            console.log('‚úÖ Dados encontrados na tabela profiles:', users);
                        } else {
                            console.log('‚ö†Ô∏è Erro na tabela profiles:', profilesError);
                        }
                    } catch (profileError) {
                        console.log('‚ö†Ô∏è Erro ao acessar tabela profiles:', profileError);
                    }
                }

                console.log('üë• Usu√°rios finais encontrados:', users);

                const feedbacksHtml = feedbacks.map(feedback => {
                    // Encontrar dados do usu√°rio que deu o feedback
                    const user = users.find(u => u.id === feedback.mentioned_user_id);
                    console.log(`üîç Feedback de ${feedback.mentioned_user_id}:`, user);
                    
                    // Se n√£o encontrou o usu√°rio e √© o pr√≥prio currentUser, usar dados dele
                    let userName, userEmail, username;
                    
                    if (user) {
                        userName = user.name || 'Usu√°rio';
                        userEmail = user.email;
                        username = userEmail?.split('@')[0] || 'usuario';
                    } else if (feedback.mentioned_user_id === currentUser.id) {
                        // √â o pr√≥prio usu√°rio logado
                        userName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Voc√™';
                        userEmail = currentUser.email;
                        username = userEmail?.split('@')[0] || 'voce';
                    } else {
                        // Fallback para campos do pr√≥prio feedback
                        userName = feedback.sender_name || feedback.user_name || 'Usu√°rio';
                        userEmail = feedback.sender_email || feedback.user_email;
                        username = userEmail?.split('@')[0] || feedback.sender_username || feedback.username || 'usuario';
                    }
                    
                    const date = feedback.created_at ? formatDateShort(feedback.created_at) : 'recente';
                    const feedbackText = feedback.feedback_text || feedback.message || feedback.content || 'Feedback sem conte√∫do';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 1px solid #ff9800; border-radius: 12px; box-shadow: 0 2px 8px rgba(255,152,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="color: #e65100; font-weight: bold; font-size: 14px;">
                                    üîÑ ${username === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `@${username}` :
                                        `<span onclick="openUserProfileKeepingModals('${username}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${username}
                                        </span>`
                                    }
                                </div>
                                <div style="color: #999; font-size: 12px;">
                                    ${date}
                                </div>
                            </div>
                            <div style="color: #bf360c; line-height: 1.5; font-size: 15px; font-style: italic;">
                                ${feedbackText}
                            </div>
                        </div>
                    `;
                }).join('');

                feedbackContent.innerHTML = feedbacksHtml;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks do post:', error);
                document.getElementById('postFeedbackContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p>Erro ao carregar feedbacks</p>
                        <p style="font-size: 14px; color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadUserData() {
            try {
                console.log('üìä Carregando dados do usu√°rio...');
                console.log('üîç Carregando dados de seguir/seguidores reais do Supabase com timeout...');
                
                // Carregar quem eu sigo
                const followingQuery = supabase
                    .from('follows')
                    .select('following_id')
                    .eq('follower_id', currentUser.id);
                
                // Carregar meus seguidores
                const followersQuery = supabase
                    .from('follows')
                    .select('follower_id')
                    .eq('following_id', currentUser.id);
                
                try {
                    const [followingResult, followersResult] = await Promise.all([
                        withTimeout(followingQuery, 5000),
                        withTimeout(followersQuery, 5000)
                    ]);
                    
                    if (followingResult.error) throw followingResult.error;
                    if (followersResult.error) throw followersResult.error;
                    
                    following = followingResult.data || [];
                    followers = followersResult.data || [];
                    
                    console.log(`‚úÖ Dados reais carregados: ${following.length} seguindo, ${followers.length} seguidores`);
                    
                } catch (queryError) {
                    console.warn('‚ö†Ô∏è Erro nas queries, mantendo arrays vazios:', queryError.message);
                    
                    // Manter arrays vazios em caso de erro
                    following = [];
                    followers = [];
                    
                    console.log('‚úÖ Arrays vazios configurados devido ao erro');
                }
                
                // Atualizar contadores na interface
                updateFollowCounts();
                console.log('‚úÖ Dados do usu√°rio carregados e atualizados');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                
                // Fallback final
                following = [];
                followers = [];
                updateFollowCounts();
                console.log('‚úÖ Fallback aplicado');
            }
        }

        function updateFollowCounts() {
            const followingCountEl = document.getElementById('followingCount');
            const followersCountEl = document.getElementById('followersCount');
            
            if (followingCountEl) followingCountEl.textContent = following.length;
            if (followersCountEl) followersCountEl.textContent = followers.length;
            
            console.log(`üìä Contadores atualizados: ${following.length} seguindo, ${followers.length} seguidores`);
        }

        // Fun√ß√µes de Filtro de Feed
        function setFeedFilter(filter) {
            console.log('üîç Alterando filtro para:', filter);
            window.currentFeedFilter = filter;
            
            // Atualizar apenas o emoji (texto "Feed" fica fixo)
            const emoji = document.getElementById('feedEmoji');
            if (emoji) {
                emoji.textContent = filter === 'following' ? 'üë•' : 'üåç';
            }
            
            // Atualizar op√ß√µes do dropdown (apenas cor de fundo)
            document.querySelectorAll('.filter-option').forEach(option => {
                if (option.dataset.filter === filter) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Fechar dropdown
            const dropdown = document.getElementById('feedFilterDropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            // Salvar prefer√™ncia
            localStorage.setItem('feedFilter', filter);
            
            // Recarregar feed
            loadPosts();
        }

        function getEmptyFeedMessage(filter) {
            switch (filter) {
                case 'following':
                    return `
                        <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                            <div style="font-size: 64px; margin-bottom: 1rem;">üë•</div>
                            <h3 style="color: #333; margin-bottom: 1rem;">Nenhum post de quem voc√™ segue</h3>
                            <p style="margin-bottom: 2rem;">Comece seguindo pessoas para ver os posts delas aqui!</p>
                            <button onclick="showTab('buscar')" style="
                                background: #e55a2b;
                                color: white;
                                border: none;
                                padding: 1rem 2rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 1rem;
                            ">üîç Buscar Pessoas</button>
                        </div>
                    `;
                default: // recommended
                    return `
                        <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                            <div style="font-size: 64px; margin-bottom: 1rem;">üåç</div>
                            <h3 style="color: #333; margin-bottom: 1rem;">Nenhum post ainda</h3>
                            <p>Seja o primeiro a destacar algu√©m!</p>
                        </div>
                    `;
            }
        }

        // ============================================================================
        // SETTINGS FUNCTIONS
        // ============================================================================

        let usernameCheckTimeout = null;
        let currentAvatarFile = null;

        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            
            // Preencher dados atuais
            document.getElementById('settingsFullName').value = currentUser.user_metadata?.full_name || '';
            document.getElementById('settingsUsername').value = currentUser.user_metadata?.username || '';
            document.getElementById('settingsDefaultFeed').value = currentUser.user_metadata?.default_feed || 'recommended';
            
            // Avatar preview
            const avatarUrl = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.user_metadata?.full_name || 'User')}&background=667eea&color=fff&size=200`;
            document.getElementById('settingsAvatarPreview').src = avatarUrl;
            
            modal.style.display = 'flex';
            console.log('‚öôÔ∏è Modal de configura√ß√µes aberto');
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
            currentAvatarFile = null;
            console.log('‚ùå Modal de configura√ß√µes fechado');
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tamanho (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('üö® Imagem muito grande! M√°ximo 5MB.');
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('üö® Apenas imagens s√£o permitidas!');
                return;
            }
            
            currentAvatarFile = file;
            
            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('settingsAvatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            console.log('üì∑ Avatar selecionado:', file.name);
        }

        async function checkUsernameAvailability() {
            const usernameInput = document.getElementById('settingsUsername');
            const statusIcon = document.getElementById('usernameStatus');
            const message = document.getElementById('usernameMessage');
            const username = usernameInput.value.trim();
            
            // Limpar timeout anterior
            if (usernameCheckTimeout) {
                clearTimeout(usernameCheckTimeout);
            }
            
            // Se vazio ou igual ao atual, limpar
            if (!username || username === currentUser.user_metadata?.username) {
                statusIcon.textContent = '';
                message.textContent = '';
                usernameInput.style.borderColor = '#e0e0e0';
                return;
            }
            
            // Validar formato
            if (!/^[a-zA-Z0-9._]+$/.test(username)) {
                statusIcon.textContent = '‚ùå';
                message.textContent = 'Apenas letras, n√∫meros, . e _';
                message.style.color = '#e74c3c';
                usernameInput.style.borderColor = '#e74c3c';
                return;
            }
            
            // Mostrar loading
            statusIcon.textContent = '‚è≥';
            message.textContent = 'Verificando...';
            message.style.color = '#666';
            
            // Verificar disponibilidade com debounce
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabase.rpc('check_username_availability', {
                        p_username: username,
                        p_current_user_id: currentUser.id
                    });
                    
                    if (error) throw error;
                    
                    if (data) {
                        // Dispon√≠vel
                        statusIcon.textContent = '‚úÖ';
                        message.textContent = 'Username dispon√≠vel!';
                        message.style.color = '#27ae60';
                        usernameInput.style.borderColor = '#27ae60';
                    } else {
                        // J√° em uso
                        statusIcon.textContent = '‚ùå';
                        message.textContent = 'Username j√° est√° em uso';
                        message.style.color = '#e74c3c';
                        usernameInput.style.borderColor = '#e74c3c';
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar username:', error);
                    statusIcon.textContent = '‚ö†Ô∏è';
                    message.textContent = 'Erro ao verificar';
                    message.style.color = '#f39c12';
                }
            }, 500);
        }

        async function saveSettings(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveSettingsBtn');
            const originalText = saveBtn.textContent;
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';
                
                const fullName = document.getElementById('settingsFullName').value.trim();
                const username = document.getElementById('settingsUsername').value.trim();
                const defaultFeed = document.getElementById('settingsDefaultFeed').value;
                
                let avatarUrl = currentUser.user_metadata?.avatar_url;
                
                // Upload de avatar se houver
                if (currentAvatarFile) {
                    console.log('üì∑ Fazendo upload do avatar...');
                    
                    const fileExt = currentAvatarFile.name.split('.').pop();
                    const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
                    const filePath = `avatars/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('avatars')
                        .upload(filePath, currentAvatarFile, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('avatars')
                        .getPublicUrl(filePath);
                    
                    avatarUrl = urlData.publicUrl;
                    console.log('‚úÖ Avatar uploaded:', avatarUrl);
                }
                
                // Atualizar perfil
                console.log('üîÑ Atualizando perfil...');
                
                const { data, error } = await supabase.rpc('update_user_profile', {
                    p_user_id: currentUser.id,
                    p_full_name: fullName,
                    p_username: username,
                    p_avatar_url: avatarUrl,
                    p_default_feed: defaultFeed
                });
                
                if (error) throw error;
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao atualizar perfil');
                }
                
                console.log('‚úÖ Perfil atualizado com sucesso!');
                
                // Atualizar currentUser
                currentUser.user_metadata = {
                    ...currentUser.user_metadata,
                    full_name: fullName,
                    username: username,
                    avatar_url: avatarUrl,
                    default_feed: defaultFeed
                };
                
                // Atualizar localStorage do filtro
                localStorage.setItem('feedFilter', defaultFeed);
                window.currentFeedFilter = defaultFeed;
                
                // Atualizar UI
                await loadUserData();
                
                // Fechar modal
                closeSettingsModal();
                
                // Mostrar sucesso
                alert('‚úÖ Configura√ß√µes salvas com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                alert('üö® Erro ao salvar: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // ============================================================================
        // POSTS FUNCTIONS
        // ============================================================================

        async function loadPosts() {
            try {
                console.log('üìù Carregando posts...');
                console.log('üîç [DEBUG] loadPosts chamado de:', new Error().stack);
                
                // Marcar como carregando (SEM renderizar ainda)
                window.isLoadingPosts = true;
                
                console.log('üîç Carregando posts reais do Supabase com timeout...');
                console.log('üîç Filtro atual:', window.currentFeedFilter || 'recommended');
                
                // Usar fun√ß√£o SQL com filtro
                const postsQuery = supabase.rpc('get_feed_posts', {
                    p_user_id: currentUser.id,
                    p_filter_type: window.currentFeedFilter || 'recommended',
                    p_limit: 50,
                    p_offset: 0
                });
                
                const { data, error } = await withTimeout(postsQuery, 5000);
                
                if (error) {
                    console.error('‚ùå Erro ao carregar posts:', error);
                    throw error;
                }
                
                console.log(`‚úÖ ${data?.length || 0} posts reais carregados do banco`);
                posts = data || [];
                
                // Finalizar loading IMEDIATAMENTE ap√≥s carregar posts
                window.isLoadingPosts = false;
                await renderPosts();
                console.log('‚úÖ Posts carregados e renderizados');
                
                // Processar dados de usu√°rios e rea√ß√µes em background (n√£o bloqueia UI)
                setTimeout(async () => {
                    await processPostsUserData();
                    await loadPostsReactions();
                    await loadAllFeedbacksInBatch(); // OTIMIZA√á√ÉO: Carregar feedbacks em lote
                    await loadAllCommentsInBatch(); // OTIMIZA√á√ÉO: Carregar coment√°rios em lote
                    await renderPosts(); // Re-renderizar com dados completos
                    processPostsForUsernames(); // Processar @username nos posts
                    console.log('‚úÖ Posts processados com dados completos');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar posts:', error);
                console.log('‚ö†Ô∏è [DEBUG] Erro (provavelmente timeout), ignorando e deixando loading ativo');
                console.log('‚ö†Ô∏è [DEBUG] Outra chamada de loadPosts deve resolver isso');
                
                // N√ÉO setar isLoadingPosts = false aqui!
                // Deixar o loading spinner ativo at√© uma chamada bem-sucedida
                // Isso evita o "flash" de mensagem "sem posts"
            }
        }

        async function loadPostsReactions() {
            try {
                console.log('üíñ Carregando rea√ß√µes dos posts...');
                
                if (posts.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum post para carregar rea√ß√µes');
                    return;
                }
                
                const postIds = posts.map(p => p.id);
                
                try {
                    console.log('üîç Tentando carregar rea√ß√µes reais do Supabase...');
                    
                    // Promise com timeout de 5 segundos
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout na query de rea√ß√µes')), 5000)
                    );
                    
                    const queryPromise = supabase
                        .from('reactions')
                        .select('*')
                        .in('post_id', postIds);
                    
                    const { data: reactionsData, error } = await Promise.race([queryPromise, timeoutPromise]);
                    
                    if (error) {
                        console.error('‚ùå Erro na query de rea√ß√µes:', error);
                        throw error;
                    }
                    
                    console.log(`‚úÖ ${reactionsData?.length || 0} rea√ß√µes reais carregadas do banco`);
                    
                    // Distribuir rea√ß√µes para os posts correspondentes
                    posts.forEach(post => {
                        post.reactions = reactionsData?.filter(r => r.post_id === post.id) || [];
                    });
                    
                } catch (reactionsError) {
                    console.warn('‚ö†Ô∏è Falha na query de rea√ß√µes, usando rea√ß√µes de exemplo:', reactionsError.message);
                    
                    // Fallback: Rea√ß√µes de exemplo
                    posts.forEach((post, index) => {
                        if (index === 0) {
                            post.reactions = [
                                { id: 'r1', user_id: 'user-3', type: 'touched', created_at: new Date().toISOString() },
                                { id: 'r2', user_id: 'user-4', type: 'grateful', created_at: new Date().toISOString() }
                            ];
                        } else if (index === 1) {
                            post.reactions = [
                                { id: 'r3', user_id: 'user-5', type: 'inspired', created_at: new Date().toISOString() }
                            ];
                        } else {
                            post.reactions = [];
                        }
                    });
                }
                
                console.log('‚úÖ Rea√ß√µes distribu√≠das para os posts');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar rea√ß√µes:', error);
                // Garantir que todos os posts tenham array de rea√ß√µes
                posts.forEach(post => {
                    if (!post.reactions) {
                        post.reactions = [];
                    }
                });
            }
        }

        async function processPostsUserData() {
            console.log('üë• Processando dados de usu√°rios...');
            
            // Coletar todos os user_ids √∫nicos (exceto o usu√°rio atual)
            const uniqueUserIds = [...new Set(
                posts
                    .filter(post => post.user_id !== currentUser.id)
                    .map(post => post.user_id)
            )];
            
            console.log(`üîç Buscando ${uniqueUserIds.length} perfis √∫nicos em lote...`);
            
            // Cache para armazenar dados dos usu√°rios
            const userDataCache = new Map();
            
            // Buscar todos os perfis em uma √∫nica consulta
            if (uniqueUserIds.length > 0) {
                try {
                    const usersQuery = supabase
                        .from('profiles')
                        .select('id, name, email, avatar_url')
                        .in('id', uniqueUserIds);
                    
                    const { data: usersData, error: usersError } = await withTimeout(usersQuery, 5000);
                    
                    if (usersData && !usersError) {
                        // Armazenar no cache
                        usersData.forEach(user => {
                            const realName = user.name || user.email || 'Usu√°rio';
                            const realAvatar = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(realName)}&background=667eea&color=fff`;
                            
                            userDataCache.set(user.id, {
                                name: realName,
                                email: user.email,
                                avatar_url: realAvatar
                            });
                        });
                        
                        console.log(`‚úÖ ${usersData.length} perfis carregados em lote`);
                    } else {
                        console.error('‚ùå Erro ao buscar perfis em lote:', usersError);
                    }
                } catch (error) {
                    console.error('‚ùå Erro cr√≠tico ao buscar perfis:', error);
                }
            }
            
            // Aplicar dados aos posts
            for (let post of posts) {
                try {
                    if (post.user_id === currentUser.id) {
                        // Usu√°rio atual
                        post.user_data = {
                            name: currentUser.user_metadata?.name || currentUser.email || 'Voc√™',
                            email: currentUser.email,
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        };
                    } else {
                        // Outros usu√°rios - usar cache
                        const cachedUserData = userDataCache.get(post.user_id);
                        
                        if (cachedUserData) {
                            post.user_data = cachedUserData;
                        } else {
                            // Fallback se n√£o encontrou no cache
                            console.warn(`‚ö†Ô∏è Usu√°rio ${post.user_id} n√£o encontrado no cache, usando fallback`);
                            
                            const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                            const nameIndex = post.user_id.charCodeAt(0) % names.length;
                            const userName = names[nameIndex];
                            
                            post.user_data = {
                                name: userName,
                                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`
                            };
                        }
                    }
                    
                    // Inicializar array de rea√ß√µes se n√£o existir
                    if (!post.reactions) {
                        post.reactions = [];
                    }
                    
                } catch (userError) {
                    console.warn('‚ö†Ô∏è Erro ao processar usu√°rio do post:', userError);
                    post.user_data = {
                        name: 'Usu√°rio',
                        avatar_url: 'https://ui-avatars.com/api/?name=Usuario&background=ccc&color=333'
                    };
                    post.reactions = [];
                }
            }
            
            console.log('‚úÖ Dados de usu√°rios processados com otimiza√ß√£o em lote');
        }

        // Tooltip functions
        function showTooltip(event) {
            // Remove tooltip existente
            hideTooltip();
            
            // Criar tooltip igual ao Chart.js
            const tooltip = document.createElement('div');
            tooltip.id = 'customTooltip';
            tooltip.innerHTML = 'Tamanho da sua rede:<br>pessoas diferentes que<br>interagiram com voc√™';
            tooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 400;
                z-index: 50000;
                pointer-events: none;
                white-space: normal;
                max-width: 160px;
                text-align: center;
                line-height: 1.3;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            document.body.appendChild(tooltip);
            
            // Posicionar tooltip acima do elemento
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        // Cache global para feedbacks, perfis e coment√°rios
        // (Vari√°veis j√° declaradas no in√≠cio do arquivo)
        
        // Fun√ß√µes de invalida√ß√£o e atualiza√ß√£o em tempo real
        function invalidateFeedbackCache(postId = null) {
            if (postId) {
                feedbacksCache.delete(postId);
                console.log(`üîÑ Cache de feedbacks invalidado para post ${postId}`);
            } else {
                feedbacksCache.clear();
                console.log('üîÑ Cache completo de feedbacks invalidado');
            }
        }
        
        function addFeedbackToCache(postId, feedback) {
            if (!feedbacksCache.has(postId)) {
                feedbacksCache.set(postId, []);
            }
            feedbacksCache.get(postId).push(feedback);
            console.log(`‚úÖ Feedback adicionado ao cache para post ${postId}`);
        }
        
        function invalidateCommentsCache(postId = null) {
            if (postId) {
                commentsCache.delete(postId);
                console.log(`üîÑ Cache de coment√°rios invalidado para post ${postId}`);
            } else {
                commentsCache.clear();
                console.log('üîÑ Cache completo de coment√°rios invalidado');
            }
        }
        
        function getCommentsCountFromCache(postId) {
            const comments = commentsCache.get(postId) || [];
            return comments.length;
        }
        
        async function updateMetricsRealTime() {
            console.log('üìä Atualizando m√©tricas em tempo real...');
            try {
                // Atualizar apenas as m√©tricas sem recarregar tudo
                await updateStats();
                console.log('‚úÖ M√©tricas atualizadas em tempo real');
            } catch (error) {
                console.error('‚ùå Erro ao atualizar m√©tricas:', error);
            }
        }
        
        async function reRenderPostsRealTime() {
            console.log('üé® Re-renderizando posts em tempo real...');
            try {
                // Re-renderizar apenas os posts sem recarregar dados
                await renderPosts();
                console.log('‚úÖ Posts re-renderizados em tempo real');
            } catch (error) {
                console.error('‚ùå Erro ao re-renderizar posts:', error);
            }
        }
        
        // Fun√ß√£o para carregar todos os feedbacks em lote
        async function loadAllFeedbacksInBatch() {
            if (posts.length === 0) return;
            
            const postIds = posts.map(p => p.id);
            console.log('üîç Carregando todos os feedbacks em lote...');
            
            try {
                const { data: allFeedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('post_id, feedback_text, mentioned_user_id, created_at')
                    .in('post_id', postIds)
                    .order('created_at', { ascending: true });
                
                if (!error && allFeedbacks) {
                    // Organizar feedbacks por post_id
                    feedbacksCache.clear();
                    allFeedbacks.forEach(feedback => {
                        if (!feedbacksCache.has(feedback.post_id)) {
                            feedbacksCache.set(feedback.post_id, []);
                        }
                        feedbacksCache.get(feedback.post_id).push(feedback);
                    });
                    
                    console.log(`‚úÖ ${allFeedbacks.length} feedbacks carregados em lote`);
                    
                    // Carregar perfis dos usu√°rios que deram feedback
                    const userIds = [...new Set(allFeedbacks.map(f => f.mentioned_user_id))];
                    if (userIds.length > 0) {
                        await loadProfilesInBatch(userIds);
                    }
                } else {
                    console.error('‚ùå Erro ao carregar feedbacks em lote:', error);
                }
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar feedbacks:', error);
            }
        }
        
        // Fun√ß√£o para carregar todos os coment√°rios em lote
        async function loadAllCommentsInBatch() {
            if (posts.length === 0) return;
            
            const postIds = posts.map(p => p.id);
            console.log('üîç Carregando todos os coment√°rios em lote...');
            
            try {
                const { data: allComments, error } = await supabase
                    .from('comments')
                    .select('post_id, id')
                    .in('post_id', postIds);
                
                if (!error && allComments) {
                    // Organizar coment√°rios por post_id
                    commentsCache.clear();
                    allComments.forEach(comment => {
                        if (!commentsCache.has(comment.post_id)) {
                            commentsCache.set(comment.post_id, []);
                        }
                        commentsCache.get(comment.post_id).push(comment);
                    });
                    
                    // üîß CORRE√á√ÉO: Atualizar comments_count nos posts
                    posts.forEach(post => {
                        const postComments = commentsCache.get(post.id) || [];
                        post.comments_count = postComments.length;
                    });
                    
                    console.log(`‚úÖ ${allComments.length} coment√°rios carregados em lote e contadores atualizados`);
                } else {
                    console.error('‚ùå Erro ao carregar coment√°rios em lote:', error);
                    // Em caso de erro, definir comments_count como 0 para todos os posts
                    posts.forEach(post => {
                        post.comments_count = 0;
                    });
                }
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar coment√°rios:', error);
                // Em caso de erro, definir comments_count como 0 para todos os posts
                posts.forEach(post => {
                    post.comments_count = 0;
                });
            }
        }
        
        // Fun√ß√£o para carregar perfis em lote
        async function loadProfilesInBatch(userIds) {
            console.log(`üîç Carregando ${userIds.length} perfis em lote...`);
            
            try {
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('id, name, email')
                    .in('id', userIds);
                
                if (!error && profiles) {
                    profiles.forEach(profile => {
                        profilesCache.set(profile.id, profile);
                    });
                    
                    console.log(`‚úÖ ${profiles.length} perfis carregados em lote`);
                } else {
                    console.error('‚ùå Erro ao carregar perfis em lote:', error);
                }
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar perfis:', error);
            }
        }

        // Fun√ß√£o getFeedbackButtonForPost - VERS√ÉO OTIMIZADA
        async function getFeedbackButtonForPost(post) {
            try {
                // Usar cache ao inv√©s de consulta individual
                const allFeedbacks = feedbacksCache.get(post.id) || [];
                
                let feedbacksHtml = '';
                let userHasFeedback = false;
                
                // Mostrar todos os feedbacks existentes
                if (allFeedbacks.length > 0) {
                    for (const feedback of allFeedbacks) {
                        // Verificar se este feedback √© do usu√°rio atual
                        if (feedback.mentioned_user_id === currentUser.id) {
                            userHasFeedback = true;
                        }
                        
                        // Usar cache para dados do usu√°rio
                        const feedbackUser = profilesCache.get(feedback.mentioned_user_id);
                        const feedbackUserName = feedbackUser?.name || feedbackUser?.email?.split('@')[0] || 'Usu√°rio';
                        const feedbackUsername = feedbackUser?.email?.split('@')[0] || 'usuario';
                        
                        feedbacksHtml += `
                            <div class="feedback-section" style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 1px solid #ff9800; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div style="color: #e65100; font-weight: bold; font-size: 13px;">
                                        üîÑ Feedback de 
                                        ${feedbackUsername === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                            `<span>@${feedbackUsername}</span>` :
                                            `<span onclick="openUserProfileKeepingModals('${feedbackUsername}')" 
                                                  style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                                  onmouseover="this.style.color='#0056b3'"
                                                  onmouseout="this.style.color='#007bff'">
                                                @${feedbackUsername}
                                            </span>`
                                        }
                                    </div>
                                    <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                        ${feedback.created_at ? formatDateShort(feedback.created_at) : 'recente'}
                                    </div>
                                </div>
                                <div style="color: #bf360c; line-height: 1.4; font-style: italic;">
                                    ${feedback.feedback_text}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Se o usu√°rio atual √© a pessoa mencionada E ainda n√£o deu feedback, retornar bot√£o separadamente
                let feedbackButtonHtml = '';
                if (post.mentioned_user_id === currentUser.id && !userHasFeedback) {
                    feedbackButtonHtml = `
                        <button onclick="openFeedbackModal('${post.id}')" style="
                            background: linear-gradient(135deg, #e55a2b, #ffb700);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üîÑ Dar Feedback
                        </button>
                    `;
                }
                
                return { feedbacksHtml, feedbackButtonHtml };
                
            } catch (error) {
                console.error('‚ùå Erro na fun√ß√£o getFeedbackButtonForPost:', error);
                return { feedbacksHtml: '', feedbackButtonHtml: '' }; // Em caso de erro, n√£o mostrar nada
            }
        }

        async function renderPosts() {
            const container = document.getElementById('postsContainer');
            
            // Se ainda est√° carregando, mostrar loading (n√£o verificar posts.length)
            if (window.isLoadingPosts) {
                container.innerHTML = `
                    <div class="post" style="text-align: center; padding: 2rem;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #e65100; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
                        <p style="color: #666; margin: 0;">Carregando...</p>
                    </div>
                `;
                return;
            }
            
            // Se n√£o h√° posts, mostrar mensagem customizada baseada no filtro
            if (posts.length === 0) {
                container.innerHTML = getEmptyFeedMessage(window.currentFeedFilter || 'recommended');
                return;
            }

            // Processar posts de forma ass√≠ncrona agora
            const postsHtml = [];
            for (const post of posts) {
                const isFollowing = following.some(f => f.following_id === post.user_id);
                
                // Garantir que reactions seja sempre um array
                if (!Array.isArray(post.reactions)) {
                    post.reactions = [];
                }
                
                const userReactions = post.reactions.filter(r => r.user_id === currentUser.id);
                
                const typeEmojis = {
                    'gratidao': 'üôè', 'gratitude': 'üôè',
                    'memoria': 'üí≠', 'memory': 'üí≠',
                    'conquista': 'üèÜ', 'achievement': 'üèÜ',
                    'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                    'apoio': 'ü§ù', 'support': 'ü§ù',
                    'admiracao': 'üåü', 'admiration': 'üåü'
                };

                const typeNames = {
                    'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                    'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                    'conquista': 'Conquista', 'achievement': 'Conquista',
                    'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                    'apoio': 'Apoio', 'support': 'Apoio',
                    'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                };
                
                // Obter feedbacks e bot√£o usando fun√ß√£o
                const feedbackData = await getFeedbackButtonForPost(post);
                const feedbacksSection = feedbackData.feedbacksHtml;
                const feedbackButton = feedbackData.feedbackButtonHtml;
                
                const postHtml = `
                    <div class="post" style="position: relative;">
                        <div class="post-header">
                            <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                            <div class="post-author">
                                <div class="post-author-name">
                                    ${post.user_data?.name || 'Usu√°rio'}
                                </div>
                                <div class="post-author-meta">
                                    ${(post.user_data?.email?.split('@')[0] || 'usuario') === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `<span class="post-author-username">@${post.user_data?.email?.split('@')[0] || 'usuario'}</span>` :
                                        `<span class="post-author-username" onclick="openUserProfileKeepingModals('${post.user_data?.email?.split('@')[0] || 'usuario'}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${post.user_data?.email?.split('@')[0] || 'usuario'}
                                        </span>`
                                    }
                                    <span class="post-time-separator">‚Ä¢</span>
                                    <span class="post-time">${formatDateShort(post.created_at)}</span>
                                </div>
                            </div>
                            <div class="post-share-btn" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 50%; background: rgba(255,255,255,0.9); transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onclick="sharePost('${post.id}')" onmouseover="this.style.background='#e65100'; this.style.color='white'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#666'; this.style.transform='scale(1)';">
                                üîó
                            </div>
                        </div>
                        
                        <div class="post-content">
                            <div class="post-person">
                                Holofotes para: 
                                ${post.mentioned_user_id ? `
                                    ${post.mentioned_user_id === currentUser.id ? 
                                        `<span>${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}</span>` :
                                        `<span onclick="openUserProfileByIdKeepingModals('${post.mentioned_user_id}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            ${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}
                                        </span>`
                                    }
                                ` : `${post.celebrated_person_name || post.person_name}`}
                            </div>
                            ${post.type || post.highlight_type ? `
                                <div class="post-type">
                                    ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                </div>
                            ` : ''}
                            ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post" style="height: auto; object-fit: contain;">` : ''}
                            <div class="post-story">${post.content || post.story}</div>
                        </div>
                        
                        ${feedbacksSection}
                        
                        <div class="post-reactions">
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'touched') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'touched')"`}>
                                ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                            </button>
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'grateful') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'grateful')"`}>
                                üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                            </button>
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'inspired') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'inspired')"`}>
                                ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                            </button>
                        </div>
                        
                        <div class="post-footer">
                            <span class="comments-display" id="comments-${post.id}" style="display: flex; align-items: center; gap: 6px; padding: 12px 18px; background: #f5f5f5; color: #666; border-radius: 25px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onclick="openCommentsModal('${post.id}')" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                üí¨ ${post.comments_count || 0}
                            </span>
                            ${feedbackButton}
                        </div>
                    </div>
                `;
                
                postsHtml.push(postHtml);
            }

            container.innerHTML = postsHtml.join('');
            
            // üöÄ OTIMIZA√á√ÉO: Usar cache ao inv√©s de consultas individuais
            setTimeout(() => {
                updateAllCommentsCountersFromCache();
            }, 100);
        }

        async function toggleFollow(userId) {
            try {
                console.log(`üë• Tentando ${following.some(f => f.following_id === userId) ? 'desseguir' : 'seguir'} usu√°rio:`, userId);
                const isFollowing = following.some(f => f.following_id === userId);
                
                if (isFollowing) {
                    // Unfollow
                    try {
                        const unfollowQuery = supabase
                            .from('follows')
                            .delete()
                            .eq('follower_id', currentUser.id)
                            .eq('following_id', userId);
                        
                        await withTimeout(unfollowQuery, 2000);
                        console.log('‚úÖ Unfollow realizado no banco');
                    } catch (unfollowError) {
                        console.warn('‚ö†Ô∏è Erro ao desseguir no banco, atualizando apenas localmente:', unfollowError.message);
                    }
                    
                    following = following.filter(f => f.following_id !== userId);
                    console.log('‚úÖ Usu√°rio removido da lista local de seguindo');
                } else {
                    // Follow
                    try {
                        const followQuery = supabase
                            .from('follows')
                            .insert({
                                follower_id: currentUser.id,
                                following_id: userId
                            });
                        
                        await withTimeout(followQuery, 2000);
                        console.log('‚úÖ Follow realizado no banco');
                    } catch (followError) {
                        console.warn('‚ö†Ô∏è Erro ao seguir no banco, atualizando apenas localmente:', followError.message);
                    }
                    
                    following.push({ following_id: userId });
                    console.log('‚úÖ Usu√°rio adicionado √† lista local de seguindo');
                    
                    // Tentar criar notifica√ß√£o
                    // üîß NOTIFICA√á√ÉO REMOVIDA: Agora √© criada automaticamente pelo trigger SQL
                    console.log('‚úÖ Notifica√ß√£o de follow ser√° criada automaticamente pelo trigger SQL');
                }
                
                // Sempre atualizar contadores e interface
                updateFollowCounts();
                if (!window.isLoadingPosts) {
                    await renderPosts();
                }
                console.log('‚úÖ Interface atualizada ap√≥s follow/unfollow');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao seguir/desseguir:', error);
                alert('Erro ao seguir/desseguir usu√°rio. Tente novamente.');
            }
        }

        // Fun√ß√£o para atualizar contador de feedbacks de um post espec√≠fico
        async function updateFeedbackCounter(postId) {
            try {
                // Buscar n√∫mero atual de feedbacks
                const { data: feedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('id')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar feedbacks:', error);
                    return;
                }
                
                const feedbackCount = feedbacks ? feedbacks.length : 0;
                console.log(`üìä Atualizando contador de feedbacks do post ${postId}: ${feedbackCount}`);
                
                // Atualizar TODOS os elementos de feedback deste post
                const allFeedbackElements = document.querySelectorAll(`[onclick*="openPostFeedbackModal('${postId}'"]`);
                
                allFeedbackElements.forEach((element, index) => {
                    if (element.innerHTML.includes('üîÑ')) {
                        element.innerHTML = `üîÑ ${feedbackCount}`;
                        
                        // Atualizar estilo baseado no n√∫mero de feedbacks
                        if (feedbackCount > 0) {
                            element.style.background = 'linear-gradient(135deg, #e55a2b, #ffb700)';
                            element.style.color = 'white';
                        } else {
                            element.style.background = '#f5f5f5';
                            element.style.color = '#666';
                        }
                        
                        console.log(`‚úÖ Contador de feedback ${index + 1} atualizado para post ${postId}: ${feedbackCount}`);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar contador de feedbacks:', error);
            }
        }

        // Fun√ß√£o para atualizar contador de coment√°rios de um post espec√≠fico
        async function updateCommentCounter(postId) {
            try {
                // Buscar n√∫mero atual de coment√°rios
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('id')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar coment√°rios:', error);
                    return;
                }
                
                const commentCount = comments ? comments.length : 0;
                console.log(`üìä Atualizando contador de coment√°rios do post ${postId}: ${commentCount}`);
                
                // üîß CORRE√á√ÉO: Atualizar comments_count no array global de posts
                const post = posts.find(p => p.id === postId);
                if (post) {
                    post.comments_count = commentCount;
                    console.log(`‚úÖ comments_count atualizado no post ${postId}: ${commentCount}`);
                }
                
                // Atualizar TODOS os elementos de coment√°rios deste post (em todos os modais)
                const allCommentsElements = document.querySelectorAll(`[id="comments-${postId}"], [id*="comments-${postId}"]`);
                
                allCommentsElements.forEach((element, index) => {
                    element.innerHTML = `üí¨ ${commentCount}`;
                    
                    // Atualizar estilo baseado no n√∫mero de coment√°rios
                    if (commentCount > 0) {
                        element.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
                        element.style.color = 'white';
                    } else {
                        element.style.background = '#f5f5f5';
                        element.style.color = '#666';
                    }
                    
                    console.log(`‚úÖ Contador ${index + 1} atualizado para post ${postId}: ${commentCount}`);
                });
                
                // Tamb√©m atualizar qualquer elemento que contenha o ID do post
                const additionalElements = document.querySelectorAll(`[onclick*="${postId}"][class*="comments"]`);
                additionalElements.forEach((element, index) => {
                    if (element.innerHTML.includes('üí¨')) {
                        element.innerHTML = `üí¨ ${commentCount}`;
                        console.log(`‚úÖ Elemento adicional ${index + 1} atualizado para post ${postId}`);
                    }
                });
                
                // Atualizar t√≠tulo do modal de coment√°rios se estiver aberto
                const commentsModal = document.getElementById('commentsModal');
                if (commentsModal) {
                    const titleElement = commentsModal.querySelector('h3');
                    if (titleElement) {
                        titleElement.textContent = `üí¨ Coment√°rios (${commentCount})`;
                        console.log(`‚úÖ T√≠tulo do modal atualizado: Coment√°rios (${commentCount})`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar contador de coment√°rios:', error);
            }
        }

        // Fun√ß√£o para reagir a posts (usada nos modais)
        async function reactToPost(postId, type) {
            console.log(`üéØ Reagindo ao post ${postId} com ${type} no modal`);
            
            // Chamar a fun√ß√£o original de rea√ß√£o
            await toggleReaction(postId, type);
            
            // Atualizar bot√µes de rea√ß√£o no modal em tempo real
            setTimeout(async () => {
                await updateModalReactions(postId);
            }, 500);
        }
        
        // Fun√ß√£o para atualizar rea√ß√µes no modal em tempo real
        async function updateModalReactions(postId) {
            try {
                console.log(`üîÑ Atualizando rea√ß√µes do post ${postId} no modal`);
                
                // Buscar rea√ß√µes atualizadas do post
                const { data: reactions, error } = await supabase
                    .from('reactions')
                    .select('*')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar rea√ß√µes:', error);
                    return;
                }
                
                // Contar rea√ß√µes por tipo
                const reactionCounts = {
                    touched: reactions?.filter(r => r.type === 'touched').length || 0,
                    grateful: reactions?.filter(r => r.type === 'grateful').length || 0,
                    inspired: reactions?.filter(r => r.type === 'inspired').length || 0
                };
                
                // Verificar se o usu√°rio atual j√° reagiu
                const userReactions = reactions?.filter(r => r.user_id === currentUser.id) || [];
                const userReactionTypes = userReactions.map(r => r.type);
                
                console.log(`üìä Contadores: touched=${reactionCounts.touched}, grateful=${reactionCounts.grateful}, inspired=${reactionCounts.inspired}`);
                console.log(`üë§ Usu√°rio reagiu com: ${userReactionTypes.join(', ')}`);
                
                // Atualizar bot√µes de rea√ß√£o no modal
                const reactionButtons = document.querySelectorAll(`[onclick*="reactToPost('${postId}'"]`);
                
                reactionButtons.forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    let reactionType = '';
                    
                    if (onclick.includes("'touched'")) reactionType = 'touched';
                    else if (onclick.includes("'grateful'")) reactionType = 'grateful';
                    else if (onclick.includes("'inspired'")) reactionType = 'inspired';
                    
                    if (reactionType) {
                        const count = reactionCounts[reactionType];
                        const userReacted = userReactionTypes.includes(reactionType);
                        
                        // Atualizar texto do bot√£o
                        const emoji = { touched: '‚ù§Ô∏è', grateful: 'üôè', inspired: '‚ú®' }[reactionType];
                        button.innerHTML = `${emoji} ${count}`;
                        
                        // Atualizar estilo baseado se o usu√°rio reagiu
                        if (userReacted) {
                            // Usu√°rio j√° reagiu - usar gradiente dourado/roxo
                            button.style.background = 'linear-gradient(135deg, #FFB700, #9C27B0)';
                            button.style.color = 'white';
                            button.style.border = 'none';
                            
                            // Remover eventos de hover para manter o estilo
                            button.onmouseover = null;
                            button.onmouseout = null;
                        } else {
                            // Usu√°rio n√£o reagiu - usar estilo padr√£o com hover
                            button.style.background = '#f5f5f5';
                            button.style.color = '#666';
                            button.style.border = 'none';
                            
                            // Adicionar eventos de hover apenas quando n√£o reagiu
                            if (reactionType === 'touched') {
                                button.onmouseover = () => {
                                    button.style.background = '#e74c3c';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            } else if (reactionType === 'grateful') {
                                button.onmouseover = () => {
                                    button.style.background = '#f39c12';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            } else if (reactionType === 'inspired') {
                                button.onmouseover = () => {
                                    button.style.background = '#9b59b6';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            }
                        }
                        
                        console.log(`‚úÖ Bot√£o ${reactionType} atualizado: ${count} (usu√°rio reagiu: ${userReacted})`);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar rea√ß√µes do modal:', error);
            }
        }

        // ===== FUN√á√ÉO DE RETRY COM BACKOFF EXPONENCIAL =====
        async function retryWithBackoff(operation, maxRetries = 3, baseDelay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await operation();
                } catch (error) {
                    console.log(`üîÑ Tentativa ${attempt}/${maxRetries} falhou:`, error.message);
                    
                    // Se √© o √∫ltimo retry, relan√ßar o erro
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Verificar se √© erro de rede que vale a pena tentar novamente
                    const isNetworkError = 
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('ERR_NETWORK_CHANGED') ||
                        error.message.includes('ERR_INTERNET_DISCONNECTED') ||
                        error.message.includes('ERR_CONNECTION_REFUSED') ||
                        error.code === 'NETWORK_ERROR';
                    
                    if (!isNetworkError) {
                        throw error; // N√£o tentar novamente para outros tipos de erro
                    }
                    
                    // Delay com backoff exponencial
                    const delay = baseDelay * Math.pow(2, attempt - 1);
                    console.log(`‚è≥ Aguardando ${delay}ms antes da pr√≥xima tentativa...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function toggleReaction(postId, type) {
            try {
                console.log(`üíñ Tentando ${type} no post:`, postId);
                
                // Buscar post diretamente do banco se n√£o estiver no array global
                let post = posts.find(p => p.id === postId);
                
                if (!post) {
                    console.log('üîç Post n√£o encontrado no array local, buscando no banco...');
                    
                    try {
                        const { data: postData, error: postError } = await supabase
                            .from('posts')
                            .select('*')
                            .eq('id', postId)
                            .single();
                        
                        if (postError || !postData) {
                            console.error('‚ùå Post n√£o encontrado no banco:', postError);
                            return;
                        }
                        
                        post = postData;
                    } catch (fetchError) {
                        console.error('‚ùå Erro ao buscar post:', fetchError);
                        return;
                    }
                }
                
                // Verificar se o usu√°rio est√° tentando reagir ao pr√≥prio post
                if (post.user_id === currentUser.id) {
                    return; // Silenciosamente n√£o fazer nada
                }
                
                // Garantir que reactions seja sempre um array
                if (!Array.isArray(post.reactions)) {
                    post.reactions = [];
                }
                
                const existingReaction = post.reactions.find(r => r.user_id === currentUser.id && r.type === type);
                
                if (existingReaction) {
                    // ===== REMOVER REA√á√ÉO COM RETRY =====
                    try {
                        // S√≥ tentar deletar do banco se n√£o for ID local
                        if (!existingReaction.id.toString().startsWith('local-')) {
                            await retryWithBackoff(async () => {
                                const { error: deleteError } = await supabase
                                    .from('reactions')
                                    .delete()
                                    .eq('id', existingReaction.id);
                                
                                if (deleteError) {
                                    // Ignorar erro 404 (rea√ß√£o j√° n√£o existe)
                                    if (deleteError.code === 'PGRST116' || deleteError.message.includes('404')) {
                                        console.log('‚úÖ Rea√ß√£o j√° n√£o existia no banco');
                                        return;
                                    }
                                    throw deleteError;
                                }
                                
                                console.log('‚úÖ Rea√ß√£o removida do banco');
                            });
                        } else {
                            console.log('‚úÖ Rea√ß√£o local removida (n√£o estava no banco)');
                        }
                        
                        // Remover localmente
                        post.reactions = post.reactions.filter(r => r.id !== existingReaction.id);
                        console.log('‚úÖ Rea√ß√£o removida localmente');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao remover rea√ß√£o do banco, removendo apenas localmente:', error.message);
                        
                        // Mesmo com erro, remover localmente
                        post.reactions = post.reactions.filter(r => r.id !== existingReaction.id);
                        
                        // Mostrar feedback espec√≠fico para erro de rede
                        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_NETWORK')) {
                            showToast('Rea√ß√£o removida localmente. Verifique sua conex√£o.');
                        }
                    }
                } else {
                    // ===== ADICIONAR REA√á√ÉO COM RETRY =====
                    let newReaction = null;
                    
                    try {
                        await retryWithBackoff(async () => {
                            const { data, error } = await supabase
                                .from('reactions')
                                .insert({
                                    post_id: postId,
                                    user_id: currentUser.id,
                                    type: type
                                })
                                .select()
                                .single();
                            
                            if (error) throw error;
                            
                            newReaction = data;
                            console.log('‚úÖ Rea√ß√£o adicionada no banco');
                        });
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao adicionar rea√ß√£o no banco ap√≥s tentativas, adicionando apenas localmente:', error.message);
                        
                        // Fallback: criar rea√ß√£o local
                        newReaction = {
                            id: `local-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            post_id: postId,
                            user_id: currentUser.id,
                            type: type,
                            created_at: new Date().toISOString()
                        };
                        
                        // Mostrar feedback espec√≠fico para erro de rede
                        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_NETWORK')) {
                            showToast('Rea√ß√£o adicionada localmente. Verifique sua conex√£o.');
                        }
                    }
                    
                    if (newReaction) {
                        post.reactions.push(newReaction);
                        console.log('‚úÖ Rea√ß√£o adicionada localmente');
                        
                        // Notifica√ß√£o ser√° criada pelo trigger SQL quando a conex√£o for restaurada
                        if (post.user_id !== currentUser.id) {
                            console.log('‚úÖ Notifica√ß√£o de rea√ß√£o ser√° criada automaticamente pelo trigger SQL');
                        }
                    }
                }
                
                // ===== ATUALIZAR INTERFACE =====
                try {
                    await updateMetricsRealTime();
                    await reRenderPostsRealTime();
                    console.log('‚úÖ Interface atualizada em tempo real ap√≥s rea√ß√£o');
                } catch (renderError) {
                    console.error('‚ùå Erro ao atualizar interface em tempo real:', renderError);
                }
                
                try {
                    updateStats();
                    console.log('‚úÖ Estat√≠sticas atualizadas');
                    
                    // Tentar atualizar notifica√ß√µes (com retry menor)
                    try {
                        await retryWithBackoff(async () => {
                            await loadNotifications();
                        }, 2, 500); // Menos tentativas para notifica√ß√µes
                        console.log('‚úÖ Notifica√ß√µes atualizadas ap√≥s rea√ß√£o');
                    } catch (notifError) {
                        console.warn('‚ö†Ô∏è Erro ao atualizar notifica√ß√µes:', notifError.message);
                    }
                    
                    // Atualizar m√©tricas do perfil em tempo real
                    if (typeof updateSimpleMetrics === 'function') {
                        setTimeout(() => {
                            updateSimpleMetrics();
                            console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s rea√ß√£o');
                        }, 500);
                    }
                } catch (statsError) {
                    console.error('‚ùå Erro ao atualizar estat√≠sticas:', statsError);
                }
                
                console.log('‚úÖ Interface atualizada ap√≥s rea√ß√£o');
                
                // üî• VERIFICAR STREAK EM TEMPO REAL AP√ìS REA√á√ÉO
                await checkStreakAfterActivity('reaction_added');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao reagir:', error);
                console.error('‚ùå Stack trace:', error.stack);
                showToast('Erro ao processar rea√ß√£o. Verifique sua conex√£o.');
            }
        }

        function openFeedbackModal(postId) {
            console.log('üí¨ Abrindo modal de feedback para post:', postId);
            
            // Verificar se j√° existe modal de feedback e fechar apenas ele
            const existingFeedbackModal = document.getElementById('feedbackModal');
            if (existingFeedbackModal) {
                console.log('‚ö†Ô∏è Modal de feedback j√° existe, fechando antes de abrir novo');
                existingFeedbackModal.remove();
            }
            
            // Encontrar o post
            const post = posts.find(p => p.id === postId);
            if (!post) {
                console.error('‚ùå Post n√£o encontrado:', postId);
                alert('Erro: Post n√£o encontrado.');
                return;
            }
            
            // Buscar dados da pessoa mencionada
            let mentionedPersonName = 'Usu√°rio';
            let mentionedPersonUsername = 'usuario';
            
            // Se temos mentioned_user_id, buscar dados reais do usu√°rio
            if (post.mentioned_user_id) {
                try {
                    // Buscar na lista de usu√°rios carregados
                    const mentionedUser = mentionUsers.find(u => u.id === post.mentioned_user_id);
                    if (mentionedUser) {
                        mentionedPersonName = mentionedUser.name;
                        mentionedPersonUsername = mentionedUser.username;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar dados da pessoa mencionada:', error);
                }
            }
            
            // Se n√£o encontrou pelos dados reais, usar os campos do post (removendo @ se existir)
            if (mentionedPersonName === 'Usu√°rio') {
                const personName = post.celebrated_person_name || post.person_name || '';
                if (personName.startsWith('@')) {
                    mentionedPersonUsername = personName.substring(1);
                    mentionedPersonName = personName.substring(1); // Usar username como nome se n√£o tiver nome real
                } else {
                    mentionedPersonName = personName;
                    mentionedPersonUsername = personName.toLowerCase().replace(/\s+/g, '');
                }
            }
            
            // Criar modal de feedback
            const modal = document.createElement('div');
            modal.id = 'feedbackModal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="feedback-modal">
                    <div class="feedback-modal-header">
                        <h3>üîÑ Feedback</h3>
                        <button class="close-btn" onclick="closeFeedbackModal()">√ó</button>
                    </div>
                    <div class="feedback-modal-body">
                        <p><strong>Post sobre:</strong> ${mentionedPersonName} (@${mentionedPersonUsername})</p>
                        <p><strong>Autor:</strong> ${post.user_data?.name || 'Usu√°rio'} (@${post.user_data?.email?.split('@')[0] || 'usuario'})</p>
                        <div class="form-group">
                            <label class="form-label">Seu feedback:</label>
                            <textarea id="feedbackText" class="form-input" rows="4" 
                                placeholder="Compartilhe como voc√™ se sentiu ao ser destacado..."></textarea>
                        </div>
                    </div>
                    <div class="feedback-modal-footer">
                        <button class="btn-primary" onclick="submitFeedback('${postId}')">Enviar Feedback</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fechar modal clicando fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeFeedbackModal();
                }
            });
            
            // Focar no textarea
            setTimeout(() => {
                document.getElementById('feedbackText').focus();
            }, 100);
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitFeedback(postId) {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            
            if (!feedbackText) {
                alert('Por favor, escreva seu feedback.');
                return;
            }
            
            try {
                console.log('üí¨ Enviando feedback para post:', postId);
                
                const post = posts.find(p => p.id === postId);
                if (!post) {
                    throw new Error('Post n√£o encontrado');
                }
                
                // Tentar salvar no banco
                try {
                    const { data, error } = await supabase
                        .from('feedbacks')
                        .insert({
                            post_id: postId,
                            author_id: post.user_id,
                            mentioned_user_id: currentUser.id,
                            feedback_text: feedbackText
                        });
                    
                    if (error) throw error;
                    console.log('‚úÖ Feedback salvo no banco');
                    
                    // üöÄ CACHE INTELIGENTE: Adicionar feedback ao cache local
                    const newFeedback = {
                        post_id: postId,
                        feedback_text: feedbackText,
                        mentioned_user_id: currentUser.id,
                        created_at: new Date().toISOString()
                    };
                    addFeedbackToCache(postId, newFeedback);
                    
                    // üöÄ TEMPO REAL: Atualizar m√©tricas e interface imediatamente
                    setTimeout(async () => {
                        await updateMetricsRealTime();
                        await reRenderPostsRealTime();
                        console.log('‚úÖ Interface atualizada em tempo real ap√≥s feedback');
                    }, 100);
                    
                } catch (dbError) {
                    console.warn('‚ö†Ô∏è Erro ao salvar feedback no banco:', dbError.message);
                    // Continuar mesmo com erro no banco
                }
                
                // Marcar como feedback dado localmente
                post.feedback_given = true;
                
                // üîß NOTIFICA√á√ÉO REMOVIDA: Agora √© criada automaticamente pelo trigger SQL
                console.log('‚úÖ Notifica√ß√£o de feedback ser√° criada automaticamente pelo trigger SQL');
                
                // üîî CORRE√á√ÉO: Atualizar notifica√ß√µes de badges em tempo real
                try {
                    await loadNotifications();
                    console.log('‚úÖ Notifica√ß√µes atualizadas ap√≥s feedback');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar notifica√ß√µes:', error);
                }
                
                // Fechar modal (interface j√° foi atualizada em tempo real)
                closeFeedbackModal();
                
                alert('Feedback enviado com sucesso! O autor do post foi notificado.');
                console.log('‚úÖ Feedback enviado com sucesso');
                
                // üî• VERIFICAR STREAK EM TEMPO REAL AP√ìS FEEDBACK
                await checkStreakAfterActivity('feedback_given');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar feedback:', error);
                alert('Erro ao enviar feedback. Tente novamente.');
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('A imagem deve ter no m√°ximo 5MB.');
                return;
            }
            
            selectedPhotoFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            console.log('üì∑ Foto selecionada:', file.name, file.size, 'bytes');
        }

        function removePhoto() {
            selectedPhotoFile = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoUpload').value = '';
        }

        async function uploadPhoto(file) {
            try {
                console.log('üì∏ Iniciando upload da foto:', file.name);
                
                // Gerar nome √∫nico para o arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
                console.log('üìù Nome do arquivo:', fileName);
                
                // Fazer upload do arquivo diretamente
                const { data, error } = await supabase.storage
                    .from('photos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('‚ùå Erro no upload:', error);
                    // Se o bucket n√£o existir, tentar criar ou usar alternativa
                    if (error.message.includes('Bucket not found')) {
                        console.log('üîß Tentando criar bucket photos...');
                        try {
                            await supabase.storage.createBucket('photos', { public: true });
                            console.log('‚úÖ Bucket photos criado');
                            
                            // Tentar upload novamente
                            const { data: retryData, error: retryError } = await supabase.storage
                                .from('photos')
                                .upload(fileName, file, {
                                    cacheControl: '3600',
                                    upsert: false
                                });
                            
                            if (retryError) throw retryError;
                            console.log('‚úÖ Upload realizado ap√≥s criar bucket:', retryData.path);
                        } catch (createError) {
                            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel criar bucket, usando URL local');
                            // Retornar URL local como fallback
                            return URL.createObjectURL(file);
                        }
                    } else {
                        throw error;
                    }
                }
                
                console.log('‚úÖ Upload realizado com sucesso:', data?.path || fileName);
                
                // Obter URL p√∫blica
                const { data: urlData } = supabase.storage
                    .from('photos')
                    .getPublicUrl(fileName);
                
                const publicUrl = urlData.publicUrl;
                console.log('‚úÖ URL p√∫blica gerada:', publicUrl);
                
                return publicUrl;
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico no upload:', error);
                console.log('üîß Usando URL local como fallback');
                // Retornar URL local como √∫ltimo recurso
                return URL.createObjectURL(file);
            }
        }

        async function findMentionedUserId(personName) {
            try {
                console.log('üîç Buscando ID do usu√°rio mencionado:', personName);
                
                // Extrair username se for uma men√ß√£o (@username)
                let searchTerm = personName;
                if (personName.startsWith('@')) {
                    searchTerm = personName.substring(1); // Remove @
                }
                
                // BUSCAR POR USERNAME PRIMEIRO (mais preciso)
                try {
                    const { data: usernameData, error: usernameError } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('username', searchTerm)
                        .limit(1);
                    
                    if (usernameData && usernameData.length > 0 && !usernameError) {
                        console.log('‚úÖ Usu√°rio encontrado por username:', searchTerm, 'ID:', usernameData[0].id);
                        return usernameData[0].id;
                    }
                } catch (usernameSearchError) {
                    console.log('‚ö†Ô∏è Busca por username falhou');
                }
                
                // FALLBACK: BUSCAR POR NOME
                try {
                    const { data: nameData, error: nameError } = await supabase
                        .from('profiles')
                        .select('id')
                        .ilike('name', `%${searchTerm}%`)
                        .limit(1);
                    
                    if (nameData && nameData.length > 0 && !nameError) {
                        console.log('‚úÖ Usu√°rio encontrado por nome:', searchTerm, 'ID:', nameData[0].id);
                        return nameData[0].id;
                    }
                } catch (nameSearchError) {
                    console.log('‚ö†Ô∏è Busca por nome falhou');
                }
                
                // FALLBACK: Tentar apenas gmail.com (mais comum)
                try {
                    const email = `${searchTerm}@gmail.com`;
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('email', email)
                        .limit(1);
                    
                    if (data && data.length > 0 && !error) {
                        console.log('‚úÖ Usu√°rio encontrado por email:', email, 'ID:', data[0].id);
                        return data[0].id;
                    }
                } catch (emailSearchError) {
                    // Silenciar erro de busca por email
                    console.log('‚ö†Ô∏è Busca por email falhou silenciosamente');
                }
                
                console.log('‚ö†Ô∏è Usu√°rio n√£o encontrado:', personName);
                return null;
                
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao buscar ID do usu√°rio (silenciado):', error.message);
                return null;
            }
        }

        async function createPost() {
            const personNameInput = document.getElementById('personName');
            const personName = personNameInput.value.trim();
            const storyText = document.getElementById('storyText').value.trim();
            
            if (!personName || !storyText) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Validar men√ß√£o se presente
            if (personName.includes('@')) {
                if (personNameInput.dataset.mentionLocked !== 'true') {
                    alert('Por favor, selecione uma men√ß√£o v√°lida da lista de sugest√µes.');
                    return;
                }
                
                // Verificar se a men√ß√£o ainda √© v√°lida no banco de dados
                const mentionUsername = personNameInput.dataset.validMention;
                const mentionId = personNameInput.dataset.validMentionId;
                
                if (mentionUsername && mentionId) {
                    try {
                        const { data: user, error } = await supabase
                            .from('profiles')
                            .select('id, username')
                            .eq('id', mentionId)
                            .single();
                        
                        if (error || !user) {
                            alert('A pessoa mencionada n√£o foi encontrada no sistema. Por favor, selecione uma men√ß√£o v√°lida.');
                            return;
                        }
                        
                        // Verificar se o username ainda √© o mesmo
                        const currentUsername = user.username || (user.email ? user.email.split('@')[0] : '');
                        if (currentUsername !== mentionUsername) {
                            alert('Os dados da pessoa mencionada foram alterados. Por favor, selecione a men√ß√£o novamente.');
                            // Desbloquear campo para nova sele√ß√£o
                            personNameInput.dataset.mentionLocked = 'false';
                            delete personNameInput.dataset.validMention;
                            delete personNameInput.dataset.validMentionId;
                            delete personNameInput.dataset.validMentionName;
                            return;
                        }
                        
                        console.log('‚úÖ Men√ß√£o validada no banco de dados');
                    } catch (error) {
                        console.error('‚ùå Erro ao validar men√ß√£o:', error);
                        alert('Erro ao validar a men√ß√£o. Por favor, tente novamente.');
                        return;
                    }
                } else {
                    alert('Dados da men√ß√£o inv√°lidos. Por favor, selecione uma men√ß√£o v√°lida.');
                    return;
                }
            }

            if (!selectedHighlightType) {
                alert('Por favor, selecione um tipo de destaque.');
                return;
            }

            // Map Portuguese types to English for database constraint
            const typeMapping = {
                'gratidao': 'gratitude',
                'memoria': 'memory',
                'conquista': 'achievement',
                'inspiracao': 'inspiration',
                'apoio': 'support',
                'admiracao': 'admiration'
            };
            
            const mappedType = typeMapping[selectedHighlightType] || selectedHighlightType;
            
            const createBtn = document.getElementById('createPostBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Criando...';
            
            try {
                let photoUrl = null;
                
                // Upload photo if selected
                if (selectedPhotoFile) {
                    try {
                        console.log('üì∏ Tentando upload da foto...');
                        createBtn.textContent = 'Fazendo upload da foto...';
                        photoUrl = await uploadPhoto(selectedPhotoFile);
                        console.log('‚úÖ Upload da foto conclu√≠do:', photoUrl);
                    } catch (uploadError) {
                        console.error('‚ùå Erro no upload da foto:', uploadError);
                        
                        // Perguntar ao usu√°rio se quer continuar sem foto
                        const continueWithoutPhoto = confirm(
                            `Erro ao fazer upload da foto: ${uploadError.message}\n\n` +
                            'Deseja continuar criando o post sem a foto?'
                        );
                        
                        if (!continueWithoutPhoto) {
                            createBtn.disabled = false;
                            createBtn.innerHTML = '<img src="./holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa';
                            return;
                        }
                        
                        console.log('‚ö†Ô∏è Continuando sem foto por escolha do usu√°rio');
                        photoUrl = null;
                    }
                }
                
                // Create post
                createBtn.textContent = 'Criando post...';
                console.log('üìù Criando post no banco de dados...');
                
                // Buscar ID do usu√°rio mencionado
                let mentionedUserId = null;
                try {
                    mentionedUserId = await findMentionedUserId(personName);
                    console.log('üîç ID do usu√°rio mencionado:', mentionedUserId);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar ID do usu√°rio mencionado:', error);
                }
                
                try {
                    const { data, error } = await supabase
                        .from('posts')
                        .insert({
                            user_id: currentUser.id,
                            celebrated_person_name: personName,
                            content: storyText,
                            photo_url: photoUrl,
                            type: mappedType,
                            mentioned_user_id: mentionedUserId
                        })
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('‚ùå Erro ao criar post no banco:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Post criado no banco com sucesso');
                    
                    // Add user data and reactions array to the new post
                    data.user_data = {
                        name: currentUser.user_metadata?.name || currentUser.email || 'Usu√°rio',
                        email: currentUser.email,
                        avatar_url: currentUser.user_metadata?.avatar_url || ''
                    };
                    data.reactions = [];
                    
                    // Add to posts array at the beginning
                    posts.unshift(data);
                    console.log('‚úÖ Post adicionado √† lista local');
                    
                } catch (postError) {
                    console.error('‚ùå Erro ao criar post:', postError);
                    
                    // Fallback: criar post apenas localmente
                    console.warn('‚ö†Ô∏è Criando post apenas localmente como fallback');
                    const localPost = {
                        id: `local-${Date.now()}`,
                        user_id: currentUser.id,
                        celebrated_person_name: personName,
                        content: storyText,
                        photo_url: photoUrl,
                        type: mappedType,
                        created_at: new Date().toISOString(),
                        user_data: {
                            name: currentUser.user_metadata?.name || currentUser.email || 'Usu√°rio',
                            email: currentUser.email,
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        },
                        reactions: []
                    };
                    
                    posts.unshift(localPost);
                    console.log('‚úÖ Post local criado como fallback');
                    
                    alert('Post criado localmente. Pode haver problemas de sincroniza√ß√£o com o servidor.');
                }
                
                // Clear form
                const personNameInput = document.getElementById('personName');
                personNameInput.value = '';
                // Clear mention data
                personNameInput.dataset.mentionLocked = 'false';
                delete personNameInput.dataset.validMention;
                delete personNameInput.dataset.validMentionId;
                delete personNameInput.dataset.validMentionName;
                
                document.getElementById('storyText').value = '';
                removePhoto();
                
                // Clear highlight type selection
                document.querySelectorAll('.highlight-type').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedHighlightType = null;
                
                // Switch to home tab and re-render
                switchTab('inicio');
                await renderPosts(); // CORRIGIDO: Renderizar posts imediatamente
                updateStats();
                
                // üîî CORRE√á√ÉO: Atualizar notifica√ß√µes de badges em tempo real
                try {
                    await loadNotifications();
                    console.log('‚úÖ Notifica√ß√µes atualizadas ap√≥s criar post');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar notifica√ß√µes:', error);
                }
                
                // Atualizar m√©tricas do perfil em tempo real
                if (typeof updateSimpleMetrics === 'function') {
                    setTimeout(() => {
                        updateSimpleMetrics();
                        
                        
                        console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s cria√ß√£o de post');
                    }, 500);
                }
                
                trackEvent('post_created', { 
                    person_name: personName, 
                    has_photo: !!photoUrl,
                    story_length: storyText.length,
                    highlight_type: selectedHighlightType
                });
                
                alert('‚ú® Post criado com sucesso!');
                
                // üî• VERIFICAR STREAK EM TEMPO REAL AP√ìS CRIAR POST
                await checkStreakAfterActivity('post_created');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar post:', error);
                alert('Erro ao criar post: ' + error.message);
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<img src="./holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa';
            }
        }

        async function createNotification(userId, type, message) {
            try {
                console.log('üîî Criando notifica√ß√£o:', { userId, type, message });
                
                const insertQuery = supabase
                    .from('notifications')
                    .insert({
                        user_id: userId,
                        type: type,
                        message: message,
                        from_user_id: currentUser.id
                    });
                
                await withTimeout(insertQuery, 2000);
                console.log('‚úÖ Notifica√ß√£o criada no banco');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar notifica√ß√£o:', error);
            }
        }

        async function loadNotifications() {
            try {
                console.log('üîî Carregando notifica√ß√µes...');
                console.log('üîç Carregando notifica√ß√µes reais do Supabase com timeout...');
                
                const notificationsQuery = supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                const { data, error } = await withTimeout(notificationsQuery, 5000);
                
                if (error) {
                    console.error('‚ùå Erro ao carregar notifica√ß√µes:', error);
                    throw error;
                }
                
                console.log(`‚úÖ ${data?.length || 0} notifica√ß√µes reais carregadas do banco`);
                notifications = data || [];
                
                updateNotificationBadge();
                renderNotifications();
                
                // Processar @username nas notifica√ß√µes ap√≥s renderizar
                setTimeout(() => {
                    processNotificationsForUsernames();
                }, 200);
                console.log('‚úÖ Notifica√ß√µes processadas e renderizadas');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar notifica√ß√µes, mantendo array vazio:', error);
                
                // Manter array vazio em caso de erro
                notifications = [];
                
                console.log('‚úÖ Array de notifica√ß√µes vazio configurado devido ao erro');
                
                updateNotificationBadge();
                renderNotifications();
                console.log('‚úÖ Interface de notifica√ß√µes renderizada sem dados');
            }
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function renderNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            const markAllBtn = document.getElementById('markAllReadBtn');
            
            if (notifications.length === 0) {
                dropdown.innerHTML = `
                    <div class="notification-item">
                        <strong>Nenhuma notifica√ß√£o</strong><br>
                        <small>Voc√™ receber√° notifica√ß√µes quando algu√©m interagir com seus posts</small>
                    </div>
                `;
                return;
            }
            
            // Contar notifica√ß√µes n√£o lidas
            const unreadCount = notifications.filter(n => !n.read).length;
            
            dropdown.innerHTML = `
                ${notifications.map(notification => {
                    // Verificar se √© notifica√ß√£o relacionada a post (usar campo post_id)
                    const isPostRelated = notification.type && ['comment', 'reaction', 'mention', 'feedback'].includes(notification.type);
                    
                    // Usar o novo campo post_id que ser√° adicionado √† tabela
                    const postId = notification.post_id;
                    const hasPostReference = postId !== undefined && postId !== null;
                    
                    console.log('üîç An√°lise notifica√ß√£o:', {
                        id: notification.id,
                        type: notification.type,
                        isPostRelated,
                        hasPostReference,
                        postId,
                        message: notification.message
                    });
                    
                    // Se for relacionada a post, adicionar funcionalidade de clique
                    if (isPostRelated && postId) {
                        return `
                            <div class="notification-item ${!notification.read ? 'unread' : ''}" 
                                 style="cursor: pointer; transition: background-color 0.2s ease;"
                                 onclick="openPostFromNotification('${notification.id}', '${postId}')"
                                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                                 onmouseout="this.style.backgroundColor='transparent'">
                                <strong>${notification.message}</strong><br>
                                <small>${formatDate(notification.created_at)}</small>
                                <div style="font-size: 12px; color: #007bff; margin-top: 4px;">
                                    üëÜ Clique para ver o post
                                </div>
                            </div>
                        `;
                    } else {
                        // Notifica√ß√£o normal (sem link para post)
                        return `
                            <div class="notification-item ${!notification.read ? 'unread' : ''}" 
                                 onclick="markNotificationAsRead('${notification.id}')">
                                <strong>${notification.message}</strong><br>
                                <small>${formatDate(notification.created_at)}</small>
                            </div>
                        `;
                    }
                }).join('')}
                ${unreadCount > 0 ? `
                    <div style="padding: 0.5rem;">
                        <button id="markAllReadBtn" class="mark-all-read-btn">
                            Marcar todas como lidas (${unreadCount})
                        </button>
                    </div>
                ` : ''}
            `;
            
            // Adicionar event listener para o bot√£o "Marcar todas como lidas"
            const newMarkAllBtn = document.getElementById('markAllReadBtn');
            if (newMarkAllBtn) {
                newMarkAllBtn.addEventListener('click', markAllNotificationsAsRead);
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                console.log('üìù Marcando notifica√ß√£o como lida:', notificationId);
                
                // Tentar atualizar no banco com timeout
                try {
                    const updateQuery = supabase
                        .from('notifications')
                        .update({ read: true })
                        .eq('id', notificationId);
                    
                    await withTimeout(updateQuery, 2000);
                    console.log('‚úÖ Notifica√ß√£o marcada como lida no banco');
                } catch (updateError) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar no banco, marcando apenas localmente:', updateError.message);
                }
                
                // Sempre atualizar estado local
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    console.log('‚úÖ Notifica√ß√£o marcada como lida localmente');
                }
                
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar notifica√ß√£o como lida:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                console.log('üìù Marcando todas as notifica√ß√µes como lidas...');
                
                const markAllBtn = document.getElementById('markAllReadBtn');
                if (markAllBtn) {
                    markAllBtn.disabled = true;
                    markAllBtn.textContent = 'Marcando...';
                }
                
                // Tentar usar a fun√ß√£o do banco com timeout
                try {
                    const { data, error } = await withTimeout(
                        supabase.rpc('mark_all_notifications_read', { 
                            p_user_id: currentUser.id 
                        }),
                        5000
                    );
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Todas as notifica√ß√µes marcadas como lidas no banco:', data);
                    
                    // Mostrar mensagem de sucesso no console
                    if (data && data.message) {
                        console.log('‚úÖ Sucesso:', data.message);
                    } else {
                        console.log('‚úÖ Todas as notifica√ß√µes foram marcadas como lidas!');
                    }
                    
                } catch (dbError) {
                    console.warn('‚ö†Ô∏è Erro ao usar fun√ß√£o do banco, marcando individualmente:', dbError.message);
                    
                    // Fallback: marcar individualmente
                    const unreadNotifications = notifications.filter(n => !n.read);
                    
                    if (unreadNotifications.length > 0) {
                        const updateQuery = supabase
                            .from('notifications')
                            .update({ read: true })
                            .eq('user_id', currentUser.id)
                            .eq('read', false);
                        
                        await withTimeout(updateQuery, 5000);
                        
                        console.log(`‚úÖ ${unreadNotifications.length} notifica√ß√µes marcadas como lidas!`);
                    } else {
                        console.log('‚ÑπÔ∏è Nenhuma notifica√ß√£o n√£o lida encontrada!');
                    }
                }
                
                // Sempre atualizar estado local
                notifications.forEach(notification => {
                    if (!notification.read) {
                        notification.read = true;
                    }
                });
                
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar todas as notifica√ß√µes como lidas:', error);
            } finally {
                // Restaurar bot√£o
                const markAllBtn = document.getElementById('markAllReadBtn');
                if (markAllBtn) {
                    markAllBtn.disabled = false;
                    const unreadCount = notifications.filter(n => !n.read).length;
                    markAllBtn.textContent = `Marcar todas como lidas (${unreadCount})`;
                }
            }
        }

        // ===== FUNCIONALIDADE: MODAL DE POST AO CLICAR EM NOTIFICA√á√ÉO =====
        
        async function openPostFromNotification(notificationId, postId) {
            try {
                console.log('üîó Abrindo post a partir de notifica√ß√£o:', { notificationId, postId });
                
                // 1. Marcar notifica√ß√£o como lida
                await markNotificationAsRead(notificationId);
                
                // 2. Buscar dados completos do post
                const postData = await fetchPostDetails(postId);
                
                if (!postData) {
                    console.error('‚ùå Post n√£o encontrado:', postId);
                    showToast('Post n√£o encontrado');
                    return;
                }
                
                // 3. Determinar tipo de modal baseado no contexto
                const modalType = determineModalType(postData);
                
                // 4. Abrir modal apropriado
                showPostModal(postData, modalType);
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir post a partir de notifica√ß√£o:', error);
                showToast('Erro ao carregar post');
            }
        }

        async function fetchPostDetails(postId) {
            try {
                console.log('üîç Buscando detalhes do post:', postId);
                
                // Buscar post b√°sico primeiro
                const { data: post, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('id', postId)
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao buscar post:', error);
                    return null;
                }
                
                // Buscar dados do autor separadamente
                let authorData = null;
                if (post.user_id) {
                    const { data: author } = await supabase
                        .from('profiles')
                        .select('id, username, avatar_url, name')
                        .eq('id', post.user_id)
                        .single();
                    authorData = author;
                }
                
                // Buscar dados do usu√°rio mencionado separadamente
                let mentionedUserData = null;
                if (post.mentioned_user_id) {
                    const { data: mentionedUser } = await supabase
                        .from('profiles')
                        .select('id, username, avatar_url, name')
                        .eq('id', post.mentioned_user_id)
                        .single();
                    mentionedUserData = mentionedUser;
                }
                
                // Buscar rea√ß√µes do post (query simples)
                const { data: reactions } = await supabase
                    .from('reactions')
                    .select('*')
                    .eq('post_id', postId);
                
                // Buscar coment√°rios do post (query simples)
                const { data: comments } = await supabase
                    .from('comments')
                    .select('*')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: true });
                
                // Buscar feedbacks do post (query simples)
                const { data: feedbacks } = await supabase
                    .from('feedbacks')
                    .select('*')
                    .eq('post_id', postId);
                
                // Montar objeto completo do post
                const completePost = {
                    ...post,
                    reactions: reactions || [],
                    comments: comments || [],
                    feedbacks: feedbacks || [],
                    user_data: authorData || {
                        name: 'Usu√°rio',
                        username: 'usuario',
                        avatar_url: ''
                    },
                    mentioned_user_data: mentionedUserData || null
                };
                
                console.log('‚úÖ Detalhes do post carregados:', completePost);
                return completePost;
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar detalhes do post:', error);
                return null;
            }
        }

        function determineModalType(postData) {
            if (!currentUser) return 'other_post';
            
            if (postData.user_id === currentUser.id) {
                return 'own_post'; // Post pr√≥prio - estilo "Seus Posts"
            } else if (postData.mentioned_user_id === currentUser.id) {
                return 'received_holofote'; // Holofote recebido - estilo "Holofotes Recebidos"
            } else {
                return 'other_post'; // Post de terceiro (coment√°rio/rea√ß√£o)
            }
        }

        function showPostModal(postData, modalType) {
            console.log('üì± Abrindo modal de post:', { modalType, postId: postData.id });
            
            // Criar ou obter modal
            let modal = document.getElementById('singlePostModal');
            if (!modal) {
                modal = createSinglePostModal();
            }
            
            // Configurar layout baseado no tipo
            const modalHeader = modal.querySelector('.modal-header');
            const modalTitle = modal.querySelector('.modal-title');
            
            if (modalType === 'own_post') {
                // Para posts pr√≥prios: esconder header completamente
                modalHeader.style.display = 'none';
            } else {
                // Para outros posts: mostrar header normal
                modalHeader.style.display = 'flex';
                const titles = {
                    'received_holofote': '<img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofote Recebido',
                    'other_post': 'Post'
                };
                modalTitle.innerHTML = titles[modalType] || 'Post';
                
                // Aplicar gradiente laranja > dourado para holofote recebido
                if (modalType === 'received_holofote') {
                    modalHeader.style.background = 'linear-gradient(135deg, #ff9800, #ffb700)';
                    modalHeader.style.color = 'white';
                } else {
                    modalHeader.style.background = '';
                    modalHeader.style.color = '';
                }
            }
            
            // Renderizar post √∫nico
            renderSinglePost(postData, modal, modalType);
            
            // Mostrar modal
            modal.style.display = 'flex';
            
            console.log('‚úÖ Modal de post aberto com sucesso');
        }

        function createSinglePostModal() {
            const modal = document.createElement('div');
            modal.id = 'singlePostModal';
            modal.className = 'modal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 30000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem 2rem;
                        border-radius: 12px 12px 0 0;
                        position: sticky;
                        top: 0;
                        background: white;
                        z-index: 10;
                    ">
                        <h2 class="modal-title" style="margin: 0;">Post</h2>
                        <button class="close-btn" onclick="closeSinglePostModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <div id="singlePostContent"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSinglePostModal();
                }
            });
            
            return modal;
        }

        function renderSinglePost(postData, modal, modalType) {
            const container = modal.querySelector('#singlePostContent');
            if (!container) return;
            
            const typeEmojis = {
                'gratidao': 'üôè', 'gratitude': 'üôè',
                'memoria': 'üí≠', 'memory': 'üí≠',
                'conquista': 'üèÜ', 'achievement': 'üèÜ',
                'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                'apoio': 'ü§ù', 'support': 'ü§ù',
                'admiracao': 'üåü', 'admiration': 'üåü'
            };

            const typeNames = {
                'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                'conquista': 'Conquista', 'achievement': 'Conquista',
                'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                'apoio': 'Apoio', 'support': 'Apoio',
                'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
            };
            
            // Usar dados do autor ou fallback
            const authorName = postData.user_data?.name || postData.author?.name || 'Usu√°rio';
            const authorUsername = postData.user_data?.username || postData.author?.username || 'usuario';
            const authorAvatar = postData.user_data?.avatar_url || postData.author?.avatar_url || '';
            
            // Contar rea√ß√µes por tipo
            const touchedCount = postData.reactions?.filter(r => r.type === 'touched').length || 0;
            const gratefulCount = postData.reactions?.filter(r => r.type === 'grateful').length || 0;
            const inspiredCount = postData.reactions?.filter(r => r.type === 'inspired').length || 0;
            
            // Verificar se usu√°rio atual j√° reagiu
            const userReactions = postData.reactions?.filter(r => r.user_id === currentUser?.id) || [];
            const userTouched = userReactions.some(r => r.type === 'touched');
            const userGrateful = userReactions.some(r => r.type === 'grateful');
            const userInspired = userReactions.some(r => r.type === 'inspired');
            
            container.innerHTML = `
                <div class="post" style="margin: 0; border: none; box-shadow: none; position: relative;">
                    <button class="share-btn" onclick="sharePost('${postData.id}')" style="
                        position: absolute;
                        top: 3rem;
                        right: 1.5rem;
                        background: rgba(255, 255, 255, 0.9);
                        border: 1px solid #ddd;
                        border-radius: 50%;
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        z-index: 10;
                        backdrop-filter: blur(5px);
                    " onmouseover="this.style.background='rgba(229, 90, 43, 0.1)'; this.style.borderColor='#e55a2b'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.borderColor='#ddd'; this.style.transform='scale(1)';">
                        üîó
                    </button>
                    ${modalType === 'own_post' ? `
                        <span class="close" style="
                            position: absolute;
                            top: 1rem;
                            right: 1rem;
                            font-size: 28px;
                            font-weight: bold;
                            cursor: pointer;
                            color: #999;
                            line-height: 1;
                            z-index: 10;
                        " onclick="closeSinglePostModal()">&times;</span>
                    ` : ''}
                    <div class="post-header" style="padding: 1.5rem 1.5rem 0 1.5rem; position: relative;">
                        <img class="post-avatar" src="${authorAvatar}" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <div class="post-author" style="flex: 1;">
                            <div class="post-author-name" style="font-weight: 600; color: #333;">${authorName}</div>
                            <div class="post-author-meta" style="color: #666; font-size: 14px;">
                                ${authorUsername === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                    `<span class="post-author-username">@${authorUsername}</span>` :
                                    `<span class="post-author-username" onclick="openUserProfile('${authorUsername}')" 
                                          style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                          onmouseover="this.style.color='#0056b3'"
                                          onmouseout="this.style.color='#007bff'">
                                        @${authorUsername}
                                    </span>`
                                }
                                <span class="post-time-separator"> ‚Ä¢ </span>
                                <span class="post-time">${formatDateShort(postData.created_at)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="post-content" style="padding: 1rem 1.5rem;">
                        <div class="post-person" style="font-weight: 600; color: #e55a2b; margin-bottom: 0.5rem;">
                            Holofotes para: 
                            ${postData.mentioned_user_id ? `
                                ${postData.mentioned_user_id === currentUser.id ? 
                                    `<span>${postData.mentioned_user?.username ? '@' + postData.mentioned_user.username : postData.mentioned_user?.email ? '@' + postData.mentioned_user.email.split('@')[0] : postData.celebrated_person_name || postData.person_name}</span>` :
                                    `<span onclick="openUserProfileByIdFromModal('${postData.mentioned_user_id}')" 
                                          style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                          onmouseover="this.style.color='#0056b3'"
                                          onmouseout="this.style.color='#007bff'">
                                        ${postData.mentioned_user?.username ? '@' + postData.mentioned_user.username : postData.mentioned_user?.email ? '@' + postData.mentioned_user.email.split('@')[0] : postData.celebrated_person_name || postData.person_name}
                                    </span>`
                                }
                            ` : `<span>${postData.celebrated_person_name || postData.person_name || 'Algu√©m especial'}</span>`}
                        </div>
                        ${postData.type || postData.highlight_type ? `
                            <div class="post-type" style="color: white; font-size: 14px; margin-bottom: 0.5rem;">
                                ${typeEmojis[postData.type || postData.highlight_type] || '‚ú®'} ${typeNames[postData.type || postData.highlight_type] || 'Destaque'}
                            </div>
                        ` : ''}
                        ${postData.photo_url ? `
                            <img class="post-image" src="${postData.photo_url}" alt="Foto do post" style="
                                width: 100%;
                                border-radius: 8px;
                                margin-bottom: 1rem;
                                height: auto;
                                object-fit: contain;
                            ">
                        ` : ''}
                        <div class="post-story" style="line-height: 1.5; color: #333; margin-bottom: 1rem;">
                            ${postData.content || postData.story || ''}
                        </div>
                    </div>
                    
                    <div class="post-reactions" style="padding: 0 1.5rem; display: flex; gap: 10px; margin-bottom: 1rem;">
                        ${(() => {
                            const isAuthor = postData.user_id === currentUser.id;
                            
                            if (isAuthor) {
                                // Autor do post: bot√µes desabilitados com hover negado
                                return `
                                    <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #ccc; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease;" onmouseover="this.style.background='#ffebee'; this.style.color='#f44336';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#ccc';" title="Voc√™ n√£o pode reagir ao seu pr√≥prio post">
                                        ‚ù§Ô∏è ${touchedCount}
                                    </button>
                                    <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #ccc; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease;" onmouseover="this.style.background='#ffebee'; this.style.color='#f44336';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#ccc';" title="Voc√™ n√£o pode reagir ao seu pr√≥prio post">
                                        üôè ${gratefulCount}
                                    </button>
                                    <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #ccc; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease;" onmouseover="this.style.background='#ffebee'; this.style.color='#f44336';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#ccc';" title="Voc√™ n√£o pode reagir ao seu pr√≥prio post">
                                        ‚ú® ${inspiredCount}
                                    </button>
                                `;
                            } else {
                                // N√£o √© autor: bot√µes funcionais normais
                                return `
                                    <button onclick="reactToPost('${postData.id}', 'touched')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: ${userTouched ? 'linear-gradient(135deg, #FFB700, #9C27B0)' : '#f5f5f5'}; border: none; border-radius: 20px; color: ${userTouched ? 'white' : '#666'}; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" ${!userTouched ? `onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';"` : ''}>
                                        ‚ù§Ô∏è ${touchedCount}
                                    </button>
                                    <button onclick="reactToPost('${postData.id}', 'grateful')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: ${userGrateful ? 'linear-gradient(135deg, #FFB700, #9C27B0)' : '#f5f5f5'}; border: none; border-radius: 20px; color: ${userGrateful ? 'white' : '#666'}; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" ${!userGrateful ? `onmouseover="this.style.background='#f39c12'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';"` : ''}>
                                        üôè ${gratefulCount}
                                    </button>
                                    <button onclick="reactToPost('${postData.id}', 'inspired')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: ${userInspired ? 'linear-gradient(135deg, #FFB700, #9C27B0)' : '#f5f5f5'}; border: none; border-radius: 20px; color: ${userInspired ? 'white' : '#666'}; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" ${!userInspired ? `onmouseover="this.style.background='#9b59b6'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';"` : ''}>
                                        ‚ú® ${inspiredCount}
                                    </button>
                                `;
                            }
                        })()}
                    </div>
                    
                    <div class="post-footer" style="padding: 0 1.5rem 1.5rem 1.5rem; display: flex; gap: 15px;">
                        <span class="comments-display" onclick="openCommentsModal('${postData.id}')" style="
                            display: flex;
                            align-items: center;
                            gap: 5px;
                            padding: 8px 12px;
                            background: ${postData.comments?.length > 0 ? 'linear-gradient(135deg, #2196f3, #1976d2)' : '#f5f5f5'};
                            color: ${postData.comments?.length > 0 ? 'white' : '#666'};
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            transition: all 0.2s ease;
                        ">
                            üí¨ ${postData.comments?.length || 0}
                        </span>
                        ${(() => {
                            const canGiveFeedback = postData.mentioned_user_id === currentUser.id;
                            const hasFeedbacks = postData.feedbacks?.length > 0;
                            const shouldEnable = canGiveFeedback || hasFeedbacks;
                            
                            if (shouldEnable) {
                                // Habilitado: pode dar feedback OU pode visualizar feedbacks existentes
                                return `<span class="feedback-display" onclick="openPostFeedbackModal('${postData.id}', '${canGiveFeedback ? 'holofotes_recebidos' : 'seus_posts'}')" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 5px;
                                    padding: 8px 12px;
                                    background: ${hasFeedbacks ? 'linear-gradient(135deg, #e55a2b, #ffb700)' : '#f5f5f5'};
                                    color: ${hasFeedbacks ? 'white' : '#666'};
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 600;
                                    transition: all 0.2s ease;
                                ">
                                    üîÑ ${postData.feedbacks?.length || 0}
                                </span>`;
                            } else {
                                // Desabilitado: n√£o pode dar feedback e n√£o h√° feedbacks para ver
                                return `<span class="feedback-display" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 5px;
                                    padding: 8px 12px;
                                    background: #f5f5f5;
                                    color: #ccc;
                                    border-radius: 20px;
                                    cursor: not-allowed;
                                    font-size: 14px;
                                    font-weight: 600;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#ffebee'; this.style.color='#f44336';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#ccc';" title="Apenas a pessoa mencionada pode dar feedback">
                                    üîÑ ${postData.feedbacks?.length || 0}
                                </span>`;
                            }
                        })()}
                    </div>
                </div>
            `;
        }

        function closeSinglePostModal() {
            const modal = document.getElementById('singlePostModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showToast(message) {
            // Criar toast se n√£o existir
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 999999;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // ===== FUNCIONALIDADE: @USERNAME CLIC√ÅVEL COM MODAL DE PERFIL =====
        
        function linkifyUsernames(text) {
            if (!text) return text;
            
            const usernameRegex = /@([a-zA-Z0-9._-]+)/g;
            
            return text.replace(usernameRegex, (match, username) => {
                const isCurrentUser = username === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username);
                
                if (isCurrentUser) {
                    return `<span class="username-link" data-username="${username}" style="
                        color: #666;
                        text-decoration: none;
                        font-weight: 500;
                    ">@${username}</span>`;
                } else {
                    return `<span class="username-link" data-username="${username}" onclick="openUserProfile('${username}')" style="
                        color: #007bff;
                        cursor: pointer;
                        text-decoration: none;
                        font-weight: 500;
                    transition: all 0.2s ease;
                    border-radius: 3px;
                    padding: 1px 3px;
                    " onmouseover="this.style.textDecoration='underline'; this.style.color='#0056b3'; this.style.backgroundColor='rgba(0, 123, 255, 0.1)';" onmouseout="this.style.textDecoration='none'; this.style.color='#007bff'; this.style.backgroundColor='transparent';">${match}</span>`;
                }
            });
        }

        function processAllTextContent() {
            console.log('üîó Processando @username em todos os textos...');
            
            // DIAGN√ìSTICO: Verificar quantos elementos existem
            const postStories = document.querySelectorAll('.post-story');
            console.log('üìä DIAGN√ìSTICO: Encontrados', postStories.length, 'elementos .post-story');
            
            // Posts - processar de forma mais inteligente
            postStories.forEach((element, index) => {
                const originalText = element.textContent;
                console.log(`üìù Post ${index + 1}:`, originalText.substring(0, 100) + '...');
                console.log(`üîç Cont√©m @? ${originalText.includes('@')}`);
                console.log(`‚úÖ J√° processado? ${element.dataset.processed === 'true'}`);
                
                if (element.dataset.processed !== 'true') {
                    if (originalText.includes('@')) {
                        console.log('üîç Post com @username encontrado:', originalText);
                        // Processar apenas se cont√©m @username
                        if (element.children.length === 0) {
                            // Texto puro - processar diretamente
                            element.innerHTML = linkifyUsernames(originalText);
                            console.log('‚úÖ Processado @username em post (texto puro)');
                        } else {
                            // Tem estrutura HTML - processar de forma mais cuidadosa
                            console.log('üîß Post com HTML, processando cuidadosamente...');
                            processTextNodesInElement(element);
                            console.log('‚úÖ Processado @username em post (com HTML)');
                        }
                    }
                    element.dataset.processed = 'true';
                }
            });
            
            // Coment√°rios
            document.querySelectorAll('.comment-content, .comment-text').forEach(element => {
                if (element.dataset.processed !== 'true') {
                    const originalText = element.textContent;
                    if (originalText.includes('@')) {
                        element.innerHTML = linkifyUsernames(originalText);
                        console.log('‚úÖ Processado @username em coment√°rio');
                    }
                    element.dataset.processed = 'true';
                }
            });
            
            // DIAGN√ìSTICO: Verificar notifica√ß√µes
            const notifications = document.querySelectorAll('.notification-item strong, .notification-item .notification-message, .notification-item');
            console.log('üìä DIAGN√ìSTICO: Encontrados', notifications.length, 'elementos de notifica√ß√£o');
            
            // Notifica√ß√µes - seletores mais amplos
            notifications.forEach((element, index) => {
                const originalText = element.textContent;
                console.log(`üìù Notifica√ß√£o ${index + 1}:`, originalText.substring(0, 50) + '...');
                console.log(`üîç Cont√©m @? ${originalText.includes('@')}`);
                console.log(`‚úÖ J√° processado? ${element.dataset.processed === 'true'}`);
                console.log(`üîó Tem onclick? ${element.hasAttribute('onclick')}`);
                
                if (element.dataset.processed !== 'true') {
                    if (originalText.includes('@')) {
                        console.log('üîç Notifica√ß√£o com @username encontrada:', originalText);
                        // Verificar se n√£o tem onclick (para n√£o quebrar funcionalidade)
                        if (!element.hasAttribute('onclick')) {
                            element.innerHTML = linkifyUsernames(originalText);
                            console.log('‚úÖ Processado @username em notifica√ß√£o');
                        } else {
                            console.log('‚ö†Ô∏è Notifica√ß√£o com onclick preservada');
                        }
                    }
                    element.dataset.processed = 'true';
                }
            });
            
            // Feedbacks
            document.querySelectorAll('.feedback-content, .feedback-text').forEach(element => {
                if (element.dataset.processed !== 'true') {
                    const originalText = element.textContent;
                    if (originalText.includes('@')) {
                        element.innerHTML = linkifyUsernames(originalText);
                        console.log('‚úÖ Processado @username em feedback');
                    }
                    element.dataset.processed = 'true';
                }
            });
            
            console.log('‚úÖ @username processados em todos os textos');
        }
        
        // Fun√ß√£o auxiliar para processar n√≥s de texto dentro de elementos com HTML
        function processTextNodesInElement(element) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                if (node.textContent.includes('@')) {
                    textNodes.push(node);
                }
            }
            
            textNodes.forEach(textNode => {
                const originalText = textNode.textContent;
                if (originalText.includes('@')) {
                    const span = document.createElement('span');
                    span.innerHTML = linkifyUsernames(originalText);
                    textNode.parentNode.replaceChild(span, textNode);
                }
            });
        }

        async function openUserProfile(username) {
            try {
                console.log('üë§ Abrindo perfil do usu√°rio:', username);
                
                // Removido loading toast para melhor UX
                
                const userData = await fetchUserProfileData(username);
                
                if (!userData) {
                    console.error('‚ùå Usu√°rio n√£o encontrado:', username);
                    showToast('Usu√°rio n√£o encontrado');
                    return;
                }
                
                const stats = await fetchUserStats(userData.id);
                
                // GARANTIR que showUserProfileModal receba os par√¢metros corretos
                showUserProfileModal(userData, stats);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                showToast('Erro ao carregar perfil do usu√°rio');
            }
        }

        // Fun√ß√£o para buscar usu√°rio por ID (mais segura)
        async function fetchUserProfileDataById(userId) {
            try {
                console.log('üîç Buscando dados do usu√°rio por ID:', userId);
                
                const { data: user, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error || !user) {
                    console.error('‚ùå Usu√°rio n√£o encontrado por ID:', error);
                    return null;
                }
                
                console.log('‚úÖ Dados do usu√°rio encontrados por ID:', user);
                return user;
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados do usu√°rio por ID:', error);
                return null;
            }
        }

        // Fun√ß√£o para abrir perfil por ID (quando temos mentioned_user_id)
        async function openUserProfileById(userId) {
            try {
                console.log('üë§ Abrindo perfil do usu√°rio por ID:', userId);
                
                // Removido loading toast para melhor UX
                
                const userData = await fetchUserProfileDataById(userId);
                
                if (!userData) {
                    console.error('‚ùå Usu√°rio n√£o encontrado por ID:', userId);
                    showToast('Usu√°rio n√£o encontrado');
                    return;
                }
                
                const stats = await fetchUserStats(userData.id);
                
                // GARANTIR que showUserProfileModal receba os par√¢metros corretos
                showUserProfileModal(userData, stats);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil por ID:', error);
                showToast('Erro ao carregar perfil do usu√°rio');
            }
        }

        async function fetchUserProfileData(username) {
            try {
                console.log('üîç Buscando dados do usu√°rio:', username);
                
                // Primeiro, tentar buscar por email (username@domain)
                let { data: user, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .ilike('email', `${username}%`)
                    .single();
                
                // Se n√£o encontrar, tentar buscar por nome que contenha o username
                if (error || !user) {
                    const { data: userByName, error: nameError } = await supabase
                        .from('profiles')
                        .select('*')
                        .ilike('name', `%${username}%`)
                        .limit(1)
                        .single();
                    
                    if (!nameError && userByName) {
                        user = userByName;
                        error = null;
                    }
                }
                
                if (error || !user) {
                    console.error('‚ùå Usu√°rio n√£o encontrado:', error);
                    return null;
                }
                
                console.log('‚úÖ Dados do usu√°rio encontrados:', user);
                return user;
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados do usu√°rio:', error);
                return null;
            }
        }

        async function fetchUserStats(userId) {
            try {
                console.log('üìä Buscando estat√≠sticas do usu√°rio:', userId);
                
                const [
                    postsResult,
                    holofotesResult,
                    followingResult,
                    followersResult
                ] = await Promise.all([
                    // Posts criados
                    supabase.from('posts').select('id').eq('user_id', userId),
                    // Holofotes recebidos
                    supabase.from('posts').select('id').eq('mentioned_user_id', userId),
                    // Seguindo
                    supabase.from('follows').select('id').eq('follower_id', userId),
                    // Seguidores
                    supabase.from('follows').select('id').eq('following_id', userId)
                ]);
                
                const stats = {
                    posts: postsResult.data?.length || 0,
                    holofotes: holofotesResult.data?.length || 0,
                    following: followingResult.data?.length || 0,
                    followers: followersResult.data?.length || 0
                };
                
                console.log('‚úÖ Estat√≠sticas do usu√°rio:', stats);
                return stats;
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar estat√≠sticas:', error);
                return {
                    posts: 0,
                    holofotes: 0,
                    following: 0,
                    followers: 0
                };
            }
        }

        function showUserProfileModal(userData, stats) {
            // VALIDA√á√ÉO: Garantir que par√¢metros est√£o corretos
            if (!userData || typeof userData !== 'object') {
                console.error('‚ùå showUserProfileModal: userData inv√°lido:', userData);
                showToast('Erro: dados do usu√°rio inv√°lidos');
                return;
            }
            
            if (!stats || typeof stats !== 'object') {
                console.error('‚ùå showUserProfileModal: stats inv√°lido:', stats);
                showToast('Erro: estat√≠sticas do usu√°rio inv√°lidas');
                return;
            }
            
            console.log('üì± Abrindo modal de perfil:', userData.name);
            console.log('üìä Estat√≠sticas:', stats);
            
            let modal = document.getElementById('userProfileModal');
            if (!modal) {
                modal = createUserProfileModal();
            }
            
            populateUserProfileModal(modal, userData, stats);
            
            // Armazenar userId no dataset do modal para uso nos event listeners
            modal.dataset.userId = userData.id;
            
            modal.style.display = 'flex';
            
            // Adicionar modal √† pilha para gerenciar ESC
            addModalToStack('userProfileModal', closeUserProfileModal);
            
            // Cards no modal de perfil s√£o apenas informativos (n√£o clic√°veis)
            
            console.log('‚úÖ Modal de perfil aberto com sucesso');
        }

        function createUserProfileModal() {
            const modal = document.createElement('div');
            modal.id = 'userProfileModal';
            modal.className = 'modal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 99999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 500px;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <span class="close" style="
                        position: absolute;
                        top: 15px;
                        right: 20px;
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        color: #999;
                        line-height: 1;
                        z-index: 20;
                    " onclick="closeUserProfileModal()">&times;</span>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div class="profile-header" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 2rem;
                            position: relative;
                        ">
                            <img class="profile-avatar" src="" alt="Avatar" style="
                                width: 80px;
                                height: 80px;
                                border-radius: 50%;
                                object-fit: cover;
                                margin-right: 1rem;

                            ">
                            <div class="profile-info" style="flex: 1;">
                                <h3 class="profile-name" style="
                                    margin: 0 0 0.5rem 0;
                                    color: #333;
                                    font-size: 1.5rem;
                                "></h3>
                                <p class="profile-username" style="
                                    margin: 0;
                                    color: #666;
                                    font-size: 1rem;
                                "></p>
                            </div>
                            <button class="follow-btn" style="
                                padding: 8px 16px;
                                border: none;
                                border-radius: 20px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                background: #007bff;
                                color: white;
                                margin-left: 15px;
                            " onclick="toggleFollow()">Seguir</button>
                        </div>
                        
                        <!-- Card do N√≠vel Atual -->
                        <div class="level-card" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            position: relative;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <div class="level-title" style="font-size: 18px; font-weight: bold; margin-bottom: 2px;">N√≠vel 1</div>
                                    <div class="level-name" style="font-size: 14px; opacity: 0.9;">Iniciante</div>
                                </div>
                                <div style="font-size: 24px;">üì¢</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="level-points" style="font-size: 14px;">0 pontos</span>
                                <span class="level-next" style="font-size: 14px;">100 para pr√≥ximo n√≠vel</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div class="level-progress" style="background: white; height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s ease;"></div>
                            </div>
                            <div class="level-ranking" style="text-align: center; margin-top: 8px; font-size: 12px; opacity: 0.9;">
                                Ranking: #-- de -- usu√°rios
                            </div>
                        </div>
                        
                        <div class="profile-stats" style="
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 15px;
                            margin-bottom: 20px;
                        ">
                            <!-- Primeira linha: Seguindo | Seguidores -->
                            <div class="stat-card" id="modalFollowingCard">
                                <div class="stat-number" id="userFollowingCount">0</div>
                                <div class="stat-label">Seguindo</div>
                            </div>
                            
                            <div class="stat-card" id="modalFollowersCard">
                                <div class="stat-number" id="userFollowersCount">0</div>
                                <div class="stat-label">Seguidores</div>
                            </div>
                            
                            <!-- Segunda linha: Posts Criados | Holofotes Recebidos -->
                            <div class="stat-card" id="modalPostsCreatedCard">
                                <div class="stat-number" id="userPostsCount">0</div>
                                <div class="stat-label">Posts Criados</div>
                            </div>
                            
                            <div class="stat-card" id="modalHolofotesCard">
                                <div class="stat-number" id="userHolofotesCount">0</div>
                                <div class="stat-label">Holofotes Recebidos</div>
                            </div>
                        </div>
                        
                        <!-- Link para perfil do usu√°rio -->
                        <div style="
                            text-align: center;
                            padding: 15px;
                            border-top: 1px solid #eee;
                            margin-top: 10px;
                        ">
                            <a href="#" onclick="openFullProfile('USER_ID_PLACEHOLDER'); return false;" style="
                                color: #007bff;
                                text-decoration: none;
                                font-size: 14px;
                                font-weight: 500;
                                transition: color 0.2s ease;
                            " onmouseover="this.style.color='#0056b3'" onmouseout="this.style.color='#007bff'">üë§ Visualizar perfil completo do usu√°rio</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                // Fechar modal se clicar no fundo
                if (e.target === modal) {
                    closeUserProfileModal();
                }
            });
            
            return modal;
        }

        function populateUserProfileModal(modal, userData, stats) {
            // Avatar
            const avatar = modal.querySelector('.profile-avatar');
            avatar.src = userData.avatar_url || '';
            avatar.onerror = function() {
                this.style.display = 'none';
                const initial = document.createElement('div');
                initial.style.cssText = `
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #e55a2b, #ffb700);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 32px;
                    font-weight: bold;

                `;
                initial.textContent = (userData.name || 'U').charAt(0).toUpperCase();
                this.parentNode.insertBefore(initial, this);
            };
            
            // Nome
            const name = modal.querySelector('.profile-name');
            name.textContent = userData.name || 'Usu√°rio';
            
            // Username (email)
            const username = modal.querySelector('.profile-username');
            const emailUsername = userData.email ? userData.email.split('@')[0] : 'usuario';
            username.textContent = `@${emailUsername}`;
            
            // Estat√≠sticas
            modal.querySelector('#userPostsCount').textContent = stats.posts;
            modal.querySelector('#userHolofotesCount').textContent = stats.holofotes;
            modal.querySelector('#userFollowingCount').textContent = stats.following || 0;
            modal.querySelector('#userFollowersCount').textContent = stats.followers || 0;
            
            // Bot√£o Seguir/Deixar de Seguir
            const followBtn = modal.querySelector('.follow-btn');
            if (followBtn) {
                // Verificar se √© o pr√≥prio usu√°rio
                if (userData.id === currentUser.id) {
                    followBtn.style.display = 'none';
                } else {
                    followBtn.style.display = 'block';
                    // Verificar se j√° segue este usu√°rio
                    checkFollowStatus(userData.id, followBtn);
                }
            }
            
            // Card do N√≠vel Atual - buscar dados reais
            const levelCard = modal.querySelector('.level-card');
            if (levelCard) {
                loadUserLevelData(userData.id, levelCard);
            }
            
            // Armazenar dados do usu√°rio no modal para uso posterior
            modal.dataset.userId = userData.id;
            modal.dataset.userName = userData.name || 'Usu√°rio';
            modal.dataset.userEmail = userData.email || '';
            
            // Atualizar link do perfil completo com username (mais amig√°vel que ID)
            const profileLink = modal.querySelector('a[onclick*="USER_ID_PLACEHOLDER"]');
            if (profileLink) {
                // Priorizar username, depois email username, fallback para ID
                const userIdentifier = userData.username || 
                                     (userData.email ? userData.email.split('@')[0] : null) || 
                                     userData.id;
                
                profileLink.onclick = function() {
                    openFullProfile(userIdentifier);
                    return false;
                };
                console.log('‚úÖ Link do perfil completo atualizado para:', userIdentifier);
            }
        }
        
        // Fun√ß√£o para verificar status de seguir
        async function checkFollowStatus(userId, followBtn) {
            try {
                const { data, error } = await supabase
                    .from('follows')
                    .select('id')
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .single();
                
                if (data) {
                    // J√° segue
                    followBtn.textContent = 'Seguindo';
                    followBtn.style.background = '#28a745';
                } else {
                    // N√£o segue
                    followBtn.textContent = 'Seguir';
                    followBtn.style.background = '#007bff';
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Usu√°rio n√£o seguido ainda');
                followBtn.textContent = 'Seguir';
                followBtn.style.background = '#007bff';
            }
        }
        
        // Fun√ß√£o para carregar dados reais de n√≠vel do usu√°rio
        async function loadUserLevelData(userId, levelCard) {
            try {
                // Buscar dados de gamifica√ß√£o do usu√°rio espec√≠fico
                const { data, error } = await supabase.rpc('get_user_gamification_data', {
                    p_user_id: userId
                });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar dados de n√≠vel:', error);
                    return;
                }
                
                console.log('üéØ Dados de n√≠vel recebidos:', data);
                
                // Atualizar card com dados reais
                if (data) {
                    const level = data.current_level?.id || 1;
                    const levelName = data.current_level?.name || 'Iniciante';
                    const totalPoints = data.total_points || 0;
                    const nextLevelPoints = data.next_level?.points_required || 100;
                    const currentLevelPoints = data.current_level?.points_required || 0;
                    const pointsToNext = nextLevelPoints - totalPoints;
                    const progressPercent = data.progress || 0;
                    
                    // Emojis dos n√≠veis
                    const levelEmojis = {
                        1: 'üì¢', 2: 'üå±', 3: 'üî•', 4: '‚≠ê', 5: 'üöÄ', 
                        6: 'üíé', 7: 'üëë', 8: 'üèÜ', 9: 'üåü', 10: 'üéØ'
                    };
                    
                    // Atualizar conte√∫do do card
                    levelCard.querySelector('.level-title').textContent = `N√≠vel ${level}`;
                    levelCard.querySelector('.level-name').textContent = levelName;
                    levelCard.querySelector('.level-points').textContent = `${totalPoints} pontos`;
                    levelCard.querySelector('.level-next').textContent = data.next_level ? `${pointsToNext} para pr√≥ximo n√≠vel` : 'N√≠vel m√°ximo!';
                    levelCard.querySelector('.level-progress').style.width = `${Math.min(progressPercent, 100)}%`;
                    
                    // Atualizar emoji
                    const emojiElement = levelCard.querySelector('div[style*="font-size: 24px"]');
                    if (emojiElement) {
                        emojiElement.textContent = levelEmojis[Math.min(level, 10)] || 'üéØ';
                    }
                    
                    // Buscar ranking se dispon√≠vel
                    if (data.ranking && data.ranking.position && data.ranking.total) {
                        levelCard.querySelector('.level-ranking').textContent = `Ranking: #${data.ranking.position} de ${data.ranking.total} usu√°rios`;
                    } else {
                        // Fallback: calcular ranking manualmente
                        calculateUserRanking(userId, totalPoints, levelCard);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados de n√≠vel:', error);
                // Fallback em caso de erro
                calculateUserRanking(userId, 0, levelCard);
            }
        }
        
        // Fun√ß√£o para calcular ranking usando a tabela user_ranking
        async function calculateUserRanking(userId, userPoints, levelCard) {
            try {
                console.log('üéØ Calculando ranking para usu√°rio:', userId, 'com pontos:', userPoints);
                
                // Buscar total de usu√°rios primeiro
                const { data: totalUsersData, error: totalError } = await supabase
                    .from('profiles')
                    .select('id', { count: 'exact' });
                
                if (totalError) {
                    console.error('‚ùå Erro ao buscar total de usu√°rios:', totalError);
                    levelCard.querySelector('.level-ranking').textContent = 'Ranking: Erro na consulta';
                    return;
                }
                
                const totalUsers = totalUsersData?.length || 0;
                console.log('üë• Total de usu√°rios encontrados:', totalUsers);
                
                if (totalUsers === 0) {
                    levelCard.querySelector('.level-ranking').textContent = 'Ranking: Sem usu√°rios';
                    return;
                }
                
                // Tentar buscar da tabela user_ranking
                const { data: rankingData, error: rankingError } = await supabase
                    .from('user_ranking')
                    .select('rank_position')
                    .eq('user_id', userId)
                    .single();
                
                console.log('üìä Dados da tabela user_ranking:', rankingData, 'Erro:', rankingError?.message);
                
                // Se encontrou na tabela user_ranking, usar esse valor
                if (!rankingError && rankingData && rankingData.rank_position) {
                    console.log('‚úÖ Usando ranking da tabela user_ranking:', rankingData.rank_position);
                    levelCard.querySelector('.level-ranking').textContent = `Ranking: #${rankingData.rank_position} de ${totalUsers} usu√°rios`;
                    return;
                }
                
                // Fallback simples: assumir posi√ß√£o baseada em pontua√ß√£o
                console.log('‚ö†Ô∏è Tabela user_ranking n√£o dispon√≠vel, usando fallback simples');
                
                // Calcular posi√ß√£o estimada baseada em pontos (quanto mais pontos, melhor posi√ß√£o)
                let estimatedPosition;
                if (userPoints === 0) {
                    estimatedPosition = totalUsers; // Sem pontos = √∫ltima posi√ß√£o
                } else if (userPoints >= 1000) {
                    estimatedPosition = 1; // Muitos pontos = primeira posi√ß√£o
                } else {
                    // Posi√ß√£o proporcional aos pontos (0-1000 pontos)
                    const percentile = userPoints / 1000;
                    estimatedPosition = Math.max(1, Math.ceil(totalUsers * (1 - percentile)));
                }
                
                console.log('üìà Posi√ß√£o estimada calculada:', estimatedPosition);
                levelCard.querySelector('.level-ranking').textContent = `Ranking: #${estimatedPosition} de ${totalUsers} usu√°rios`;
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao calcular ranking:', error);
                levelCard.querySelector('.level-ranking').textContent = 'Ranking: Erro no sistema';
            }
        }
        
        // Fun√ß√£o para toggle do bot√£o seguir com integra√ß√£o real e atualiza√ß√µes sistema-wide
        async function toggleFollow() {
            const modal = document.getElementById('userProfileModal');
            const followBtn = modal?.querySelector('.follow-btn');
            const userId = modal?.dataset.userId;
            
            if (!followBtn || !userId) return;
            
            try {
                console.log(`üë• Tentando ${following.some(f => f.following_id === userId) ? 'desseguir' : 'seguir'} usu√°rio:`, userId);
                const isFollowing = following.some(f => f.following_id === userId);
                
                if (isFollowing) {
                    // Unfollow
                    try {
                        const unfollowQuery = supabase
                            .from('follows')
                            .delete()
                            .eq('follower_id', currentUser.id)
                            .eq('following_id', userId);
                        
                        await withTimeout(unfollowQuery, 2000);
                        console.log('‚úÖ Unfollow realizado no banco');
                    } catch (unfollowError) {
                        console.warn('‚ö†Ô∏è Erro ao desseguir no banco, atualizando apenas localmente:', unfollowError.message);
                    }
                    
                    following = following.filter(f => f.following_id !== userId);
                    console.log('‚úÖ Usu√°rio removido da lista local de seguindo');
                    
                    followBtn.textContent = 'Seguir';
                    followBtn.style.background = '#007bff';
                    showToast('Deixou de seguir o usu√°rio');
                } else {
                    // Follow
                    try {
                        const followQuery = supabase
                            .from('follows')
                            .insert({
                                follower_id: currentUser.id,
                                following_id: userId
                            });
                        
                        await withTimeout(followQuery, 2000);
                        console.log('‚úÖ Follow realizado no banco');
                    } catch (followError) {
                        console.warn('‚ö†Ô∏è Erro ao seguir no banco, atualizando apenas localmente:', followError.message);
                    }
                    
                    following.push({ following_id: userId });
                    console.log('‚úÖ Usu√°rio adicionado √† lista local de seguindo');
                    
                    followBtn.textContent = 'Seguindo';
                    followBtn.style.background = '#28a745';
                    showToast('Usu√°rio seguido com sucesso!');
                    
                    // Tentar criar notifica√ß√£o
                    console.log('‚úÖ Notifica√ß√£o de follow ser√° criada automaticamente pelo trigger SQL');
                }
                
                // Sempre atualizar contadores e interface sistema-wide
                updateFollowCounts();
                if (!window.isLoadingPosts) {
                    await renderPosts();
                }
                console.log('‚úÖ Interface atualizada ap√≥s follow/unfollow');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao seguir/desseguir:', error);
                showToast('Erro ao seguir/desseguir usu√°rio. Tente novamente.');
            }
        }

        function closeUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.style.display = 'none';
                removeModalFromStack('userProfileModal');
            }
        }

        // ===== INTEGRA√á√ÉO COM P√ÅGINA COMPLETA DE PERFIL =====
        
        function openFullProfile(userId) {
            console.log('üîÑ openFullProfile chamado para userId:', userId);
            
            try {
                // Validar userId
                if (!userId) {
                    throw new Error('UserId n√£o fornecido');
                }
                
                // Fechar TODOS os modais antes de abrir perfil completo
                closeAllModals();
                
                // Aguardar um pouco para o modal fechar suavemente
                setTimeout(() => {
                    // Abrir p√°gina completa via ProfileRouter
                    if (typeof ProfileRouter !== 'undefined') {
                        ProfileRouter.showFullProfile(userId);
                        console.log('‚úÖ P√°gina completa aberta via ProfileRouter');
                    } else {
                        console.error('‚ùå ProfileRouter n√£o dispon√≠vel');
                        showToast('Erro: Sistema de perfil n√£o carregado');
                    }
                }, 300); // 300ms para transi√ß√£o suave
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir perfil completo:', error);
                showToast('Erro ao abrir perfil completo: ' + error.message);
            }
        }

        function openUserPostsListModal() {
            const modal = document.getElementById('userProfileModal');
            const userName = modal?.dataset.userName;
            
            if (userName) {
                console.log('üìù Abrindo lista de posts do usu√°rio:', userName);
                showToast(`Posts de ${userName} - Funcionalidade em desenvolvimento`);
            }
        }

        function openUserHolofotesListModal() {
            const modal = document.getElementById('userProfileModal');
            const userName = modal?.dataset.userName;
            
            if (userName) {
                console.log('üèÜ Abrindo lista de holofotes do usu√°rio:', userName);
                showToast(`Holofotes de ${userName} - Funcionalidade em desenvolvimento`);
            }
        }

        function openUserCommentsListModal() {
            const modal = document.getElementById('userProfileModal');
            const userName = modal?.dataset.userName;
            
            if (userName) {
                console.log('üí¨ Abrindo lista de coment√°rios do usu√°rio:', userName);
                showToast(`Coment√°rios de ${userName} - Funcionalidade em desenvolvimento`);
            }
        }

        function openUserReactionsListModal() {
            const modal = document.getElementById('userProfileModal');
            const userName = modal?.dataset.userName;
            
            if (userName) {
                console.log('üëç Abrindo lista de rea√ß√µes do usu√°rio:', userName);
                showToast(`Rea√ß√µes de ${userName} - Funcionalidade em desenvolvimento`);
            }
        }

        function processPostsForUsernames() {
            console.log('üîÑ Processando @username em posts...');
            setTimeout(() => {
                processAllTextContent();
            }, 500);
            // Backup: tentar novamente ap√≥s mais tempo
            setTimeout(() => {
                processAllTextContent();
            }, 2000);
        }

        function processCommentsForUsernames() {
            console.log('üîÑ Processando @username em coment√°rios...');
            setTimeout(() => {
                processAllTextContent();
            }, 100);
        }

        function processNotificationsForUsernames() {
            console.log('üîÑ Processando @username em notifica√ß√µes...');
            setTimeout(() => {
                processAllTextContent();
            }, 100);
            // Backup: tentar novamente ap√≥s mais tempo
            setTimeout(() => {
                processAllTextContent();
            }, 1000);
        }
        
        // Fun√ß√£o para for√ßar processamento manual (para debug)
        function forceProcessUsernames() {
            console.log('üîß FOR√áANDO processamento de @username...');
            
            // Limpar flags de processamento
            document.querySelectorAll('[data-processed="true"]').forEach(element => {
                element.dataset.processed = 'false';
                console.log('üîÑ Limpando flag de processamento:', element.textContent.substring(0, 50));
            });
            
            // Processar novamente
            processAllTextContent();
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function updateStats() {
            const userPosts = posts.filter(p => p.user_id === currentUser.id);
            const userTotalReactions = userPosts.reduce((sum, post) => {
                // Garantir que reactions seja um array
                const reactions = Array.isArray(post.reactions) ? post.reactions : [];
                return sum + reactions.length;
            }, 0);
            const uniquePeople = new Set(userPosts.map(p => p.celebrated_person_name || p.person_name)).size;
            
            // Profile tab stats - verificar se elementos existem
            const postsCountEl = document.getElementById('userPostsCount');
            if (postsCountEl) postsCountEl.textContent = userPosts.length;
            
            const reactionsEl = document.getElementById('userReactionsReceived');
            if (reactionsEl) reactionsEl.textContent = userTotalReactions;
            
            const peopleEl = document.getElementById('userPeopleHighlighted');
            if (peopleEl) peopleEl.textContent = uniquePeople;
            
            const followersEl = document.getElementById('userFollowersCount');
            if (followersEl) followersEl.textContent = followers.length;
            
            // Impact tab stats - verificar se elementos existem
            const totalReactions = posts.reduce((sum, post) => {
                const reactions = Array.isArray(post.reactions) ? post.reactions : [];
                return sum + reactions.length;
            }, 0);
            const estimatedReach = totalReactions * 3 + userPosts.length * 5; // More realistic calculation
            
            const totalReachEl = document.getElementById('totalReachCount');
            if (totalReachEl) totalReachEl.textContent = estimatedReach;
            
            const totalReactionsEl = document.getElementById('totalReactionsCount');
            if (totalReactionsEl) totalReactionsEl.textContent = totalReactions;
            
            const avgReactionsEl = document.getElementById('averageReactionsCount');
            if (avgReactionsEl) avgReactionsEl.textContent = posts.length > 0 ? Math.round(totalReactions / posts.length) : 0;
            
            // Growth calculation (mock for now)
            const growthPercentage = Math.min(userPosts.length * 10, 200);
            const growthEl = document.getElementById('impactGrowthCount');
            if (growthEl) growthEl.textContent = `+${growthPercentage}%`;
            
            // Update progress bars
            updateProgressBars(userPosts.length, totalReactions);
            
            // Update personalized tip
            updatePersonalizedTip(userPosts.length, totalReactions);
            
            // Update simple metrics
            updateSimpleMetrics();
            
            // Update Dashboard de Insights Estrat√©gicos
            updateDashboardInsights();
        }

        // ===== DASHBOARD DE INSIGHTS ESTRAT√âGICOS =====

        async function calculateTrueReciprocity() {
            try {
                console.log('ü§ù Calculando reciprocidade real (algoritmo correto)...');
                
                // Buscar TODOS os posts que EU criei destacando outras pessoas
                const { data: myPosts, error: myPostsError } = await supabase
                    .from('posts')
                    .select('id, mentioned_user_id')
                    .eq('user_id', currentUser.id)
                    .not('mentioned_user_id', 'is', null);

                if (myPostsError || !myPosts) {
                    console.log('‚ö†Ô∏è Erro ao buscar meus posts:', myPostsError);
                    return 0;
                }

                if (myPosts.length === 0) {
                    console.log('üìä Nenhum post destacando pessoas ainda');
                    return 0;
                }

                // Contar men√ß√µes A‚ÜíB (eu para cada pessoa)
                const mentionsAtoB = {};
                myPosts.forEach(post => {
                    const personId = post.mentioned_user_id;
                    mentionsAtoB[personId] = (mentionsAtoB[personId] || 0) + 1;
                });

                console.log('üìä Men√ß√µes que EU fiz (A‚ÜíB):', mentionsAtoB);

                // Para cada pessoa que mencionei, contar men√ß√µes B‚ÜíA (ela para mim)
                const mentionsBtoA = {};
                let numerator = 0; // Œ£ min(x_AB, y_BA)
                let denominator = 0; // Œ£ x_AB

                for (const [personId, countAtoB] of Object.entries(mentionsAtoB)) {
                    // Contar quantas vezes esta pessoa ME mencionou
                    const { data: reciprocalPosts, error: reciprocalError } = await supabase
                        .from('posts')
                        .select('id')
                        .eq('user_id', personId)
                        .eq('mentioned_user_id', currentUser.id);

                    const countBtoA = (!reciprocalError && reciprocalPosts) ? reciprocalPosts.length : 0;
                    mentionsBtoA[personId] = countBtoA;

                    // Aplicar f√≥rmula: r(A,B) = min(x,y) / max(x,y)
                    const minCount = Math.min(countAtoB, countBtoA);
                    const maxCount = Math.max(countAtoB, countBtoA);
                    const pairReciprocity = maxCount > 0 ? (minCount / maxCount) * 100 : 0;

                    console.log(`üë• Par (eu‚Üí${personId}): ${countAtoB} men√ß√µes, (${personId}‚Üíeu): ${countBtoA} men√ß√µes, reciprocidade: ${pairReciprocity.toFixed(1)}%`);

                    // Acumular para √≠ndice geral
                    numerator += minCount;
                    denominator += countAtoB;
                }

                console.log('üìä Men√ß√µes que recebi (B‚ÜíA):', mentionsBtoA);

                // Calcular √≠ndice geral: numerador / denominador
                const generalIndex = denominator > 0 ? (numerator / denominator) * 100 : 0;

                console.log(`üßÆ C√°lculo final: ${numerator}/${denominator} = ${generalIndex.toFixed(1)}%`);
                console.log(`ü§ù Reciprocidade geral calculada: ${generalIndex.toFixed(1)}%`);

                return generalIndex;
            } catch (error) {
                console.error('Erro ao calcular reciprocidade:', error);
                return 0;
            }
        }

        async function calculateEngagementRate() {
            try {
                if (!currentUser || !currentUser.id) return 0;
                
                // Buscar posts do usu√°rio
                const myPosts = posts.filter(post => post.user_id === currentUser.id);
                if (myPosts.length === 0) return 0;
                
                let totalInteractions = 0;
                
                // üöÄ USAR CACHE INTELIGENTE ao inv√©s de requests diretos
                for (const post of myPosts) {
                    // Rea√ß√µes (j√° carregadas nos posts)
                    if (post.reactions && Array.isArray(post.reactions)) {
                        totalInteractions += post.reactions.filter(r => r.user_id !== currentUser.id).length;
                    }
                    
                    // Coment√°rios (usar cache)
                    const cachedComments = commentsCache.get(post.id) || [];
                    totalInteractions += cachedComments.length;
                    
                    // Feedbacks (usar cache)
                    const cachedFeedbacks = feedbacksCache.get(post.id) || [];
                    totalInteractions += cachedFeedbacks.length;
                }
                
                return totalInteractions / myPosts.length;
                
            } catch (error) {
                console.error('Erro ao calcular taxa de engajamento:', error);
                return 0;
            }
        }

        async function calculateAverageImpact() {
            try {
                if (!currentUser || !currentUser.id) return 0;
                
                // Buscar posts do usu√°rio
                const myPosts = posts.filter(post => post.user_id === currentUser.id);
                if (myPosts.length === 0) return 0;

                let totalPessoasQueEngajaram = 0;

                // üöÄ USAR CACHE INTELIGENTE ao inv√©s de requests diretos
                for (const post of myPosts) {
                    const pessoasUnicasDoPost = new Set();

                    // Rea√ß√µes (j√° carregadas nos posts)
                    if (post.reactions && Array.isArray(post.reactions)) {
                        post.reactions.forEach(reaction => {
                            if (reaction.user_id && reaction.user_id !== currentUser.id) {
                                pessoasUnicasDoPost.add(reaction.user_id);
                            }
                        });
                    }

                    // Coment√°rios (usar cache)
                    const cachedComments = commentsCache.get(post.id) || [];
                    cachedComments.forEach(comment => {
                        if (comment.user_id && comment.user_id !== currentUser.id) {
                            pessoasUnicasDoPost.add(comment.user_id);
                        }
                    });

                    // Feedbacks (usar cache)
                    const cachedFeedbacks = feedbacksCache.get(post.id) || [];
                    cachedFeedbacks.forEach(feedback => {
                        if (feedback.mentioned_user_id && feedback.mentioned_user_id !== currentUser.id) {
                            pessoasUnicasDoPost.add(feedback.mentioned_user_id);
                        }
                    });

                    totalPessoasQueEngajaram += pessoasUnicasDoPost.size;
                }

                // M√©dia de pessoas que engajaram por post
                return Math.round(totalPessoasQueEngajaram / myPosts.length);
                
            } catch (error) {
                console.error('Erro ao calcular impacto m√©dio:', error);
                return 0;
            }
        }

        async function calculateEffectiveReach() {
            try {
                // Buscar posts do usu√°rio com contagem de intera√ß√µes
                const userPosts = posts.filter(p => p.user_id === currentUser.id);
                
                let postsWithInteraction = 0;
                
                for (const post of userPosts) {
                    // Verificar se o post tem alguma intera√ß√£o
                    const hasReactions = post.reactions && post.reactions.length > 0;
                    const hasComments = post.comments && post.comments.length > 0;
                    const hasFeedbacks = post.feedbacks && post.feedbacks.length > 0;
                    
                    if (hasReactions || hasComments || hasFeedbacks) {
                        postsWithInteraction++;
                    }
                }

                return userPosts.length > 0 ? (postsWithInteraction / userPosts.length) * 100 : 0;
            } catch (error) {
                console.error('Erro ao calcular alcance efetivo:', error);
                return 0;
            }
        }

        async function calculateNetworkSize() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.warn('‚ö†Ô∏è Usu√°rio n√£o identificado para calcular rede');
                    return 0;
                }
                
                console.log('üîó Calculando rede de engajamento completa...');
                
                // Set para armazenar IDs √∫nicos de pessoas que interagiram
                const networkPeople = new Set();
                
                // 1. PESSOAS QUE EU DESTAQUEI (usando mentioned_user_id)
                const myPosts = posts.filter(post => post.user_id === currentUser.id);
                myPosts.forEach(post => {
                    if (post.mentioned_user_id) {
                        networkPeople.add(post.mentioned_user_id);
                    }
                });
                
                // 2. PESSOAS QUE ME DESTACARAM (posts onde mentioned_user_id √© meu ID)
                posts.forEach(post => {
                    if (post.mentioned_user_id === currentUser.id && post.user_id !== currentUser.id) {
                        networkPeople.add(post.user_id);
                    }
                });
                
                // 3. PESSOAS QUE REAGIRAM AOS MEUS POSTS
                myPosts.forEach(post => {
                    if (post.reactions && Array.isArray(post.reactions)) {
                        post.reactions.forEach(reaction => {
                            if (reaction.user_id && reaction.user_id !== currentUser.id) {
                                networkPeople.add(reaction.user_id);
                            }
                        });
                    }
                });
                
                // 4. PESSOAS EM CUJOS POSTS EU REAGI
                posts.forEach(post => {
                    if (post.user_id !== currentUser.id && post.reactions && Array.isArray(post.reactions)) {
                        const myReaction = post.reactions.find(r => r.user_id === currentUser.id);
                        if (myReaction) {
                            networkPeople.add(post.user_id);
                        }
                    }
                });
                
                // 5. BUSCAR COMENT√ÅRIOS E FEEDBACKS DO BANCO (com timeout)
                try {
                    const myPostIds = myPosts.map(p => p.id);
                    
                    // S√≥ fazer queries se houver posts
                    if (myPostIds.length > 0) {
                        const [commentsGiven, commentsReceived, feedbacksGiven, feedbacksReceived] = await Promise.all([
                            // Coment√°rios que eu fiz
                            withTimeout(
                                supabase.from('comments')
                                    .select('post_id')
                                    .eq('user_id', currentUser.id),
                                3000
                            ),
                            // Coment√°rios nos meus posts
                            withTimeout(
                                supabase.from('comments')
                                    .select('user_id')
                                    .in('post_id', myPostIds),
                                3000
                            ),
                            // Feedbacks que eu dei (onde fui mencionado para dar feedback)
                            withTimeout(
                                supabase.from('feedbacks')
                                    .select('post_id, author_id')
                                    .eq('mentioned_user_id', currentUser.id),
                                3000
                            ),
                            // Feedbacks nos meus posts (pessoas que deram feedback nos meus posts)
                            withTimeout(
                                supabase.from('feedbacks')
                                    .select('mentioned_user_id, post_id')
                                    .in('post_id', myPostIds),
                                3000
                            )
                        ]);
                        
                        // Processar coment√°rios que eu fiz
                        if (commentsGiven.data) {
                            const postIds = commentsGiven.data.map(c => c.post_id);
                            posts.forEach(post => {
                                if (postIds.includes(post.id) && post.user_id !== currentUser.id) {
                                    networkPeople.add(post.user_id);
                                }
                            });
                        }
                        
                        // Processar coment√°rios nos meus posts
                        if (commentsReceived.data) {
                            commentsReceived.data.forEach(comment => {
                                if (comment.user_id && comment.user_id !== currentUser.id) {
                                    networkPeople.add(comment.user_id);
                                }
                            });
                        }
                        
                        // Processar feedbacks que eu dei (onde fui mencionado)
                        if (feedbacksGiven.data) {
                            feedbacksGiven.data.forEach(feedback => {
                                // O author_id √© quem deu o feedback (eu), ent√£o busco o dono do post
                                const post = posts.find(p => p.id === feedback.post_id);
                                if (post && post.user_id !== currentUser.id) {
                                    networkPeople.add(post.user_id);
                                }
                            });
                        }
                        
                        // Processar feedbacks nos meus posts (pessoas mencionadas para dar feedback)
                        if (feedbacksReceived.data) {
                            feedbacksReceived.data.forEach(feedback => {
                                if (feedback.mentioned_user_id && feedback.mentioned_user_id !== currentUser.id) {
                                    networkPeople.add(feedback.mentioned_user_id);
                                }
                            });
                        }
                        
                        console.log('‚úÖ Coment√°rios e feedbacks processados para rede de engajamento');
                        
                    } else {
                        console.log('üìù Nenhum post pr√≥prio encontrado, pulando queries de coment√°rios/feedbacks');
                    }
                    
                } catch (dbError) {
                    console.warn('‚ö†Ô∏è Erro ao buscar coment√°rios/feedbacks para rede:', dbError);
                }
                
                const networkSize = networkPeople.size;
                console.log(`üîó Rede de engajamento calculada: ${networkSize} pessoas √∫nicas`);
                console.log('üë• IDs na rede:', Array.from(networkPeople));
                
                // Log detalhado para debug
                console.log('üìä Detalhamento da rede:');
                console.log(`   üìù Meus posts: ${myPosts.length}`);
                console.log(`   üéØ Pessoas que destaquei: ${myPosts.filter(p => p.mentioned_user_id).length}`);
                console.log(`   üèÜ Posts que me destacaram: ${posts.filter(p => p.mentioned_user_id === currentUser.id).length}`);
                console.log(`   üëç Posts meus com rea√ß√µes: ${myPosts.filter(p => p.reactions && p.reactions.length > 0).length}`);
                console.log(`   üí¨ Posts de outros onde reagi: ${posts.filter(p => p.user_id !== currentUser.id && p.reactions && p.reactions.find(r => r.user_id === currentUser.id)).length}`);
                
                return networkSize;
                
            } catch (error) {
                console.error('‚ùå Erro ao calcular rede de engajamento:', error);
                return 0;
            }
        }

        function calculateAltruismIndex() {
            const holofotesRecebidos = parseInt(document.getElementById('userHolofotesReceived')?.textContent || '0');
            const holofotesDados = parseInt(document.getElementById('userPostsCount')?.textContent || '0');
            
            if (holofotesDados === 0) return { 
                value: "0:0", 
                message: "Sem dados", 
                type: "balanced",
                given: 0,
                received: 0
            };
            
            const ratio = holofotesRecebidos / holofotesDados;
            
            if (ratio > 1.2) {
                const multiplier = (holofotesRecebidos / holofotesDados).toFixed(1);
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: `Voc√™ recebe ${multiplier}x mais do que d√°`,
                    type: "received",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            } else if (ratio < 0.8) {
                const multiplier = (holofotesDados / holofotesRecebidos).toFixed(1);
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: `Voc√™ d√° ${multiplier}x mais do que recebe`,
                    type: "giving",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            } else {
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: "Voc√™ d√° e recebe quase igualmente",
                    type: "balanced",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            }
        }

        async function updateDashboardInsights() {
            try {
                console.log('üìä Atualizando Dashboard de Insights...');
                
                // Aguardar Chart.js carregar se necess√°rio
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 10) {
                    console.log(`üîÑ Aguardando Chart.js carregar... (tentativa ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof Chart === 'undefined') {
                    console.warn('‚ö†Ô∏è Chart.js n√£o carregou ap√≥s 5 segundos - continuando sem visualiza√ß√µes');
                } else {
                    console.log('‚úÖ Chart.js carregado com sucesso');
                }
                
                // Calcular todas as m√©tricas
                const reciprocity = await calculateTrueReciprocity();
                const engagement = await calculateEngagementRate(); // Agora √© async
                const impact = await calculateAverageImpact();
                const reach = await calculateEffectiveReach();
                const network = await calculateNetworkSize();
                const altruism = calculateAltruismIndex();
                
                // Atualizar valores na interface
                const reciprocityValueEl = document.getElementById('reciprocityValue');
                if (reciprocityValueEl) reciprocityValueEl.textContent = `${reciprocity.toFixed(0)}%`;
                
                const engagementValueEl = document.getElementById('engagementValue');
                if (engagementValueEl) engagementValueEl.textContent = `${engagement.toFixed(1)}/post`;
                
                const impactValueEl = document.getElementById('impactValue');
                if (impactValueEl) impactValueEl.textContent = `${impact}/post`;
                
                const reachValueEl = document.getElementById('reachValue');
                if (reachValueEl) reachValueEl.textContent = `${reach.toFixed(0)}%`;
                
                const networkValueEl = document.getElementById('networkSize');
                if (networkValueEl) networkValueEl.textContent = network;
                
                const altruismValueEl = document.getElementById('altruismValue');
                const altruismMessageEl = document.getElementById('altruismMessage');
                if (altruismValueEl) altruismValueEl.textContent = altruism.value;
                if (altruismMessageEl) altruismMessageEl.textContent = altruism.message;
                
                // Criar visualiza√ß√µes (apenas se Chart.js estiver dispon√≠vel)
                if (typeof Chart !== 'undefined') {
                    createReciprocityGauge(reciprocity);
                    updateEngagementValue(engagement);
                    // Impact now shows only number, no chart needed
                    createReachChart(reach, 100 - reach);
                    createAltruismChart(altruism.given, altruism.received);
                    createEvolutionChart(); // Gr√°fico temporal com dados mock
                } else {
                    console.warn('‚ö†Ô∏è Pulando visualiza√ß√µes Chart.js - biblioteca n√£o dispon√≠vel');
                }
                
                // Gerar insights personalizados
                const insights = generatePersonalizedInsights({
                    reciprocity,
                    engagement,
                    impact: parseFloat(impact),
                    reach,
                    network,
                    altruism
                });
                
                const insightsEl = document.getElementById('personalizedInsights');
                if (insightsEl) {
                    insightsEl.innerHTML = insights.map(insight => `‚Ä¢ ${insight}`).join('<br>');
                }
                
                console.log('‚úÖ Dashboard de Insights atualizado');
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar Dashboard de Insights:', error);
            }
        }

        // ===== FUN√á√ïES DE VISUALIZA√á√ÉO CHART.JS =====

        function createReciprocityGauge(value) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('reciprocityChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create linear gradient positioned to follow arc direction (bottom to top)
            const gradient = ctx.createLinearGradient(60, 120, 60, 0);
            gradient.addColorStop(0, '#ff6600'); // 100% Orange at bottom (start)
            gradient.addColorStop(1, '#9c27b0'); // 100% Purple at top (end)
            
            // Destruir chart existente se houver
            if (window.reciprocityChartInstance) {
                window.reciprocityChartInstance.destroy();
            }
            
            window.reciprocityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Retribu√≠dos', 'N√£o retribu√≠dos'],
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: [
                            gradient, // Orange to Purple gradient
                            '#f0f0f0'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                title: function() {
                                    return 'Holofotes';
                                },
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateEngagementValue(rate) {
            const valueEl = document.getElementById('engagementValue');
            if (valueEl) valueEl.textContent = `${rate.toFixed(1)}/post`;
        }

        function createAltruismChart(given, received) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('altruismChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destruir chart existente se houver
            if (window.altruismChartInstance) {
                window.altruismChartInstance.destroy();
            }
            
            window.altruismChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Dados', 'Recebidos'],
                    datasets: [{
                        data: [given, received],
                        backgroundColor: [
                            '#ff8c00', // Orange (same as evolution chart)
                            '#9c27b0'  // Purple (same as evolution chart)
                        ],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                title: function() {
                                    return 'Holofotes';
                                },
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        function createReachChart(effective, ineffective) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('reachChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create linear gradient positioned to follow arc direction (bottom to top)
            const gradient = ctx.createLinearGradient(60, 120, 60, 0);
            gradient.addColorStop(0, '#ff6600'); // 100% Orange at bottom (start)
            gradient.addColorStop(1, '#9c27b0'); // 100% Purple at top (end)
            
            // Destruir chart existente se houver
            if (window.reachChartInstance) {
                window.reachChartInstance.destroy();
            }
            
            window.reachChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Com Intera√ß√£o', 'Sem Intera√ß√£o'],
                    datasets: [{
                        data: [effective, ineffective],
                        backgroundColor: [gradient, '#f0f0f0'], // Orange to Purple gradient
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                title: function() {
                                    return 'Posts';
                                },
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Vari√°vel para controlar cria√ß√£o de chart
        let isCreatingChart = false;
        

        async function createEvolutionChart() {
            // üöÄ Debounce: evitar m√∫ltiplas chamadas simult√¢neas
            if (isCreatingChart) {
                console.log('‚è≥ Chart j√° est√° sendo criado, ignorando chamada...');
                return;
            }
            isCreatingChart = true;
            
            try {
                const canvas = document.getElementById('evolutionChart');
                if (!canvas) {
                    console.error('‚ùå Canvas evolutionChart n√£o encontrado');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                // Destruir chart existente se houver
                if (window.evolutionChartInstance) {
                    window.evolutionChartInstance.destroy();
                    window.evolutionChartInstance = null;
                    console.log('üóëÔ∏è Chart anterior destru√≠do');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // üöÄ BUSCAR DADOS REAIS ao inv√©s de mock
                let chartData = {
                    dates: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    posts: [0, 0, 0, 0],
                    holofotes: [0, 0, 0, 0]
                };
                
                try {
                    if (currentUser && currentUser.id) {
                        // Buscar posts do usu√°rio nas √∫ltimas 4 semanas
                        const fourWeeksAgo = new Date();
                        fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
                        
                        const { data: userPosts, error: postsError } = await supabase
                            .from('posts')
                            .select('created_at')
                            .eq('user_id', currentUser.id)
                            .gte('created_at', fourWeeksAgo.toISOString());
                        
                        // Buscar holofotes recebidos (posts que mencionaram o usu√°rio) nas √∫ltimas 4 semanas
                        const { data: holofotsData, error: holofotesError } = await supabase
                            .from('posts')
                            .select('created_at')
                            .eq('mentioned_user_id', currentUser.id)
                            .gte('created_at', fourWeeksAgo.toISOString());
                        
                        if (!postsError && !holofotesError) {
                            // Organizar dados por semana
                            const weeks = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
                            const postsPerWeek = [0, 0, 0, 0];
                            const holofotesPerWeek = [0, 0, 0, 0];
                            
                            // Contar posts por semana
                            if (userPosts) {
                                userPosts.forEach(post => {
                                    const postDate = new Date(post.created_at);
                                    const weekIndex = Math.floor((Date.now() - postDate.getTime()) / (7 * 24 * 60 * 60 * 1000));
                                    if (weekIndex >= 0 && weekIndex < 4) {
                                        postsPerWeek[3 - weekIndex]++; // Inverter ordem (mais recente √† direita)
                                    }
                                });
                            }
                            
                            // Contar holofotes por semana
                            if (holofotsData) {
                                holofotsData.forEach(post => {
                                    const postDate = new Date(post.created_at);
                                    const weekIndex = Math.floor((Date.now() - postDate.getTime()) / (7 * 24 * 60 * 60 * 1000));
                                    if (weekIndex >= 0 && weekIndex < 4) {
                                        holofotesPerWeek[3 - weekIndex]++; // Inverter ordem (mais recente √† direita)
                                    }
                                });
                            }
                            
                            chartData = {
                                dates: weeks,
                                posts: postsPerWeek,
                                holofotes: holofotesPerWeek
                            };
                            
                            console.log('‚úÖ Dados reais carregados para gr√°fico de evolu√ß√£o:', chartData);
                        } else {
                            console.warn('‚ö†Ô∏è Erro ao buscar dados, usando mock:', postsError || holofotesError);
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar dados do gr√°fico, usando mock:', error);
                }
                
                // Criar gr√°fico
                window.evolutionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.dates,
                        datasets: [{
                            label: 'Posts Criados',
                            data: chartData.posts,
                            borderColor: '#E55A2B',
                            backgroundColor: 'rgba(229, 90, 43, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Holofotes Recebidos',
                            data: chartData.holofotes,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true },
                            x: { }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de evolu√ß√£o criado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de evolu√ß√£o:', error);
            } finally {
                isCreatingChart = false;
            }
        }

        function generatePersonalizedInsights(metrics) {
            const insights = [];

            // Reciprocidade - 3 faixas
            if (metrics.reciprocity >= 70) {
                insights.push("üéâ Excelente! Voc√™ tem alta reciprocidade na sua rede!");
            } else if (metrics.reciprocity >= 40) {
                insights.push("üëç Boa reciprocidade! Algumas pessoas retribuem seus destaques.");
            } else {
                insights.push("üí° Dica: Destaque mais pessoas para aumentar sua reciprocidade.");
            }

            // Engajamento - 3 faixas
            if (metrics.engagement >= 2.0) {
                insights.push("üöÄ Seus posts t√™m alto engajamento! Continue assim.");
            } else if (metrics.engagement >= 1.0) {
                insights.push("üìä Engajamento moderado. Seus posts est√£o gerando algumas intera√ß√µes.");
            } else {
                insights.push("üìà Tente criar posts mais envolventes para aumentar intera√ß√µes.");
            }

            // Impacto - 3 faixas
            if (metrics.impact >= 2.0) {
                insights.push("üåü Voc√™ est√° impactando muitas pessoas diferentes!");
            } else if (metrics.impact >= 1.0) {
                insights.push("üéØ Bom impacto! Voc√™ est√° alcan√ßando pessoas diversas.");
            } else {
                insights.push("üå± Foque em criar conte√∫do que ressoe com mais pessoas.");
            }

            // Alcance - 3 faixas
            if (metrics.reach >= 60) {
                insights.push("‚ö° Excelente alcance! A maioria dos seus posts gera intera√ß√£o.");
            } else if (metrics.reach >= 30) {
                insights.push("üìà Alcance moderado. Metade dos seus posts gera engajamento.");
            } else {
                insights.push("üìä Poucos posts est√£o gerando intera√ß√£o. Analise o que funciona melhor.");
            }

            // Rede - 3 faixas
            if (metrics.network >= 15) {
                insights.push("üîó Voc√™ tem uma rede de engajamento robusta!");
            } else if (metrics.network >= 5) {
                insights.push("üåê Sua rede est√° crescendo bem! Continue expandindo conex√µes.");
            } else {
                insights.push("üå± Sua rede est√° no in√≠cio. Continue destacando e interagindo!");
            }

            // Altru√≠smo - sempre gera insight gen√©rico motivacional
            if (metrics.altruism.type === "giving") {
                insights.push("üíù Voc√™ √© muito altru√≠sta! Continue espalhando holofotes.");
            } else if (metrics.altruism.type === "received") {
                insights.push("üèÜ Voc√™ √© muito reconhecido pela comunidade!");
            } else {
                insights.push("‚öñÔ∏è Voc√™ tem um equil√≠brio perfeito entre dar e receber!");
            }

            // Garantir m√≠nimo de 3 insights
            if (insights.length < 3) {
                insights.push("üéØ Continue usando o HoloSpot para desenvolver sua presen√ßa!");
                insights.push("üìä Cada intera√ß√£o contribui para o crescimento da comunidade!");
            }

            return insights;
        }

        function updateProgressBars(postsCount, reactionsCount) {
            // First highlight achievement
            const firstProgress = Math.min(postsCount / 1 * 100, 100);
            const firstProgressEl = document.getElementById('firstHighlightProgress');
            if (firstProgressEl) firstProgressEl.style.width = firstProgress + '%';
            const firstTextEl = document.getElementById('firstHighlightText');
            if (firstTextEl) firstTextEl.textContent = `${Math.min(postsCount, 1)}/1`;
            
            // Multiplier achievement
            const multiplierValue = 1.0 + (Math.min(postsCount, 10) * 0.1);
            const multiplierProgress = Math.min(postsCount / 10 * 100, 100);
            const multiplierProgressEl = document.getElementById('multiplierProgress');
            if (multiplierProgressEl) multiplierProgressEl.style.width = multiplierProgress + '%';
            const multiplierTextEl = document.getElementById('multiplierText');
            if (multiplierTextEl) multiplierTextEl.textContent = `${multiplierValue.toFixed(1)}x`;
            
            // Inspirer achievement
            const inspirerProgress = Math.min(reactionsCount / 50 * 100, 100);
            const inspirerProgressEl = document.getElementById('inspirerProgress');
            if (inspirerProgressEl) inspirerProgressEl.style.width = inspirerProgress + '%';
            const inspirerTextEl = document.getElementById('inspirerText');
            if (inspirerTextEl) inspirerTextEl.textContent = `${Math.min(reactionsCount, 50)}/50`;
            
            // Monthly goal
            const monthlyProgress = Math.min(postsCount / 20 * 100, 100);
            const monthlyProgressEl = document.getElementById('monthlyGoalProgress');
            if (monthlyProgressEl) monthlyProgressEl.style.width = monthlyProgress + '%';
            const monthlyTextEl = document.getElementById('monthlyGoalText');
            if (monthlyTextEl) monthlyTextEl.textContent = `${Math.min(postsCount, 20)}/20`;
            
            // Engagement
            const engagementRate = postsCount > 0 ? Math.min((reactionsCount / postsCount) * 10, 100) : 0;
        }

        // Fun√ß√£o para atualizar barras de progresso do streak
        function updateStreakProgressBars(currentStreak) {
            console.log('üî• Atualizando barras de progresso do streak:', currentStreak);
            
            // Barra 7 dias
            const progress7 = Math.min(currentStreak / 7 * 100, 100);
            const progressEl7 = document.getElementById('engagementStreakProgress7');
            if (progressEl7) progressEl7.style.width = progress7 + '%';
            const textEl7 = document.getElementById('engagementStreakText7');
            if (textEl7) textEl7.textContent = `${Math.min(currentStreak, 7)}/7`;
            
            // Barra 30 dias
            const progress30 = Math.min(currentStreak / 30 * 100, 100);
            const progressEl30 = document.getElementById('engagementStreakProgress30');
            if (progressEl30) progressEl30.style.width = progress30 + '%';
            const textEl30 = document.getElementById('engagementStreakText30');
            if (textEl30) textEl30.textContent = `${Math.min(currentStreak, 30)}/30`;
            
            // Barra 182 dias
            const progress182 = Math.min(currentStreak / 182 * 100, 100);
            const progressEl182 = document.getElementById('engagementStreakProgress182');
            if (progressEl182) progressEl182.style.width = progress182 + '%';
            const textEl182 = document.getElementById('engagementStreakText182');
            if (textEl182) textEl182.textContent = `${Math.min(currentStreak, 182)}/182`;
            
            // Barra 365 dias
            const progress365 = Math.min(currentStreak / 365 * 100, 100);
            const progressEl365 = document.getElementById('engagementStreakProgress365');
            if (progressEl365) progressEl365.style.width = progress365 + '%';
            const textEl365 = document.getElementById('engagementStreakText365');
            if (textEl365) textEl365.textContent = `${Math.min(currentStreak, 365)}/365`;
        }

        function updatePersonalizedTip(postsCount, reactionsCount) {
            let tip = '';
            
            if (postsCount === 0) {
                tip = 'Comece destacando algu√©m especial! Cada pessoa merece reconhecimento pelo que faz de bom.';
            } else if (postsCount < 5) {
                tip = 'Voc√™ est√° no caminho certo! Continue destacando pessoas que fazem a diferen√ßa na sua vida.';
            } else if (reactionsCount < postsCount * 2) {
                tip = 'Seus posts est√£o inspirando pessoas! Tente adicionar fotos para aumentar o engajamento.';
            } else {
                tip = 'Incr√≠vel! Voc√™ est√° criando uma onda de positividade. Continue espalhando reconhecimento!';
            }
            
            const tipEl = document.getElementById('personalizedTip');
            if (tipEl) tipEl.textContent = tip;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return 'Agora mesmo';
            } else if (diffInMinutes < 60) {
                return `H√° ${diffInMinutes} minuto${diffInMinutes > 1 ? 's' : ''}`;
            } else if (diffInMinutes < 1440) { // 24 hours
                const hours = Math.floor(diffInMinutes / 60);
                return `H√° ${hours} hora${hours > 1 ? 's' : ''}`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `H√° ${days} dia${days > 1 ? 's' : ''}`;
            }
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return 'agora';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes}m`;
            } else if (diffInMinutes < 1440) { // 24 hours
                const hours = Math.floor(diffInMinutes / 60);
                return `${hours}h`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `${days}d`;
            }
        }

        async function showFollowingModal(userId = null) {
            console.log('üë• Abrindo modal de seguindo...', userId ? `para usu√°rio: ${userId}` : 'para usu√°rio atual');
            
            // Verificar se j√° existe modal de seguindo e fechar apenas ele
            const existingFollowingModal = document.getElementById('followingModal');
            if (existingFollowingModal) {
                console.log('‚ö†Ô∏è Modal de seguindo j√° existe, fechando antes de abrir novo');
                existingFollowingModal.remove();
            }
            
            // Determinar qual lista de seguindo usar
            let followingData;
            if (userId && userId !== currentUser.id) {
                // Buscar seguindo de outro usu√°rio
                const { data: userFollowing, error } = await supabase
                    .from('follows')
                    .select('following_id')
                    .eq('follower_id', userId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar seguindo:', error);
                    return;
                }
                followingData = (userFollowing || []).map(f => ({ following_id: f.following_id }));
            } else {
                // Usar lista do usu√°rio atual
                followingData = following;
            }
            
            const followingList = await Promise.all(followingData.map(async f => {
                // Tentar buscar dados reais do usu√°rio incluindo avatar e username
                let userName = 'Usu√°rio';
                let userAvatar = '';
                let username = 'usuario';
                
                try {
                    const userQuery = supabase
                        .from('profiles')
                        .select('name, email, avatar_url, username')
                        .eq('id', f.following_id)
                        .single();
                    
                    const { data: userData } = await withTimeout(userQuery, 1000);
                    if (userData) {
                        userName = userData.name || userData.email || 'Usu√°rio';
                        username = userData.username || (userData.email ? userData.email.split('@')[0] : 'usuario');
                        userAvatar = userData.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                    } else {
                        // Fallback com nome baseado no ID
                        const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                        const usernames = ['ana.silva', 'joao.santos', 'maria.oliveira', 'pedro.costa', 'carla.mendes', 'lucas.ferreira'];
                        const nameIndex = f.following_id.charCodeAt(0) % names.length;
                        userName = names[nameIndex];
                        username = usernames[nameIndex];
                        userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                    }
                } catch (error) {
                    // Fallback com nome baseado no ID
                    const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                    const usernames = ['ana.silva', 'joao.santos', 'maria.oliveira', 'pedro.costa', 'carla.mendes', 'lucas.ferreira'];
                    const nameIndex = f.following_id.charCodeAt(0) % names.length;
                    userName = names[nameIndex];
                    username = usernames[nameIndex];
                    userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                }
                
                // Verificar se √© o pr√≥prio usu√°rio logado
                const isCurrentUser = f.following_id === currentUser.id;
                
                return `
                    <div class="follow-item">
                        <img src="${userAvatar}" 
                             alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                        ${isCurrentUser ? 
                            `<span style="color: #666;">@${username} (Voc√™)</span>` :
                            `<span class="username-clickable" data-user-id="${f.following_id}" data-user-name="${userName}" data-user-avatar="${userAvatar}" style="cursor: pointer; color: #007bff; text-decoration: none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">@${username}</span>`
                        }
                    </div>
                `;
            }));
            
            const modal = `
                <div id="followingModal" class="modal-overlay" onclick="closeFollowingModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Seguindo (${followingData.length})</h3>
                            <button class="modal-close" onclick="closeFollowingModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="follow-list">
                                ${followingList.length > 0 ? followingList.join('') : '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Voc√™ ainda n√£o segue ningu√©m.</p></div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Adicionar modal √† pilha para gerenciar ESC
            addModalToStack('followingModal', closeFollowingModal);
            
            // Adicionar event listeners para os usernames clic√°veis
            setTimeout(() => {
                const clickableUsernames = document.querySelectorAll('#followingModal .username-clickable');
                clickableUsernames.forEach(element => {
                    element.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        const userName = this.getAttribute('data-user-name');
                        const userAvatar = this.getAttribute('data-user-avatar');
                        
                        console.log('üë§ Clique no username do modal Seguindo:', { userId, userName, userAvatar });
                        
                        // Abrir perfil do usu√°rio (sem fechar modal)
                        openUserProfileByIdKeepingModals(userId);
                    });
                });
            }, 100);
        }

        async function showFollowersModal(userId = null) {
            console.log('üë• Abrindo modal de seguidores...', userId ? `para usu√°rio: ${userId}` : 'para usu√°rio atual');
            
            // Verificar se j√° existe modal de seguidores e fechar apenas ele
            const existingFollowersModal = document.getElementById('followersModal');
            if (existingFollowersModal) {
                console.log('‚ö†Ô∏è Modal de seguidores j√° existe, fechando antes de abrir novo');
                existingFollowersModal.remove();
            }
            
            // Determinar qual lista de seguidores usar
            let followersData;
            if (userId && userId !== currentUser.id) {
                // Buscar seguidores de outro usu√°rio
                const { data: userFollowers, error } = await supabase
                    .from('follows')
                    .select('follower_id')
                    .eq('following_id', userId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar seguidores:', error);
                    return;
                }
                followersData = (userFollowers || []).map(f => ({ follower_id: f.follower_id }));
            } else {
                // Usar lista do usu√°rio atual
                followersData = followers;
            }
            
            const followersList = await Promise.all(followersData.map(async f => {
                // Tentar buscar dados reais do usu√°rio incluindo avatar e username
                let userName = 'Usu√°rio';
                let userAvatar = '';
                let username = 'usuario';
                
                try {
                    const userQuery = supabase
                        .from('profiles')
                        .select('name, email, avatar_url, username')
                        .eq('id', f.follower_id)
                        .single();
                    
                    const { data: userData } = await withTimeout(userQuery, 1000);
                    if (userData) {
                        userName = userData.name || userData.email || 'Usu√°rio';
                        username = userData.username || (userData.email ? userData.email.split('@')[0] : 'usuario');
                        userAvatar = userData.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                    } else {
                        // Fallback com nome baseado no ID
                        const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                        const usernames = ['ana.silva', 'joao.santos', 'maria.oliveira', 'pedro.costa', 'carla.mendes', 'lucas.ferreira'];
                        const nameIndex = f.follower_id.charCodeAt(0) % names.length;
                        userName = names[nameIndex];
                        username = usernames[nameIndex];
                        userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                    }
                } catch (error) {
                    // Fallback com nome baseado no ID
                    const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                    const usernames = ['ana.silva', 'joao.santos', 'maria.oliveira', 'pedro.costa', 'carla.mendes', 'lucas.ferreira'];
                    const nameIndex = f.follower_id.charCodeAt(0) % names.length;
                    userName = names[nameIndex];
                    username = usernames[nameIndex];
                    userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                }
                
                // Verificar se √© o pr√≥prio usu√°rio logado
                const isCurrentUser = f.follower_id === currentUser.id;
                
                return `
                    <div class="follow-item">
                        <img src="${userAvatar}" 
                             alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                        ${isCurrentUser ? 
                            `<span style="color: #666;">@${username} (Voc√™)</span>` :
                            `<span class="username-clickable" data-user-id="${f.follower_id}" data-user-name="${userName}" data-user-avatar="${userAvatar}" style="cursor: pointer; color: #007bff; text-decoration: none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">@${username}</span>`
                        }
                    </div>
                `;
            }));
            
            const modal = `
                <div id="followersModal" class="modal-overlay" onclick="closeFollowersModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Seguidores (${followersData.length})</h3>
                            <button class="modal-close" onclick="closeFollowersModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="follow-list">
                                ${followersList.length > 0 ? followersList.join('') : '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>Voc√™ ainda n√£o tem seguidores.</p></div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Adicionar modal √† pilha para gerenciar ESC
            addModalToStack('followersModal', closeFollowersModal);
            
            // Adicionar event listeners para os usernames clic√°veis
            setTimeout(() => {
                const clickableUsernames = document.querySelectorAll('#followersModal .username-clickable');
                clickableUsernames.forEach(element => {
                    element.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        const userName = this.getAttribute('data-user-name');
                        const userAvatar = this.getAttribute('data-user-avatar');
                        
                        console.log('üë§ Clique no username do modal Seguidores:', { userId, userName, userAvatar });
                        
                        // Abrir perfil do usu√°rio (sem fechar modal)
                        openUserProfileByIdKeepingModals(userId);
                    });
                });
            }, 100);
        }

        function closeModal() {
            // Fechar modais tempor√°rios de notifica√ß√£o primeiro
            const tempModals = ['tempPostsModal', 'tempHolofotesModal'];
            tempModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }
            });
            
            // Close dynamic modals (remove from DOM) - MAS N√ÉO OS MODAIS DE IMPACTO, CONQUISTAS, SEGUINDO E SEGUIDORES
            const dynamicModal = document.querySelector('.modal-overlay:not(#impactModal):not(#achievementsModal):not(#levelsModal):not(#progressModal):not(#followingModal):not(#followersModal)');
            if (dynamicModal) {
                dynamicModal.remove();
            }
            
            // Close static modals (hide with display: none)
            const staticModals = ['postsReceivedModal', 'commentsReceivedModal', 'feedbacksReceivedModal', 'holofotesRecebidosModal', 'pessoasQueTeDestacaramModal', 'impactModal', 'achievementsModal', 'levelsModal', 'progressModal'];
            staticModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    // Remover da pilha ESC se estiver l√°
                    removeModalFromStack(modalId);
                }
            });
        }

        function closeFollowingModal() {
            const modal = document.getElementById('followingModal');
            if (modal) {
                modal.remove();
                removeModalFromStack('followingModal');
            }
        }

        function closeFollowersModal() {
            const modal = document.getElementById('followersModal');
            if (modal) {
                modal.remove();
                removeModalFromStack('followersModal');
            }
        }

        // Fun√ß√µes para abrir modais de seguindo/seguidores de outros usu√°rios
        async function openFollowingModal(userId) {
            await showFollowingModal(userId);
        }

        async function openFollowersModal(userId) {
            await showFollowersModal(userId);
        }

        // Fun√ß√µes auxiliares que fecham modais antes de navegar para perfil
        function closeAllModals() {
            // Fechar modais din√¢micos (removidos do DOM)
            const dynamicModals = document.querySelectorAll('.modal-overlay');
            dynamicModals.forEach(modal => {
                // N√£o fechar modais de impacto, conquistas, n√≠veis e progresso
                if (!['impactModal', 'achievementsModal', 'levelsModal', 'progressModal'].includes(modal.id)) {
                    modal.remove();
                }
            });
            
            // Fechar modais tempor√°rios de notifica√ß√£o
            const tempModals = ['tempPostsModal', 'tempHolofotesModal'];
            tempModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }
            });
            
            // Fechar modais est√°ticos (ocultar com display: none)
            const staticModals = ['postsReceivedModal', 'commentsReceivedModal', 'feedbacksReceivedModal', 'holofotesRecebidosModal', 'pessoasQueTeDestacaramModal', 'postsModal', 'singlePostModal'];
            staticModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Fechar modais espec√≠ficos
            closeFollowingModal();
            closeFollowersModal();
            closePostsModal();
            closeUserProfileModal();
            
            console.log('üîÑ Todos os modais foram fechados');
        }

        // Fun√ß√µes para navegar entre perfis SEM fechar modais (para cliques em @)
        function openUserProfileKeepingModals(username) {
            // Navegar para o perfil sem fechar modais
            openUserProfile(username);
        }

        function openUserProfileByIdKeepingModals(userId) {
            // Navegar para o perfil sem fechar modais
            openUserProfileById(userId);
        }

        // Fun√ß√µes para navegar fechando modais (para bot√£o "Visualizar perfil completo")
        function openUserProfileFromModal(username) {
            // Fechar TODOS os modais antes de navegar
            closeAllModals();
            // Navegar para o perfil
            openUserProfile(username);
        }

        function openUserProfileByIdFromModal(userId) {
            // Fechar TODOS os modais antes de navegar
            closeAllModals();
            // Navegar para o perfil
            openUserProfileById(userId);
        }

        // ===== FUN√á√ïES PARA P√ÅGINA DO USU√ÅRIO =====
        
        // Fun√ß√£o para carregar contagem de emblemas conquistados
        async function loadUserAchievementsCount(userId) {
            try {
                console.log('üèÜ Carregando contagem de emblemas para usu√°rio:', userId);
                
                // Usar a mesma fun√ß√£o que j√° existe para buscar dados de gamifica√ß√£o
                const { data, error } = await supabase.rpc('get_user_gamification_data', {
                    p_user_id: userId
                });
                
                if (error) {
                    console.error('‚ùå Erro ao buscar dados de gamifica√ß√£o:', error);
                    return;
                }
                
                const badgesCount = data?.badges ? data.badges.length : 0;
                console.log(`üìä Usu√°rio tem ${badgesCount} emblemas`);
                
                // Atualizar contador no card
                const countElement = document.getElementById('userAchievementsCount');
                if (countElement) {
                    countElement.textContent = badgesCount;
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar contagem de emblemas:', error);
            }
        }
        
        // Fun√ß√£o para abrir modal de emblemas de outro usu√°rio (modal separado)
        async function openUserAchievementsModal(userId) {
            try {
                console.log('üèÜ Abrindo modal de emblemas para usu√°rio:', userId);
                
                // Buscar dados completos de gamifica√ß√£o do usu√°rio
                const { data, error } = await supabase.rpc('get_user_gamification_data', {
                    p_user_id: userId
                });
                
                if (error) {
                    console.error('‚ùå Erro ao buscar dados de gamifica√ß√£o:', error);
                    showToast('Erro ao carregar emblemas');
                    return;
                }
                
                // Buscar username do usu√°rio para personalizar t√≠tulo
                const { data: userData, error: userError } = await supabase
                    .from('profiles')
                    .select('name, username')
                    .eq('id', userId)
                    .single();
                
                const userName = userData?.name || userData?.username || 'Usu√°rio';
                const userUsername = userData?.username || userName;
                
                // Criar modal separado para n√£o afetar o modal original da aba Perfil
                let userBadgesModal = document.getElementById('userBadgesModal');
                if (!userBadgesModal) {
                    userBadgesModal = document.createElement('div');
                    userBadgesModal.id = 'userBadgesModal';
                    userBadgesModal.style.cssText = `
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 10000;
                        align-items: center;
                        justify-content: center;
                        padding: 1rem;
                    `;
                    document.body.appendChild(userBadgesModal);
                }
                
                // Criar conte√∫do do modal focado apenas em badges
                userBadgesModal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h2 style="margin: 0; font-size: 1.5rem;">üéñÔ∏è Emblemas de @${userUsername}</h2>
                            <button class="close-btn" onclick="closeUserBadgesModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            ${data.badges && data.badges.length > 0 ? 
                                `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                    ${data.badges.map(badge => `
                                        <div class="badge-card" style="background: white; border: 2px solid ${getBadgeRarityColor(badge.rarity)}; border-radius: 12px; padding: 15px; text-align: center; transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                            <div style="font-size: 32px; margin-bottom: 8px;">${badge.icon}</div>
                                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${badge.name}</div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${badge.description}</div>
                                            <div style="font-size: 10px; color: ${getBadgeRarityColor(badge.rarity)}; font-weight: bold; text-transform: uppercase;">${badge.rarity}</div>
                                            <div style="font-size: 10px; color: #999; margin-top: 4px;">${formatDate(badge.earned_at)}</div>
                                        </div>
                                    `).join('')}
                                </div>` :
                                `<div style="text-align: center; padding: 40px; color: #666;">
                                    <div style="font-size: 48px; margin-bottom: 16px;">üèÜ</div>
                                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhum emblema conquistado</div>
                                    <div style="font-size: 14px;">@${userUsername} ainda n√£o conquistou nenhum emblema.</div>
                                </div>`
                            }
                        </div>
                    </div>
                `;
                
                // Mostrar modal
                userBadgesModal.style.display = 'flex';
                
                console.log(`‚úÖ Modal de emblemas aberto para @${userUsername} com ${data.badges?.length || 0} badges`);
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de emblemas:', error);
                showToast('Erro ao carregar emblemas');
            }
        }
        
        // Fun√ß√£o para fechar modal de badges do usu√°rio
        function closeUserBadgesModal() {
            const modal = document.getElementById('userBadgesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para verificar status de seguir
        async function checkUserFollowStatus(userId) {
            try {
                console.log('üë• Verificando status de seguir para usu√°rio:', userId);
                
                // N√£o mostrar bot√£o para o pr√≥prio usu√°rio
                if (userId === currentUser.id) {
                    const followButton = document.getElementById('followButton');
                    if (followButton) {
                        followButton.style.display = 'none';
                    }
                    return;
                }
                
                // Verificar se j√° est√° seguindo
                const { data, error } = await supabase
                    .from('follows')
                    .select('id')
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .single();
                
                const isFollowing = !!data;
                console.log(`üìä Status de seguir: ${isFollowing ? 'Seguindo' : 'N√£o seguindo'}`);
                
                // Atualizar bot√£o
                const followButton = document.getElementById('followButton');
                const followButtonText = document.getElementById('followButtonText');
                
                if (followButton && followButtonText) {
                    followButton.dataset.isFollowing = isFollowing;
                    followButton.dataset.userId = userId;
                    
                    if (isFollowing) {
                        followButton.style.background = '#28a745';
                        followButtonText.textContent = 'Seguindo';
                    } else {
                        followButton.style.background = '#007bff';
                        followButtonText.textContent = 'Seguir';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar status de seguir:', error);
            }
        }
        
        // Fun√ß√£o para alternar seguir/deixar de seguir usu√°rio
        async function toggleUserFollow(userId) {
            try {
                const followButton = document.getElementById('followButton');
                const followButtonText = document.getElementById('followButtonText');
                
                if (!followButton || !followButtonText) return;
                
                const isFollowing = followButton.dataset.isFollowing === 'true';
                console.log(`üë• ${isFollowing ? 'Deixando de seguir' : 'Seguindo'} usu√°rio:`, userId);
                
                // Desabilitar bot√£o temporariamente
                followButton.disabled = true;
                followButtonText.textContent = 'Processando...';
                
                if (isFollowing) {
                    // Deixar de seguir
                    const { error } = await supabase
                        .from('follows')
                        .delete()
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', userId);
                    
                    if (error) throw error;
                    
                    // Atualizar UI
                    followButton.dataset.isFollowing = 'false';
                    followButton.style.background = '#007bff';
                    followButtonText.textContent = 'Seguir';
                    
                    // Remover da lista local
                    const index = following.findIndex(f => f.following_id === userId);
                    if (index > -1) {
                        following.splice(index, 1);
                    }
                    
                    console.log('‚úÖ Deixou de seguir com sucesso');
                    
                } else {
                    // Seguir
                    const { error } = await supabase
                        .from('follows')
                        .insert({
                            follower_id: currentUser.id,
                            following_id: userId
                        });
                    
                    if (error) throw error;
                    
                    // Atualizar UI
                    followButton.dataset.isFollowing = 'true';
                    followButton.style.background = '#28a745';
                    followButtonText.textContent = 'Seguindo';
                    
                    // Adicionar √† lista local
                    following.push({ following_id: userId });
                    
                    console.log('‚úÖ Seguiu com sucesso');
                }
                
                // Reabilitar bot√£o
                followButton.disabled = false;
                
                // Atualizar contadores na p√°gina se existirem
                updateFollowCounters();
                
            } catch (error) {
                console.error('‚ùå Erro ao alterar status de seguir:', error);
                
                // Restaurar bot√£o em caso de erro
                const followButton = document.getElementById('followButton');
                const followButtonText = document.getElementById('followButtonText');
                
                if (followButton && followButtonText) {
                    followButton.disabled = false;
                    const isFollowing = followButton.dataset.isFollowing === 'true';
                    followButtonText.textContent = isFollowing ? 'Seguindo' : 'Seguir';
                }
            }
        }
        
        // Fun√ß√£o para atualizar contadores de seguindo/seguidores
        function updateFollowCounters() {
            // Atualizar contador de seguindo se existir
            const followingCountElement = document.querySelector('[onclick*="openFollowingModal"] .stat-number');
            if (followingCountElement) {
                followingCountElement.textContent = following.length;
            }
        }

        // Sistema de Men√ß√µes - Fun√ß√£o para carregar usu√°rios
        async function loadMentionUsers() {
            try {
                console.log('üë• Carregando usu√°rios para sistema de men√ß√µes...');
                
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select('id, name, email, avatar_url, username')
                    .order('name');
                
                if (users && !error) {
                    mentionUsers = users.map(user => ({
                        id: user.id,
                        name: user.name || user.email || 'Usu√°rio',
                        username: user.username || (user.email ? user.email.split('@')[0] : 'usuario'),
                        avatar: user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email || 'Usuario')}&background=667eea&color=fff`
                    }));
                    console.log(`‚úÖ ${mentionUsers.length} usu√°rios carregados para men√ß√µes`);
                    console.log('üìã Usernames dispon√≠veis:', mentionUsers.map(u => u.username));
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar usu√°rios, mantendo array vazio');
                    mentionUsers = [];
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios para men√ß√µes:', error);
                mentionUsers = [];
            }
        }

        // Sistema de Coment√°rios
        async function loadCommentsForPost(postId) {
            try {
                console.log('üí¨ Carregando coment√°rios para post:', postId);
                
                const commentsQuery = supabase
                    .from('comments')
                    .select('*')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: false }); // Ordem decrescente - mais recente primeiro
                
                const { data: comments, error } = await withTimeout(commentsQuery, 5000);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar coment√°rios:', error.message);
                    return [];
                }
                
                console.log(`‚úÖ ${comments?.length || 0} coment√°rios carregados para post ${postId}`);
                return comments || [];
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar coment√°rios:', error.message);
                return [];
            }
        }

        async function updateCommentsCount(postId) {
            try {
                const comments = await loadCommentsForPost(postId);
                const commentsCount = comments.length;
                
                const commentsElement = document.getElementById(`comments-${postId}`);
                if (commentsElement) {
                    // Sempre permitir clique, mesmo com 0 coment√°rios
                    commentsElement.innerHTML = `üí¨ ${commentsCount}`;
                    // Usar a mesma cor dos bot√µes de rea√ß√£o zerados quando n√£o h√° coment√°rios
                    commentsElement.style.background = commentsCount > 0 ? 'linear-gradient(135deg, #2196f3, #1976d2)' : '#f5f5f5';
                    commentsElement.style.color = commentsCount > 0 ? 'white' : '#666';
                    commentsElement.style.textShadow = 'none'; // Remover sombra fixa
                    commentsElement.style.cursor = 'pointer';
                    commentsElement.onclick = () => openCommentsModal(postId);
                    // Adicionar sombra no hover igual aos bot√µes de rea√ß√£o
                    commentsElement.onmouseover = () => {
                        commentsElement.style.transform = 'scale(1.05)';
                        commentsElement.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    };
                    commentsElement.onmouseout = () => {
                        commentsElement.style.transform = 'scale(1)';
                        commentsElement.style.boxShadow = 'none';
                    };
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao atualizar contador de coment√°rios:', error.message);
            }
        }

        async function openCommentsModal(postId) {
            try {
                console.log('üí¨ Abrindo modal de coment√°rios para post:', postId);
                
                // Verificar se j√° existe modal de coment√°rios e fechar apenas ele
                const existingCommentsModal = document.getElementById('commentsModal');
                if (existingCommentsModal) {
                    console.log('‚ö†Ô∏è Modal de coment√°rios j√° existe, fechando antes de abrir novo');
                    existingCommentsModal.remove();
                }
                
                // Carregar coment√°rios
                const comments = await loadCommentsForPost(postId);
                
                // Buscar dados dos usu√°rios que comentaram
                const userIds = [...new Set(comments.map(c => c.user_id))];
                let usersData = {};
                
                try {
                    const usersQuery = supabase
                        .from('profiles')
                        .select('id, name, email, avatar_url')
                        .in('id', userIds);
                    
                    const { data: users, error } = await withTimeout(usersQuery, 5000);
                    
                    if (users) {
                        users.forEach(user => {
                            usersData[user.id] = user;
                        });
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar dados dos usu√°rios:', error.message);
                }
                
                // Criar HTML dos coment√°rios existentes
                const commentsHtml = comments.length > 0 ? comments.map(comment => {
                    const user = usersData[comment.user_id] || {};
                    const userName = user.name || 'Usu√°rio';
                    const userEmail = user.email || '';
                    const username = userEmail ? userEmail.split('@')[0] : 'usuario';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="color: #1565c0; font-weight: bold; font-size: 13px;">
                                    üí¨ 
                                    ${username === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `<span>@${username}</span>` :
                                        `<span onclick="openUserProfileKeepingModals('${username}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${username}
                                        </span>`
                                    }
                                </div>
                                <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                    ${formatDateShort(comment.created_at)}
                                </div>
                            </div>
                            <div style="color: #0d47a1; line-height: 1.4; font-size: 14px;">
                                ${comment.content || comment.text || comment.message}
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">Seja o primeiro a comentar!</div>';
                
                // Criar modal com coment√°rios acima e box de escrita embaixo
                const modal = document.createElement('div');
                modal.id = 'commentsModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981); color: white; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; color: white;">üí¨ Coment√°rios (${comments.length})</h3>
                            <button onclick="closeCommentsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">&times;</button>
                        </div>
                        
                        <div id="commentsContainer" style="flex: 1; overflow-y: auto; padding: 20px; max-height: 400px;">
                            ${commentsHtml}
                        </div>
                        
                        <div style="padding: 20px; border-top: 1px solid #eee; flex-shrink: 0;">
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <textarea id="newCommentText" placeholder="Escreva seu coment√°rio..." style="flex: 1; min-height: 60px; max-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; font-family: inherit; font-size: 14px;" rows="3"></textarea>
                                <button onclick="sendComment('${postId}')" style="background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Processar @username nos coment√°rios
                processCommentsForUsernames();
                
                // Focar no textarea
                setTimeout(() => {
                    const textarea = document.getElementById('newCommentText');
                    if (textarea) textarea.focus();
                }, 100);
                
                // Fechar modal clicando fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeCommentsModal();
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de coment√°rios:', error);
                alert('Erro ao carregar coment√°rios. Tente novamente.');
            }
        }

        function closeCommentsModal() {
            const modal = document.getElementById('commentsModal');
            if (modal) {
                modal.remove();
            }
        }

        async function sendComment(postId) {
            try {
                const textarea = document.getElementById('newCommentText');
                const commentText = textarea.value.trim();
                
                if (!commentText) {
                    alert('Por favor, escreva um coment√°rio antes de enviar.');
                    return;
                }
                
                console.log('üí¨ Enviando coment√°rio para post:', postId);
                
                // Salvar coment√°rio no banco
                const commentData = {
                    post_id: postId,
                    user_id: currentUser.id,
                    content: commentText,
                    created_at: new Date().toISOString()
                };
                
                const { data: savedComment, error } = await supabase
                    .from('comments')
                    .insert([commentData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao salvar coment√°rio:', error);
                    alert('Erro ao enviar coment√°rio. Tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Coment√°rio salvo no banco');
                
                // üîß CORRE√á√ÉO: Atualizar cache imediatamente ap√≥s salvar
                addCommentToCache(postId, savedComment);
                
                // üîß NOTIFICA√á√ÉO REMOVIDA: Agora √© criada automaticamente pelo trigger SQL
                try {
                    console.log('‚úÖ Notifica√ß√£o de coment√°rio ser√° criada automaticamente pelo trigger SQL');
                } catch (notifError) {
                    console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o de coment√°rio:', notifError.message);
                }
                
                // Adicionar coment√°rio imediatamente no topo do modal
                const commentsContainer = document.getElementById('commentsContainer');
                if (commentsContainer) {
                    const userName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Usu√°rio';
                    const userEmail = currentUser.email || '';
                    const username = userEmail ? userEmail.split('@')[0] : 'usuario';
                    const userAvatar = currentUser.user_metadata?.avatar_url || '';
                    
                    const newCommentHtml = `
                        <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="color: #1565c0; font-weight: bold; font-size: 13px;">
                                    üí¨ 
                                    ${username === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `<span>@${username}</span>` :
                                        `<span onclick="openUserProfileKeepingModals('${username}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${username}
                                        </span>`
                                    }
                                </div>
                                <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                    Agora
                                </div>
                            </div>
                            <div style="color: #0d47a1; line-height: 1.4; font-size: 14px;">
                                ${commentText}
                            </div>
                        </div>
                    `;
                    
                    // Verificar se h√° mensagem "Seja o primeiro a comentar" e remov√™-la
                    const firstCommentMsg = commentsContainer.querySelector('div');
                    if (firstCommentMsg && firstCommentMsg.textContent.includes('primeiro a comentar')) {
                        firstCommentMsg.remove();
                        console.log('‚úÖ Mensagem "primeiro a comentar" removida');
                    }
                    
                    // Adicionar o novo coment√°rio no topo IMEDIATAMENTE
                    commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
                    console.log('‚úÖ Coment√°rio adicionado imediatamente no topo do modal');
                    
                    // Atualizar contador de coment√°rios no post
                    updateCommentCounter(postId);
                    
                    // Atualizar m√©tricas do usu√°rio
                    updateSimpleMetrics();
                    
                    // Atualizar display do streak ap√≥s comentar
                    loadUserGamificationData().catch(error => {
                        console.warn('‚ö†Ô∏è Erro ao atualizar dados de gamifica√ß√£o ap√≥s comentar:', error);
                    });
                }
                
                // Limpar textarea
                textarea.value = '';
                
                // Atualizar contador na interface principal
                setTimeout(() => {
                    updateCommentsCount(postId);
                    // Atualizar m√©tricas do perfil em tempo real
                    if (typeof updateSimpleMetrics === 'function') {
                        updateSimpleMetrics();
                        
                        
                        console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s coment√°rio');
                    }
                }, 500);
                
                // üîî CORRE√á√ÉO: Atualizar notifica√ß√µes de badges em tempo real
                try {
                    await loadNotifications();
                    console.log('‚úÖ Notifica√ß√µes atualizadas ap√≥s coment√°rio');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar notifica√ß√µes:', error);
                }
                
                console.log('‚úÖ Coment√°rio enviado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar coment√°rio:', error);
                alert('Erro ao enviar coment√°rio. Tente novamente.');
            }
        }

        // Fun√ß√£o para atualizar contadores de coment√°rios ap√≥s carregar posts
        // üöÄ OTIMIZA√á√ÉO: Atualizar contadores usando cache (sem consultas individuais)
        function updateAllCommentsCountersFromCache() {
            try {
                console.log('üí¨ Atualizando contadores de coment√°rios usando cache...');
                
                const postElements = document.querySelectorAll('[id^="comments-"]');
                for (const element of postElements) {
                    const postId = element.id.replace('comments-', '');
                    const commentsCount = getCommentsCountFromCache(postId);
                    
                    // Atualizar elemento visual
                    element.innerHTML = `üí¨ ${commentsCount}`;
                    element.style.background = commentsCount > 0 ? 'linear-gradient(135deg, #2196f3, #1976d2)' : '#f5f5f5';
                    element.style.color = commentsCount > 0 ? 'white' : '#666';
                    element.style.textShadow = 'none';
                    element.style.cursor = 'pointer';
                    element.onclick = () => openCommentsModal(postId);
                    
                    // Hover effects
                    element.onmouseover = () => {
                        element.style.transform = 'scale(1.05)';
                        element.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    };
                    element.onmouseout = () => {
                        element.style.transform = 'scale(1)';
                        element.style.boxShadow = 'none';
                    };
                }
                
                console.log(`‚úÖ ${postElements.length} contadores de coment√°rios atualizados usando cache`);
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao atualizar contadores de coment√°rios do cache:', error.message);
            }
        }
        
        async function updateAllCommentsCounters() {
            try {
                const postElements = document.querySelectorAll('[id^="comments-"]');
                for (const element of postElements) {
                    const postId = element.id.replace('comments-', '');
                    await updateCommentsCount(postId);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao atualizar contadores de coment√°rios:', error.message);
            }
        }

        // Sistema de Men√ß√µes - Configurar event listeners
        function setupMentionsSystem() {
            const input = document.getElementById('personName');
            const autocomplete = document.getElementById('mentionsAutocomplete');
            
            if (!input || !autocomplete) {
                console.warn('‚ö†Ô∏è Elementos de men√ß√£o n√£o encontrados');
                return;
            }
            
            console.log('‚úÖ Configurando sistema de men√ß√µes no campo Nome da pessoa...');
            
            input.addEventListener('input', handleMentionInput);
            input.addEventListener('keydown', handleMentionKeydown);
            
            // Fechar autocomplete ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !autocomplete.contains(e.target)) {
                    hideMentionsAutocomplete();
                }
            });
        }

        // Sistema de Men√ß√µes - Detectar @ no input
        function handleMentionInput(event) {
            const textarea = event.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // LIMITA√á√ÉO: Apenas uma men√ß√£o no campo "Nome da pessoa"
            if (textarea.id === 'personName') {
                // Verificar se o campo est√° bloqueado com uma men√ß√£o v√°lida
                if (textarea.dataset.mentionLocked === 'true') {
                    const validMention = textarea.dataset.validMention;
                    const expectedText = `@${validMention}`;
                    
                    // Se o texto n√£o cont√©m mais a men√ß√£o v√°lida, desbloquear o campo
                    if (!text.includes(expectedText)) {
                        console.log('üîì Men√ß√£o removida, desbloqueando campo');
                        textarea.dataset.mentionLocked = 'false';
                        delete textarea.dataset.validMention;
                        delete textarea.dataset.validMentionId;
                        delete textarea.dataset.validMentionName;
                        
                        // Se ainda h√° @ no texto, continuar com a l√≥gica normal
                        if (text.includes('@')) {
                            // Continuar processamento normal
                        } else {
                            hideMentionsAutocomplete();
                            return;
                        }
                    } else {
                        // Campo bloqueado e men√ß√£o ainda presente - bloquear qualquer entrada adicional
                        console.log('üîí Campo bloqueado - entrada rejeitada');
                        
                        // Verificar se a entrada atual √© diferente da men√ß√£o esperada
                        if (text !== expectedText) {
                            // Restaurar apenas a men√ß√£o v√°lida
                            textarea.value = expectedText;
                            textarea.setSelectionRange(expectedText.length, expectedText.length);
                        }
                        hideMentionsAutocomplete();
                        return;
                    }
                }
                
                // L√≥gica normal para campo desbloqueado
                const atCount = (text.match(/@/g) || []).length;
                if (atCount > 1) {
                    // Remove o @ extra digitado
                    const newText = text.substring(0, cursorPos - 1) + text.substring(cursorPos);
                    textarea.value = newText;
                    textarea.setSelectionRange(cursorPos - 1, cursorPos - 1);
                    console.log('‚ö†Ô∏è Limitado a apenas uma men√ß√£o no campo Nome da pessoa');
                    return;
                }
            }
            
            // Procurar por @ antes do cursor - incluindo pontos nos usernames
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@([\w.]*)$/); // Adiciona ponto na regex
            
            if (atMatch) {
                console.log('üéØ @ detectado, query:', atMatch[1]);
                mentionStartPos = cursorPos - atMatch[0].length;
                currentMentionQuery = atMatch[1].toLowerCase();
                showMentionsAutocomplete(currentMentionQuery);
            } else {
                hideMentionsAutocomplete();
            }
        }

        // Sistema de Men√ß√µes - Mostrar lista de usu√°rios
        function showMentionsAutocomplete(query) {
            const autocomplete = document.getElementById('mentionsAutocomplete');
            
            // Filtrar usu√°rios baseado na query E excluir o usu√°rio atual
            const filteredUsers = mentionUsers.filter(user => {
                // Excluir o pr√≥prio usu√°rio logado
                if (currentUser && (user.id === currentUser.id || user.username === (currentUser.email ? currentUser.email.split('@')[0] : ''))) {
                    return false;
                }
                
                // Filtrar por query - busca mais flex√≠vel para usernames com pontos
                const queryLower = query.toLowerCase();
                const nameLower = user.name.toLowerCase();
                const usernameLower = user.username.toLowerCase();
                
                return nameLower.includes(queryLower) || 
                       usernameLower.includes(queryLower) ||
                       usernameLower.startsWith(queryLower); // Adiciona busca por in√≠cio do username
            }).slice(0, 5); // M√°ximo 5 resultados
            
            if (filteredUsers.length === 0) {
                hideMentionsAutocomplete();
                return;
            }
            
            console.log(`üìã Mostrando ${filteredUsers.length} usu√°rios para men√ß√£o (excluindo usu√°rio atual)`);
            
            const html = filteredUsers.map((user, index) => `
                <div class="mention-item" data-index="${index}" onclick="selectMention(${index})">
                    <img src="${user.avatar}" alt="${user.name}">
                    <div class="mention-info">
                        <div class="mention-name">${user.name}</div>
                        <div class="mention-username">@${user.username}</div>
                    </div>
                </div>
            `).join('');
            
            autocomplete.innerHTML = html;
            autocomplete.style.display = 'block';
            selectedMentionIndex = 0;
            updateMentionSelection();
        }

        // Sistema de Men√ß√µes - Esconder autocomplete
        function hideMentionsAutocomplete() {
            const autocomplete = document.getElementById('mentionsAutocomplete');
            autocomplete.style.display = 'none';
            selectedMentionIndex = -1;
            mentionStartPos = -1;
            currentMentionQuery = '';
        }

        // Sistema de Men√ß√µes - Atualizar sele√ß√£o visual
        function updateMentionSelection() {
            const items = document.querySelectorAll('.mention-item');
            items.forEach((item, index) => {
                if (index === selectedMentionIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Sistema de Men√ß√µes - Navega√ß√£o por teclado
        function handleMentionKeydown(event) {
            const input = event.target;
            
            // Se o campo estiver bloqueado, permitir apenas teclas de navega√ß√£o e delete/backspace
            if (input.id === 'personName' && input.dataset.mentionLocked === 'true') {
                const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Home', 'End', 'Tab'];
                if (!allowedKeys.includes(event.key)) {
                    event.preventDefault();
                    console.log('üîí Entrada bloqueada - campo cont√©m men√ß√£o v√°lida');
                    return;
                }
            }
            
            const autocomplete = document.getElementById('mentionsAutocomplete');
            if (autocomplete.style.display === 'none') return;
            
            const items = autocomplete.querySelectorAll('.mention-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
                    updateMentionSelection();
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedMentionIndex = Math.max(selectedMentionIndex - 1, -1);
                    updateMentionSelection();
                    break;
                    
                case 'Enter':
                case 'Tab':
                    if (selectedMentionIndex >= 0) {
                        event.preventDefault();
                        selectMention(selectedMentionIndex);
                    }
                    break;
                    
                case 'Escape':
                    hideMentionsAutocomplete();
                    break;
            }
        }

        // Sistema de Men√ß√µes - Selecionar usu√°rio
        function selectMention(index) {
            const input = document.getElementById('personName');
            
            // Filtrar usu√°rios novamente para pegar o correto (excluindo usu√°rio atual)
            const filteredUsers = mentionUsers.filter(user => {
                // Excluir o pr√≥prio usu√°rio logado
                if (currentUser && (user.id === currentUser.id || user.username === (currentUser.email ? currentUser.email.split('@')[0] : ''))) {
                    return false;
                }
                
                // Filtrar por query - busca mais flex√≠vel para usernames com pontos
                const queryLower = currentMentionQuery.toLowerCase();
                const nameLower = user.name.toLowerCase();
                const usernameLower = user.username.toLowerCase();
                
                return nameLower.includes(queryLower) || 
                       usernameLower.includes(queryLower) ||
                       usernameLower.replace(/\./g, '').includes(queryLower); // Remove pontos para busca
            });
            
            const selectedUser = filteredUsers[index];
            if (!selectedUser) return;
            
            const beforeMention = input.value.substring(0, mentionStartPos);
            const afterCursor = input.value.substring(input.selectionStart);
            
            // Substituir @query por @username
            const newText = beforeMention + `@${selectedUser.username}`;
            input.value = newText;
            
            // Posicionar cursor ap√≥s a men√ß√£o
            const newCursorPos = mentionStartPos + selectedUser.username.length + 1;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            console.log(`‚úÖ Usu√°rio @${selectedUser.username} mencionado no campo Nome`);
            
            // BLOQUEAR campo ap√≥s men√ß√£o v√°lida e armazenar dados do usu√°rio
            input.dataset.mentionLocked = 'true';
            input.dataset.validMention = selectedUser.username;
            input.dataset.validMentionId = selectedUser.id;
            input.dataset.validMentionName = selectedUser.name;
            console.log('üîí Campo bloqueado ap√≥s men√ß√£o v√°lida');
            
            hideMentionsAutocomplete();
            input.focus();
        }

        // Listen for auth state changes
        let isInitialLoad = true;
        let isAppAlreadyShown = false; // Evitar recarregamento ao mudar aba
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                
                // S√≥ mostrar app se ainda n√£o foi mostrado (evita limpar tela ao mudar aba)
                if (!isAppAlreadyShown) {
                    showApp();
                    isAppAlreadyShown = true;
                    
                    // Mostrar loading imediatamente
                    window.isLoadingPosts = true;
                    await renderPosts();
                }
                
                // S√≥ carrega dados na primeira vez ou se n√£o h√° dados
                if (isInitialLoad || posts.length === 0) {
                    console.log('üîÑ Carregamento inicial ou dados vazios, carregando tudo...');
                    
                    // Marcar como carregando ANTES de renderizar
                    window.isLoadingPosts = true;
                    
                    // Carregar dados do usu√°rio primeiro (mais r√°pido)
                    await loadUserData();
                    
                    // Carregar posts e notifica√ß√µes em paralelo (mais eficiente)
                    await Promise.all([
                        loadPosts(),
                        loadNotifications()
                    ]);
                    
                    updateStats();
                    isInitialLoad = false;
                } else {
                    console.log('‚úÖ Dados j√° carregados, pulando recarregamento desnecess√°rio');
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                showLogin();
                isInitialLoad = true; // Reset para pr√≥ximo login
                isAppAlreadyShown = false; // Reset para pr√≥ximo login
            }
         });
        
        // Modal de Pessoas Destacadas
        function openPeopleHighlightedModal() {
            console.log('üîç Tentando abrir modal de pessoas destacadas...');
            console.log('Current user:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.error('‚ùå currentUser n√£o est√° definido ou n√£o tem ID');
                alert('Erro: Usu√°rio n√£o identificado. Tente fazer login novamente.');
                return;
            }
            
            let modal = document.getElementById('peopleHighlightedModal');
            
            // Se modal n√£o existe, recriar
            if (!modal) {
                console.log('üîß Modal peopleHighlightedModal n√£o encontrado, recriando...');
                modal = document.createElement('div');
                modal.id = 'peopleHighlightedModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.onclick = () => closeModal();
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>üë• Pessoas Destacadas</h2>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="modalPeopleHighlightedContent">
                                <p style="text-align: center; color: #666;">Carregando...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                console.log('‚úÖ Modal peopleHighlightedModal recriado');
            }
            
            modal.style.display = 'flex';
            addModalToStack('peopleHighlightedModal', closePeopleHighlightedModal);
            loadPeopleHighlightedInModal();
        }

        function closePeopleHighlightedModal() {
            const modal = document.getElementById('peopleHighlightedModal');
            if (modal) {
                modal.style.display = 'none';
                removeModalFromStack('peopleHighlightedModal');
            }
        }

        async function loadPeopleHighlightedInModal() {
            try {
                console.log('üë• Carregando pessoas destacadas no modal...');
                console.log('üîç Current user ID:', currentUser.id);
                console.log('üîç Total posts carregados:', posts?.length || 0);
                
                if (!currentUser || !currentUser.id) {
                    console.error('‚ùå currentUser n√£o est√° definido em loadPeopleHighlightedInModal');
                    throw new Error('Usu√°rio n√£o identificado');
                }
                
                if (!posts || !Array.isArray(posts)) {
                    console.error('‚ùå Array posts n√£o est√° definido ou n√£o √© um array');
                    throw new Error('Dados de posts n√£o dispon√≠veis');
                }
                
                // Debug: mostrar TODOS os posts e seus user_ids
                console.log('üîç TODOS os posts dispon√≠veis:');
                posts.forEach((post, index) => {
                    console.log(`Post ${index + 1}:`, {
                        id: post.id,
                        user_id: post.user_id,
                        mentioned_user_id: post.mentioned_user_id,
                        author: post.user_data?.name || 'Unknown',
                        isCurrentUser: post.user_id === currentUser.id
                    });
                });
                
                const userPosts = posts.filter(post => post.user_id === currentUser.id);
                console.log('üîç Posts filtrados para o usu√°rio atual:', userPosts.length);
                
                // Se n√£o encontrou posts, verificar se h√° posts com email similar
                if (userPosts.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum post encontrado para user_id. Verificando por email...');
                    const userEmail = currentUser.email;
                    const postsByEmail = posts.filter(post => 
                        post.user_data?.email === userEmail || 
                        post.user_data?.email?.includes(userEmail?.split('@')[0])
                    );
                    console.log('üîç Posts encontrados por email:', postsByEmail.length);
                    postsByEmail.forEach(post => {
                        console.log('üìß Post por email:', {
                            id: post.id,
                            user_id: post.user_id,
                            email: post.user_data?.email,
                            mentioned_user_id: post.mentioned_user_id
                        });
                    });
                }
                const peopleHighlighted = new Set();
                const peopleDetails = [];
                
                console.log('üìã Posts do usu√°rio para an√°lise:', userPosts.length);
                console.log('üìã Detalhes dos posts:', userPosts.map(p => ({
                    id: p.id,
                    mentioned_user_id: p.mentioned_user_id,
                    celebrated_person_name: p.celebrated_person_name,
                    person_name: p.person_name,
                    content: p.content?.substring(0, 100) + '...'
                })));
                
                // Extrair pessoas mencionadas usando mentioned_user_id (mais confi√°vel)
                userPosts.forEach(post => {
                    if (post.mentioned_user_id) {
                        console.log(`üîç Post ${post.id} menciona user_id: ${post.mentioned_user_id}`);
                        
                        if (!peopleHighlighted.has(post.mentioned_user_id)) {
                            peopleHighlighted.add(post.mentioned_user_id);
                            
                            // Contar quantos posts mencionam esta pessoa
                            const postCount = userPosts.filter(p => p.mentioned_user_id === post.mentioned_user_id).length;
                            
                            peopleDetails.push({
                                userId: post.mentioned_user_id,
                                displayName: post.celebrated_person_name || post.person_name || 'Usu√°rio',
                                postCount: postCount
                            });
                            console.log(`‚úÖ Adicionado user_id: ${post.mentioned_user_id} (${postCount} posts)`);
                        }
                    } else {
                        // Fallback: tentar extrair @username se n√£o tiver mentioned_user_id
                        const personName = post.celebrated_person_name || post.person_name;
                        console.log(`üîç Fallback - Analisando post ${post.id}: personName = "${personName}"`);
                        
                        if (personName && personName.includes('@')) {
                            const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                            console.log(`üìù Matches encontrados para "${personName}":`, usernameMatch);
                            
                            if (usernameMatch) {
                                usernameMatch.forEach(match => {
                                    const username = match.substring(1);
                                    console.log(`üë§ Username extra√≠do (fallback): "${username}"`);
                                    
                                    if (username && !peopleHighlighted.has(username)) {
                                        peopleHighlighted.add(username);
                                        peopleDetails.push({
                                            username: username,
                                            displayName: personName,
                                            postCount: userPosts.filter(p => 
                                                (p.celebrated_person_name || p.person_name || '').includes(`@${username}`)
                                            ).length
                                        });
                                        console.log(`‚úÖ Adicionado (fallback): @${username}`);
                                    }
                                });
                            }
                        }
                    }
                });

                console.log('üîç Pessoas encontradas:', peopleDetails.map(p => p.userId || p.username));

                // Buscar dados REAIS dos usu√°rios mencionados na tabela profiles
                if (peopleDetails.length > 0) {
                    // Separar pessoas com userId (mais confi√°vel) das com username (fallback)
                    const peopleWithIds = peopleDetails.filter(p => p.userId);
                    const peopleWithUsernames = peopleDetails.filter(p => p.username);
                    
                    console.log('üîç Pessoas com user_id:', peopleWithIds.map(p => p.userId));
                    console.log('üîç Pessoas com username (fallback):', peopleWithUsernames.map(p => p.username));
                    
                    let realUsers = [];
                    
                    // Buscar por IDs (mais eficiente e confi√°vel)
                    if (peopleWithIds.length > 0) {
                        const userIds = peopleWithIds.map(p => p.userId);
                        console.log('üîç Buscando perfis por IDs:', userIds);
                        
                        const { data: usersByIds, error: idsError } = await supabase
                            .from('profiles')
                            .select('*')
                            .in('id', userIds);
                        
                        if (!idsError && usersByIds) {
                            realUsers = realUsers.concat(usersByIds);
                            console.log('‚úÖ Perfis encontrados por ID:', usersByIds);
                        } else {
                            console.error('‚ùå Erro ao buscar por IDs:', idsError);
                        }
                    }
                    
                    // Buscar por usernames (fallback) se necess√°rio
                    if (peopleWithUsernames.length > 0) {
                        console.log('üîç Buscando perfis por username (fallback)...');
                        const { data: allProfiles, error: allError } = await supabase
                            .from('profiles')
                            .select('*');
                        
                        if (!allError && allProfiles) {
                            const usernames = peopleWithUsernames.map(p => p.username);
                            const usersByUsername = allProfiles.filter(profile => {
                                return usernames.some(username => {
                                    const email = profile.email || '';
                                    const name = profile.name || '';
                                    const displayName = profile.display_name || '';
                                    const username_field = profile.username || '';
                                    const emailUsername = email.split('@')[0] || '';
                                    
                                    return emailUsername.toLowerCase() === username.toLowerCase() ||
                                           username_field.toLowerCase() === username.toLowerCase() ||
                                           email.toLowerCase().includes(username.toLowerCase()) || 
                                           name.toLowerCase().includes(username.toLowerCase()) ||
                                           displayName.toLowerCase().includes(username.toLowerCase());
                                });
                            });
                            
                            realUsers = realUsers.concat(usersByUsername);
                            console.log('‚úÖ Perfis encontrados por username:', usersByUsername);
                        }
                    }

                    if (realUsers && realUsers.length > 0) {
                        // Combinar dados reais com os dados extra√≠dos
                        const uniquePeopleMap = new Map();
                        
                        peopleDetails.forEach(person => {
                            let realUser = null;
                            
                            if (person.userId) {
                                // Buscar por ID (mais confi√°vel)
                                realUser = realUsers.find(u => u.id === person.userId);
                            } else if (person.username) {
                                // Buscar por username (fallback)
                                realUser = realUsers.find(u => {
                                    const email = u.email || '';
                                    const name = u.name || '';
                                    const displayName = u.display_name || '';
                                    const username_field = u.username || '';
                                    const emailUsername = email.split('@')[0] || '';
                                    
                                    return emailUsername.toLowerCase() === person.username.toLowerCase() ||
                                           username_field.toLowerCase() === person.username.toLowerCase() ||
                                           email.toLowerCase().includes(person.username.toLowerCase()) || 
                                           name.toLowerCase().includes(person.username.toLowerCase()) ||
                                           displayName.toLowerCase().includes(person.username.toLowerCase());
                                });
                            }
                            
                            if (realUser) {
                                person.realUserId = realUser.id;
                                person.realName = realUser.name || realUser.display_name;
                                person.avatarUrl = realUser.avatar_url;
                                person.realUsername = realUser.email?.split('@')[0] || realUser.username || person.username;
                                console.log(`‚úÖ Dados REAIS encontrados para ${person.userId || person.username}:`, {
                                    id: realUser.id,
                                    name: realUser.name,
                                    avatar: realUser.avatar_url
                                });
                                
                                // Adicionar ao Map para remover duplicatas
                                if (uniquePeopleMap.has(realUser.id)) {
                                    // Se j√° existe, somar o postCount
                                    const existing = uniquePeopleMap.get(realUser.id);
                                    existing.postCount += person.postCount;
                                    console.log(`üîÑ Duplicata encontrada! Somando postCount: ${existing.postCount}`);
                                } else {
                                    // Primeira ocorr√™ncia, adicionar ao Map
                                    uniquePeopleMap.set(realUser.id, person);
                                }
                            } else {
                                console.log(`‚ö†Ô∏è Perfil REAL n√£o encontrado para ${person.userId || person.username}`);
                            }
                        });
                        
                        // Substituir peopleDetails pelo array sem duplicatas
                        peopleDetails.length = 0;
                        peopleDetails.push(...Array.from(uniquePeopleMap.values()));
                        console.log(`‚úÖ Pessoas √∫nicas ap√≥s deduplication: ${peopleDetails.length}`);
                    }
                }

                const modalContent = document.getElementById('modalPeopleHighlightedContent');
                
                if (peopleDetails.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                            <p>Voc√™ ainda n√£o destacou ningu√©m com @username</p>
                            <p style="font-size: 14px; margin-top: 10px;">Use @username ao destacar pessoas para elas aparecerem aqui!</p>
                        </div>
                    `;
                } else {
                    // Ordenar por n√∫mero de destaques (maior para menor)
                    peopleDetails.sort((a, b) => b.postCount - a.postCount);
                    
                    modalContent.innerHTML = peopleDetails.map(person => {
                        // Usar avatar real se dispon√≠vel
                        const avatarHtml = person.avatarUrl && person.avatarUrl.trim() !== '' 
                            ? `<img src="${person.avatarUrl}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 1rem;" onerror="console.log('‚ùå Erro ao carregar avatar:', '${person.avatarUrl}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 1rem;">
                                ${(person.realName || person.realUsername || person.username || 'U').charAt(0).toUpperCase()}
                               </div>`
                            : `<div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 1rem;">
                                ${(person.realName || person.realUsername || person.username || 'U').charAt(0).toUpperCase()}
                               </div>`;
                        
                        // Usar nome real se dispon√≠vel, sen√£o username
                        const displayName = person.realName && person.realName.trim() !== '' 
                            ? person.realName 
                            : (person.realUsername || person.username || 'Usu√°rio');
                        
                        const usernameDisplay = person.realUsername || person.username || 'usuario';
                        
                        return `
                            <div style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee;">
                                ${avatarHtml}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 0.2rem;">
                                        ${displayName}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        @${usernameDisplay}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #999; margin-top: 0.3rem;">
                                        ${person.postCount} ${person.postCount === 1 ? 'destaque' : 'destaques'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log('‚úÖ Pessoas destacadas carregadas no modal:', peopleDetails.length);
                console.log('üìã Detalhes completos:', peopleDetails);
            } catch (error) {
                console.error('‚ùå Erro ao carregar pessoas destacadas:', error);
                document.getElementById('modalPeopleHighlightedContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>‚ùå Erro ao carregar pessoas destacadas</p>
                        <p style="font-size: 12px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ===== EVENT LISTENERS ROBUSTOS PARA CARDS DE ESTAT√çSTICAS =====
        function setupStatCardListeners() {
            console.log('üîß Configurando event listeners dos cards de estat√≠sticas...');
            
            // Posts Criados
            const postsCreatedCard = document.getElementById('postsCreatedCard');
            if (postsCreatedCard) {
                postsCreatedCard.removeEventListener('click', openPostsModal); // Remove listener anterior se existir
                postsCreatedCard.addEventListener('click', openPostsModal);
                console.log('‚úÖ Event listener configurado para Posts Criados');
            } else {
                console.warn('‚ö†Ô∏è Elemento postsCreatedCard n√£o encontrado');
            }
            
            // Pessoas Destacadas
            const peopleHighlightedCard = document.getElementById('peopleHighlightedCard');
            if (peopleHighlightedCard) {
                peopleHighlightedCard.removeEventListener('click', openPeopleHighlightedModal); // Remove listener anterior se existir
                peopleHighlightedCard.addEventListener('click', openPeopleHighlightedModal);
                console.log('‚úÖ Event listener configurado para Pessoas Destacadas');
            } else {
                console.warn('‚ö†Ô∏è Elemento peopleHighlightedCard n√£o encontrado');
            }
            
            // Holofotes Recebidos
            const postsReceivedCard = document.getElementById('postsReceivedCard');
            if (postsReceivedCard) {
                postsReceivedCard.removeEventListener('click', openHolofotesRecebidosModal); // Remove listener anterior se existir
                postsReceivedCard.addEventListener('click', openHolofotesRecebidosModal);
                console.log('‚úÖ Event listener configurado para Holofotes Recebidos');
            } else {
                console.warn('‚ö†Ô∏è Elemento postsReceivedCard n√£o encontrado');
            }
            
            // Pessoas que te Destacaram
            const peopleWhoHighlightedCard = document.getElementById('peopleWhoHighlightedCard');
            if (peopleWhoHighlightedCard) {
                peopleWhoHighlightedCard.removeEventListener('click', openPessoasQueTeDestacaramModal); // Remove listener anterior se existir
                peopleWhoHighlightedCard.addEventListener('click', openPessoasQueTeDestacaramModal);
                console.log('‚úÖ Event listener configurado para Pessoas que te Destacaram');
            } else {
                console.warn('‚ö†Ô∏è Elemento peopleWhoHighlightedCard n√£o encontrado');
            }
            
            console.log('‚úÖ Event listeners dos cards de estat√≠sticas configurados');
            
            // Bot√£o Ver Impacto Detalhado - IGUAL AO SEUS POSTS
            const impactBtn = document.getElementById('impactBtn');
            if (impactBtn) {
                impactBtn.removeEventListener('click', openImpactModal); // Remove listener anterior se existir
                impactBtn.addEventListener('click', openImpactModal);
                console.log('‚úÖ Event listener configurado para bot√£o Ver Impacto Detalhado');
            } else {
                console.warn('‚ö†Ô∏è Elemento impactBtn n√£o encontrado');
            }
            
            // RECONFIGURAR BOT√ÉO DE IMPACTO SEMPRE QUE OS CARDS S√ÉO RECONFIGURADOS
            setTimeout(() => {
                const impactBtnAgain = document.getElementById('impactBtn');
                if (impactBtnAgain) {
                    impactBtnAgain.removeEventListener('click', openImpactModal);
                    impactBtnAgain.addEventListener('click', openImpactModal);
                    console.log('üîÑ Event listener do bot√£o Ver Impacto Detalhado reconfigurado');
                }
                
                // Bot√£o Ver Suas Conquistas
                const achievementsBtn = document.getElementById('achievementsBtn');
                if (achievementsBtn) {
                    achievementsBtn.removeEventListener('click', openAchievementsModal);
                    achievementsBtn.addEventListener('click', openAchievementsModal);
                    console.log('üîÑ Event listener do bot√£o Ver Suas Conquistas configurado');
                }
            }, 100);
        }

        function setupModalStatCardListeners() {
            console.log('üîß [DEBUG] Iniciando setupModalStatCardListeners...');
            
            // Debug: verificar se o modal existe
            const modal = document.getElementById('userProfileModal');
            console.log('üîß [DEBUG] Modal encontrado:', !!modal);
            console.log('üîß [DEBUG] Modal display:', modal?.style.display);
            console.log('üîß [DEBUG] Modal dataset.userId:', modal?.dataset.userId);
            
            // Debug: verificar se os cards existem
            const modalPostsCreatedCard = document.getElementById('modalPostsCreatedCard');
            const modalHolofotesCard = document.getElementById('modalHolofotesCard');
            
            console.log('üîß [DEBUG] modalPostsCreatedCard encontrado:', !!modalPostsCreatedCard);
            console.log('üîß [DEBUG] modalHolofotesCard encontrado:', !!modalHolofotesCard);
            
            if (modalPostsCreatedCard) {
                console.log('üîß [DEBUG] modalPostsCreatedCard parent:', modalPostsCreatedCard.parentNode?.tagName);
                console.log('üîß [DEBUG] modalPostsCreatedCard innerHTML:', modalPostsCreatedCard.innerHTML);
                
                // Adicionar event listener com debug
                modalPostsCreatedCard.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    openPostsModal();
                });
                
                // Adicionar debug para mousedown e mouseup
                modalPostsCreatedCard.addEventListener('mousedown', function(event) {
                    console.log('üîÑ [DEBUG] MOUSEDOWN detectado no card Posts Criados!');
                });
                modalPostsCreatedCard.addEventListener('mouseup', function(event) {
                    console.log('üîÑ [DEBUG] MOUSEUP detectado no card Posts Criados!');
                });
                console.log('‚úÖ [DEBUG] Event listener adicionado para Posts Criados');
            } else {
                console.error('‚ùå [DEBUG] modalPostsCreatedCard N√ÉO ENCONTRADO!');
            }
            
            if (modalHolofotesCard) {
                console.log('üîß [DEBUG] modalHolofotesCard parent:', modalHolofotesCard.parentNode?.tagName);
                console.log('üîß [DEBUG] modalHolofotesCard innerHTML:', modalHolofotesCard.innerHTML);
                
                // Adicionar event listener com debug
                modalHolofotesCard.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    openHolofotesRecebidosModal();
                });
                
                // Adicionar debug para mousedown e mouseup
                modalHolofotesCard.addEventListener('mousedown', function(event) {
                    console.log('üîÑ [DEBUG] MOUSEDOWN detectado no card Holofotes Recebidos!');
                });
                modalHolofotesCard.addEventListener('mouseup', function(event) {
                    console.log('üîÑ [DEBUG] MOUSEUP detectado no card Holofotes Recebidos!');
                });
                console.log('‚úÖ [DEBUG] Event listener adicionado para Holofotes Recebidos');
            } else {
                console.error('‚ùå [DEBUG] modalHolofotesCard N√ÉO ENCONTRADO!');
            }
            
            console.log('üîß [DEBUG] setupModalStatCardListeners finalizado');
        }

        // ===== FUN√á√ïES DOS MODAIS DE M√âTRICAS RECEBIDAS =====

        function openHolofotesRecebidosModal() {
            console.log('üîç [DEBUG] openHolofotesRecebidosModal CHAMADA!');
            
            let modal = document.getElementById('holofotesRecebidosModal');
            
            // Se modal n√£o existe, recriar
            if (!modal) {
                console.log('üîß [DEBUG] Modal holofotesRecebidosModal n√£o encontrado, recriando...');
                modal = document.createElement('div');
                modal.id = 'holofotesRecebidosModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.onclick = () => closeModal();
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2><img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos</h2>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="modalHolofotesRecebidosContent">
                                <p style="text-align: center; color: #666;">Carregando...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                console.log('‚úÖ [DEBUG] Modal holofotesRecebidosModal recriado');
            }
            
            if (currentUser && currentUser.id) {
                console.log('üîç [DEBUG] Usu√°rio v√°lido encontrado, abrindo modal...');
                modal.style.display = 'flex';
                addModalToStack('holofotesRecebidosModal', closeModal);
                loadHolofotesRecebidosInModal(currentUser.id);
            } else {
                console.error('‚ùå [DEBUG] currentUser n√£o est√° definido ou n√£o tem ID');
            }
        }

        function openPessoasQueTeDestacaramModal() {
            console.log('üîç Tentando abrir modal de pessoas que te destacaram...');
            
            let modal = document.getElementById('pessoasQueTeDestacaramModal');
            
            // Se modal n√£o existe, recriar
            if (!modal) {
                console.log('üîß Modal pessoasQueTeDestacaramModal n√£o encontrado, recriando...');
                modal = document.createElement('div');
                modal.id = 'pessoasQueTeDestacaramModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.onclick = () => closeModal();
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>üë• Pessoas que te Destacaram</h2>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="modalPessoasQueTeDestacaramContent">
                                <p style="text-align: center; color: #666;">Carregando...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                console.log('‚úÖ Modal pessoasQueTeDestacaramModal recriado');
            }
            
            modal.style.display = 'flex';
            addModalToStack('pessoasQueTeDestacaramModal', closePessoasQueTeDestacaramModal);
            loadPessoasQueTeDestacaramInModal();
        }

        function closePessoasQueTeDestacaramModal() {
            const modal = document.getElementById('pessoasQueTeDestacaramModal');
            if (modal) {
                modal.style.display = 'none';
                removeModalFromStack('pessoasQueTeDestacaramModal');
            }
        }

        // Fun√ß√£o para carregar contadores de um post espec√≠fico
        async function loadPostCounts(postId) {
            try {
                // üöÄ OTIMIZA√á√ÉO: Usar cache ao inv√©s de consultas individuais
                
                // Buscar rea√ß√µes do cache (se dispon√≠vel) ou fazer consulta
                let reactionCounts = { heart: 0, gratitude: 0, inspiration: 0 };
                const post = posts.find(p => p.id === postId);
                if (post && post.reactions) {
                    post.reactions.forEach(reaction => {
                        if (reaction.type === 'touched') reactionCounts.heart++;
                        else if (reaction.type === 'grateful') reactionCounts.gratitude++;
                        else if (reaction.type === 'inspired') reactionCounts.inspiration++;
                    });
                } else {
                    // Fallback: consulta individual apenas se n√£o tiver no cache
                    const reactionsResult = await supabase.from('reactions').select('type').eq('post_id', postId);
                    reactionsResult.data?.forEach(reaction => {
                        if (reaction.type === 'touched') reactionCounts.heart++;
                        else if (reaction.type === 'grateful') reactionCounts.gratitude++;
                        else if (reaction.type === 'inspired') reactionCounts.inspiration++;
                    });
                }
                
                // Usar cache para coment√°rios
                const commentsCount = getCommentsCountFromCache(postId);
                
                // Usar cache para feedbacks
                const feedbacksCount = (feedbacksCache.get(postId) || []).length;

                // Atualizar elementos na interface
                const heartElement = document.getElementById(`heart-count-${postId}`);
                const gratitudeElement = document.getElementById(`gratitude-count-${postId}`);
                const inspirationElement = document.getElementById(`inspiration-count-${postId}`);
                const commentElement = document.getElementById(`comment-count-${postId}`);
                const feedbackElement = document.getElementById(`feedback-count-${postId}`);

                if (heartElement) heartElement.textContent = reactionCounts.heart;
                if (gratitudeElement) gratitudeElement.textContent = reactionCounts.gratitude;
                if (inspirationElement) inspirationElement.textContent = reactionCounts.inspiration;
                if (commentElement) commentElement.textContent = commentsCount;
                if (feedbackElement) feedbackElement.textContent = feedbacksCount;

            } catch (error) {
                console.error('‚ùå Erro ao carregar contadores do post:', error);
            }
        }

        async function loadHolofotesRecebidosInModal(targetUserId = null) {
            const postsContainer = document.getElementById('modalHolofotesRecebidosContent');
            postsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>Carregando holofotes...</p></div>';
            try {
                const userId = targetUserId || currentUser?.id;
                console.log('üì® Carregando holofotes recebidos no modal para usu√°rio:', userId);
                
                // Recarregar posts onde o usu√°rio especificado foi mencionado
                const { data: userPosts, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('mentioned_user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar holofotes recebidos:', error);
                    throw error;
                }
                
                console.log('üìä Holofotes recebidos encontrados:', userPosts?.length || 0);
                
                if (!userPosts || userPosts.length === 0) {
                    postsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì®</div>
                            <p>üì® Nenhum holofote recebido ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Quando algu√©m te destacar, aparecer√° aqui!</p>
                        </div>
                    `;
                    return;
                }

                // Recarregar rea√ß√µes para os posts recebidos
                const postIds = userPosts.map(p => p.id);
                let allReactions = [];
                
                if (postIds.length > 0) {
                    try {
                        const { data: reactionsData } = await supabase
                            .from('reactions')
                            .select('*')
                            .in('post_id', postIds);
                        allReactions = reactionsData || [];
                    } catch (reactionError) {
                        console.log('Erro ao carregar rea√ß√µes:', reactionError);
                    }
                }

                // Buscar dados dos autores dos posts
                const authorIds = [...new Set(userPosts.map(post => post.user_id))];
                let authors = [];
                
                if (authorIds.length > 0) {
                    try {
                        const { data: authorsData, error: authorsError } = await supabase
                            .from('profiles')
                            .select('id, name, email, avatar_url')
                            .filter('id', 'in', `(${authorIds.join(',')})`);
                        
                        if (authorsError) {
                            console.error('‚ùå Erro ao buscar autores:', authorsError);
                        } else {
                            authors = authorsData || [];
                        }
                    } catch (error) {
                        console.error('‚ùå Erro na query de autores:', error);
                    }
                }

                const authorMap = {};
                authors?.forEach(author => {
                    authorMap[author.id] = author;
                });

                // Usar o mesmo c√≥digo do renderPosts do in√≠cio
                const postsHtml = [];
                for (const post of userPosts) {
                    // Adicionar rea√ß√µes ao post
                    post.reactions = allReactions.filter(r => r.post_id === post.id);
                    
                    // Usar dados do autor do post (n√£o do usu√°rio atual)
                    const author = authorMap[post.user_id] || {};
                    post.user_data = {
                        name: author.name || 'Usu√°rio',
                        email: author.email || 'usuario@example.com',
                        avatar_url: author.avatar_url || ''
                    };
                    
                    const typeEmojis = {
                        'gratidao': 'üôè', 'gratitude': 'üôè',
                        'memoria': 'üí≠', 'memory': 'üí≠',
                        'conquista': 'üèÜ', 'achievement': 'üèÜ',
                        'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                        'apoio': 'ü§ù', 'support': 'ü§ù',
                        'admiracao': 'üåü', 'admiration': 'üåü'
                    };

                    const typeNames = {
                        'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                        'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                        'conquista': 'Conquista', 'achievement': 'Conquista',
                        'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                        'apoio': 'Apoio', 'support': 'Apoio',
                        'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                    };
                    
                    // Usar cache para feedbacks (muito mais r√°pido!)
                    const feedbacksCount = (feedbacksCache.get(post.id) || []).length;
                    
                    // Usar cache para coment√°rios (muito mais r√°pido!)
                    const commentsCount = getCommentsCountFromCache(post.id);
                    
                    const feedbacksSection = await getFeedbacksForAuthorPost(post);
                    
                const postHtml = `
                    <div class="post" style="position: relative;">
                        <button class="share-btn" onclick="sharePost('${post.id}')" style="
                            position: absolute;
                            top: 1rem;
                            right: 1rem;
                            background: rgba(255, 255, 255, 0.9);
                            border: 1px solid #ddd;
                            border-radius: 50%;
                            width: 36px;
                            height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            font-size: 16px;
                            transition: all 0.2s ease;
                            z-index: 10;
                            backdrop-filter: blur(5px);
                        " onmouseover="this.style.background='rgba(229, 90, 43, 0.1)'; this.style.borderColor='#e55a2b'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.borderColor='#ddd'; this.style.transform='scale(1)';">
                            üîó
                        </button>
                        <div class="post-header">
                            <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                            <div class="post-author">
                                <div class="post-author-name">
                                    ${post.user_data?.name || 'Usu√°rio'}
                                </div>
                                <div class="post-author-meta">
                                    ${(post.user_data?.email?.split('@')[0] || 'usuario') === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `<span class="post-author-username">@${post.user_data?.email?.split('@')[0] || 'usuario'}</span>` :
                                        `<span class="post-author-username" onclick="openUserProfileKeepingModals('${post.user_data?.email?.split('@')[0] || 'usuario'}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${post.user_data?.email?.split('@')[0] || 'usuario'}
                                        </span>`
                                    }
                                    <span class="post-time-separator">‚Ä¢</span>
                                    <span class="post-time">${formatDateShort(post.created_at)}</span>
                                </div>
                            </div>
                        </div>
                            
                            <div class="post-content">
                                <div class="post-person">
                                Holofotes para: 
                                ${post.mentioned_user_id ? `
                                    ${post.mentioned_user_id === currentUser.id ? 
                                        `<span>${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}</span>` :
                                        `<span onclick="openUserProfileByIdKeepingModals('${post.mentioned_user_id}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            ${post.mentioned_user?.username ? '@' + post.mentioned_user.username : post.mentioned_user?.email ? '@' + post.mentioned_user.email.split('@')[0] : post.celebrated_person_name || post.person_name}
                                        </span>`
                                    }
                                ` : `${post.celebrated_person_name || post.person_name}`}
                            </div>
                                ${post.type || post.highlight_type ? `
                                    <div class="post-type">
                                        ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                    </div>
                                ` : ''}
                                ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post" style="height: auto; object-fit: contain;">` : ''}
                                <div class="post-story">${post.content || post.story}</div>
                            </div>
                            
                            <div class="post-reactions">
                                <button onclick="reactToPost('${post.id}', 'touched')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                                </button>
                                <button onclick="reactToPost('${post.id}', 'grateful')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#f39c12'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                                </button>
                                <button onclick="reactToPost('${post.id}', 'inspired')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#9b59b6'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                                </button>
                            </div>
                            
                            <div class="post-footer">
                                <span class="comments-display" id="comments-${post.id}" ${commentsCount > 0 ? `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"` : `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üí¨ ${commentsCount}
                                </span>
                                <span class="feedback-display" onclick="openPostFeedbackModal('${post.id}', 'holofotes_recebidos')" ${feedbacksCount > 0 ? `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #e55a2b, #ffb700); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üîÑ ${feedbacksCount}
                                </span>
                            </div>
                            
                            ${feedbacksSection}
                        </div>
                    `;
                    
                    postsHtml.push(postHtml);
                }

                postsContainer.innerHTML = postsHtml.join('');
                console.log('‚úÖ Holofotes recebidos carregados no modal');
                
                // ‚úÖ OTIMIZA√á√ÉO: Rea√ß√µes e coment√°rios j√° foram processados no HTML acima
                // N√£o precisamos fazer consultas individuais adicionais
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar holofotes recebidos:', error);
                document.getElementById('modalHolofotesRecebidosContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar holofotes recebidos</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

         async function loadPessoasQueTeDestacaramInModal() {
            try {
                console.log('üë• Carregando pessoas que te destacaram no modal...');
                
                // Encontrar posts que mencionaram o usu√°rio atual usando mentioned_user_id
                const postsAboutUser = posts.filter(post => {
                    return post.mentioned_user_id === currentUser.id;
                });

                // Extrair IDs √∫nicos dos autores que destacaram o usu√°rio
                const authorIds = [...new Set(postsAboutUser.map(post => post.user_id))];
                
                if (authorIds.length === 0) {
                    const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhuma pessoa te destacou ainda</div>
                            <div style="font-size: 14px;">Quando algu√©m criar um post mencionando voc√™, aparecer√° aqui!</div>
                        </div>
                    `;
                    return;
                }

                // Buscar dados reais dos usu√°rios da tabela profiles
                const { data: authorsData, error } = await supabase
                    .from('profiles')
                    .select('id, name, email, avatar_url')
                    .filter('id', 'in', `(${authorIds.join(',')})`);

                if (error) {
                    console.error('‚ùå Erro ao buscar dados dos autores:', error);
                    throw error;
                }

                console.log('üìä Dados dos autores encontrados:', authorsData?.length || 0);

                // Criar mapa de autores para acesso r√°pido
                const authorMap = {};
                authorsData?.forEach(author => {
                    authorMap[author.id] = author;
                });

                // Criar lista de pessoas com dados reais
                const peopleDetails = [];
                
                authorIds.forEach(authorId => {
                    const author = authorMap[authorId];
                    const authorPosts = postsAboutUser.filter(p => p.user_id === authorId);
                    
                    if (author) {
                        const userName = author.name || author.email?.split('@')[0] || 'Usu√°rio';
                        const userEmail = author.email || '';
                        const username = userEmail ? userEmail.split('@')[0] : author.id;
                        const userAvatar = author.avatar_url || '';
                        
                        peopleDetails.push({
                            id: authorId,
                            name: userName,
                            username: username,
                            avatar: userAvatar,
                            lastMention: new Date(authorPosts[0].created_at).toLocaleDateString('pt-BR'),
                            postsCount: authorPosts.length
                        });
                    }
                });

                const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                
                if (peopleDetails.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhuma pessoa te destacou ainda</div>
                            <div style="font-size: 14px;">Quando algu√©m criar um post mencionando voc√™, aparecer√° aqui!</div>
                        </div>
                    `;
                    return;
                }

                // Ordenar por n√∫mero de posts (quem mais destacou primeiro)
                peopleDetails.sort((a, b) => b.postsCount - a.postsCount);

                // Gerar HTML das pessoas com fotos e dados reais
                const peopleHtml = peopleDetails.map(person => `
                    <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                            ${person.avatar ? 
                                `<img src="${person.avatar}" alt="${person.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<span style="color: white; font-weight: bold; font-size: 18px;">${person.name.charAt(0).toUpperCase()}</span>`
                            }
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${person.name}</div>
                            <div style="color: #666; font-size: 13px; margin-bottom: 4px;">@${person.username}</div>
                            <div style="color: #999; font-size: 12px;">
                                ${person.postsCount} ${person.postsCount === 1 ? 'destaque' : 'destaques'}
                            </div>
                        </div>
                    </div>
                `).join('');

                modalContent.innerHTML = peopleHtml;
                console.log('‚úÖ Pessoas que te destacaram carregadas no modal');

            } catch (error) {
                console.error('‚ùå Erro ao carregar pessoas que te destacaram:', error);
                const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Erro ao carregar pessoas</div>
                        <div style="font-size: 14px;">Tente novamente em alguns instantes.</div>
                    </div>
                `;
            }
        }

        // ===== FIM DAS FUN√á√ïES DOS NOVOS MODAIS =====

        // Atualizar m√©tricas reais
        async function updateSimpleMetrics() {
            try {
                console.log('üìä Atualizando m√©tricas reais...');

                // 1. Buscar posts do usu√°rio diretamente do Supabase (mesma l√≥gica do modal)
                const { data: userPosts, error: postsError } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (postsError) {
                    console.error('‚ùå Erro ao buscar posts do usu√°rio:', postsError);
                    return;
                }
                
                console.log('üìä Posts do usu√°rio encontrados para m√©tricas:', userPosts?.length || 0);
                
                // Atualizar contador de Posts Criados
                document.getElementById('userPostsCount').textContent = userPosts?.length || 0;
                
                // 2. Pessoas Destacadas (usar mentioned_user_id + fallback para @username)
                const peopleDetailsForCard = [];
                const peopleHighlightedSet = new Set();
                
                console.log('üìä Calculando pessoas destacadas para o card...');
                
                userPosts.forEach(post => {
                    if (post.mentioned_user_id) {
                        // Usar mentioned_user_id (mais confi√°vel)
                        if (!peopleHighlightedSet.has(post.mentioned_user_id)) {
                            peopleHighlightedSet.add(post.mentioned_user_id);
                            peopleDetailsForCard.push({ userId: post.mentioned_user_id });
                            console.log(`‚úÖ Card: Adicionado via mentioned_user_id: ${post.mentioned_user_id}`);
                        }
                    } else {
                        // Fallback: extrair @username se n√£o tiver mentioned_user_id
                        const personName = post.celebrated_person_name || post.person_name;
                        if (personName && personName.includes('@')) {
                            const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                            if (usernameMatch) {
                                usernameMatch.forEach(match => {
                                    const username = match.substring(1);
                                    if (username && !peopleHighlightedSet.has(`@${username}`)) {
                                        peopleHighlightedSet.add(`@${username}`);
                                        peopleDetailsForCard.push({ username: username });
                                        console.log(`‚úÖ Card: Adicionado via @username: ${username}`);
                                    }
                                });
                            }
                        }
                    }
                });
                
                // Buscar dados reais e deduplica√ß√£o (mesma l√≥gica do modal)
                let uniqueRealPeopleCount = peopleDetailsForCard.length;
                
                if (peopleDetailsForCard.length > 0) {
                    const peopleWithIds = peopleDetailsForCard.filter(p => p.userId);
                    const uniquePeopleMap = new Map();
                    
                    if (peopleWithIds.length > 0) {
                        const userIds = peopleWithIds.map(p => p.userId);
                        const { data: usersByIds } = await supabase
                            .from('profiles')
                            .select('id')
                            .in('id', userIds);
                        
                        if (usersByIds) {
                            usersByIds.forEach(user => uniquePeopleMap.set(user.id, true));
                        }
                    }
                    
                    // Adicionar pessoas sem userId (fallback @username)
                    const peopleWithUsernames = peopleDetailsForCard.filter(p => p.username);
                    
                    if (peopleWithUsernames.length > 0) {
                        // Buscar IDs reais dos usernames para evitar duplica√ß√£o
                        const { data: allProfiles } = await supabase
                            .from('profiles')
                            .select('id, username, email');
                        
                        if (allProfiles) {
                            peopleWithUsernames.forEach(p => {
                                // Tentar encontrar o perfil real pelo username
                                const realProfile = allProfiles.find(profile => {
                                    const emailUsername = profile.email?.split('@')[0] || '';
                                    const profileUsername = profile.username || '';
                                    return emailUsername.toLowerCase() === p.username.toLowerCase() ||
                                           profileUsername.toLowerCase() === p.username.toLowerCase();
                                });
                                
                                if (realProfile) {
                                    // Verificar se o ID real j√° existe no Map
                                    if (!uniquePeopleMap.has(realProfile.id)) {
                                        uniquePeopleMap.set(realProfile.id, true);
                                        console.log(`‚úÖ Card: Adicionado @${p.username} com ID real: ${realProfile.id}`);
                                    } else {
                                        console.log(`‚ö†Ô∏è Card: @${p.username} j√° existe como ID ${realProfile.id}, ignorando`);
                                    }
                                } else {
                                    // Se n√£o encontrou perfil real, adicionar como @username
                                    if (!uniquePeopleMap.has(`@${p.username}`)) {
                                        uniquePeopleMap.set(`@${p.username}`, true);
                                        console.log(`‚úÖ Card: Adicionado @${p.username} (sem perfil real)`);
                                    }
                                }
                            });
                        }
                    }
                    
                    uniqueRealPeopleCount = uniquePeopleMap.size;
                    console.log('üìä Pessoas √∫nicas ap√≥s deduplication (card):', uniqueRealPeopleCount);
                }
                
                document.getElementById('userPeopleHighlighted').textContent = uniqueRealPeopleCount;

                // Buscar m√©tricas de reconhecimento DADO
                const [commentsResult, feedbacksResult, reactionsResult] = await Promise.all([
                    supabase.from('comments').select('id', { count: 'exact' }).eq('user_id', currentUser.id),
                    supabase.from('feedbacks').select('id', { count: 'exact' }).eq('mentioned_user_id', currentUser.id), // Feedbacks Dados: fui mencionado, vou dar feedback
                    supabase.from('reactions').select('id', { count: 'exact' }).eq('user_id', currentUser.id)
                ]);

                console.log('üìä Contagens das consultas:', {
                    comments: commentsResult.count,
                    feedbacks: feedbacksResult.count,
                    reactions: reactionsResult.count
                });

                const commentsCount = commentsResult.count || 0;
                const feedbacksCount = feedbacksResult.count || 0;
                const reactionsCount = reactionsResult.count || 0;

                // Atualizar elementos separadamente
                document.getElementById('userCommentsGiven').textContent = commentsCount;
                document.getElementById('userFeedbacksGiven').textContent = feedbacksCount;
                document.getElementById('userReactionsGiven').textContent = reactionsCount;
                
                // üî• SISTEMA DE STREAK CORRIGIDO - USANDO BACKEND RPC
                try {
                    console.log('üî• Atualizando sistema de streak via backend...');
                    
                    const { data: streakResult, error: streakError } = await supabase.rpc('update_user_streak_with_data', {
                        p_user_id: currentUser.id
                    });
                    
                    if (streakError) {
                        console.error('‚ùå Erro ao atualizar streak:', streakError);
                        // Fallback: zerar todos os streaks em caso de erro
                        updateStreakProgressBars(0);
                        updateStreakDisplay(0);
                    } else if (streakResult) {
                        console.log('‚úÖ Streak atualizado via backend:', streakResult);
                        
                        const currentStreak = streakResult.current_streak || 0;
                        
                        // Atualizar display principal
                        updateStreakDisplay(currentStreak);
                        
                        // Atualizar barras de progresso
                        updateStreakProgressBars(currentStreak);
                        
                        // Verificar se atingiu milestone e mostrar notifica√ß√£o
                        if (streakResult.milestone_reached && streakResult.bonus_points > 0) {
                            showStreakBonus(streakResult);
                        }
                        
                        console.log(`üî• Streak atualizado: ${currentStreak} dias consecutivos`);
                    }
                } catch (streakError) {
                    console.error('‚ùå Erro no sistema de streak:', streakError);
                    // Fallback: zerar todos os streaks em caso de erro
                    updateStreakProgressBars(0);
                    updateStreakDisplay(0);
                }

                // ===== C√ÅLCULOS DAS M√âTRICAS RECEBIDAS =====

                // 1. Holofotes Recebidos (posts que mencionaram o usu√°rio)
                console.log('üîç Buscando holofotes recebidos usando mentioned_user_id...');
                console.log('Current user ID:', currentUser?.id);
                
                const postsAboutUser = posts.filter(post => {
                    return post.mentioned_user_id === currentUser.id;
                });
                
                console.log('Posts about user encontrados:', postsAboutUser.length);
                console.log('Posts details:', postsAboutUser);
                
                document.getElementById('userHolofotesReceived').textContent = postsAboutUser.length;

                // 2. Pessoas que te Destacaram (pessoas √∫nicas que mencionaram o usu√°rio)
                const peopleWhoHighlighted = new Set();
                postsAboutUser.forEach(post => {
                    peopleWhoHighlighted.add(post.user_id);
                });
                document.getElementById('userPeopleWhoHighlighted').textContent = peopleWhoHighlighted.size;

                // 3. Consultas para m√©tricas recebidas (rea√ß√µes, coment√°rios, feedbacks nos posts do usu√°rio)
                const userPostIds = userPosts.map(post => post.id);
                
                const [reactionsReceivedResult, commentsReceivedResult, feedbacksReceivedResult] = await Promise.all([
                    userPostIds.length > 0 ? supabase.from('reactions').select('id', { count: 'exact' }).in('post_id', userPostIds) : { count: 0 },
                    userPostIds.length > 0 ? supabase.from('comments').select('id', { count: 'exact' }).in('post_id', userPostIds).neq('user_id', currentUser.id) : { count: 0 },
                    userPostIds.length > 0 ? supabase.from('feedbacks').select('id', { count: 'exact' }).in('post_id', userPostIds) : { count: 0 } // Feedbacks nos posts do usu√°rio
                ]);

                // 4. Atualizar elementos das m√©tricas recebidas
                document.getElementById('userReactionsReceived').textContent = reactionsReceivedResult.count || 0;
                document.getElementById('userCommentsReceived').textContent = commentsReceivedResult.count || 0;
                document.getElementById('userFeedbacksReceived').textContent = feedbacksReceivedResult.count || 0;

                console.log('‚úÖ M√©tricas reais atualizadas:', {
                    pessoas: uniqueRealPeopleCount,
                    comentarios: commentsResult.count || 0,
                    reacoes: reactionsResult.count || 0,
                    streak: currentStreak,
                    // M√©tricas recebidas
                    holofotesRecebidos: postsAboutUser.length,
                    pessoasQueTeDestacaram: peopleWhoHighlighted.size,
                    reacoesRecebidas: reactionsReceivedResult.count || 0,
                    comentariosRecebidos: commentsReceivedResult.count || 0,
                    feedbacksRecebidos: feedbacksReceivedResult.count || 0
                });
                
                // üî• ATUALIZAR SISTEMA DE STREAK COM BONUS RETROATIVO (REMOVIDO - J√Å FEITO ACIMA)
                // Sistema de streak j√° foi atualizado na se√ß√£o anterior usando update_user_streak_with_data
                
                // Reconfigurar event listeners ap√≥s atualizar m√©tricas
                setupStatCardListeners();
            } catch (error) {
                console.error('‚ùå Erro ao atualizar m√©tricas reais:', error);
                // Em caso de erro, manter valores existentes
            }
        }

        // üî• FUN√á√ÉO PARA VERIFICAR STREAK EM TEMPO REAL AP√ìS ATIVIDADES
        async function checkStreakAfterActivity(activityType) {
            try {
                console.log(`üî• Verificando streak ap√≥s atividade: ${activityType}`);
                
                const { data: streakResult, error: streakError } = await supabase.rpc('update_user_streak_with_data', {
                    p_user_id: currentUser.id
                });
                
                if (streakError) {
                    console.error('‚ùå Erro ao verificar streak:', streakError);
                    return;
                }
                
                if (streakResult) {
                    console.log('‚úÖ Streak verificado:', streakResult);
                    
                    const currentStreak = streakResult.current_streak || 0;
                    
                    // Atualizar display principal
                    updateStreakDisplay(currentStreak);
                    
                    // Atualizar barras de progresso
                    updateStreakProgressBars(currentStreak);
                    
                    // üéâ MOSTRAR NOTIFICA√á√ÉO DE MILESTONE EM TEMPO REAL
                    if (streakResult.milestone_reached && streakResult.bonus_points > 0) {
                        console.log('üéâ MILESTONE ATINGIDO EM TEMPO REAL!', streakResult);
                        
                        // Pequeno delay para garantir que a atividade foi processada
                        setTimeout(() => {
                            showStreakBonus(streakResult);
                        }, 1000);
                    }
                    
                    console.log(`üî• Streak atualizado em tempo real: ${currentStreak} dias`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar streak em tempo real:', error);
            }
        }

        // üî• FUN√á√ïES AUXILIARES PARA STREAK
        function updateStreakDisplay(streak) {
            const userStreakElement = document.getElementById('userStreakDisplay');
            if (userStreakElement) {
                if (streak === 1) {
                    userStreakElement.textContent = '1 dia';
                } else {
                    userStreakElement.textContent = streak + ' dias';
                }
            }
        }

        function updateStreakProgressBars(currentStreak) {
            const progressElements = [
                { period: 7, progressId: 'engagementStreakProgress7', textId: 'engagementStreakText7' },
                { period: 30, progressId: 'engagementStreakProgress30', textId: 'engagementStreakText30' },
                { period: 182, progressId: 'engagementStreakProgress182', textId: 'engagementStreakText182' },
                { period: 365, progressId: 'engagementStreakProgress365', textId: 'engagementStreakText365' }
            ];
            
            progressElements.forEach(({ period, progressId, textId }) => {
                const progressBar = document.getElementById(progressId);
                const progressText = document.getElementById(textId);
                
                if (progressBar && progressText) {
                    const streak = Math.min(currentStreak, period);
                    const percentage = (streak / period) * 100;
                    
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${streak}/${period}`;
                }
            });
            
            console.log('‚úÖ Barras de progresso do streak atualizadas:', {
                currentStreak,
                progress: progressElements.map(({ period }) => ({
                    period,
                    streak: Math.min(currentStreak, period),
                    percentage: `${((Math.min(currentStreak, period) / period) * 100).toFixed(1)}%`
                }))
            });
        }

        // üî• FUN√á√ÉO PARA MOSTRAR BONUS DE STREAK
        function showStreakBonus(streakData) {
            const { completed_milestone, bonus_points, points_period } = streakData;
            
            if (!completed_milestone || !bonus_points) return;
            
            // Criar notifica√ß√£o visual elegante
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
                color: white;
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 50000;
                text-align: center;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 400px;
                animation: streakBonusAppear 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">üî•</div>
                <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                    STREAK ${completed_milestone} DIAS COMPLETADO!
                </div>
                <div style="font-size: 16px; margin-bottom: 15px; opacity: 0.9;">
                    Pontos dos √∫ltimos ${completed_milestone} dias: ${points_period}
                </div>
                <div style="font-size: 20px; font-weight: bold; color: #ffeb3b;">
                    BONUS: +${bonus_points} pts! üéâ
                </div>
                <div style="font-size: 14px; margin-top: 15px; opacity: 0.8;">
                    Continue assim para o pr√≥ximo milestone!
                </div>
            `;
            
            // Adicionar CSS da anima√ß√£o se n√£o existir
            if (!document.getElementById('streakBonusCSS')) {
                const style = document.createElement('style');
                style.id = 'streakBonusCSS';
                style.textContent = `
                    @keyframes streakBonusAppear {
                        0% { 
                            opacity: 0; 
                            transform: translate(-50%, -50%) scale(0.5); 
                        }
                        100% { 
                            opacity: 1; 
                            transform: translate(-50%, -50%) scale(1); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                notification.style.animation = 'streakBonusAppear 0.3s ease-in reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            // Log para debug
            console.log('üéâ STREAK BONUS MOSTRADO:', {
                milestone: completed_milestone,
                bonus: bonus_points,
                period_points: points_period
            });
        }

        // Modal functions for received metrics
        function openPostsReceivedModal() {
            const modal = document.getElementById('postsReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadPostsReceivedInModal();
            }
        }

        function openCommentsReceivedModal() {
            const modal = document.getElementById('commentsReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadCommentsReceivedInModal();
            }
        }

        function openFeedbacksReceivedModal() {
            const modal = document.getElementById('feedbacksReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadFeedbacksReceivedInModal();
            }
        }

        async function loadPostsReceivedInModal() {
            try {
                const userPostsReceived = posts.filter(post => {
                    const personName = post.celebrated_person_name || post.person_name;
                    if (personName && personName.includes('@')) {
                        const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                        if (usernameMatch) {
                            return usernameMatch.some(match => {
                                const username = match.substring(1);
                                return username === currentUser.username;
                            });
                        }
                    }
                    return false;
                });

                const modalContent = document.getElementById('postsReceivedModalContent');
                if (!modalContent) return;

                if (userPostsReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum post recebido ainda.</p>';
                    return;
                }

                let html = '';
                for (const post of userPostsReceived) {
                    const timeAgo = getTimeAgo(post.created_at);
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${post.celebrated_person_name || post.person_name}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${post.content || post.story || ''}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                }
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar posts recebidos:', error);
            }
        }

        async function loadCommentsReceivedInModal() {
            try {
                const userPostIds = posts.filter(post => post.user_id === currentUser.id).map(post => post.id);
                
                if (userPostIds.length === 0) {
                    const modalContent = document.getElementById('commentsReceivedModalContent');
                    if (modalContent) {
                        modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum coment√°rio recebido ainda.</p>';
                    }
                    return;
                }

                const { data: commentsReceived, error } = await supabase
                    .from('comments')
                    .select('*, profiles(name, username)')
                    .in('post_id', userPostIds)
                    .neq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                const modalContent = document.getElementById('commentsReceivedModalContent');
                if (!modalContent) return;

                if (error || !commentsReceived || commentsReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum coment√°rio recebido ainda.</p>';
                    return;
                }

                let html = '';
                commentsReceived.forEach(comment => {
                    const timeAgo = getTimeAgo(comment.created_at);
                    const userName = comment.profiles?.name || 'Usu√°rio';
                    const username = comment.profiles?.username || '';
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">üí¨ ${username ? `@${username}` : userName}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${comment.content}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                });
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar coment√°rios recebidos:', error);
            }
        }

        async function loadFeedbacksReceivedInModal() {
            try {
                const { data: feedbacksReceived, error } = await supabase
                    .from('feedbacks')
                    .select('*, profiles(name, username)')
                    .eq('mentioned_user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                const modalContent = document.getElementById('feedbacksReceivedModalContent');
                if (!modalContent) return;

                if (error || !feedbacksReceived || feedbacksReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum feedback recebido ainda.</p>';
                    return;
                }

                let html = '';
                feedbacksReceived.forEach(feedback => {
                    const timeAgo = getTimeAgo(feedback.created_at);
                    const userName = feedback.profiles?.name || 'Usu√°rio';
                    const username = feedback.profiles?.username || '';
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">üîÑ ${
                                username ? 
                                    (username === (currentUser.email?.split('@')[0] || currentUser.user_metadata?.username) ? 
                                        `@${username}` :
                                        `<span onclick="openUserProfileKeepingModals('${username}')" 
                                              style="color: #007bff; cursor: pointer; transition: color 0.2s ease;"
                                              onmouseover="this.style.color='#0056b3'"
                                              onmouseout="this.style.color='#007bff'">
                                            @${username}
                                        </span>`
                                    ) : userName
                            }</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${feedback.content}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                });
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks recebidos:', error);
            }
        }

        // ===== SISTEMA DE BUSCA =====
        
        let searchTimeout;
        let isSearching = false;

        // Configurar event listeners da busca
        function setupSearchSystem() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchInput || !searchResults) return;

            // Busca em tempo real com debounce
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length === 0) {
                    hideSearchResults();
                    return;
                }
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 300);
                }
            });
        }

        // Fun√ß√£o principal de busca
        async function performSearch(query) {
            if (isSearching) return;
            
            isSearching = true;
            showSearchLoading();
            
            try {
                console.log('üîç Realizando busca para:', query);
                
                // Buscar posts e perfis em paralelo
                const [posts, profiles] = await Promise.all([
                    searchPosts(query),
                    searchProfiles(query)
                ]);
                
                renderSearchResults(posts, profiles, query);
                
            } catch (error) {
                console.error('‚ùå Erro na busca:', error);
                showSearchError();
            } finally {
                isSearching = false;
            }
        }

        // Buscar posts no banco
        async function searchPosts(query) {
            try {
                const { data, error } = await supabase
                    .from('posts')
                    .select('id, content, celebrated_person_name, type, created_at, user_id')
                    .or(`content.ilike.%${query}%,celebrated_person_name.ilike.%${query}%`)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar posts:', error);
                return [];
            }
        }

        // Buscar perfis no banco
        async function searchProfiles(query) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, name, username, email')
                    .or(`name.ilike.%${query}%,username.ilike.%${query}%,email.ilike.%${query}%`)
                    .limit(8);
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar perfis:', error);
                return [];
            }
        }

        // Renderizar resultados da busca
        function renderSearchResults(posts, profiles, query) {
            const searchResults = document.getElementById('searchResults');
            let html = '';
            
            const totalResults = posts.length + profiles.length;
            
            if (totalResults === 0) {
                html = `
                    <div class="search-empty">
                        <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">Nenhum resultado encontrado</div>
                        <div style="font-size: 14px; color: #999;">
                            Tente buscar por nomes, conte√∫do de posts ou usernames
                        </div>
                    </div>
                `;
            } else {
                // Se√ß√£o de Posts
                if (posts.length > 0) {
                    html += `
                        <div class="search-section">
                            <h4>üìù Posts (${posts.length})</h4>
                            ${posts.map(post => `
                                <div class="search-result-item" onclick="openPostFromSearch('${post.id}')">
                                    <div class="result-title">
                                        Holofote para: ${post.celebrated_person_name || 'Pessoa n√£o informada'}
                                    </div>
                                    <div class="result-content">
                                        ${(post.content || '').substring(0, 100)}${post.content && post.content.length > 100 ? '...' : ''}
                                    </div>
                                    <div class="result-meta">
                                        ${formatDateShort(post.created_at)} ‚Ä¢ ${getTypeEmoji(post.type)} ${getTypeName(post.type)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Se√ß√£o de Perfis
                if (profiles.length > 0) {
                    html += `
                        <div class="search-section">
                            <h4>üë§ Perfis (${profiles.length})</h4>
                            ${profiles.map(profile => `
                                <div class="search-result-item" onclick="openProfileFromSearch('${profile.id}', '${profile.username || profile.email?.split('@')[0] || 'usuario'}')">
                                    <div class="result-title">${profile.name || 'Nome n√£o informado'}</div>
                                    <div class="result-content">
                                        @${profile.username || profile.email?.split('@')[0] || 'usuario'}
                                    </div>
                                    <div class="result-meta">Perfil do usu√°rio</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            searchResults.innerHTML = html;
            searchResults.style.display = 'block';
        }

        // Abrir post a partir da busca
        async function openPostFromSearch(postId) {
            try {
                console.log('üîó Abrindo post da busca:', postId);
                
                // Reutilizar fun√ß√£o existente
                const postData = await fetchPostDetails(postId);
                
                if (!postData) {
                    showToast('Post n√£o encontrado');
                    return;
                }
                
                const modalType = determineModalType(postData);
                showPostModal(postData, modalType);
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir post da busca:', error);
                showToast('Erro ao carregar post');
            }
        }

        // Abrir perfil a partir da busca
        async function openProfileFromSearch(userId, username) {
            try {
                console.log('üë§ Abrindo perfil da busca:', { userId, username });
                
                // Reutilizar fun√ß√£o existente
                await openUserProfile(username);
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir perfil da busca:', error);
                showToast('Erro ao carregar perfil');
            }
        }

        // Fun√ß√µes auxiliares
        function showSearchLoading() {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = `
                <div class="search-loading">
                    <div style="font-size: 32px; margin-bottom: 15px;">‚è≥</div>
                    <div style="font-size: 16px;">Buscando...</div>
                </div>
            `;
            searchResults.style.display = 'block';
        }

        function showSearchError() {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = `
                <div class="search-empty">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Erro ao realizar busca</div>
                    <div style="font-size: 14px; color: #999;">
                        Tente novamente em alguns instantes
                    </div>
                </div>
            `;
            searchResults.style.display = 'block';
        }

        function hideSearchResults() {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
        }

        function getTypeEmoji(type) {
            const typeEmojis = {
                'gratidao': 'üôè',
                'memoria': 'üß†',
                'conquista': 'üèÜ',
                'inspiracao': 'üí°',
                'apoio': 'ü§ù',
                'reconhecimento': 'üëè'
            };
            return typeEmojis[type] || '‚ú®';
        }

        function getTypeName(type) {
            const typeNames = {
                'gratidao': 'Gratid√£o',
                'memoria': 'Mem√≥ria',
                'conquista': 'Conquista',
                'inspiracao': 'Inspira√ß√£o',
                'apoio': 'Apoio',
                'reconhecimento': 'Reconhecimento'
            };
            return typeNames[type] || 'Destaque';
        }
        
        // ===== SISTEMA DE URLS DE PERFIL =====
        
        class ProfileRouter {
            static currentProfileData = null;
            
            static showFullProfile(userId) {
                console.log('üîÑ ProfileRouter.showFullProfile chamado para userId:', userId);
                
                try {
                    if (!userId || userId === 'undefined' || userId === 'null') {
                        throw new Error('UserId inv√°lido');
                    }
                    
                    this.hideMainInterface();
                    this.showProfileContainer();
                    this.updateURL(userId);
                    this.loadFullProfile(userId);
                    
                    console.log('‚úÖ Perfil completo aberto para userId:', userId);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao mostrar perfil completo:', error);
                    this.showError('Erro ao carregar perfil: ' + error.message);
                }
            }
            
            static closeFullProfile() {
                console.log('üîÑ ProfileRouter.closeFullProfile chamado');
                
                try {
                    this.showMainInterface();
                    this.hideProfileContainer();
                    this.clearURL();
                    this.currentProfileData = null;
                    
                    console.log('‚úÖ Perfil completo fechado');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao fechar perfil completo:', error);
                    this.forceShowMainInterface();
                }
            }
            
            static hideMainInterface() {
                const appContainer = document.getElementById('appContainer');
                const navTabs = document.querySelector('.nav-tabs');
                
                if (appContainer) appContainer.style.display = 'none';
                if (navTabs) navTabs.style.display = 'none';
                console.log('‚úÖ Interface principal escondida');
            }
            
            static showMainInterface() {
                const appContainer = document.getElementById('appContainer');
                const navTabs = document.querySelector('.nav-tabs');
                
                if (appContainer) appContainer.style.display = 'block';
                if (navTabs) navTabs.style.display = 'flex';
                console.log('‚úÖ Interface principal mostrada');
            }
            
            static forceShowMainInterface() {
                console.log('üîß For√ßando volta √† interface principal...');
                this.showMainInterface();
                this.hideProfileContainer();
                this.clearURL();
                if (typeof showToast !== 'undefined') {
                    showToast('Erro ao carregar perfil. Voltando √† p√°gina principal.');
                }
            }
            
            static showProfileContainer() {
                const container = document.getElementById('fullProfileContainer');
                if (container) {
                    container.style.display = 'block';
                    console.log('‚úÖ Container de perfil mostrado');
                } else {
                    throw new Error('Container de perfil n√£o encontrado');
                }
            }
            
            static hideProfileContainer() {
                const container = document.getElementById('fullProfileContainer');
                if (container) {
                    container.style.display = 'none';
                    console.log('‚úÖ Container de perfil escondido');
                }
            }
            
            static updateURL(userId) {
                try {
                    const url = new URL(window.location);
                    url.searchParams.set('profile', userId);
                    window.history.pushState({ profileId: userId }, '', url);
                    console.log('‚úÖ URL atualizada para:', url.toString());
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar URL:', error);
                }
            }
            
            static clearURL() {
                try {
                    const url = new URL(window.location);
                    url.searchParams.delete('profile');
                    window.history.pushState({}, '', url);
                    console.log('‚úÖ URL limpa');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao limpar URL:', error);
                }
            }
            
            // Carregar dados do perfil (agora com busca inteligente por username ou ID)
            static async loadFullProfile(userIdentifier) {
                console.log('üìä Carregando perfil completo para:', userIdentifier);
                
                try {
                    this.showLoading();
                    
                    // Detectar se √© ID (UUID) ou username
                    const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userIdentifier);
                    
                    let userData;
                    if (isUUID) {
                        // Buscar por ID usando fun√ß√£o existente
                        console.log('üîç Buscando por ID:', userIdentifier);
                        userData = await fetchUserProfileDataById(userIdentifier);
                    } else {
                        // Buscar por username
                        console.log('üîç Buscando por username:', userIdentifier);
                        userData = await this.fetchUserDataByUsername(userIdentifier);
                    }
                    
                    if (userData) {
                        // Buscar estat√≠sticas do usu√°rio
                        console.log('üìä Carregando estat√≠sticas para:', userData.id);
                        const stats = await fetchUserStats(userData.id);
                        
                        const displayName = userData.username || 
                                          (userData.email ? userData.email.split('@')[0] : null) || 
                                          userData.name || 'Usu√°rio';
                        
                        this.showFullUserProfile(userData, stats);
                        // T√≠tulo ser√° atualizado automaticamente pelo showFullUserProfile
                    } else {
                        throw new Error('Usu√°rio n√£o encontrado');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar perfil:', error);
                    this.showError('Usu√°rio n√£o encontrado ou erro ao carregar dados');
                }
            }
            
            // Buscar dados do usu√°rio por username
            static async fetchUserDataByUsername(username) {
                try {
                    // Primeiro tentar buscar por campo username
                    let { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('username', username)
                        .single();
                    
                    if (!data && !error) {
                        // Se n√£o encontrou, tentar buscar por email (username@domain)
                        const { data: emailData, error: emailError } = await supabase
                            .from('profiles')
                            .select('*')
                            .like('email', username + '@%')
                            .single();
                        
                        data = emailData;
                        error = emailError;
                    }
                    
                    if (error && error.code !== 'PGRST116') throw error; // PGRST116 = not found
                    return data;
                } catch (error) {
                    console.error('‚ùå Erro ao buscar por username:', error);
                    return null;
                }
            }
            
            static showLoading() {
                const content = document.getElementById('fullProfileContent');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 3rem;"><div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div><h3>Carregando perfil...</h3></div>';
                }
            }
            
            // Mostrar perfil completo com dados reais
            static showFullUserProfile(userData, stats) {
                const content = document.getElementById('fullProfileContent');
                if (content) {
                    const displayUsername = userData.username || 
                                          (userData.email ? userData.email.split('@')[0] : null) || 
                                          'usuario';
                    
                    content.innerHTML = `
                        <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
                            <!-- Header do Perfil -->
                            <div style="text-align: center; margin-bottom: 3rem;">
                                <div style="margin-bottom: 1.5rem;">
                                    <img src="${userData.avatar_url || ''}" 
                                         style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #007bff;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div style="
                                        display: none;
                                        width: 120px; 
                                        height: 120px; 
                                        border-radius: 50%; 
                                        background: linear-gradient(135deg, #e55a2b, #ffb700);
                                        align-items: center; 
                                        justify-content: center; 
                                        color: white; 
                                        font-size: 48px; 
                                        font-weight: bold;
                                        margin: 0 auto;
                                    ">${(userData.name || 'U').charAt(0).toUpperCase()}</div>
                                </div>
                                
                                <h1 style="margin: 0 0 0.5rem 0; color: #333; font-size: 2.5rem;">${userData.name || 'Usu√°rio'}</h1>
                                <p style="color: #666; font-size: 1.3rem; margin: 0 0 1rem 0;">@${displayUsername}</p>
                                
                                <div style="color: #999; font-size: 0.9rem;">
                                    Membro desde ${new Date(userData.created_at).toLocaleDateString('pt-BR')}
                                </div>
                            </div>
                            
                            <!-- Linha 1: Seguindo/Seguidores + Bot√µes de A√ß√£o -->
                            <div style="
                                display: grid; 
                                grid-template-columns: 1fr 1fr 1fr; 
                                gap: 1.5rem; 
                                margin-bottom: 2rem;
                            ">
                                <div onclick="openFollowingModal('${userData.id}')" style="
                                    background: linear-gradient(135deg, #ff9800, #f57c00); 
                                    color: white;
                                    border-radius: 15px; 
                                    padding: 1.5rem; 
                                    text-align: center; 
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    cursor: pointer;
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(255,152,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                                    <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${stats.following}</div>
                                    <div style="font-weight: 600;">Seguindo</div>
                                </div>
                                
                                <div onclick="openFollowersModal('${userData.id}')" style="
                                    background: linear-gradient(135deg, #ff9800, #f57c00); 
                                    color: white;
                                    border-radius: 15px; 
                                    padding: 1.5rem; 
                                    text-align: center; 
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    cursor: pointer;
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(255,152,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                                    <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${stats.followers}</div>
                                    <div style="font-weight: 600;">Seguidores</div>
                                </div>
                                
                                <!-- Bot√µes de A√ß√£o -->
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <button id="followButton" onclick="toggleUserPageFollow('${userData.id}')" style="
                                        background: #007bff; 
                                        color: white; 
                                        border: none; 
                                        padding: 0.75rem 1rem; 
                                        border-radius: 8px; 
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                        transition: background 0.2s ease;
                                        flex: 1;
                                        min-width: 120px;
                                    " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background=this.dataset.isFollowing === 'true' ? '#28a745' : '#007bff'">
                                        <span id="followButtonText">Seguir</span>
                                    </button>
                                    
                                    <button onclick="navigator.clipboard.writeText(window.location.href).then(() => showToast('Link do perfil copiado!'))" style="
                                        background: linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981); 
                                        color: white; 
                                        border: none; 
                                        padding: 0.75rem 1rem; 
                                        border-radius: 8px; 
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                        transition: all 0.2s ease;
                                        flex: 1;
                                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        üîó Compartilhar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Card de N√≠vel -->
                            <div class="level-card" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 15px 20px;
                                border-radius: 12px;
                                margin-bottom: 20px;
                                position: relative;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <div class="level-title" style="font-size: 18px; font-weight: bold; margin-bottom: 2px;">N√≠vel 1</div>
                                        <div class="level-name" style="font-size: 14px; opacity: 0.9;">Iniciante</div>
                                    </div>
                                    <div style="font-size: 24px;">üì¢</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="level-points" style="font-size: 14px;">0 pontos</span>
                                    <span class="level-next" style="font-size: 14px;">100 para pr√≥ximo n√≠vel</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div class="level-progress" style="background: white; height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s ease;"></div>
                                </div>
                                <div class="level-ranking" style="text-align: center; margin-top: 8px; font-size: 12px; opacity: 0.9;">
                                    Ranking: #-- de -- usu√°rios
                                </div>
                            </div>
                            
                            <!-- Linha 3: Posts Criados | Holofotes Recebidos | Emblemas Conquistados -->
                            <div style="
                                display: grid; 
                                grid-template-columns: repeat(3, 1fr); 
                                gap: 1.5rem; 
                                margin-bottom: 2rem;
                            ">
                                <div onclick="ProfileRouter.loadUserPosts('${userData.id}')" style="
                                    border-radius: 12px; 
                                    padding: 1.5rem; 
                                    text-align: center; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                    border: 2px solid transparent;
                                    background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box;
                                    cursor: pointer;
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                    <div style="font-size: 2rem; font-weight: bold; color: #e65100; margin-bottom: 0.5rem;">${stats.posts}</div>
                                    <div style="color: #666; font-weight: 600;">Posts Criados</div>
                                </div>
                                
                                <div onclick="ProfileRouter.loadUserHolofotes('${userData.id}')" style="
                                    border-radius: 12px; 
                                    padding: 1.5rem; 
                                    text-align: center; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                    border: 2px solid transparent;
                                    background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box;
                                    cursor: pointer;
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                    <div style="font-size: 2rem; font-weight: bold; color: #e65100; margin-bottom: 0.5rem;">${stats.holofotes}</div>
                                    <div style="color: #666; font-weight: 600;">Holofotes Recebidos</div>
                                </div>
                                
                                <div onclick="openUserAchievementsModal('${userData.id}')" style="
                                    border-radius: 12px; 
                                    padding: 1.5rem; 
                                    text-align: center; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                    border: 2px solid transparent;
                                    background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box;
                                    cursor: pointer;
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                    <div style="font-size: 2rem; font-weight: bold; color: #e65100; margin-bottom: 0.5rem;" id="userAchievementsCount">0</div>
                                    <div style="color: #666; font-weight: 600;">Emblemas Conquistados</div>
                                </div>
                            </div>
                            
                            <!-- Bot√µes de A√ß√£o -->
                            <div style="text-align: center;">
                                <button onclick="ProfileRouter.closeFullProfile()" style="
                                    background: #6c757d; 
                                    color: white; 
                                    border: none; 
                                    padding: 0.75rem 2rem; 
                                    border-radius: 25px; 
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    margin-right: 1rem;
                                    transition: background 0.2s ease;
                                " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">‚Üê Voltar para o Feed</button>
                            </div>
                        </div>
                    `;
                    
                    // Carregar dados do n√≠vel do usu√°rio (reutilizando fun√ß√£o existente)
                    const levelCard = content.querySelector('.level-card');
                    if (levelCard) {
                        loadUserLevelData(userData.id, levelCard);
                    }
                    
                    // Carregar dados de emblemas conquistados
                    loadUserAchievementsCount(userData.id);
                    
                    // Verificar status de seguir
                    checkUserFollowStatus(userData.id);
                }
            }
            
            static showPlaceholder(userIdentifier, userData = null) {
                const content = document.getElementById('fullProfileContent');
                if (content) {
                    // Fallback para placeholder gen√©rico (caso n√£o tenha userData)
                    content.innerHTML = '<div style="text-align: center; padding: 3rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">üë§</div><h2>P√°gina de Perfil Completo</h2><p style="color: #666; margin: 1rem 0;"><strong>Identificador:</strong> ' + userIdentifier + '</p><p style="color: #666; margin: 1rem 0;">Esta √© a nova p√°gina completa de perfil!<br>Carregando dados...</p><div style="margin-top: 2rem;"><button onclick="ProfileRouter.closeFullProfile()" style="background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600;">‚Üê Voltar para o Feed</button></div></div>';
                }
            }

        // Fun√ß√£o showError movida para dentro da classe PostRouter
        static showError(message) {
                const content = document.getElementById('fullProfileContent');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 3rem; color: #dc3545;"><div style="font-size: 2rem; margin-bottom: 1rem;">üòï</div><h3>Ops! Algo deu errado</h3><p style="margin: 1rem 0;">' + message + '</p><button onclick="ProfileRouter.closeFullProfile()" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600;">‚Üê Voltar</button></div>';
                }
            }
            
            // Abrir modal de posts do usu√°rio espec√≠fico
            static async loadUserPosts(userId) {
                console.log('üìù Abrindo modal de posts do usu√°rio:', userId);
                
                // Tentar abrir modal diretamente
                let modal = document.getElementById('postsModal');
                
                // Se modal n√£o existe, estamos na p√°gina de perfil - criar modal temporariamente
                if (!modal) {
                    console.log('üìù Modal n√£o encontrado na p√°gina de perfil, usando modal tempor√°rio...');
                    
                    // Criar modal tempor√°rio para a p√°gina de perfil (c√≥pia exata do original)
                    modal = document.createElement('div');
                    modal.id = 'tempPostsModal';
                    modal.className = 'modal-overlay';
                    modal.style.cssText = 'display: flex; z-index: 10001;'; // z-index maior que p√°gina de perfil (10000)
                    
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2>üìù Posts</h2>
                                <button class="close-btn" onclick="document.getElementById('tempPostsModal').remove()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="modalPostsContent" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Posts ser√£o carregados aqui -->
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Fechar modal ao clicar no fundo
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                }
                
                // Modal existe, abrir diretamente
                await this.openPostsModalDirect(modal, userId);
            }
            
            static async openPostsModalDirect(modal, userId) {
                // Personalizar t√≠tulo baseado no usu√°rio
                const modalHeader = modal.querySelector('.modal-header h2');
                if (modalHeader) {
                    if (userId === currentUser?.id) {
                        modalHeader.textContent = 'üìù Seus Posts';
                    } else {
                        // Buscar dados do usu√°rio para pegar o username
                        try {
                            const { data: userData } = await supabase
                                .from('profiles')
                                .select('email')
                                .eq('id', userId)
                                .single();
                            
                            const username = userData?.email?.split('@')[0] || 'usuario';
                            modalHeader.textContent = `üìù Posts de @${username}`;
                        } catch (error) {
                            modalHeader.textContent = 'üìù Posts do Usu√°rio';
                        }
                    }
                }
                
                modal.style.display = 'flex';
                
                // Usar fun√ß√£o original com par√¢metro
                await window.loadPostsInModal(userId);
            }
            
            // Abrir modal de holofotes do usu√°rio espec√≠fico
            static async loadUserHolofotes(userId) {
                console.log('üéØ Abrindo modal de holofotes do usu√°rio:', userId);
                
                // Tentar abrir modal diretamente
                let modal = document.getElementById('holofotesRecebidosModal');
                
                // Se modal n√£o existe, estamos na p√°gina de perfil - criar modal temporariamente
                if (!modal) {
                    console.log('üéØ Modal n√£o encontrado na p√°gina de perfil, usando modal tempor√°rio...');
                    
                    // Criar modal tempor√°rio para a p√°gina de perfil (c√≥pia exata do original)
                    modal = document.createElement('div');
                    modal.id = 'tempHolofotesModal';
                    modal.className = 'modal-overlay';
                    modal.style.cssText = 'display: flex; z-index: 10001;'; // z-index maior que p√°gina de perfil (10000)
                    
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2><img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos</h2>
                                <button class="close-btn" onclick="document.getElementById('tempHolofotesModal').remove()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="modalHolofotesRecebidosContent">
                                    <p style="text-align: center; color: #666;">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Fechar modal ao clicar no fundo
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                }
                
                // Modal existe, abrir diretamente
                await this.openHolofotesModalDirect(modal, userId);
            }
            
            static async openHolofotesModalDirect(modal, userId) {
                // Personalizar t√≠tulo baseado no usu√°rio
                const modalHeader = modal.querySelector('.modal-header h2');
                if (modalHeader) {
                    if (userId === currentUser?.id) {
                        modalHeader.innerHTML = '<img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos';
                    } else {
                        // Buscar dados do usu√°rio para pegar o username
                        try {
                            const { data: userData } = await supabase
                                .from('profiles')
                                .select('email')
                                .eq('id', userId)
                                .single();
                            
                            const username = userData?.email?.split('@')[0] || 'usuario';
                            modalHeader.innerHTML = `<img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes para @${username}`;
                        } catch (error) {
                            modalHeader.innerHTML = '<img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos';
                        }
                    }
                }
                
                modal.style.display = 'flex';
                
                // Usar fun√ß√£o original com par√¢metro
                await window.loadHolofotesRecebidosInModal(userId);
            }
            
            // Verificar URL inicial ao carregar a p√°gina
            static checkInitialURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const profileParam = urlParams.get('profile');
                
                if (profileParam) {
                    console.log('üîç Par√¢metro profile encontrado na URL:', profileParam);
                    // Abrir perfil automaticamente
                    this.showFullProfile(profileParam);
                } else {
                    console.log('‚ÑπÔ∏è Nenhum par√¢metro profile na URL');
                }
            }
            
        }

        // Classe PostRouter para gerenciar p√°ginas √∫nicas de posts
        class PostRouter {
            static currentPostData = null;
            
            static showSinglePostPage(postId) {
                console.log('üîÑ PostRouter.showSinglePostPage chamado para postId:', postId);
                
                try {
                    if (!postId || postId === 'undefined' || postId === 'null') {
                        throw new Error('PostId inv√°lido');
                    }
                    
                    this.hideMainInterface();
                    this.showPostContainer();
                    this.updateURL(postId);
                    this.loadPostContent(postId);
                    
                    console.log('‚úÖ P√°gina √∫nica de post aberta para postId:', postId);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao mostrar p√°gina √∫nica de post:', error);
                    this.showError('Erro ao carregar post: ' + error.message);
                }
            }
            
            static closeSinglePostPage() {
                console.log('üîÑ PostRouter.closeSinglePostPage chamado');
                
                try {
                    this.showMainInterface();
                    this.hidePostContainer();
                    this.clearURL();
                    this.currentPostData = null;
                    
                    console.log('‚úÖ P√°gina √∫nica de post fechada');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao fechar p√°gina √∫nica de post:', error);
                    this.forceShowMainInterface();
                }
            }
            
            static hideMainInterface() {
                const appContainer = document.getElementById('appContainer');
                const navTabs = document.querySelector('.nav-tabs');
                
                if (appContainer) appContainer.style.display = 'none';
                if (navTabs) navTabs.style.display = 'none';
                console.log('‚úÖ Interface principal escondida');
            }
            
            static showMainInterface() {
                const appContainer = document.getElementById('appContainer');
                const navTabs = document.querySelector('.nav-tabs');
                
                if (appContainer) appContainer.style.display = 'block';
                if (navTabs) navTabs.style.display = 'flex';
                console.log('‚úÖ Interface principal mostrada');
            }
            
            static forceShowMainInterface() {
                this.showMainInterface();
                this.hidePostContainer();
                this.clearURL();
                console.log('üîß Interface principal for√ßada a aparecer');
            }
            
            static showPostContainer() {
                const container = document.getElementById('singlePostPageContainer');
                if (container) {
                    container.style.display = 'block';
                    console.log('‚úÖ Container de post mostrado');
                }
            }
            
            static hidePostContainer() {
                const container = document.getElementById('singlePostPageContainer');
                if (container) {
                    container.style.display = 'none';
                    console.log('‚úÖ Container de post escondido');
                }
            }
            
            static updateURL(postId) {
                const newURL = `${window.location.origin}${window.location.pathname}?post=${postId}`;
                window.history.pushState({ postId }, '', newURL);
                console.log('üîó URL atualizada para:', newURL);
            }
            
            static clearURL() {
                const newURL = `${window.location.origin}${window.location.pathname}`;
                window.history.pushState({}, '', newURL);
                console.log('üîó URL limpa para:', newURL);
            }
            
            static async loadPostContent(postId) {
                const content = document.getElementById('singlePostPageContent');
                if (!content) return;
                
                try {
                    // Verificar cache primeiro
                    if (this.currentPostData && this.currentPostData.id === postId) {
                        console.log('üìã Usando post do cache');
                        this.renderCachedPost();
                        return;
                    }
                    
                    // Mostrar loading
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
                            <h3>Carregando post...</h3>
                            <p style="color: #666; margin: 1rem 0;">Aguarde um momento...</p>
                        </div>
                    `;
                    
                    // Buscar dados do post usando fun√ß√£o original que funciona
                    const postData = await fetchPostDetails(postId);
                    
                    if (!postData) {
                        throw new Error('Post n√£o encontrado');
                    }
                    
                    // Salvar no cache
                    this.currentPostData = postData;
                    
                    // Renderizar post
                    this.renderPostContent(postData);
                    
                    // Bot√£o voltar ser√° adicionado pela fun√ß√£o renderPostContent
                    
                    console.log('‚úÖ Post carregado com sucesso:', postId);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar post:', error);
                    this.showError('Erro ao carregar post: ' + error.message);
                }
            }
            
            static determineModalType(postData) {
                // Mesma l√≥gica do sistema existente
                if (postData.mentioned_user_id === currentUser?.id) {
                    return 'received';
                } else if (postData.user_id === currentUser?.id) {
                    return 'sent';
                } else {
                    return 'public';
                }
            }

            static showError(message) {
                const content = document.getElementById('singlePostPageContent');
                if (content) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #dc3545;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üòï</div>
                            <h3>Ops! Algo deu errado</h3>
                            <p style="margin: 1rem 0;">${message}</p>
                            <button onclick="PostRouter.closeSinglePostPage()" style="
                                background: #dc3545; 
                                color: white; 
                                border: none; 
                                padding: 0.75rem 1.5rem; 
                                border-radius: 25px; 
                                cursor: pointer; 
                                font-size: 1rem; 
                                font-weight: 600;
                            ">‚Üê Voltar</button>
                        </div>
                    `;
                }
            }

            // Fun√ß√£o otimizada para buscar dados do post (reduz requests)
            static async fetchPostDataOptimized(postId) {
                try {
                    console.log('üöÄ Buscando post otimizado:', postId);
                    
                    // Uma √∫nica query com joins para reduzir requests
                    const { data: postData, error } = await supabase
                        .from('posts')
                        .select(`
                            *,
                            user_data:profiles!posts_user_id_fkey(id, username, avatar_url, name),
                            mentioned_user_data:profiles!posts_mentioned_user_id_fkey(id, username, avatar_url, name),
                            reactions(*),
                            comments(*),
                            feedbacks(*)
                        `)
                        .eq('id', postId)
                        .single();
                    
                    if (error) {
                        console.error('‚ùå Erro ao buscar post otimizado:', error);
                        return null;
                    }
                    
                    console.log('‚úÖ Post carregado com 1 request otimizado');
                    return postData;
                    
                } catch (error) {
                    console.error('‚ùå Erro na busca otimizada:', error);
                    return null;
                }
            }

            // Renderizar post do cache
            static renderCachedPost() {
                if (this.currentPostData) {
                    this.renderPostContent(this.currentPostData);
                }
            }

            // Renderizar conte√∫do do post
            static renderPostContent(postData) {
                const content = document.getElementById('singlePostPageContent');
                if (!content) return;
                
                // Criar mock de modal para reutilizar renderSinglePost
                const mockModal = {
                    querySelector: (selector) => {
                        if (selector === '#singlePostContent') {
                            return content;
                        }
                        return null;
                    }
                };
                
                // Determinar tipo de modal
                const modalType = this.determineModalType(postData);
                
                // Reutilizar fun√ß√£o existente
                renderSinglePost(postData, mockModal, modalType);
                
                // Adicionar bot√£o voltar no topo
                const backButton = document.createElement('div');
                backButton.innerHTML = `
                    <button onclick="PostRouter.closeSinglePostPage()" style="
                        background: linear-gradient(135deg, #ff6b35, #f7931e);
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 600;
                        margin-bottom: 1.5rem;
                        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 53, 0.4)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 53, 0.3)'">
                        ‚Üê Voltar para o Feed
                    </button>
                `;
                content.insertBefore(backButton, content.firstChild);
            }

            // Verificar URL inicial ao carregar a p√°gina
            static checkInitialURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const postParam = urlParams.get('post');
                
                if (postParam) {
                    console.log('üîç Par√¢metro post encontrado na URL:', postParam);
                    console.log('üöÄ Carregando APENAS o post espec√≠fico (otimizado)');
                    
                    // Carregar APENAS o post espec√≠fico, n√£o todos os posts
                    // Aguardar apenas autentica√ß√£o b√°sica
                    setTimeout(() => {
                        PostRouter.showSinglePostPage(postParam);
                    }, 500); // Reduzido de 1000ms para 500ms
                } else {
                    console.log('‚ÑπÔ∏è Nenhum par√¢metro post na URL');
                }
            }
        }

        // Fun√ß√£o para compartilhar posts (copiar link))
        function sharePost(postId) {
            try {
                console.log('üîó Copiando link do post:', postId);
                
                // Gerar URL compartilh√°vel
                const shareURL = `${window.location.origin}${window.location.pathname}?post=${postId}`;
                
                // Copiar para clipboard
                copyToClipboard(shareURL);
                
            } catch (error) {
                console.error('‚ùå Erro ao copiar link do post:', error);
                alert('Erro ao copiar link do post. Tente novamente.');
            }
        }

        // Fun√ß√£o auxiliar para copiar para clipboard
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('‚úÖ URL copiada para clipboard');
                    showShareSuccess('Link copiado para a √°rea de transfer√™ncia!');
                }).catch((error) => {
                    console.error('‚ùå Erro ao copiar para clipboard:', error);
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback para navegadores mais antigos
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                console.log('‚úÖ URL copiada via fallback');
                showShareSuccess('Link copiado para a √°rea de transfer√™ncia!');
            } catch (error) {
                console.error('‚ùå Erro no fallback de c√≥pia:', error);
                showShareSuccess(`Link do post: ${text}`);
            }
            
            document.body.removeChild(textArea);
        }

        // Mostrar feedback de sucesso
        function showShareSuccess(message) {
            // Criar toast de sucesso
            const toast = document.createElement('div');
            toast.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #e65100, #ff8a50);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 25px;
                    box-shadow: 0 4px 12px rgba(230, 81, 0, 0.3);
                    z-index: 10002;
                    font-weight: 600;
                    animation: slideIn 0.3s ease;
                ">
                    ‚úÖ ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Event listeners para ProfileRouter
        window.addEventListener('popstate', function(event) {
            console.log('üîÑ Evento popstate detectado:', event.state);
            try {
                if (event.state && event.state.profileId) {
                    ProfileRouter.showFullProfile(event.state.profileId);
                } else {
                    ProfileRouter.closeFullProfile();
                }
            } catch (error) {
                console.error('‚ùå Erro no popstate:', error);
            }
        });
        
        // Event listeners para PostRouter
        window.addEventListener('popstate', function(event) {
            console.log('üîÑ Evento popstate detectado para PostRouter:', event.state);
            try {
                if (event.state && event.state.postId) {
                    PostRouter.showSinglePostPage(event.state.postId);
                } else if (event.state && event.state.profileId) {
                    // Manter funcionalidade do ProfileRouter
                    ProfileRouter.showFullProfile(event.state.profileId);
                } else {
                    // Fechar ambos se n√£o h√° par√¢metros
                    PostRouter.closeSinglePostPage();
                    ProfileRouter.closeFullProfile();
                }
            } catch (error) {
                console.error('‚ùå Erro no popstate:', error);
            }
        });

        // Event listeners para dropdown de filtros
        document.addEventListener('click', function(e) {
            const feedEmojiDropdown = document.getElementById('feedEmojiDropdown');
            const dropdown = document.getElementById('feedFilterDropdown');
            const inicioNavTab = document.getElementById('inicioNavTab');
            
            // Toggle dropdown ao clicar no emoji+setinha
            if (feedEmojiDropdown && (e.target === feedEmojiDropdown || feedEmojiDropdown.contains(e.target))) {
                if (dropdown && inicioNavTab) {
                    const isVisible = dropdown.style.display === 'block';
                    
                    if (!isVisible) {
                        // Calcular posi√ß√£o do bot√£o ANTES de mostrar
                        const rect = inicioNavTab.getBoundingClientRect();
                        dropdown.style.top = `${rect.bottom + 8}px`;
                        dropdown.style.left = `${rect.left + (rect.width / 2)}px`;
                        dropdown.style.transform = 'translateX(-50%)';
                        dropdown.style.opacity = '0';
                        dropdown.style.display = 'block';
                        
                        // For√ßar reflow para aplicar posi√ß√£o antes da anima√ß√£o
                        dropdown.offsetHeight;
                        
                        // Agora mostrar com anima√ß√£o
                        dropdown.style.opacity = '1';
                    } else {
                        dropdown.style.display = 'none';
                    }
                }
                e.stopPropagation();
            }
            // Fechar dropdown ao clicar fora
            else if (dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Event listeners para op√ß√µes do dropdown
        document.addEventListener('click', function(e) {
            const filterOption = e.target.closest('.filter-option');
            if (filterOption) {
                const filter = filterOption.dataset.filter;
                if (filter) {
                    setFeedFilter(filter);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar filtro de feed
            // Prioridade: default_feed do perfil > localStorage > 'recommended'
            const userDefaultFeed = currentUser?.user_metadata?.default_feed;
            const savedFilter = userDefaultFeed || localStorage.getItem('feedFilter') || 'recommended';
            window.currentFeedFilter = savedFilter;
            
            // Sincronizar localStorage com prefer√™ncia do usu√°rio
            if (userDefaultFeed) {
                localStorage.setItem('feedFilter', userDefaultFeed);
            }
            
            // Atualizar APENAS a UI inicial (sem chamar loadPosts)
            setTimeout(() => {
                // Atualizar emoji
                const emoji = document.getElementById('feedEmoji');
                if (emoji) {
                    emoji.textContent = savedFilter === 'following' ? 'üë•' : 'üåç';
                }
                
                // Atualizar dropdown
                document.querySelectorAll('.filter-option').forEach(option => {
                    if (option.dataset.filter === savedFilter) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                console.log('‚úÖ [DEBUG] UI do filtro inicializada sem chamar loadPosts');
            }, 100);
            
            setTimeout(() => {
                ProfileRouter.checkInitialURL();
                PostRouter.checkInitialURL();
            }, 2000);
        });

        console.log('‚úÖ HoloSpot v8 carregado com sucesso!');
    </script>

    <!-- Modals for Received Metrics -->
    <div id="postsReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üì® Posts Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="postsReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="commentsReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üí¨ Coment√°rios Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="commentsReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="feedbacksReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üì¨ Feedback</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="feedbacksReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Novos Modais para M√©tricas Recebidas -->
    <div id="holofotesRecebidosModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><img src="./holofote.png" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalHolofotesRecebidosContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="pessoasQueTeDestacaramModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üë• Pessoas que te Destacaram</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPessoasQueTeDestacaramContent" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Posts Criados -->
    <div id="postsModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üìù Seus Posts</h2>
                <button class="close-btn" onclick="closePostsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPostsContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Posts ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pessoas Destacadas -->
    <div id="peopleHighlightedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üë• Pessoas Destacadas</h2>
                <button class="close-btn" onclick="closePeopleHighlightedModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPeopleHighlightedContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Pessoas destacadas ser√£o carregadas aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Container para p√°gina √∫nica de post (inicialmente oculto) -->
    <div id="singlePostPageContainer" class="single-post-page-container" style="display: none;">
        <div class="single-post-page-header">
            <div class="post-page-logo" onclick="PostRouter.closeSinglePostPage()" style="cursor: pointer;">
                <img src="./holospot_logo_cropped-Photoroom.png" style="width: 180px; height: auto;">
            </div>
        </div>
        <div id="singlePostPageContent" class="single-post-page-content">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>

    <script>
        // Fun√ß√£o espec√≠fica para toggle follow na p√°gina do usu√°rio
        async function toggleUserPageFollow(userId) {
            const followButton = document.getElementById('followButton');
            const followButtonText = document.getElementById('followButtonText');
            
            if (!followButton || !followButtonText) return;
            
            // Mostrar estado de carregamento
            followButtonText.textContent = 'Processando...';
            followButton.disabled = true;
            
            try {
                // Chamar fun√ß√£o original que faz a a√ß√£o no banco
                await toggleFollow(userId);
                
                // Recarregar dados da p√°gina (igual como funciona na aba Perfil)
                // Buscar dados atualizados do usu√°rio
                const { data: userData, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (userData && !error) {
                    // Recarregar a p√°gina do usu√°rio com dados atualizados
                    ProfileRouter.showFullProfile(userData.id);
                } else {
                    // Se n√£o conseguir recarregar, pelo menos atualizar o bot√£o
                    const isNowFollowing = following.some(f => f.following_id === userId);
                    followButtonText.textContent = isNowFollowing ? 'Seguindo' : 'Seguir';
                    followButton.style.background = isNowFollowing ? '#28a745' : '#007bff';
                    followButton.dataset.isFollowing = isNowFollowing.toString();
                }
                
            } catch (error) {
                console.error('Erro ao seguir/desseguir:', error);
                showToast('Erro ao atualizar. Tente novamente.');
            } finally {
                followButton.disabled = false;
            }
        }
    </script>

    <!-- Feed Filter Dropdown (fora do container das abas) -->
    <div id="feedFilterDropdown" class="feed-filter-dropdown" style="display: none;">
        <div class="filter-option" data-filter="recommended">
            <span>üåç Recomendados</span>
        </div>
        <div class="filter-option" data-filter="following">
            <span>üë• Seguindo</span>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="settingsModal" class="modal-overlay" style="display: none;" onclick="closeSettingsModal()">
        <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2 style="margin-bottom: 2rem; color: #333;">‚öôÔ∏è Configura√ß√µes do Perfil</h2>
            
            <form id="settingsForm" onsubmit="saveSettings(event)">
                <!-- Avatar -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="position: relative; display: inline-block;">
                        <img id="settingsAvatarPreview" src="" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea;">
                        <label for="avatarUpload" style="position: absolute; bottom: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            üì∑
                        </label>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                    </div>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Clique na c√¢mera para alterar</p>
                </div>
                
                <!-- Nome Completo -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: 600;">Nome Completo</label>
                    <input type="text" id="settingsFullName" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;" placeholder="Seu nome completo">
                </div>
                
                <!-- Username -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: 600;">@Username</label>
                    <div style="position: relative;">
                        <input type="text" id="settingsUsername" required pattern="[a-zA-Z0-9._]+" style="width: 100%; padding: 12px; padding-right: 40px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;" placeholder="seu.username" oninput="checkUsernameAvailability()">
                        <span id="usernameStatus" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem;"></span>
                    </div>
                    <p id="usernameMessage" style="font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0;"></p>
                </div>
                
                <!-- Feed Padr√£o -->
                <div style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: 600;">Feed Padr√£o</label>
                    <select id="settingsDefaultFeed" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer;">
                        <option value="recommended">üåç Recomendados (todos os posts)</option>
                        <option value="following">üë• Seguindo (apenas quem voc√™ segue)</option>
                    </select>
                    <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0;">Escolha qual feed aparecer√° ao abrir o app</p>
                </div>
                
                <!-- Bot√µes -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeSettingsModal()" style="padding: 12px 24px; border: 2px solid #e0e0e0; background: white; color: #666; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s;">
                        Cancelar
                    </button>
                    <button type="submit" id="saveSettingsBtn" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
