<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoloSpot - Colocando os holofotes nos outros</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Fallback para Chart.js se o primeiro CDN falhar
        if (typeof Chart === 'undefined') {
            console.log('üîÑ Tentando CDN alternativo para Chart.js...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.min.js';
            script.onload = function() {
                console.log('‚úÖ Chart.js carregado via CDN alternativo');
            };
            script.onerror = function() {
                console.error('‚ùå Falha ao carregar Chart.js via CDN alternativo');
            };
            document.head.appendChild(script);
        } else {
            console.log('‚úÖ Chart.js carregado com sucesso');
        }
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKK75JRY5W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HKK75JRY5W');
        
        function trackEvent(eventName, parameters = {}) {
            gtag('event', eventName, parameters);
            console.log('üìä Event tracked:', eventName, parameters);
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem 0.5rem 2rem;
            box-shadow: none;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: none;
            border-radius: 0;
            margin-bottom: -10px;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .header-content {
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0;
        }

        /* Layout mobile - duas linhas */
        @media (max-width: 768px) {
            /* Reorganiza elementos para mobile */
            .header-content {
                display: grid;
                grid-template-areas: 
                    "logo notifications"
                    "user-section logout";
                grid-template-columns: 1fr auto;
                gap: 1rem;
                align-items: center;
            }

            .logo {
                grid-area: logo;
                grid-column: 1 / -1;
                justify-self: center !important;
                align-self: center;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                justify-content: center;
            }

            .notifications {
                grid-area: notifications;
                justify-self: end;
            }

            .user-section {
                grid-area: user-section;
                justify-self: start;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .logout-btn {
                grid-area: logout;
                justify-self: end;
            }

            .header-actions {
                display: contents;
            }
        }

        /* Layout desktop - uma linha */
        @media (min-width: 769px) {
            .header-top {
                display: contents;
            }

            .header-bottom {
                display: contents;
            }

            .user-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            /* Aproxima abas do header apenas no desktop */
            .nav-tabs {
                top: 140px !important;
            }

            /* Reorganiza header para desktop */
            .header-content {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                grid-template-areas: none !important;
                align-items: center !important;
                gap: 2rem;
                height: auto;
            }

            /* User info na esquerda */
            .user-section {
                grid-column: 1;
                grid-area: unset !important;
                justify-self: start !important;
                align-self: center;
                order: 1;
            }

            /* Logo no centro */
            .logo {
                grid-column: 2;
                grid-area: unset !important;
                justify-self: center !important;
                align-self: center;
                order: 2;
            }

            /* Notifica√ß√µes e bot√£o sair na direita */
            .header-actions {
                grid-column: 3;
                grid-area: unset !important;
                justify-self: end;
                align-self: center;
                display: flex;
                align-items: center;
                gap: 1rem;
                order: 3;
            }

            .notifications {
                order: 1;
            }

            .logout-btn {
                order: 2;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo span {
            background: linear-gradient(135deg, #FFB700, #E55A2B) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFF 30%, transparent 70%);
            border-radius: 50%;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 215, 0, 0.3) 45deg, transparent 90deg, rgba(255, 215, 0, 0.3) 135deg, transparent 180deg, rgba(255, 215, 0, 0.3) 225deg, transparent 270deg, rgba(255, 215, 0, 0.3) 315deg, transparent 360deg);
            border-radius: 50%;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            background: rgba(255, 183, 0, 0.1);
            transition: all 0.3s ease;
        }

        .notifications:hover {
            background: rgba(255, 183, 0, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: rgba(255, 183, 0, 0.05);
            border-left: 3px solid #FFB700;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            line-height: 1.2;
            margin: 0;
            padding: 0;
        }

        .user-username {
            font-size: 0.85rem;
            color: #666;
            margin-top: 3px;
            margin-bottom: 0;
            padding: 0;
            line-height: 1.1;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff3742;
            transform: translateY(-1px);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: bold;
            color: #FFB700;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .google-login-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .google-login-btn:hover {
            border-color: #4285f4;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.2);
            transform: translateY(-2px);
        }

        /* Main App */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 2rem 2rem;
            display: none;
        }

        .app-container.active {
            display: block;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            padding: 0.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-top: -10px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: sticky;
            top: 160px;
            z-index: 98;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            min-width: 120px;
            text-indent: -2px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .nav-tab:not(.active):hover {
            background: rgba(255, 183, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Posts */
        .posts-container {
            display: grid;
            gap: 1.5rem;
        }

        .post {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-author {
            flex: 1;
        }

        .post-author-name {
            font-weight: 600;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.2;
        }

        .post-author-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 3px;
        }

        .post-author-username {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .post-time-separator {
            color: #999;
            font-size: 0.8rem;
        }

        .post-time {
            color: #666;
            font-size: 0.75rem;
        }

        .follow-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .follow-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .follow-btn.following {
            background: #28a745;
        }

        .post-content {
            margin-bottom: 1rem;
        }

        .post-person {
            font-weight: 600;
            color: #e65100;
            margin-bottom: 0.5rem;
        }

        .post-type {
            display: inline-block;
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .post-story {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .post-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: none;
            border: none;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .reaction-btn:hover {
            background: rgba(255, 183, 0, 0.1);
            transform: translateY(-1px);
        }

        .reaction-btn.active {
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
        }

        /* Feedback Section */
        .feedback-section {
            margin-top: 1rem;
        }

        .feedback-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .feedback-btn.feedback-given {
            background: #28a745;
            cursor: not-allowed;
        }

        .feedback-btn.feedback-given:hover {
            transform: none;
            box-shadow: none;
        }

        /* Create Post Form */
        .create-post-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
        }

        .form-input:focus {
            outline: none;
            border-color: #FFB700;
            box-shadow: 0 0 0 3px rgba(255, 183, 0, 0.1);
        }

        .highlight-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .highlight-type {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .highlight-type:hover {
            border-color: #FFB700;
            transform: translateY(-2px);
        }

        .highlight-type.selected {
            border-color: #FFB700;
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
        }

        .highlight-type-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .highlight-type-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .highlight-type-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .photo-upload-section {
            margin-bottom: 1.5rem;
        }

        .photo-upload-btn {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .photo-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .photo-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .photo-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            object-fit: cover;
        }

        .remove-photo-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 183, 0, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reaction-btn:disabled {
            cursor: not-allowed !important;
            opacity: 1 !important;
            background-color: transparent !important;
            color: inherit !important;
            border-color: transparent !important;
        }

        .reaction-btn.disabled {
            cursor: not-allowed !important;
            opacity: 1 !important;
            background-color: transparent !important;
            color: inherit !important;
            border-color: transparent !important;
        }

        /* Profile & Impact Tabs */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* Desktop: Force 5 columns for metrics */
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.8rem;
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* Desktop: Smaller padding for compact layout */
        @media (min-width: 1024px) {
            .stat-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        /* Gradient borders for clickable stat cards */
        #postsCreatedCard,
        #peopleHighlightedCard,
        #postsReceivedCard,
        #peopleWhoHighlightedCard {
            border: 2px solid transparent !important;
            background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box !important;
        }

        #postsReceivedCard,
        #peopleWhoHighlightedCard {
            background: linear-gradient(#f8f9fa, #f8f9fa) padding-box, linear-gradient(135deg, #E55A2B, #9C27B0) border-box !important;
        }

        /* Hover effect only for clickable stat cards */
        #postsCreatedCard:hover,
        #peopleHighlightedCard:hover,
        #postsReceivedCard:hover,
        #peopleWhoHighlightedCard:hover {
            /* Hover effects are now handled by inline styles for better control */
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .evolution-chart {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
            text-align: right;
        }

        /* Following/Followers */
        .follow-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .follow-stat {
            text-align: center;
            cursor: pointer;
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .follow-stat:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .follow-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .follow-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            max-height: 70vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB700 0%, #E55A2B 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        /* Header espec√≠fico para modal de feedbacks */
        #feedbacksModal .modal-header {
            background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 24px;
            max-height: calc(70vh - 80px);
            overflow-y: auto;
        }

        .follow-list {
            margin: 0;
        }

        .follow-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            transition: all 0.2s ease;
        }

        .follow-item:last-child {
            border-bottom: none;
        }

        .follow-item:hover {
            background: #f9fafb;
            margin: 0 -24px;
            padding: 12px 24px;
            border-radius: 8px;
        }

        .follow-item img {
            margin-right: 12px;
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s ease;
        }

        .follow-item:hover img {
            border-color: #FFB700;
        }

        .follow-item span {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Feedback Modal */
        .feedback-modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            position: relative;
        }

        .feedback-modal-header {
            background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .feedback-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .feedback-modal-body {
            padding: 24px;
        }

        .feedback-modal-body p {
            margin: 0 0 1rem 0;
            color: #555;
        }

        .feedback-modal-footer {
            padding: 16px 24px;
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid #e9ecef;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: none;
            outline: none;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 90, 43, 0.3);
        }

        .holofote-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
            position: relative;
        }

        .holofote-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: #FF8C00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .app-container {
                padding: 1rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                top: 200px !important;
            }

            .nav-tab {
                min-width: auto;
                flex: 1;
                padding: 0.5rem 0;
                font-size: 0.75rem;
                font-weight: 500;
                text-align: center !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .follow-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .highlight-types {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden file input */
        #photoUpload {
            display: none;
        }

        /* Sistema de Men√ß√µes */
        .textarea-container {
            position: relative;
        }

        .mentions-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }

        .mention-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .mention-item:last-child {
            border-bottom: none;
        }

        .mention-item:hover,
        .mention-item.selected {
            background-color: #f3f4f6;
        }

        .mention-item img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #e5e7eb;
        }

        .mention-info {
            flex: 1;
        }

        .mention-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.95rem;
        }

        .mention-username {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        /* que das men√ß√µes nos posts */
        .mention-highlight {
            color: #FFB700;
            font-weight: 500;
            text-decoration: none;
        }

        .mention-highlight:hover {
            text-decoration: underline;
        }

        /* Bot√£o de Impacto */
        .impact-button-container {
            margin: 2rem 0;
            text-align: center;
        }

        .impact-btn {
            background: linear-gradient(135deg, #FFD700, #E55A2B, #8B5CF6);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .impact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        /* Modal de Impacto - Using unified modal-overlay */
        .modal-overlay--impact {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-container {
            background: white;
            border-radius: 20px;
            max-width: 95vw;
            max-height: 90vh;
            width: 900px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB700, #E55A2B);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .modal-container {
                width: 95vw;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 1rem 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
        }

        /* Dashboard de Insights Estrat√©gicos */
        .insights-dashboard {
            margin-top: 2rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .insight-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        .insight-icon {
            font-size: 1.2rem;
        }

        .insight-title {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .insight-chart {
            position: relative;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .insight-progress {
            margin: 1rem 0;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #E55A2B;
            margin: 0.5rem 0;
        }

        .insight-description {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .insight-network {
            margin: 1rem 0;
        }

        .network-size {
            font-size: 2rem;
            font-weight: bold;
            color: #E55A2B;
        }

        .network-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .insight-altruism {
            margin: 1rem 0;
        }

        .altruism-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #E55A2B;
        }

        .altruism-message {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .insight-chart-large {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* Responsive adjustments for insights */
        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .insight-card {
                padding: 0.8rem;
            }
            
            .insight-value {
                font-size: 1.3rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }    
            .network-size {
                font-size: 1.6rem;
            }
            
            .altruism-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holospot_logo_cropped-Photoroom.png" style="width: 220px; height: auto;">
            </div>
            <p class="login-subtitle">Colocando os holofotes nos outros</p>
            <button id="loginBtn" class="google-login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <!-- User section (esquerda no desktop) -->
            <div class="user-section">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <div class="user-info">
                    <div id="userName" class="user-name">Carregando...</div>
                    <div id="userUsername" class="user-username">@carregando</div>
                </div>
            </div>

            <!-- Logo (centro no desktop) -->
            <div class="logo">
                <img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holospot_logo_cropped-Photoroom.png" style="width: 180px; height: auto;">
            </div>

            <!-- Actions (direita no desktop) -->
            <div class="header-actions">
                <div class="notifications" id="notificationsBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-item">
                            <div class="notification-text">Voc√™ tem novas men√ß√µes!</div>
                            <div class="notification-time">h√° 2 minutos</div>
                        </div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">Sair</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="inicio">üè† In√≠cio</div>
        <div class="nav-tab" data-tab="destacar"><img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar</div>
        <div class="nav-tab" data-tab="perfil">üë§ Perfil</div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">

        <!-- Tab Contents -->
        <div id="inicioTab" class="tab-content active">
            <div id="postsContainer" class="posts-container">
                <!-- Posts will be loaded here -->
            </div>
        </div>

        <div id="destacarTab" class="tab-content">
            <div class="create-post-form">
                <h2 style="margin-bottom: 1.5rem; color: #e65100;"><img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 20px; height: 20px; margin-right: 6px; vertical-align: middle;"> Destacar Algu√©m</h2>
                
                <div class="form-group">
                    <label class="form-label">Nome da pessoa</label>
                    <div class="textarea-container">
                        <input type="text" id="personName" class="form-input" placeholder="Digite o nome ou use @ para mencionar algu√©m...">
                        <div id="mentionsAutocomplete" class="mentions-autocomplete" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Que tipo de destaque √© esse?</label>
                    <div class="highlight-types">
                        <div class="highlight-type" data-type="gratidao">
                            <div class="highlight-type-emoji">üôè</div>
                            <div class="highlight-type-name">Gratid√£o</div>
                            <div class="highlight-type-desc">Agradecer por algo</div>
                        </div>
                        <div class="highlight-type" data-type="memoria">
                            <div class="highlight-type-emoji">üí≠</div>
                            <div class="highlight-type-name">Mem√≥ria</div>
                            <div class="highlight-type-desc">Lembrar momentos especiais</div>
                        </div>
                        <div class="highlight-type" data-type="conquista">
                            <div class="highlight-type-emoji">üèÜ</div>
                            <div class="highlight-type-name">Conquista</div>
                            <div class="highlight-type-desc">Celebrar vit√≥rias</div>
                        </div>
                        <div class="highlight-type" data-type="inspiracao">
                            <div class="highlight-type-emoji">‚ú®</div>
                            <div class="highlight-type-name">Inspira√ß√£o</div>
                            <div class="highlight-type-desc">Reconhecer exemplo</div>
                        </div>
                        <div class="highlight-type" data-type="apoio">
                            <div class="highlight-type-emoji">ü§ù</div>
                            <div class="highlight-type-name">Apoio</div>
                            <div class="highlight-type-desc">Valorizar suporte</div>
                        </div>
                        <div class="highlight-type" data-type="admiracao">
                            <div class="highlight-type-emoji">üåü</div>
                            <div class="highlight-type-name">Admira√ß√£o</div>
                            <div class="highlight-type-desc">Expressar respeito</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Conte sua hist√≥ria</label>
                    <textarea id="storyText" class="form-input" rows="4" placeholder="Por que essa pessoa merece destaque? O que ela fez de especial?"></textarea>
                </div>

                <div class="photo-upload-section">
                    <button type="button" class="photo-upload-btn" onclick="document.getElementById('photoUpload').click()">
                        üì∑ Adicionar Foto
                    </button>
                    <input type="file" id="photoUpload" accept="image/*" onchange="handlePhotoUpload(event)">
                    
                    <div id="photoPreview" class="photo-preview" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <br>
                        <button type="button" class="remove-photo-btn" onclick="removePhoto()">‚ùå Remover Foto</button>
                    </div>
                </div>

                <button id="createPostBtn" class="submit-btn" onclick="createPost()">
                    <img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa
                </button>
            </div>
        </div>

        <div id="perfilTab" class="tab-content">
            <div class="follow-stats">
                <div class="follow-stat" onclick="showFollowingModal()">
                    <div class="follow-number" id="followingCount">0</div>
                    <div class="follow-label">Seguindo</div>
                </div>
                <div class="follow-stat" onclick="showFollowersModal()">
                    <div class="follow-number" id="followersCount">0</div>
                    <div class="follow-label">Seguidores</div>
                </div>
            </div>
            
            <div class="stats-grid">
                <!-- Posts Criados -->
                <div class="stat-card" id="postsCreatedCard" style="cursor: pointer; transition: transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPostsCount">0</div>
                    <div class="stat-label">Posts Criados</div>
                </div>
                <!-- Pessoas Destacadas -->
                <div class="stat-card" id="peopleHighlightedCard" style="cursor: pointer; transition: transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPeopleHighlighted">0</div>
                    <div class="stat-label">Pessoas Destacadas</div>
                </div>
                <!-- Feedbacks Dados -->
                <div class="stat-card">
                    <div class="stat-number" id="userFeedbacksGiven">0</div>
                    <div class="stat-label">Feedbacks Dados</div>
                </div>
                <!-- Coment√°rios Escritos -->
                <div class="stat-card">
                    <div class="stat-number" id="userCommentsGiven">0</div>
                    <div class="stat-label">Coment√°rios Escritos</div>
                </div>
                <!-- Rea√ß√µes Dadas -->
                <div class="stat-card">
                    <div class="stat-number" id="userReactionsGiven">0</div>
                    <div class="stat-label">Rea√ß√µes Dadas</div>
                </div>
            </div>

            <!-- Streak de Engajamento -->
            <div class="evolution-chart">
                <h3 class="chart-title">üî• Streak de Engajamento</h3>
                <div style="margin-bottom: 1rem;">
                    <strong>Dias consecutivos ativo</strong>
                    
                    <!-- Barra 7 dias -->
                    <div class="progress-bar" style="margin-top: 0.5rem;">
                        <div class="progress-fill" id="engagementStreakProgress7" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText7">0/7</div>
                    
                    <!-- Barra 30 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress30" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText30">0/30</div>
                    
                    <!-- Barra 182 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress182" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText182">0/182</div>
                    
                    <!-- Barra 365 dias -->
                    <div class="progress-bar" style="margin-top: 0.3rem;">
                        <div class="progress-fill" id="engagementStreakProgress365" style="width: 0%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%);"></div>
                    </div>
                    <div class="progress-text" id="engagementStreakText365">0/365</div>
                </div>
            </div>

            <!-- M√âTRICAS RECEBIDAS -->
            <div class="stats-grid">
                <!-- Holofotes Recebidos (abaixo de Posts Criados) -->
                <div class="stat-card" id="postsReceivedCard" style="cursor: pointer; transition: transform 0.2s ease; background-color: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userHolofotesReceived">0</div>
                    <div class="stat-label">Holofotes Recebidos</div>
                </div>
                <!-- Pessoas que te Destacaram (abaixo de Pessoas Destacadas) -->
                <div class="stat-card" id="peopleWhoHighlightedCard" style="cursor: pointer; transition: transform 0.2s ease; background-color: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div class="stat-number" id="userPeopleWhoHighlighted">0</div>
                    <div class="stat-label">Pessoas que te Destacaram</div>
                </div>
                <!-- Feedbacks Recebidos (abaixo de Feedbacks Dados) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userFeedbacksReceived">0</div>
                    <div class="stat-label">Feedbacks Recebidos</div>
                </div>
                <!-- Coment√°rios Recebidos (abaixo de Coment√°rios Escritos) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userCommentsReceived">0</div>
                    <div class="stat-label">Coment√°rios Recebidos</div>
                </div>
                <!-- Rea√ß√µes Recebidas (abaixo de Rea√ß√µes Dadas) -->
                <div class="stat-card" style="background-color: #f8f9fa;">
                    <div class="stat-number" id="userReactionsReceived">0</div>
                    <div class="stat-label">Rea√ß√µes Recebidas</div>
                </div>
            </div>

            <!-- Bot√£o para abrir modal de Impacto -->
            <div class="impact-button-container">
                <button id="impactBtn" class="impact-btn" onclick="openImpactModal()">üìä Ver Impacto Detalhado</button>
            </div>
        </div>
    </div>
    <!-- Modal de Impacto -->
    <div id="impactModal" class="modal-overlay modal-overlay--impact" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üìä Impacto Detalhado</h2>
                <button class="close-btn" onclick="closeImpactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="insights-grid">
                    <!-- Reciprocidade Real -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">ü§ù</span>
                            <span class="insight-title">Reciprocidade Real</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="reciprocityChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="reciprocityValue">0%</div>
                        <div class="insight-description">% pessoas que retribu√≠ram</div>
                    </div>

                    <!-- √çndice de Altru√≠smo -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">üíù</span>
                            <span class="insight-title">√çndice de Altru√≠smo</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="altruismChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="altruismValue">0:0</div>
                        <div class="insight-description">balan√ßo dar vs receber</div>
                        <div class="insight-message" id="altruismMessage" style="font-style: italic; font-size: 0.9em; color: #666; margin-top: 0.5rem;"></div>
                    </div>

                    <!-- Alcance Efetivo -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">‚ö°</span>
                            <span class="insight-title">Alcance Efetivo</span>
                        </div>
                        <div class="insight-chart">
                            <canvas id="reachChart" width="120" height="120"></canvas>
                        </div>
                        <div class="insight-value" id="reachValue">0%</div>
                        <div class="insight-description">posts que geram intera√ß√£o</div>
                    </div>
                </div>

                <!-- Evolu√ß√£o Temporal -->
                <div class="evolution-chart">
                    <h3 class="chart-title">üìà Evolu√ß√£o (√öltimos 30 dias)</h3>
                    <div class="insight-chart-large">
                        <canvas id="evolutionChart" width="800" height="300"></canvas>
                    </div>
                </div>

                <div class="insights-grid">
                    <!-- Taxa de Engajamento -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">üéØ</span>
                            <span class="insight-title">Taxa de Engajamento</span>
                        </div>
                        <div class="insight-value" id="engagementValue">0.0/post</div>
                        <div class="insight-description">Intera√ß√µes m√©dias por post</div>
                    </div>

                    <!-- Impacto M√©dio -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">üåê</span>
                            <span class="insight-title">Impacto M√©dio</span>
                        </div>
                        <div class="insight-value" id="impactValue">0.0</div>
                        <div class="insight-description">pessoas diferentes/post</div>
                    </div>

                    <!-- Rede de Engajamento -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-icon">üîó</span>
                            <span class="insight-title">Rede de Engajamento</span>
                        </div>
                        <div class="insight-network">
                            <div class="network-size" id="networkSize">0</div>
                            <div class="network-label">pessoas conectadas</div>
                        </div>
                        <div class="insight-value" id="networkValue">Tamanho da rede</div>
                        <div class="insight-description">pessoas √∫nicas na sua rede</div>
                    </div>
                </div>

                <!-- Insights Personalizados -->
                <div class="evolution-chart">
                    <h3 class="chart-title">üí° Insights Personalizados</h3>
                    <div id="personalizedInsights" style="color: #666; line-height: 1.6;">
                        üìä Analisando seus dados...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Feedbacks Recebidos -->
    <div id="feedbacksModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üîÑ Feedbacks Recebidos</h2>
                <button class="close-btn" onclick="closeFeedbacksModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalFeedbacksContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Feedbacks ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://dwcmrbrhyuflhtymbhll.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3Y21yYnJoeXVmbGh0eW1iaGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDU0NDgsImV4cCI6MjA3MTkyMTQ0OH0.55BtZc5dcwTlF7TXNMuoD0Sa6bUO2WkB-r1itj5t2tw';
        
        // SECURITY FIX: Using ANON_KEY instead of SERVICE_KEY for client-side operations
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ACCESSIBILITY: ESC key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close all possible modals
                closeImpactModal();
                closeFeedbacksModal();
                closePostsModal();
                closePeopleHighlightedModal();
                closeModal(); // For dynamic modals
                console.log('üîë ESC pressed - closing all modals');
            }
        });

        // Fun√ß√£o para timeout agressivo
        function withTimeout(promise, timeoutMs = 10000) {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(`Timeout ap√≥s ${timeoutMs}ms`)), timeoutMs)
                )
            ]);
        }
        
        let currentUser = null;
        let posts = [];
        let notifications = [];
        let following = [];
        let followers = [];
        let selectedPhotoFile = null;
        let selectedHighlightType = null;

        // Sistema de Men√ß√µes
        let mentionUsers = [];
        let currentMentionQuery = '';
        let selectedMentionIndex = -1;
        let mentionStartPos = -1;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ HoloSpot v8 iniciando...');
                
                // Check if user is already logged in
                console.log('üîç Verificando sess√£o...');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Erro ao verificar sess√£o:', error);
                    showLogin();
                    return;
                }
                
                if (session) {
                    console.log('‚úÖ Usu√°rio logado encontrado:', session.user.email);
                    currentUser = session.user;
                    showApp();
                    
                    try {
                        console.log('üìä Carregando dados do usu√°rio...');
                        await loadUserData();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                    }
                    
                    try {
                        console.log('üìù Carregando posts...');
                        await loadPosts();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar posts:', error);
                    }
                    
                    try {
                        console.log('üîî Carregando notifica√ß√µes...');
                        await loadNotifications();
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar notifica√ß√µes:', error);
                    }
                    
                    try {
                        console.log('üìà Atualizando estat√≠sticas...');
                        updateStats();
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar estat√≠sticas:', error);
                    }
                } else {
                    console.log('üë§ Nenhum usu√°rio logado, mostrando tela de login');
                    showLogin();
                }

                // Setup event listeners
                console.log('üéØ Configurando event listeners...');
                setupEventListeners();
                console.log('‚úÖ HoloSpot v8 carregado com sucesso!');
                
            } catch (error) {
                console.error('üí• ERRO CR√çTICO na inicializa√ß√£o:', error);
                alert('Erro ao carregar o HoloSpot. Recarregue a p√°gina.');
            }
        });

        function setupEventListeners() {
            try {
                console.log('üéØ Configurando event listeners...');
                
                // Login button
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', handleLogin);
                    console.log('‚úÖ Login button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Login button n√£o encontrado');
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                    console.log('‚úÖ Logout button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Logout button n√£o encontrado');
                }
                
                // Tab navigation
                const navTabs = document.querySelectorAll('.nav-tab');
                if (navTabs.length > 0) {
                    navTabs.forEach(tab => {
                        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                    });
                    console.log(`‚úÖ ${navTabs.length} tab listeners configurados`);
                } else {
                    console.warn('‚ö†Ô∏è Nav tabs n√£o encontradas');
                }

                // Highlight type selection
                const highlightTypes = document.querySelectorAll('.highlight-type');
                if (highlightTypes.length > 0) {
                    highlightTypes.forEach(type => {
                        type.addEventListener('click', () => selectHighlightType(type.dataset.type));
                    });
                    console.log(`‚úÖ ${highlightTypes.length} highlight type listeners configurados`);
                } else {
                    console.warn('‚ö†Ô∏è Highlight types n√£o encontrados');
                }

                // Notifications
                const notificationsBtn = document.getElementById('notificationsBtn');
                if (notificationsBtn) {
                    notificationsBtn.addEventListener('click', toggleNotifications);
                    console.log('‚úÖ Notifications button listener configurado');
                } else {
                    console.warn('‚ö†Ô∏è Notifications button n√£o encontrado');
                }
                
                // Close notifications when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications')) {
                        const dropdown = document.getElementById('notificationDropdown');
                        if (dropdown) {
                            dropdown.style.display = 'none';
                        }
                    }
                });
                console.log('‚úÖ Outside click listener configurado');

                // Event listeners j√° configurados via onclick no HTML
                console.log('‚úÖ Event listeners configurados via onclick no HTML');
                
            } catch (error) {
                console.error('‚ùå Erro ao configurar event listeners:', error);
            }
        }

        function selectHighlightType(type) {
            // Remove previous selection
            document.querySelectorAll('.highlight-type').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked type
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            selectedHighlightType = type;
        }

        async function handleLogin() {
            try {
                console.log('üîê Iniciando login...');
                trackEvent('login_attempt');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://holospot.vercel.app'
                    }
                });
                
                if (error) {
                    console.error('‚ùå Erro no login:', error);
                    alert('Erro no login: ' + error.message);
                }
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                alert('Erro no login: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                console.log('üö™ Fazendo logout...');
                await supabase.auth.signOut();
                currentUser = null;
                showLogin();
                console.log('‚úÖ Logout realizado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro no logout:', error);
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            
            // Ocultar header e navega√ß√£o quando mostrar login
            const header = document.querySelector('.header');
            const navTabs = document.querySelector('.nav-tabs');
            if (header) header.style.display = 'none';
            if (navTabs) navTabs.style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Mostrar header e navega√ß√£o quando mostrar app
            const header = document.querySelector('.header');
            const navTabs = document.querySelector('.nav-tabs');
            if (header) header.style.display = 'block';
            if (navTabs) navTabs.style.display = 'flex';
            
            // Update user info in header
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.user_metadata.name || currentUser.email || 'Usu√°rio';
                document.getElementById('userUsername').textContent = '@' + (currentUser.email?.split('@')[0] || 'usuario');
                document.getElementById('userAvatar').src = currentUser.user_metadata.avatar_url || '';
                console.log('‚úÖ Usu√°rio logado:', currentUser.email);
            }
            
            // Inicializar sistema de men√ß√µes
            loadMentionUsers().then(() => {
                setupMentionsSystem();
            });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Reconfigurar event listeners quando mudar para aba perfil
            if (tabName === 'perfil') {
                // Aguardar um pequeno delay para garantir que o DOM esteja pronto
                setTimeout(() => {
                    setupStatCardListeners();
                    console.log('üîÑ Event listeners dos cards reconfigurados na aba perfil');
                }, 100);
            }
            
            console.log('üì± Aba alterada para:', tabName);
        }

        // Fun√ß√µes do Modal de Impacto
        function openImpactModal() {
            const modal = document.getElementById('impactModal');
            if (modal) {
                modal.style.display = 'flex';
                loadImpactDataInModal();
            }
        }

        function closeImpactModal() {
            const modal = document.getElementById('impactModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadImpactDataInModal() {
            try {
                console.log('üìä Carregando Dashboard de Insights no modal...');
                
                // Aguardar Chart.js carregar se necess√°rio
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 10) {
                    console.log(`üîÑ Aguardando Chart.js carregar... (tentativa ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                // Atualizar Dashboard de Insights no modal
                await updateDashboardInsights();
                
                console.log('‚úÖ Dashboard de Insights carregado no modal');
            } catch (error) {
                console.error('‚ùå Erro ao carregar Dashboard de Insights:', error);
            }
        }

        // Fun√ß√µes do Modal de Feedbacks
        function openFeedbacksModal() {
            const modal = document.getElementById('feedbacksModal');
            if (modal) {
                modal.style.display = 'flex';
                loadFeedbacksInModal();
            }
        }

        function closeFeedbacksModal() {
            const modal = document.getElementById('feedbacksModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadFeedbacksInModal() {
            try {
                console.log('üîÑ Carregando feedbacks no modal...');
                
                // Primeiro, vamos tentar buscar feedbacks com diferentes estruturas poss√≠veis
                let feedbacks = [];
                let error = null;
                
                // Tentar primeira estrutura (to_user_id)
                try {
                    const { data: feedbacksData, error: feedbacksError } = await supabase
                        .from('feedbacks')
                        .select(`
                            *,
                            from_user:from_user_id(name, username, avatar_url),
                            post:post_id(content, highlight_type)
                        `)
                        .eq('to_user_id', currentUser.id)
                        .order('created_at', { ascending: false });
                    
                    if (!feedbacksError && feedbacksData) {
                        feedbacks = feedbacksData;
                    } else {
                        throw feedbacksError;
                    }
                } catch (firstError) {
                    console.log('Tentando estrutura alternativa...');
                    
                    // Tentar segunda estrutura (mentioned_user_id)
                    try {
                        const { data: feedbacksData2, error: feedbacksError2 } = await supabase
                            .from('feedbacks')
                            .select(`
                                *,
                                author:author_id(name, username, avatar_url),
                                post:post_id(content, highlight_type)
                            `)
                            .eq('mentioned_user_id', currentUser.id)
                            .order('created_at', { ascending: false });
                        
                        if (!feedbacksError2 && feedbacksData2) {
                            feedbacks = feedbacksData2;
                        } else {
                            throw feedbacksError2;
                        }
                    } catch (secondError) {
                        console.log('Tentando buscar todos os feedbacks...');
                        
                        // Tentar buscar todos e filtrar
                        const { data: allFeedbacks, error: allError } = await supabase
                            .from('feedbacks')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (allError) throw allError;
                        
                        // Filtrar feedbacks relacionados ao usu√°rio atual
                        feedbacks = allFeedbacks.filter(feedback => 
                            feedback.to_user_id === currentUser.id || 
                            feedback.mentioned_user_id === currentUser.id ||
                            feedback.user_id === currentUser.id
                        );
                    }
                }

                const feedbacksContainer = document.getElementById('modalFeedbacksContent');
                
                if (!feedbacks || feedbacks.length === 0) {
                    feedbacksContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>üì≠ Nenhum feedback recebido ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Continue destacando pessoas para receber feedbacks!</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">Debug: Estrutura da tabela pode estar diferente</p>
                        </div>
                    `;
                    return;
                }

                console.log('Feedbacks encontrados:', feedbacks);

                const feedbacksHtml = feedbacks.map(feedback => {
                    // Tentar diferentes campos para o remetente
                    const sender = feedback.from_user || feedback.author || {};
                    const senderName = sender.name || feedback.sender_name || 'Usu√°rio';
                    const senderUsername = sender.username || feedback.sender_username || 'usuario';
                    const senderAvatar = sender.avatar_url || '/default-avatar.png';
                    
                    // Tentar diferentes campos para a mensagem
                    const message = feedback.message || feedback.feedback_text || feedback.content || 'Feedback sem conte√∫do';
                    
                    return `
                        <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #FFB700; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <img src="${senderAvatar}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${senderName}</div>
                                    <div style="font-size: 12px; color: #666;">@${senderUsername}</div>
                                </div>
                                <div style="margin-left: auto; font-size: 11px; color: #999;">
                                    ${formatDateShort(feedback.created_at)}
                                </div>
                            </div>
                            <div style="color: #555; line-height: 1.5; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                "${message}"
                            </div>
                        </div>
                    `;
                }).join('');

                feedbacksContainer.innerHTML = feedbacksHtml;
                console.log('‚úÖ Feedbacks carregados no modal:', feedbacks.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks:', error);
                document.getElementById('modalFeedbacksContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar feedbacks</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                        <p style="font-size: 12px; color: #999;">Verifique a estrutura da tabela feedbacks</p>
                    </div>
                `;
            }
        }

        // Fun√ß√µes do Modal de Posts
        function openPostsModal() {
            console.log('üîç Tentando abrir modal de posts...');
            console.log('Current user:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.error('‚ùå currentUser n√£o est√° definido ou n√£o tem ID');
                alert('Erro: Usu√°rio n√£o identificado. Tente fazer login novamente.');
                return;
            }
            
            const modal = document.getElementById('postsModal');
            if (modal) {
                modal.style.display = 'flex';
                loadPostsInModal();
            } else {
                console.error('‚ùå Modal postsModal n√£o encontrado');
            }
        }

        function closePostsModal() {
            const modal = document.getElementById('postsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function getFeedbacksForAuthorPost(post) {
            // Fun√ß√£o removida - agora s√≥ usamos o modal clic√°vel
            return '';
        }

        async function loadPostsInModal() {
            try {
                console.log('üìù Carregando posts no modal...');
                
                if (!currentUser || !currentUser.id) {
                    console.error('‚ùå currentUser n√£o est√° definido em loadPostsInModal');
                    throw new Error('Usu√°rio n√£o identificado');
                }
                
                // Recarregar posts do usu√°rio atual para evitar problemas de cache
                const { data: userPosts, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar posts do usu√°rio:', error);
                    throw error;
                }
                
                console.log('üìä Posts do usu√°rio encontrados:', userPosts?.length || 0);
                
                const postsContainer = document.getElementById('modalPostsContent');
                
                if (!postsContainer) {
                    console.error('‚ùå Container modalPostsContent n√£o encontrado');
                    throw new Error('Container do modal n√£o encontrado');
                }
                
                if (!userPosts || userPosts.length === 0) {
                    postsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                            <p>üìù Nenhum post criado ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Comece destacando algu√©m especial!</p>
                        </div>
                    `;
                    return;
                }

                // Recarregar rea√ß√µes para os posts do usu√°rio
                const postIds = userPosts.map(p => p.id);
                let allReactions = [];
                
                if (postIds.length > 0) {
                    try {
                        const { data: reactionsData } = await supabase
                            .from('reactions')
                            .select('*')
                            .in('post_id', postIds);
                        allReactions = reactionsData || [];
                    } catch (reactionError) {
                        console.log('Erro ao carregar rea√ß√µes:', reactionError);
                    }
                }

                // Usar o mesmo c√≥digo do renderPosts do in√≠cio
                const postsHtml = [];
                for (const post of userPosts) {
                    // Adicionar rea√ß√µes ao post
                    post.reactions = allReactions.filter(r => r.post_id === post.id);
                    post.user_data = {
                        name: currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Usu√°rio',
                        email: currentUser.email,
                        avatar_url: currentUser.user_metadata?.avatar_url || ''
                    };
                    
                    const typeEmojis = {
                        'gratidao': 'üôè', 'gratitude': 'üôè',
                        'memoria': 'üí≠', 'memory': 'üí≠',
                        'conquista': 'üèÜ', 'achievement': 'üèÜ',
                        'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                        'apoio': 'ü§ù', 'support': 'ü§ù',
                        'admiracao': 'üåü', 'admiration': 'üåü'
                    };

                    const typeNames = {
                        'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                        'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                        'conquista': 'Conquista', 'achievement': 'Conquista',
                        'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                        'apoio': 'Apoio', 'support': 'Apoio',
                        'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                    };
                    
                    // Contar feedbacks para este post
                    let feedbacksCount = 0;
                    try {
                        const { data: feedbacksData } = await supabase
                            .from('feedbacks')
                            .select('id')
                            .eq('post_id', post.id);
                        feedbacksCount = feedbacksData ? feedbacksData.length : 0;
                    } catch (error) {
                        console.log('Erro ao contar feedbacks:', error);
                    }
                    
                    // Contar coment√°rios para este post
                    let commentsCount = 0;
                    try {
                        const { data: commentsData } = await supabase
                            .from('comments')
                            .select('id')
                            .eq('post_id', post.id);
                        commentsCount = commentsData ? commentsData.length : 0;
                    } catch (error) {
                        console.log('Erro ao contar coment√°rios:', error);
                    }
                    const feedbacksSection = await getFeedbacksForAuthorPost(post);
                    
                    const postHtml = `
                        <div class="post">
                            <div class="post-header">
                                <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                                <div class="post-author">
                                    <div class="post-author-name">${post.user_data?.name || 'Usu√°rio'}</div>
                                    <div class="post-author-meta">
                                        <span class="post-author-username">@${currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'usuario'}</span>
                                        <span class="post-time-separator">‚Ä¢</span>
                                        <span class="post-time">${formatDateShort(post.created_at)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="post-content">
                                <div class="post-person">Holofotes para: ${post.celebrated_person_name || post.person_name}</div>
                                ${post.type || post.highlight_type ? `
                                    <div class="post-type">
                                        ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                    </div>
                                ` : ''}
                                <div class="post-story">${post.content || post.story}</div>
                                ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post">` : ''}
                            </div>
                            
                            <div class="post-reactions">
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                                </button>
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                                </button>
                                <button class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: not-allowed; transition: all 0.2s ease; opacity: 0.6;" disabled>
                                    ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                                </button>
                            </div>
                            
                            <div class="post-footer">
                                <span class="comments-display" id="comments-${post.id}" ${commentsCount > 0 ? `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"` : `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üí¨ ${commentsCount}
                                </span>
                                <span class="feedback-display" ${feedbacksCount > 0 ? `onclick="openPostFeedbackModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #e55a2b, #ffb700); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: not-allowed; font-size: 14px; font-weight: 600; transition: all 0.2s ease; opacity: 0.6;"`}>
                                    üîÑ ${feedbacksCount}
                                </span>
                            </div>
                            
                            ${feedbacksSection}
                        </div>
                    `;
                    
                    postsHtml.push(postHtml);
                }

                postsContainer.innerHTML = postsHtml.join('');
                console.log('‚úÖ Posts carregados no modal');
                
                // Atualizar contadores de coment√°rios ap√≥s carregar posts
                setTimeout(() => {
                    updateAllCommentsCounters();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar posts:', error);
                document.getElementById('modalPostsContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar posts</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Fun√ß√µes do Modal de Feedbacks de Post Espec√≠fico
        function openPostFeedbackModal(postId, source = 'seus_posts') {
            console.log('üì¨ Abrindo modal de feedbacks para post:', postId, 'origem:', source);
            
            // Definir t√≠tulo baseado na origem
            const modalTitle = source === 'holofotes_recebidos' ? 'üì¨ Feedbacks' : 'üì¨ Feedbacks Recebidos';
            
            // Criar modal
            const modal = document.createElement('div');
            modal.id = 'postFeedbackModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 25px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 70vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: linear-gradient(135deg, #e55a2b 0%, #ffb700 100%); color: white; padding: 20px; margin: -25px -25px 20px -25px; border-radius: 15px 15px 0 0;">
                        <h3 style="margin: 0; color: white; font-size: 18px;">${modalTitle}</h3>
                        <button onclick="closePostFeedbackModal()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: white;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
                    </div>
                    <div id="postFeedbackContent" style="min-height: 100px;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                            <p>Carregando feedbacks...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar feedbacks
            loadPostFeedbacks(postId, source);
            
            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePostFeedbackModal();
                }
            });
        }

        function closePostFeedbackModal() {
            const modal = document.getElementById('postFeedbackModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Fun√ß√£o para enviar feedback (usada no modal Holofotes Recebidos)
        async function sendFeedback(postId) {
            try {
                const textarea = document.getElementById('newFeedbackText');
                const feedbackText = textarea.value.trim();
                
                if (!feedbackText) {
                    alert('Por favor, escreva um feedback antes de enviar.');
                    return;
                }
                
                console.log('üì§ Enviando feedback para post:', postId);
                
                // Salvar feedback no banco
                const feedbackData = {
                    post_id: postId,
                    mentioned_user_id: currentUser.id,
                    feedback_text: feedbackText,
                    created_at: new Date().toISOString()
                };
                
                const { data: savedFeedback, error } = await supabase
                    .from('feedbacks')
                    .insert([feedbackData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao salvar feedback:', error);
                    alert('Erro ao enviar feedback. Tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Feedback salvo no banco');
                
                // Recarregar feedbacks no modal
                loadPostFeedbacks(postId, 'holofotes_recebidos');
                
                // Atualizar contador de feedbacks
                updateFeedbackCounter(postId);
                
                // Atualizar m√©tricas do usu√°rio
                updateSimpleMetrics();
                
                alert('‚úÖ Feedback enviado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar feedback:', error);
                alert('Erro ao enviar feedback. Tente novamente.');
            }
        }

        async function loadPostFeedbacks(postId, source = 'seus_posts') {
            try {
                console.log('üì¨ Carregando feedbacks para post:', postId, 'origem:', source);
                
                // Buscar todos os feedbacks do post (n√£o filtrar por author_id)
                const { data: feedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('*')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                const feedbackContent = document.getElementById('postFeedbackContent');
                
                if (!feedbacks || feedbacks.length === 0) {
                    // Se for modal "Holofotes Recebidos", permitir escrever feedback
                    if (source === 'holofotes_recebidos') {
                        feedbackContent.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                                <p style="font-size: 16px; margin-bottom: 15px;">Seja o primeiro a dar feedback!</p>
                                <div style="margin-top: 20px;">
                                    <textarea id="newFeedbackText" placeholder="Escreva seu feedback aqui..." style="
                                        width: 100%;
                                        min-height: 80px;
                                        padding: 12px;
                                        border: 2px solid #ddd;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        resize: vertical;
                                        margin-bottom: 10px;
                                    "></textarea>
                                    <button onclick="sendFeedback('${postId}')" style="
                                        background: linear-gradient(135deg, #e55a2b, #ffb700);
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 20px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        transition: transform 0.2s ease;
                                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        üì§ Enviar Feedback
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        feedbackContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                                <p style="font-size: 16px; margin-bottom: 5px;">Nenhum feedback recebido</p>
                                <p style="font-size: 14px; color: #999;">Este post ainda n√£o recebeu feedbacks</p>
                            </div>
                        `;
                    }
                    return;
                }

                console.log('üìä Feedbacks encontrados:', feedbacks);
                console.log('üîç Mentioned User IDs dos feedbacks:', feedbacks.map(f => f.mentioned_user_id));

                // Buscar dados dos usu√°rios que deram feedback
                const userIds = [...new Set(feedbacks.map(f => f.mentioned_user_id).filter(Boolean))];
                console.log('üë• User IDs para buscar:', userIds);
                
                let users = [];
                
                if (userIds.length > 0) {
                    // Tentar tabela 'profiles' com colunas corretas
                    try {
                        const { data: profilesData, error: profilesError } = await supabase
                            .from('profiles')
                            .select('id, name, email')
                            .filter('id', 'in', `(${userIds.join(',')})`);
                        
                        if (!profilesError && profilesData) {
                            users = profilesData;
                            console.log('‚úÖ Dados encontrados na tabela profiles:', users);
                        } else {
                            console.log('‚ö†Ô∏è Erro na tabela profiles:', profilesError);
                        }
                    } catch (profileError) {
                        console.log('‚ö†Ô∏è Erro ao acessar tabela profiles:', profileError);
                    }
                }

                console.log('üë• Usu√°rios finais encontrados:', users);

                const feedbacksHtml = feedbacks.map(feedback => {
                    // Encontrar dados do usu√°rio que deu o feedback
                    const user = users.find(u => u.id === feedback.mentioned_user_id);
                    console.log(`üîç Feedback de ${feedback.mentioned_user_id}:`, user);
                    
                    // Se n√£o encontrou o usu√°rio e √© o pr√≥prio currentUser, usar dados dele
                    let userName, userEmail, username;
                    
                    if (user) {
                        userName = user.name || 'Usu√°rio';
                        userEmail = user.email;
                        username = userEmail?.split('@')[0] || 'usuario';
                    } else if (feedback.mentioned_user_id === currentUser.id) {
                        // √â o pr√≥prio usu√°rio logado
                        userName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Voc√™';
                        userEmail = currentUser.email;
                        username = userEmail?.split('@')[0] || 'voce';
                    } else {
                        // Fallback para campos do pr√≥prio feedback
                        userName = feedback.sender_name || feedback.user_name || 'Usu√°rio';
                        userEmail = feedback.sender_email || feedback.user_email;
                        username = userEmail?.split('@')[0] || feedback.sender_username || feedback.username || 'usuario';
                    }
                    
                    const date = feedback.created_at ? formatDateShort(feedback.created_at) : 'recente';
                    const feedbackText = feedback.feedback_text || feedback.message || feedback.content || 'Feedback sem conte√∫do';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 1px solid #ff9800; border-radius: 12px; box-shadow: 0 2px 8px rgba(255,152,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="color: #e65100; font-weight: bold; font-size: 14px;">
                                    üîÑ ${userName} (@${username})
                                </div>
                                <div style="color: #999; font-size: 12px;">
                                    ${date}
                                </div>
                            </div>
                            <div style="color: #bf360c; line-height: 1.5; font-size: 15px; font-style: italic;">
                                ${feedbackText}
                            </div>
                        </div>
                    `;
                }).join('');

                feedbackContent.innerHTML = feedbacksHtml;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks do post:', error);
                document.getElementById('postFeedbackContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p>Erro ao carregar feedbacks</p>
                        <p style="font-size: 14px; color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadUserData() {
            try {
                console.log('üìä Carregando dados do usu√°rio...');
                console.log('üîç Carregando dados de seguir/seguidores reais do Supabase com timeout...');
                
                // Carregar quem eu sigo
                const followingQuery = supabase
                    .from('follows')
                    .select('following_id')
                    .eq('follower_id', currentUser.id);
                
                // Carregar meus seguidores
                const followersQuery = supabase
                    .from('follows')
                    .select('follower_id')
                    .eq('following_id', currentUser.id);
                
                try {
                    const [followingResult, followersResult] = await Promise.all([
                        withTimeout(followingQuery, 2000),
                        withTimeout(followersQuery, 2000)
                    ]);
                    
                    if (followingResult.error) throw followingResult.error;
                    if (followersResult.error) throw followersResult.error;
                    
                    following = followingResult.data || [];
                    followers = followersResult.data || [];
                    
                    console.log(`‚úÖ Dados reais carregados: ${following.length} seguindo, ${followers.length} seguidores`);
                    
                } catch (queryError) {
                    console.warn('‚ö†Ô∏è Erro nas queries, mantendo arrays vazios:', queryError.message);
                    
                    // Manter arrays vazios em caso de erro
                    following = [];
                    followers = [];
                    
                    console.log('‚úÖ Arrays vazios configurados devido ao erro');
                }
                
                // Atualizar contadores na interface
                updateFollowCounts();
                console.log('‚úÖ Dados do usu√°rio carregados e atualizados');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                
                // Fallback final
                following = [];
                followers = [];
                updateFollowCounts();
                console.log('‚úÖ Fallback aplicado');
            }
        }

        function updateFollowCounts() {
            const followingCountEl = document.getElementById('followingCount');
            const followersCountEl = document.getElementById('followersCount');
            
            if (followingCountEl) followingCountEl.textContent = following.length;
            if (followersCountEl) followersCountEl.textContent = followers.length;
            
            console.log(`üìä Contadores atualizados: ${following.length} seguindo, ${followers.length} seguidores`);
        }

        async function loadPosts() {
            try {
                console.log('üìù Carregando posts...');
                console.log('üîç Carregando posts reais do Supabase com timeout...');
                
                const postsQuery = supabase
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                const { data, error } = await withTimeout(postsQuery, 2000);
                
                if (error) {
                    console.error('‚ùå Erro ao carregar posts:', error);
                    throw error;
                }
                
                console.log(`‚úÖ ${data?.length || 0} posts reais carregados do banco`);
                posts = data || [];
                
                // Processar dados de usu√°rios para cada post
                await processPostsUserData();
                
                // Carregar rea√ß√µes para cada post
                await loadPostsReactions();
                
                await renderPosts();
                console.log('‚úÖ Posts processados e renderizados');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar posts:', error);
                
                // N√£o usar fallback de posts fict√≠cios - manter array vazio
                console.log('‚ö†Ô∏è Mantendo array de posts vazio devido ao erro');
                posts = [];
                await renderPosts();
                console.log('‚úÖ Interface renderizada sem posts');
            }
        }

        async function loadPostsReactions() {
            try {
                console.log('üíñ Carregando rea√ß√µes dos posts...');
                
                if (posts.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum post para carregar rea√ß√µes');
                    return;
                }
                
                const postIds = posts.map(p => p.id);
                
                try {
                    console.log('üîç Tentando carregar rea√ß√µes reais do Supabase...');
                    
                    // Promise com timeout de 5 segundos
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout na query de rea√ß√µes')), 5000)
                    );
                    
                    const queryPromise = supabase
                        .from('reactions')
                        .select('*')
                        .in('post_id', postIds);
                    
                    const { data: reactionsData, error } = await Promise.race([queryPromise, timeoutPromise]);
                    
                    if (error) {
                        console.error('‚ùå Erro na query de rea√ß√µes:', error);
                        throw error;
                    }
                    
                    console.log(`‚úÖ ${reactionsData?.length || 0} rea√ß√µes reais carregadas do banco`);
                    
                    // Distribuir rea√ß√µes para os posts correspondentes
                    posts.forEach(post => {
                        post.reactions = reactionsData?.filter(r => r.post_id === post.id) || [];
                    });
                    
                } catch (reactionsError) {
                    console.warn('‚ö†Ô∏è Falha na query de rea√ß√µes, usando rea√ß√µes de exemplo:', reactionsError.message);
                    
                    // Fallback: Rea√ß√µes de exemplo
                    posts.forEach((post, index) => {
                        if (index === 0) {
                            post.reactions = [
                                { id: 'r1', user_id: 'user-3', type: 'touched', created_at: new Date().toISOString() },
                                { id: 'r2', user_id: 'user-4', type: 'grateful', created_at: new Date().toISOString() }
                            ];
                        } else if (index === 1) {
                            post.reactions = [
                                { id: 'r3', user_id: 'user-5', type: 'inspired', created_at: new Date().toISOString() }
                            ];
                        } else {
                            post.reactions = [];
                        }
                    });
                }
                
                console.log('‚úÖ Rea√ß√µes distribu√≠das para os posts');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar rea√ß√µes:', error);
                // Garantir que todos os posts tenham array de rea√ß√µes
                posts.forEach(post => {
                    if (!post.reactions) {
                        post.reactions = [];
                    }
                });
            }
        }

        async function processPostsUserData() {
            console.log('üë• Processando dados de usu√°rios...');
            
            for (let post of posts) {
                try {
                    if (post.user_id === currentUser.id) {
                        // Usu√°rio atual
                        post.user_data = {
                            name: currentUser.user_metadata?.name || currentUser.email || 'Voc√™',
                            email: currentUser.email,
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        };
                    } else {
                        // Outros usu√°rios - buscar dados reais da tabela profiles
                        console.log(`üîç Buscando dados reais do usu√°rio: ${post.user_id}`);
                        
                        try {
                            const userQuery = supabase
                                .from('profiles')
                                .select('name, email, avatar_url')
                                .eq('id', post.user_id)
                                .single();
                            
                            const { data: userData, error: userError } = await withTimeout(userQuery, 1500);
                            
                            if (userData && !userError) {
                                // Dados reais encontrados
                                const realName = userData.name || userData.email || 'Usu√°rio';
                                const realAvatar = userData.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(realName)}&background=667eea&color=fff`;
                                
                                post.user_data = {
                                    name: realName,
                                    email: userData.email,
                                    avatar_url: realAvatar
                                };
                                
                                console.log(`‚úÖ Dados reais encontrados: ${realName}`);
                            } else {
                                throw new Error('Usu√°rio n√£o encontrado na tabela profiles');
                            }
                            
                        } catch (profileError) {
                            console.warn(`‚ö†Ô∏è Erro ao buscar perfil, usando fallback para ${post.user_id}:`, profileError.message);
                            
                            // Fallback com nomes fict√≠cios baseados no ID
                            const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                            const nameIndex = post.user_id.charCodeAt(0) % names.length;
                            const userName = names[nameIndex];
                            
                            post.user_data = {
                                name: userName,
                                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`
                            };
                        }
                    }
                    
                    // Inicializar array de rea√ß√µes se n√£o existir
                    if (!post.reactions) {
                        post.reactions = [];
                    }
                    
                } catch (userError) {
                    console.warn('‚ö†Ô∏è Erro ao processar usu√°rio do post:', userError);
                    post.user_data = {
                        name: 'Usu√°rio',
                        avatar_url: 'https://ui-avatars.com/api/?name=Usuario&background=ccc&color=333'
                    };
                    post.reactions = [];
                }
            }
            
            console.log('‚úÖ Dados de usu√°rios processados');
        }

        // Fun√ß√£o getFeedbackButtonForPost - VERS√ÉO REAL
        async function getFeedbackButtonForPost(post) {
            try {
                // Buscar TODOS os feedbacks para este post (n√£o apenas do usu√°rio atual)
                const { data: allFeedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('feedback_text, mentioned_user_id, created_at')
                    .eq('post_id', post.id)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar feedbacks:', error);
                    return ''; // Em caso de erro, n√£o mostrar nada
                }
                
                let feedbacksHtml = '';
                let userHasFeedback = false;
                
                // Mostrar todos os feedbacks existentes
                if (allFeedbacks && allFeedbacks.length > 0) {
                    for (const feedback of allFeedbacks) {
                        // Verificar se este feedback √© do usu√°rio atual
                        if (feedback.mentioned_user_id === currentUser.id) {
                            userHasFeedback = true;
                        }
                        
                        // Buscar dados do usu√°rio que deu o feedback
                        let feedbackUserName = 'Usu√°rio';
                        let feedbackUsername = 'usuario';
                        
                        try {
                            const { data: feedbackUser } = await supabase
                                .from('profiles')
                                .select('name, email')
                                .eq('id', feedback.mentioned_user_id)
                                .single();
                            
                            if (feedbackUser) {
                                feedbackUserName = feedbackUser.name || feedbackUser.email?.split('@')[0] || 'Usu√°rio';
                                feedbackUsername = feedbackUser.email?.split('@')[0] || 'usuario';
                            }
                        } catch (userError) {
                            console.warn('‚ö†Ô∏è Erro ao buscar dados do usu√°rio do feedback');
                        }
                        
                        feedbacksHtml += `
                            <div class="feedback-section" style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 1px solid #ff9800; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div style="color: #e65100; font-weight: bold; font-size: 13px;">
                                        üîÑ Feedback de ${feedbackUserName} (@${feedbackUsername})
                                    </div>
                                    <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                        ${feedback.created_at ? formatDateShort(feedback.created_at) : 'recente'}
                                    </div>
                                </div>
                                <div style="color: #bf360c; line-height: 1.4; font-style: italic;">
                                    ${feedback.feedback_text}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Se o usu√°rio atual √© a pessoa mencionada E ainda n√£o deu feedback, retornar bot√£o separadamente
                let feedbackButtonHtml = '';
                if (post.mentioned_user_id === currentUser.id && !userHasFeedback) {
                    feedbackButtonHtml = `
                        <button onclick="openFeedbackModal('${post.id}')" style="
                            background: linear-gradient(135deg, #e55a2b, #ffb700);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üîÑ Dar Feedback
                        </button>
                    `;
                }
                
                return { feedbacksHtml, feedbackButtonHtml };
                
            } catch (error) {
                console.error('‚ùå Erro na fun√ß√£o getFeedbackButtonForPost:', error);
                return { feedbacksHtml: '', feedbackButtonHtml: '' }; // Em caso de erro, n√£o mostrar nada
            }
        }

        async function renderPosts() {
            const container = document.getElementById('postsContainer');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="post">
                        <h3 style="text-align: center; color: #e65100; margin-bottom: 1rem;">Bem-vindo ao HoloSpot!</h3>
                        <p style="text-align: center; color: #666;">
                            Seja o primeiro a destacar algu√©m especial! V√° para a aba "<img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 14px; height: 14px; margin: 0 2px; vertical-align: middle;"> Destacar" e comece a espalhar reconhecimento.
                        </p>
                    </div>
                `;
                return;
            }

            // Processar posts de forma ass√≠ncrona agora
            const postsHtml = [];
            for (const post of posts) {
                const isFollowing = following.some(f => f.following_id === post.user_id);
                
                // Garantir que reactions seja sempre um array
                if (!Array.isArray(post.reactions)) {
                    post.reactions = [];
                }
                
                const userReactions = post.reactions.filter(r => r.user_id === currentUser.id);
                
                const typeEmojis = {
                    'gratidao': 'üôè', 'gratitude': 'üôè',
                    'memoria': 'üí≠', 'memory': 'üí≠',
                    'conquista': 'üèÜ', 'achievement': 'üèÜ',
                    'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                    'apoio': 'ü§ù', 'support': 'ü§ù',
                    'admiracao': 'üåü', 'admiration': 'üåü'
                };

                const typeNames = {
                    'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                    'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                    'conquista': 'Conquista', 'achievement': 'Conquista',
                    'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                    'apoio': 'Apoio', 'support': 'Apoio',
                    'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                };
                
                // Obter feedbacks e bot√£o usando fun√ß√£o
                const feedbackData = await getFeedbackButtonForPost(post);
                const feedbacksSection = feedbackData.feedbacksHtml;
                const feedbackButton = feedbackData.feedbackButtonHtml;
                
                const postHtml = `
                    <div class="post">
                        <div class="post-header">
                            <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                            <div class="post-author">
                                <div class="post-author-name">${post.user_data?.name || 'Usu√°rio'}</div>
                                <div class="post-author-meta">
                                    <span class="post-author-username">@${post.user_data?.email?.split('@')[0] || 'usuario'}</span>
                                    <span class="post-time-separator">‚Ä¢</span>
                                    <span class="post-time">${formatDateShort(post.created_at)}</span>
                                </div>
                            </div>
                            ${post.user_id !== currentUser.id ? `
                                <button class="follow-btn ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${post.user_id}')">
                                    ${isFollowing ? '‚úì Seguindo' : '+ Seguir'}
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="post-content">
                            <div class="post-person">Holofotes para: ${post.celebrated_person_name || post.person_name}</div>
                            ${post.type || post.highlight_type ? `
                                <div class="post-type">
                                    ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                </div>
                            ` : ''}
                            <div class="post-story">${post.content || post.story}</div>
                            ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post">` : ''}
                        </div>
                        
                        ${feedbacksSection}
                        
                        <div class="post-reactions">
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'touched') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'touched')"`}>
                                ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                            </button>
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'grateful') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'grateful')"`}>
                                üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                            </button>
                            <button class="reaction-btn ${userReactions.some(r => r.type === 'inspired') ? 'active' : ''} ${post.user_id === currentUser.id ? 'disabled' : ''}" 
                                    ${post.user_id === currentUser.id ? 'disabled style="cursor: not-allowed;"' : `onclick="toggleReaction('${post.id}', 'inspired')"`}>
                                ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                            </button>
                        </div>
                        
                        <div class="post-footer">
                            <span class="comments-display" id="comments-${post.id}" style="display: flex; align-items: center; gap: 6px; padding: 12px 18px; background: #f5f5f5; color: #666; border-radius: 25px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onclick="openCommentsModal('${post.id}')" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                üí¨ 0
                            </span>
                            ${feedbackButton}
                        </div>
                    </div>
                `;
                
                postsHtml.push(postHtml);
            }

            container.innerHTML = postsHtml.join('');
            
            // Atualizar contadores de coment√°rios ap√≥s renderizar
            setTimeout(() => {
                updateAllCommentsCounters();
            }, 100);
        }

        async function toggleFollow(userId) {
            try {
                console.log(`üë• Tentando ${following.some(f => f.following_id === userId) ? 'desseguir' : 'seguir'} usu√°rio:`, userId);
                const isFollowing = following.some(f => f.following_id === userId);
                
                if (isFollowing) {
                    // Unfollow
                    try {
                        const unfollowQuery = supabase
                            .from('follows')
                            .delete()
                            .eq('follower_id', currentUser.id)
                            .eq('following_id', userId);
                        
                        await withTimeout(unfollowQuery, 2000);
                        console.log('‚úÖ Unfollow realizado no banco');
                    } catch (unfollowError) {
                        console.warn('‚ö†Ô∏è Erro ao desseguir no banco, atualizando apenas localmente:', unfollowError.message);
                    }
                    
                    following = following.filter(f => f.following_id !== userId);
                    console.log('‚úÖ Usu√°rio removido da lista local de seguindo');
                } else {
                    // Follow
                    try {
                        const followQuery = supabase
                            .from('follows')
                            .insert({
                                follower_id: currentUser.id,
                                following_id: userId
                            });
                        
                        await withTimeout(followQuery, 2000);
                        console.log('‚úÖ Follow realizado no banco');
                    } catch (followError) {
                        console.warn('‚ö†Ô∏è Erro ao seguir no banco, atualizando apenas localmente:', followError.message);
                    }
                    
                    following.push({ following_id: userId });
                    console.log('‚úÖ Usu√°rio adicionado √† lista local de seguindo');
                    
                    // Tentar criar notifica√ß√£o
                    try {
                        await createNotification(userId, 'follow', `${currentUser.user_metadata.name || currentUser.email} come√ßou a te seguir!`);
                        console.log('‚úÖ Notifica√ß√£o de follow criada');
                    } catch (notifError) {
                        console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o de follow:', notifError.message);
                    }
                }
                
                // Sempre atualizar contadores e interface
                updateFollowCounts();
                await renderPosts();
                console.log('‚úÖ Interface atualizada ap√≥s follow/unfollow');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao seguir/desseguir:', error);
                alert('Erro ao seguir/desseguir usu√°rio. Tente novamente.');
            }
        }

        // Fun√ß√£o para atualizar contador de feedbacks de um post espec√≠fico
        async function updateFeedbackCounter(postId) {
            try {
                // Buscar n√∫mero atual de feedbacks
                const { data: feedbacks, error } = await supabase
                    .from('feedbacks')
                    .select('id')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar feedbacks:', error);
                    return;
                }
                
                const feedbackCount = feedbacks ? feedbacks.length : 0;
                console.log(`üìä Atualizando contador de feedbacks do post ${postId}: ${feedbackCount}`);
                
                // Atualizar TODOS os elementos de feedback deste post
                const allFeedbackElements = document.querySelectorAll(`[onclick*="openPostFeedbackModal('${postId}'"]`);
                
                allFeedbackElements.forEach((element, index) => {
                    if (element.innerHTML.includes('üîÑ')) {
                        element.innerHTML = `üîÑ ${feedbackCount}`;
                        
                        // Atualizar estilo baseado no n√∫mero de feedbacks
                        if (feedbackCount > 0) {
                            element.style.background = 'linear-gradient(135deg, #e55a2b, #ffb700)';
                            element.style.color = 'white';
                        } else {
                            element.style.background = '#f5f5f5';
                            element.style.color = '#666';
                        }
                        
                        console.log(`‚úÖ Contador de feedback ${index + 1} atualizado para post ${postId}: ${feedbackCount}`);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar contador de feedbacks:', error);
            }
        }

        // Fun√ß√£o para atualizar contador de coment√°rios de um post espec√≠fico
        async function updateCommentCounter(postId) {
            try {
                // Buscar n√∫mero atual de coment√°rios
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('id')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar coment√°rios:', error);
                    return;
                }
                
                const commentCount = comments ? comments.length : 0;
                console.log(`üìä Atualizando contador de coment√°rios do post ${postId}: ${commentCount}`);
                
                // Atualizar TODOS os elementos de coment√°rios deste post (em todos os modais)
                const allCommentsElements = document.querySelectorAll(`[id="comments-${postId}"], [id*="comments-${postId}"]`);
                
                allCommentsElements.forEach((element, index) => {
                    element.innerHTML = `üí¨ ${commentCount}`;
                    
                    // Atualizar estilo baseado no n√∫mero de coment√°rios
                    if (commentCount > 0) {
                        element.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
                        element.style.color = 'white';
                    } else {
                        element.style.background = '#f5f5f5';
                        element.style.color = '#666';
                    }
                    
                    console.log(`‚úÖ Contador ${index + 1} atualizado para post ${postId}: ${commentCount}`);
                });
                
                // Tamb√©m atualizar qualquer elemento que contenha o ID do post
                const additionalElements = document.querySelectorAll(`[onclick*="${postId}"][class*="comments"]`);
                additionalElements.forEach((element, index) => {
                    if (element.innerHTML.includes('üí¨')) {
                        element.innerHTML = `üí¨ ${commentCount}`;
                        console.log(`‚úÖ Elemento adicional ${index + 1} atualizado para post ${postId}`);
                    }
                });
                
                // Atualizar t√≠tulo do modal de coment√°rios se estiver aberto
                const commentsModal = document.getElementById('commentsModal');
                if (commentsModal) {
                    const titleElement = commentsModal.querySelector('h3');
                    if (titleElement) {
                        titleElement.textContent = `üí¨ Coment√°rios (${commentCount})`;
                        console.log(`‚úÖ T√≠tulo do modal atualizado: Coment√°rios (${commentCount})`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar contador de coment√°rios:', error);
            }
        }

        // Fun√ß√£o para reagir a posts (usada nos modais)
        async function reactToPost(postId, type) {
            console.log(`üéØ Reagindo ao post ${postId} com ${type} no modal`);
            
            // Chamar a fun√ß√£o original de rea√ß√£o
            await toggleReaction(postId, type);
            
            // Atualizar bot√µes de rea√ß√£o no modal em tempo real
            setTimeout(async () => {
                await updateModalReactions(postId);
            }, 500);
        }
        
        // Fun√ß√£o para atualizar rea√ß√µes no modal em tempo real
        async function updateModalReactions(postId) {
            try {
                console.log(`üîÑ Atualizando rea√ß√µes do post ${postId} no modal`);
                
                // Buscar rea√ß√µes atualizadas do post
                const { data: reactions, error } = await supabase
                    .from('reactions')
                    .select('*')
                    .eq('post_id', postId);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar rea√ß√µes:', error);
                    return;
                }
                
                // Contar rea√ß√µes por tipo
                const reactionCounts = {
                    touched: reactions?.filter(r => r.type === 'touched').length || 0,
                    grateful: reactions?.filter(r => r.type === 'grateful').length || 0,
                    inspired: reactions?.filter(r => r.type === 'inspired').length || 0
                };
                
                // Verificar se o usu√°rio atual j√° reagiu
                const userReactions = reactions?.filter(r => r.user_id === currentUser.id) || [];
                const userReactionTypes = userReactions.map(r => r.type);
                
                console.log(`üìä Contadores: touched=${reactionCounts.touched}, grateful=${reactionCounts.grateful}, inspired=${reactionCounts.inspired}`);
                console.log(`üë§ Usu√°rio reagiu com: ${userReactionTypes.join(', ')}`);
                
                // Atualizar bot√µes de rea√ß√£o no modal
                const reactionButtons = document.querySelectorAll(`[onclick*="reactToPost('${postId}'"]`);
                
                reactionButtons.forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    let reactionType = '';
                    
                    if (onclick.includes("'touched'")) reactionType = 'touched';
                    else if (onclick.includes("'grateful'")) reactionType = 'grateful';
                    else if (onclick.includes("'inspired'")) reactionType = 'inspired';
                    
                    if (reactionType) {
                        const count = reactionCounts[reactionType];
                        const userReacted = userReactionTypes.includes(reactionType);
                        
                        // Atualizar texto do bot√£o
                        const emoji = { touched: '‚ù§Ô∏è', grateful: 'üôè', inspired: '‚ú®' }[reactionType];
                        button.innerHTML = `${emoji} ${count}`;
                        
                        // Atualizar estilo baseado se o usu√°rio reagiu
                        if (userReacted) {
                            // Usu√°rio j√° reagiu - usar gradiente dourado/roxo
                            button.style.background = 'linear-gradient(135deg, #FFB700, #9C27B0)';
                            button.style.color = 'white';
                            button.style.border = 'none';
                            
                            // Remover eventos de hover para manter o estilo
                            button.onmouseover = null;
                            button.onmouseout = null;
                        } else {
                            // Usu√°rio n√£o reagiu - usar estilo padr√£o com hover
                            button.style.background = '#f5f5f5';
                            button.style.color = '#666';
                            button.style.border = 'none';
                            
                            // Adicionar eventos de hover apenas quando n√£o reagiu
                            if (reactionType === 'touched') {
                                button.onmouseover = () => {
                                    button.style.background = '#e74c3c';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            } else if (reactionType === 'grateful') {
                                button.onmouseover = () => {
                                    button.style.background = '#f39c12';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            } else if (reactionType === 'inspired') {
                                button.onmouseover = () => {
                                    button.style.background = '#9b59b6';
                                    button.style.color = 'white';
                                };
                                button.onmouseout = () => {
                                    button.style.background = '#f5f5f5';
                                    button.style.color = '#666';
                                };
                            }
                        }
                        
                        console.log(`‚úÖ Bot√£o ${reactionType} atualizado: ${count} (usu√°rio reagiu: ${userReacted})`);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar rea√ß√µes do modal:', error);
            }
        }

        async function toggleReaction(postId, type) {
            try {
                console.log(`üíñ Tentando ${type} no post:`, postId);
                
                // Buscar post diretamente do banco se n√£o estiver no array global
                let post = posts.find(p => p.id === postId);
                
                if (!post) {
                    console.log('üîç Post n√£o encontrado no array local, buscando no banco...');
                    
                    try {
                        const { data: postData, error: postError } = await supabase
                            .from('posts')
                            .select('*')
                            .eq('id', postId)
                            .single();
                        
                        if (postError || !postData) {
                            console.error('‚ùå Post n√£o encontrado no banco:', postError);
                            return;
                        }
                        
                        post = postData;
                    } catch (fetchError) {
                        console.error('‚ùå Erro ao buscar post:', fetchError);
                        return;
                    }
                }
                
                // Verificar se o usu√°rio est√° tentando reagir ao pr√≥prio post
                if (post.user_id === currentUser.id) {
                    return; // Silenciosamente n√£o fazer nada
                }
                
                const existingReaction = post.reactions.find(r => r.user_id === currentUser.id && r.type === type);
                
                if (existingReaction) {
                    // Remove reaction
                    try {
                        await supabase
                            .from('reactions')
                            .delete()
                            .eq('id', existingReaction.id);
                        console.log('‚úÖ Rea√ß√£o removida do banco');
                    } catch (deleteError) {
                        console.warn('‚ö†Ô∏è Erro ao remover rea√ß√£o do banco, removendo apenas localmente:', deleteError.message);
                    }
                    
                    post.reactions = post.reactions.filter(r => r.id !== existingReaction.id);
                    console.log('‚úÖ Rea√ß√£o removida localmente');
                } else {
                    // Add reaction
                    let newReaction = null;
                    
                    try {
                        const { data, error } = await supabase
                            .from('reactions')
                            .insert({
                                post_id: postId,
                                user_id: currentUser.id,
                                type: type
                            })
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        newReaction = data;
                        console.log('‚úÖ Rea√ß√£o adicionada no banco');
                    } catch (insertError) {
                        console.warn('‚ö†Ô∏è Erro ao adicionar rea√ß√£o no banco, adicionando apenas localmente:', insertError.message);
                        
                        // Fallback: criar rea√ß√£o local
                        newReaction = {
                            id: `local-${Date.now()}`,
                            post_id: postId,
                            user_id: currentUser.id,
                            type: type,
                            created_at: new Date().toISOString()
                        };
                    }
                    
                    if (newReaction) {
                        post.reactions.push(newReaction);
                        console.log('‚úÖ Rea√ß√£o adicionada localmente');
                        
                        // Tentar criar notifica√ß√£o para o autor do post
                        if (post.user_id !== currentUser.id) {
                            try {
                                const reactionEmoji = { touched: '‚ù§Ô∏è', grateful: 'üôè', inspired: '‚ú®' }[type];
                                const userName = currentUser.user_metadata?.name || currentUser.email || 'Algu√©m';
                                const personName = post.celebrated_person_name || post.person_name || 'uma pessoa especial';
                                
                                await createNotification(
                                    post.user_id, 
                                    'reaction', 
                                    `${userName} reagiu ${reactionEmoji} ao seu post sobre ${personName}`
                                );
                                console.log('‚úÖ Notifica√ß√£o de rea√ß√£o criada');
                            } catch (notifError) {
                                console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o de rea√ß√£o:', notifError.message);
                            }
                        }
                    }
                }
                
                // Sempre re-renderizar posts e atualizar estat√≠sticas
                try {
                    await renderPosts();
                    console.log('‚úÖ Posts re-renderizados');
                } catch (renderError) {
                    console.error('‚ùå Erro ao re-renderizar posts:', renderError);
                }
                
                try {
                    updateStats();
                    console.log('‚úÖ Estat√≠sticas atualizadas');
                    
                    // Atualizar m√©tricas do perfil em tempo real
                    if (typeof updateSimpleMetrics === 'function') {
                        setTimeout(() => {
                            updateSimpleMetrics();
                            
                            
                            console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s rea√ß√£o');
                        }, 500);
                    }
                } catch (statsError) {
                    console.error('‚ùå Erro ao atualizar estat√≠sticas:', statsError);
                }
                
                console.log('‚úÖ Interface atualizada ap√≥s rea√ß√£o');
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao reagir:', error);
                console.error('‚ùå Stack trace:', error.stack);
                alert('Erro ao reagir ao post. Tente novamente.');
            }
        }

        function openFeedbackModal(postId) {
            console.log('üí¨ Abrindo modal de feedback para post:', postId);
            
            // Verificar se j√° existe modal de feedback e fechar apenas ele
            const existingFeedbackModal = document.getElementById('feedbackModal');
            if (existingFeedbackModal) {
                console.log('‚ö†Ô∏è Modal de feedback j√° existe, fechando antes de abrir novo');
                existingFeedbackModal.remove();
            }
            
            // Encontrar o post
            const post = posts.find(p => p.id === postId);
            if (!post) {
                console.error('‚ùå Post n√£o encontrado:', postId);
                alert('Erro: Post n√£o encontrado.');
                return;
            }
            
            // Buscar dados da pessoa mencionada
            let mentionedPersonName = 'Usu√°rio';
            let mentionedPersonUsername = 'usuario';
            
            // Se temos mentioned_user_id, buscar dados reais do usu√°rio
            if (post.mentioned_user_id) {
                try {
                    // Buscar na lista de usu√°rios carregados
                    const mentionedUser = mentionUsers.find(u => u.id === post.mentioned_user_id);
                    if (mentionedUser) {
                        mentionedPersonName = mentionedUser.name;
                        mentionedPersonUsername = mentionedUser.username;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar dados da pessoa mencionada:', error);
                }
            }
            
            // Se n√£o encontrou pelos dados reais, usar os campos do post (removendo @ se existir)
            if (mentionedPersonName === 'Usu√°rio') {
                const personName = post.celebrated_person_name || post.person_name || '';
                if (personName.startsWith('@')) {
                    mentionedPersonUsername = personName.substring(1);
                    mentionedPersonName = personName.substring(1); // Usar username como nome se n√£o tiver nome real
                } else {
                    mentionedPersonName = personName;
                    mentionedPersonUsername = personName.toLowerCase().replace(/\s+/g, '');
                }
            }
            
            // Criar modal de feedback
            const modal = document.createElement('div');
            modal.id = 'feedbackModal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="feedback-modal">
                    <div class="feedback-modal-header">
                        <h3>üîÑ Feedback</h3>
                        <button class="close-btn" onclick="closeFeedbackModal()">√ó</button>
                    </div>
                    <div class="feedback-modal-body">
                        <p><strong>Post sobre:</strong> ${mentionedPersonName} (@${mentionedPersonUsername})</p>
                        <p><strong>Autor:</strong> ${post.user_data?.name || 'Usu√°rio'} (@${post.user_data?.email?.split('@')[0] || 'usuario'})</p>
                        <div class="form-group">
                            <label class="form-label">Seu feedback:</label>
                            <textarea id="feedbackText" class="form-input" rows="4" 
                                placeholder="Compartilhe como voc√™ se sentiu ao ser destacado..."></textarea>
                        </div>
                    </div>
                    <div class="feedback-modal-footer">
                        <button class="btn-primary" onclick="submitFeedback('${postId}')">Enviar Feedback</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fechar modal clicando fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeFeedbackModal();
                }
            });
            
            // Focar no textarea
            setTimeout(() => {
                document.getElementById('feedbackText').focus();
            }, 100);
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitFeedback(postId) {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            
            if (!feedbackText) {
                alert('Por favor, escreva seu feedback.');
                return;
            }
            
            try {
                console.log('üí¨ Enviando feedback para post:', postId);
                
                const post = posts.find(p => p.id === postId);
                if (!post) {
                    throw new Error('Post n√£o encontrado');
                }
                
                // Tentar salvar no banco
                try {
                    const { data, error } = await supabase
                        .from('feedbacks')
                        .insert({
                            post_id: postId,
                            author_id: post.user_id,
                            mentioned_user_id: currentUser.id,
                            feedback_text: feedbackText
                        });
                    
                    if (error) throw error;
                    console.log('‚úÖ Feedback salvo no banco');
                    
                    // Atualizar m√©tricas imediatamente ap√≥s salvar no banco
                    setTimeout(() => {
                        if (typeof updateSimpleMetrics === 'function') {
                            updateSimpleMetrics();
                            
                            
                            console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s feedback (imediato)');
                        }
                    }, 100);
                    
                } catch (dbError) {
                    console.warn('‚ö†Ô∏è Erro ao salvar feedback no banco:', dbError.message);
                    // Continuar mesmo com erro no banco
                }
                
                // Marcar como feedback dado localmente
                post.feedback_given = true;
                
                // Tentar criar notifica√ß√£o para o autor do post
                try {
                    const userName = currentUser.user_metadata?.name || currentUser.email || 'Algu√©m';
                    await createNotification(
                        post.user_id,
                        'feedback',
                        `${userName} deu feedback sobre o post que voc√™ fez destacando-o!`
                    );
                    console.log('‚úÖ Notifica√ß√£o de feedback criada');
                } catch (notifError) {
                    console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o de feedback:', notifError.message);
                }
                
                // Fechar modal e atualizar interface
                closeFeedbackModal();
                await renderPosts();
                
                alert('Feedback enviado com sucesso! O autor do post foi notificado.');
                console.log('‚úÖ Feedback enviado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar feedback:', error);
                alert('Erro ao enviar feedback. Tente novamente.');
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('A imagem deve ter no m√°ximo 5MB.');
                return;
            }
            
            selectedPhotoFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            console.log('üì∑ Foto selecionada:', file.name, file.size, 'bytes');
        }

        function removePhoto() {
            selectedPhotoFile = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoUpload').value = '';
        }

        async function uploadPhoto(file) {
            try {
                console.log('üì∏ Iniciando upload da foto:', file.name);
                
                // Gerar nome √∫nico para o arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
                console.log('üìù Nome do arquivo:', fileName);
                
                // Fazer upload do arquivo diretamente
                const { data, error } = await supabase.storage
                    .from('photos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('‚ùå Erro no upload:', error);
                    // Se o bucket n√£o existir, tentar criar ou usar alternativa
                    if (error.message.includes('Bucket not found')) {
                        console.log('üîß Tentando criar bucket photos...');
                        try {
                            await supabase.storage.createBucket('photos', { public: true });
                            console.log('‚úÖ Bucket photos criado');
                            
                            // Tentar upload novamente
                            const { data: retryData, error: retryError } = await supabase.storage
                                .from('photos')
                                .upload(fileName, file, {
                                    cacheControl: '3600',
                                    upsert: false
                                });
                            
                            if (retryError) throw retryError;
                            console.log('‚úÖ Upload realizado ap√≥s criar bucket:', retryData.path);
                        } catch (createError) {
                            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel criar bucket, usando URL local');
                            // Retornar URL local como fallback
                            return URL.createObjectURL(file);
                        }
                    } else {
                        throw error;
                    }
                }
                
                console.log('‚úÖ Upload realizado com sucesso:', data?.path || fileName);
                
                // Obter URL p√∫blica
                const { data: urlData } = supabase.storage
                    .from('photos')
                    .getPublicUrl(fileName);
                
                const publicUrl = urlData.publicUrl;
                console.log('‚úÖ URL p√∫blica gerada:', publicUrl);
                
                return publicUrl;
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico no upload:', error);
                console.log('üîß Usando URL local como fallback');
                // Retornar URL local como √∫ltimo recurso
                return URL.createObjectURL(file);
            }
        }

        async function findMentionedUserId(personName) {
            try {
                console.log('üîç Buscando ID do usu√°rio mencionado:', personName);
                
                // Extrair username se for uma men√ß√£o (@username)
                let searchTerm = personName;
                if (personName.startsWith('@')) {
                    searchTerm = personName.substring(1); // Remove @
                }
                
                // Buscar por email exato (incluindo dom√≠nios reais dos usu√°rios)
                const emailPatterns = [
                    `${searchTerm}@gmail.com`,
                    `${searchTerm}@hotmail.com`,
                    `${searchTerm}@outlook.com`,
                    `${searchTerm}@yahoo.com`,
                    `${searchTerm}@b11c.com`,
                    `${searchTerm}@vockan.com`
                ];
                
                for (const email of emailPatterns) {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('email', email)
                        .single();
                    
                    if (data && !error) {
                        console.log('‚úÖ Usu√°rio encontrado por email:', email, 'ID:', data.id);
                        return data.id;
                    }
                }
                
                // Buscar por nome (fallback)
                const { data: nameData, error: nameError } = await supabase
                    .from('profiles')
                    .select('id')
                    .ilike('name', `%${searchTerm}%`)
                    .single();
                
                if (nameData && !nameError) {
                    console.log('‚úÖ Usu√°rio encontrado por nome:', searchTerm, 'ID:', nameData.id);
                    return nameData.id;
                }
                
                console.log('‚ö†Ô∏è Usu√°rio n√£o encontrado:', personName);
                return null;
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar ID do usu√°rio:', error);
                return null;
            }
        }

        async function createPost() {
            const personName = document.getElementById('personName').value.trim();
            const storyText = document.getElementById('storyText').value.trim();
            
            if (!personName || !storyText) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            if (!selectedHighlightType) {
                alert('Por favor, selecione um tipo de destaque.');
                return;
            }

            // Map Portuguese types to English for database constraint
            const typeMapping = {
                'gratidao': 'gratitude',
                'memoria': 'memory',
                'conquista': 'achievement',
                'inspiracao': 'inspiration',
                'apoio': 'support',
                'admiracao': 'admiration'
            };
            
            const mappedType = typeMapping[selectedHighlightType] || selectedHighlightType;
            
            const createBtn = document.getElementById('createPostBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Criando...';
            
            try {
                let photoUrl = null;
                
                // Upload photo if selected
                if (selectedPhotoFile) {
                    try {
                        console.log('üì∏ Tentando upload da foto...');
                        createBtn.textContent = 'Fazendo upload da foto...';
                        photoUrl = await uploadPhoto(selectedPhotoFile);
                        console.log('‚úÖ Upload da foto conclu√≠do:', photoUrl);
                    } catch (uploadError) {
                        console.error('‚ùå Erro no upload da foto:', uploadError);
                        
                        // Perguntar ao usu√°rio se quer continuar sem foto
                        const continueWithoutPhoto = confirm(
                            `Erro ao fazer upload da foto: ${uploadError.message}\n\n` +
                            'Deseja continuar criando o post sem a foto?'
                        );
                        
                        if (!continueWithoutPhoto) {
                            createBtn.disabled = false;
                            createBtn.innerHTML = '<img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa';
                            return;
                        }
                        
                        console.log('‚ö†Ô∏è Continuando sem foto por escolha do usu√°rio');
                        photoUrl = null;
                    }
                }
                
                // Create post
                createBtn.textContent = 'Criando post...';
                console.log('üìù Criando post no banco de dados...');
                
                // Buscar ID do usu√°rio mencionado
                let mentionedUserId = null;
                try {
                    mentionedUserId = await findMentionedUserId(personName);
                    console.log('üîç ID do usu√°rio mencionado:', mentionedUserId);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar ID do usu√°rio mencionado:', error);
                }
                
                try {
                    const { data, error } = await supabase
                        .from('posts')
                        .insert({
                            user_id: currentUser.id,
                            celebrated_person_name: personName,
                            content: storyText,
                            photo_url: photoUrl,
                            type: mappedType,
                            mentioned_user_id: mentionedUserId
                        })
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('‚ùå Erro ao criar post no banco:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Post criado no banco com sucesso');
                    
                    // Add user data and reactions array to the new post
                    data.user_data = {
                        name: currentUser.user_metadata?.name || currentUser.email || 'Usu√°rio',
                        avatar_url: currentUser.user_metadata?.avatar_url || ''
                    };
                    data.reactions = [];
                    
                    // Add to posts array at the beginning
                    posts.unshift(data);
                    console.log('‚úÖ Post adicionado √† lista local');
                    
                } catch (postError) {
                    console.error('‚ùå Erro ao criar post:', postError);
                    
                    // Fallback: criar post apenas localmente
                    console.warn('‚ö†Ô∏è Criando post apenas localmente como fallback');
                    const localPost = {
                        id: `local-${Date.now()}`,
                        user_id: currentUser.id,
                        celebrated_person_name: personName,
                        content: storyText,
                        photo_url: photoUrl,
                        type: mappedType,
                        created_at: new Date().toISOString(),
                        user_data: {
                            name: currentUser.user_metadata?.name || currentUser.email || 'Usu√°rio',
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        },
                        reactions: []
                    };
                    
                    posts.unshift(localPost);
                    console.log('‚úÖ Post local criado como fallback');
                    
                    alert('Post criado localmente. Pode haver problemas de sincroniza√ß√£o com o servidor.');
                }
                
                // Clear form
                document.getElementById('personName').value = '';
                document.getElementById('storyText').value = '';
                removePhoto();
                
                // Clear highlight type selection
                document.querySelectorAll('.highlight-type').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedHighlightType = null;
                
                // Switch to home tab and re-render
                switchTab('inicio');
                renderPosts();
                updateStats();
                
                // Atualizar m√©tricas do perfil em tempo real
                if (typeof updateSimpleMetrics === 'function') {
                    setTimeout(() => {
                        updateSimpleMetrics();
                        
                        
                        console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s cria√ß√£o de post');
                    }, 500);
                }
                
                trackEvent('post_created', { 
                    person_name: personName, 
                    has_photo: !!photoUrl,
                    story_length: storyText.length,
                    highlight_type: selectedHighlightType
                });
                
                alert('‚ú® Post criado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar post:', error);
                alert('Erro ao criar post: ' + error.message);
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<img src="https://raw.githubusercontent.com/holospotadm/holospot/main/holofote.png" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;"> Destacar Pessoa';
            }
        }

        async function createNotification(userId, type, message) {
            try {
                console.log('üîî Criando notifica√ß√£o:', { userId, type, message });
                
                const insertQuery = supabase
                    .from('notifications')
                    .insert({
                        user_id: userId,
                        type: type,
                        message: message,
                        from_user_id: currentUser.id
                    });
                
                await withTimeout(insertQuery, 2000);
                console.log('‚úÖ Notifica√ß√£o criada no banco');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar notifica√ß√£o:', error);
            }
        }

        async function loadNotifications() {
            try {
                console.log('üîî Carregando notifica√ß√µes...');
                console.log('üîç Carregando notifica√ß√µes reais do Supabase com timeout...');
                
                const notificationsQuery = supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                const { data, error } = await withTimeout(notificationsQuery, 2000);
                
                if (error) {
                    console.error('‚ùå Erro ao carregar notifica√ß√µes:', error);
                    throw error;
                }
                
                console.log(`‚úÖ ${data?.length || 0} notifica√ß√µes reais carregadas do banco`);
                notifications = data || [];
                
                updateNotificationBadge();
                renderNotifications();
                console.log('‚úÖ Notifica√ß√µes processadas e renderizadas');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar notifica√ß√µes, mantendo array vazio:', error);
                
                // Manter array vazio em caso de erro
                notifications = [];
                
                console.log('‚úÖ Array de notifica√ß√µes vazio configurado devido ao erro');
                
                updateNotificationBadge();
                renderNotifications();
                console.log('‚úÖ Interface de notifica√ß√µes renderizada sem dados');
            }
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function renderNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            
            if (notifications.length === 0) {
                dropdown.innerHTML = `
                    <div class="notification-item">
                        <strong>Nenhuma notifica√ß√£o</strong><br>
                        <small>Voc√™ receber√° notifica√ß√µes quando algu√©m interagir com seus posts</small>
                    </div>
                `;
                return;
            }
            
            dropdown.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" 
                     onclick="markNotificationAsRead('${notification.id}')">
                    <strong>${notification.message}</strong><br>
                    <small>${formatDate(notification.created_at)}</small>
                </div>
            `).join('');
        }

        async function markNotificationAsRead(notificationId) {
            try {
                console.log('üìù Marcando notifica√ß√£o como lida:', notificationId);
                
                // Tentar atualizar no banco com timeout
                try {
                    const updateQuery = supabase
                        .from('notifications')
                        .update({ read: true })
                        .eq('id', notificationId);
                    
                    await withTimeout(updateQuery, 2000);
                    console.log('‚úÖ Notifica√ß√£o marcada como lida no banco');
                } catch (updateError) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar no banco, marcando apenas localmente:', updateError.message);
                }
                
                // Sempre atualizar estado local
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    console.log('‚úÖ Notifica√ß√£o marcada como lida localmente');
                }
                
                updateNotificationBadge();
                renderNotifications();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar notifica√ß√£o como lida:', error);
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function updateStats() {
            const userPosts = posts.filter(p => p.user_id === currentUser.id);
            const userTotalReactions = userPosts.reduce((sum, post) => {
                // Garantir que reactions seja um array
                const reactions = Array.isArray(post.reactions) ? post.reactions : [];
                return sum + reactions.length;
            }, 0);
            const uniquePeople = new Set(userPosts.map(p => p.celebrated_person_name || p.person_name)).size;
            
            // Profile tab stats - verificar se elementos existem
            const postsCountEl = document.getElementById('userPostsCount');
            if (postsCountEl) postsCountEl.textContent = userPosts.length;
            
            const reactionsEl = document.getElementById('userReactionsReceived');
            if (reactionsEl) reactionsEl.textContent = userTotalReactions;
            
            const peopleEl = document.getElementById('userPeopleHighlighted');
            if (peopleEl) peopleEl.textContent = uniquePeople;
            
            const followersEl = document.getElementById('userFollowersCount');
            if (followersEl) followersEl.textContent = followers.length;
            
            // Impact tab stats - verificar se elementos existem
            const totalReactions = posts.reduce((sum, post) => {
                const reactions = Array.isArray(post.reactions) ? post.reactions : [];
                return sum + reactions.length;
            }, 0);
            const estimatedReach = totalReactions * 3 + userPosts.length * 5; // More realistic calculation
            
            const totalReachEl = document.getElementById('totalReachCount');
            if (totalReachEl) totalReachEl.textContent = estimatedReach;
            
            const totalReactionsEl = document.getElementById('totalReactionsCount');
            if (totalReactionsEl) totalReactionsEl.textContent = totalReactions;
            
            const avgReactionsEl = document.getElementById('averageReactionsCount');
            if (avgReactionsEl) avgReactionsEl.textContent = posts.length > 0 ? Math.round(totalReactions / posts.length) : 0;
            
            // Growth calculation (mock for now)
            const growthPercentage = Math.min(userPosts.length * 10, 200);
            const growthEl = document.getElementById('impactGrowthCount');
            if (growthEl) growthEl.textContent = `+${growthPercentage}%`;
            
            // Update progress bars
            updateProgressBars(userPosts.length, totalReactions);
            
            // Update personalized tip
            updatePersonalizedTip(userPosts.length, totalReactions);
            
            // Update simple metrics
            updateSimpleMetrics();
            
            // Update Dashboard de Insights Estrat√©gicos
            updateDashboardInsights();
        }

        // ===== DASHBOARD DE INSIGHTS ESTRAT√âGICOS =====

        async function calculateTrueReciprocity() {
            try {
                console.log('ü§ù Calculando reciprocidade real (algoritmo correto)...');
                
                // Buscar TODOS os posts que EU criei destacando outras pessoas
                const { data: myPosts, error: myPostsError } = await supabase
                    .from('posts')
                    .select('id, mentioned_user_id')
                    .eq('user_id', currentUser.id)
                    .not('mentioned_user_id', 'is', null);

                if (myPostsError || !myPosts) {
                    console.log('‚ö†Ô∏è Erro ao buscar meus posts:', myPostsError);
                    return 0;
                }

                if (myPosts.length === 0) {
                    console.log('üìä Nenhum post destacando pessoas ainda');
                    return 0;
                }

                // Contar men√ß√µes A‚ÜíB (eu para cada pessoa)
                const mentionsAtoB = {};
                myPosts.forEach(post => {
                    const personId = post.mentioned_user_id;
                    mentionsAtoB[personId] = (mentionsAtoB[personId] || 0) + 1;
                });

                console.log('üìä Men√ß√µes que EU fiz (A‚ÜíB):', mentionsAtoB);

                // Para cada pessoa que mencionei, contar men√ß√µes B‚ÜíA (ela para mim)
                const mentionsBtoA = {};
                let numerator = 0; // Œ£ min(x_AB, y_BA)
                let denominator = 0; // Œ£ x_AB

                for (const [personId, countAtoB] of Object.entries(mentionsAtoB)) {
                    // Contar quantas vezes esta pessoa ME mencionou
                    const { data: reciprocalPosts, error: reciprocalError } = await supabase
                        .from('posts')
                        .select('id')
                        .eq('user_id', personId)
                        .eq('mentioned_user_id', currentUser.id);

                    const countBtoA = (!reciprocalError && reciprocalPosts) ? reciprocalPosts.length : 0;
                    mentionsBtoA[personId] = countBtoA;

                    // Aplicar f√≥rmula: r(A,B) = min(x,y) / max(x,y)
                    const minCount = Math.min(countAtoB, countBtoA);
                    const maxCount = Math.max(countAtoB, countBtoA);
                    const pairReciprocity = maxCount > 0 ? (minCount / maxCount) * 100 : 0;

                    console.log(`üë• Par (eu‚Üí${personId}): ${countAtoB} men√ß√µes, (${personId}‚Üíeu): ${countBtoA} men√ß√µes, reciprocidade: ${pairReciprocity.toFixed(1)}%`);

                    // Acumular para √≠ndice geral
                    numerator += minCount;
                    denominator += countAtoB;
                }

                console.log('üìä Men√ß√µes que recebi (B‚ÜíA):', mentionsBtoA);

                // Calcular √≠ndice geral: numerador / denominador
                const generalIndex = denominator > 0 ? (numerator / denominator) * 100 : 0;

                console.log(`üßÆ C√°lculo final: ${numerator}/${denominator} = ${generalIndex.toFixed(1)}%`);
                console.log(`ü§ù Reciprocidade geral calculada: ${generalIndex.toFixed(1)}%`);

                return generalIndex;
            } catch (error) {
                console.error('Erro ao calcular reciprocidade:', error);
                return 0;
            }
        }

        function calculateEngagementRate() {
            const reacoes = parseInt(document.getElementById('userReactionsReceived')?.textContent || '0');
            const comentarios = parseInt(document.getElementById('userCommentsReceived')?.textContent || '0');
            const feedbacks = parseInt(document.getElementById('userFeedbacksReceived')?.textContent || '0');
            const posts = parseInt(document.getElementById('userPostsCount')?.textContent || '0');
            
            return posts > 0 ? (reacoes + comentarios + feedbacks) / posts : 0;
        }

        async function calculateAverageImpact() {
            try {
                // Buscar todos os posts do usu√°rio
                const { data: userPosts, error } = await supabase
                    .from('posts')
                    .select('id')
                    .eq('user_id', currentUser.id);

                if (error || !userPosts || userPosts.length === 0) return 0;

                let totalPessoasQueEngajaram = 0;

                // Para cada post, contar pessoas √öNICAS que engajaram
                for (const post of userPosts) {
                    const pessoasUnicasDoPost = new Set();

                    try {
                        // Buscar rea√ß√µes do post
                        const { data: reactions, error: reactionsError } = await supabase
                            .from('reactions')
                            .select('user_id')
                            .eq('post_id', post.id);

                        if (!reactionsError && reactions) {
                            reactions.forEach(reaction => {
                                if (reaction.user_id !== currentUser.id) {
                                    pessoasUnicasDoPost.add(reaction.user_id);
                                }
                            });
                        }

                        // Buscar coment√°rios do post
                        const { data: comments, error: commentsError } = await supabase
                            .from('comments')
                            .select('user_id')
                            .eq('post_id', post.id);

                        if (!commentsError && comments) {
                            comments.forEach(comment => {
                                if (comment.user_id !== currentUser.id) {
                                    pessoasUnicasDoPost.add(comment.user_id);
                                }
                            });
                        }

                        // Buscar feedbacks do post (removido user_id que n√£o existe na tabela)
                        // Nota: A tabela feedbacks n√£o possui coluna user_id, ent√£o n√£o inclu√≠mos nos c√°lculos
                        console.log(`‚ÑπÔ∏è Pulando feedbacks para post ${post.id} - tabela n√£o possui user_id`);
                        
                        // Se futuramente a tabela feedbacks tiver user_id, descomente:
                        /*
                        const { data: feedbacks, error: feedbacksError } = await supabase
                            .from('feedbacks')
                            .select('user_id')
                            .eq('post_id', post.id);

                        if (!feedbacksError && feedbacks) {
                            feedbacks.forEach(feedback => {
                                if (feedback.user_id !== currentUser.id) {
                                    pessoasUnicasDoPost.add(feedback.user_id);
                                }
                            });
                        } else if (feedbacksError) {
                            console.warn(`‚ö†Ô∏è Erro ao buscar feedbacks para post ${post.id}:`, feedbacksError.message);
                        }
                        */

                    } catch (postError) {
                        console.warn(`‚ö†Ô∏è Erro ao processar post ${post.id}:`, postError);
                        continue; // Pular este post e continuar com os outros
                    }

                    totalPessoasQueEngajaram += pessoasUnicasDoPost.size;
                }

                // M√©dia de pessoas que engajaram por post
                return (totalPessoasQueEngajaram / userPosts.length).toFixed(1);
            } catch (error) {
                console.error('Erro ao calcular impacto m√©dio:', error);
                return 0;
            }
        }

        async function calculateEffectiveReach() {
            try {
                // Buscar posts do usu√°rio com contagem de intera√ß√µes
                const userPosts = posts.filter(p => p.user_id === currentUser.id);
                
                let postsWithInteraction = 0;
                
                for (const post of userPosts) {
                    // Verificar se o post tem alguma intera√ß√£o
                    const hasReactions = post.reactions && post.reactions.length > 0;
                    const hasComments = post.comments && post.comments.length > 0;
                    const hasFeedbacks = post.feedbacks && post.feedbacks.length > 0;
                    
                    if (hasReactions || hasComments || hasFeedbacks) {
                        postsWithInteraction++;
                    }
                }

                return userPosts.length > 0 ? (postsWithInteraction / userPosts.length) * 100 : 0;
            } catch (error) {
                console.error('Erro ao calcular alcance efetivo:', error);
                return 0;
            }
        }

        function calculateNetworkSize() {
            const pessoasDestacadas = parseInt(document.getElementById('userPeopleHighlighted')?.textContent || '0');
            const pessoasQueDestacaram = parseInt(document.getElementById('userPeopleWhoHighlighted')?.textContent || '0');
            
            // Simplificado inicialmente - futuramente implementar deduplica√ß√£o
            return pessoasDestacadas + pessoasQueDestacaram;
        }

        function calculateAltruismIndex() {
            const holofotesRecebidos = parseInt(document.getElementById('userHolofotesReceived')?.textContent || '0');
            const holofotesDados = parseInt(document.getElementById('userPostsCount')?.textContent || '0');
            
            if (holofotesDados === 0) return { 
                value: "0:0", 
                message: "Sem dados", 
                type: "balanced",
                given: 0,
                received: 0
            };
            
            const ratio = holofotesRecebidos / holofotesDados;
            
            if (ratio > 1.2) {
                const multiplier = (holofotesRecebidos / holofotesDados).toFixed(1);
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: `Voc√™ recebe ${multiplier}x mais do que d√°`,
                    type: "received",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            } else if (ratio < 0.8) {
                const multiplier = (holofotesDados / holofotesRecebidos).toFixed(1);
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: `Voc√™ d√° ${multiplier}x mais do que recebe`,
                    type: "giving",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            } else {
                return {
                    value: `${holofotesDados}:${holofotesRecebidos}`, // dar:receber
                    message: "Voc√™ d√° e recebe quase igualmente",
                    type: "balanced",
                    given: holofotesDados,
                    received: holofotesRecebidos
                };
            }
        }

        async function updateDashboardInsights() {
            try {
                console.log('üìä Atualizando Dashboard de Insights...');
                
                // Aguardar Chart.js carregar se necess√°rio
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 10) {
                    console.log(`üîÑ Aguardando Chart.js carregar... (tentativa ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof Chart === 'undefined') {
                    console.warn('‚ö†Ô∏è Chart.js n√£o carregou ap√≥s 5 segundos - continuando sem visualiza√ß√µes');
                } else {
                    console.log('‚úÖ Chart.js carregado com sucesso');
                }
                
                // Calcular todas as m√©tricas
                const reciprocity = await calculateTrueReciprocity();
                const engagement = calculateEngagementRate();
                const impact = await calculateAverageImpact();
                const reach = await calculateEffectiveReach();
                const network = calculateNetworkSize();
                const altruism = calculateAltruismIndex();
                
                // Atualizar valores na interface
                const reciprocityValueEl = document.getElementById('reciprocityValue');
                if (reciprocityValueEl) reciprocityValueEl.textContent = `${reciprocity.toFixed(0)}%`;
                
                const engagementValueEl = document.getElementById('engagementValue');
                if (engagementValueEl) engagementValueEl.textContent = `${engagement.toFixed(1)}/post`;
                
                const impactValueEl = document.getElementById('impactValue');
                if (impactValueEl) impactValueEl.textContent = impact;
                
                const reachValueEl = document.getElementById('reachValue');
                if (reachValueEl) reachValueEl.textContent = `${reach.toFixed(0)}%`;
                
                const networkValueEl = document.getElementById('networkSize');
                if (networkValueEl) networkValueEl.textContent = network;
                
                const altruismValueEl = document.getElementById('altruismValue');
                const altruismMessageEl = document.getElementById('altruismMessage');
                if (altruismValueEl) altruismValueEl.textContent = altruism.value;
                if (altruismMessageEl) altruismMessageEl.textContent = altruism.message;
                
                // Criar visualiza√ß√µes (apenas se Chart.js estiver dispon√≠vel)
                if (typeof Chart !== 'undefined') {
                    createReciprocityGauge(reciprocity);
                    updateEngagementValue(engagement);
                    // Impact now shows only number, no chart needed
                    createReachChart(reach, 100 - reach);
                    createAltruismChart(altruism.given, altruism.received);
                    createEvolutionChart(); // Gr√°fico temporal com dados mock
                } else {
                    console.warn('‚ö†Ô∏è Pulando visualiza√ß√µes Chart.js - biblioteca n√£o dispon√≠vel');
                }
                
                // Gerar insights personalizados
                const insights = generatePersonalizedInsights({
                    reciprocity,
                    engagement,
                    impact: parseFloat(impact),
                    reach,
                    network,
                    altruism
                });
                
                const insightsEl = document.getElementById('personalizedInsights');
                if (insightsEl) {
                    insightsEl.innerHTML = insights.map(insight => `‚Ä¢ ${insight}`).join('<br>');
                }
                
                console.log('‚úÖ Dashboard de Insights atualizado');
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar Dashboard de Insights:', error);
            }
        }

        // ===== FUN√á√ïES DE VISUALIZA√á√ÉO CHART.JS =====

        function createReciprocityGauge(value) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('reciprocityChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create linear gradient positioned to follow arc direction (bottom to top)
            const gradient = ctx.createLinearGradient(60, 120, 60, 0);
            gradient.addColorStop(0, '#ff6600'); // 100% Orange at bottom (start)
            gradient.addColorStop(1, '#9c27b0'); // 100% Purple at top (end)
            
            // Destruir chart existente se houver
            if (window.reciprocityChartInstance) {
                window.reciprocityChartInstance.destroy();
            }
            
            window.reciprocityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: [
                            gradient, // Orange to Purple gradient
                            '#f0f0f0'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateEngagementValue(rate) {
            const valueEl = document.getElementById('engagementValue');
            if (valueEl) valueEl.textContent = `${rate.toFixed(1)}/post`;
        }

        function createAltruismChart(given, received) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('altruismChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destruir chart existente se houver
            if (window.altruismChartInstance) {
                window.altruismChartInstance.destroy();
            }
            
            window.altruismChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Dados', 'Recebidos'],
                    datasets: [{
                        data: [given, received],
                        backgroundColor: [
                            '#ff8c00', // Orange (same as evolution chart)
                            '#9c27b0'  // Purple (same as evolution chart)
                        ],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        function createReachChart(effective, ineffective) {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('reachChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Create linear gradient positioned to follow arc direction (bottom to top)
            const gradient = ctx.createLinearGradient(60, 120, 60, 0);
            gradient.addColorStop(0, '#ff6600'); // 100% Orange at bottom (start)
            gradient.addColorStop(1, '#9c27b0'); // 100% Purple at top (end)
            
            // Destruir chart existente se houver
            if (window.reachChartInstance) {
                window.reachChartInstance.destroy();
            }
            
            window.reachChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Com Intera√ß√£o', 'Sem Intera√ß√£o'],
                    datasets: [{
                        data: [effective, ineffective],
                        backgroundColor: [gradient, '#f0f0f0'], // Orange to Purple gradient
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function createEvolutionChart() {
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js n√£o carregado - pulando visualiza√ß√£o');
                return;
            }
            
            const canvas = document.getElementById('evolutionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destruir chart existente se houver
            if (window.evolutionChartInstance) {
                window.evolutionChartInstance.destroy();
            }
            
            try {
                console.log('üìà Carregando dados temporais reais...');
                
                // Buscar posts dos √∫ltimos 30 dias agrupados por semana
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const { data: recentPosts, error: postsError } = await supabase
                    .from('posts')
                    .select('created_at, mentioned_user_id')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', thirtyDaysAgo.toISOString())
                    .order('created_at', { ascending: true });
                
                if (postsError) {
                    console.warn('‚ö†Ô∏è Erro ao buscar posts temporais:', postsError);
                    return;
                }
                
                // Buscar posts onde EU fui mencionado (holofotes recebidos)
                const { data: receivedPosts, error: receivedError } = await supabase
                    .from('posts')
                    .select('created_at, user_id')
                    .eq('mentioned_user_id', currentUser.id)
                    .gte('created_at', thirtyDaysAgo.toISOString())
                    .order('created_at', { ascending: true });
                
                if (receivedError) {
                    console.warn('‚ö†Ô∏è Erro ao buscar holofotes recebidos:', receivedError);
                }
                
                // Agrupar dados por semana
                const weeklyData = {};
                const today = new Date();
                
                // Inicializar 4 semanas
                for (let i = 3; i >= 0; i--) {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - (i * 7) - (today.getDay() || 7) + 1);
                    const weekKey = `Sem ${4-i}`;
                    weeklyData[weekKey] = { posts: 0, holofotes: 0 };
                }
                
                // Contar posts criados por semana
                if (recentPosts) {
                    recentPosts.forEach(post => {
                        const postDate = new Date(post.created_at);
                        const weeksDiff = Math.floor((today - postDate) / (7 * 24 * 60 * 60 * 1000));
                        if (weeksDiff >= 0 && weeksDiff < 4) {
                            const weekKey = `Sem ${4-weeksDiff}`;
                            if (weeklyData[weekKey]) {
                                weeklyData[weekKey].posts++;
                            }
                        }
                    });
                }
                
                // Contar holofotes recebidos por semana
                if (receivedPosts) {
                    receivedPosts.forEach(post => {
                        const postDate = new Date(post.created_at);
                        const weeksDiff = Math.floor((today - postDate) / (7 * 24 * 60 * 60 * 1000));
                        if (weeksDiff >= 0 && weeksDiff < 4) {
                            const weekKey = `Sem ${4-weeksDiff}`;
                            if (weeklyData[weekKey]) {
                                weeklyData[weekKey].holofotes++;
                            }
                        }
                    });
                }
                
                const dates = Object.keys(weeklyData);
                const postsData = dates.map(week => weeklyData[week].posts);
                const holofotesData = dates.map(week => weeklyData[week].holofotes);
                
                console.log('üìä Dados temporais:', { dates, postsData, holofotesData });
                
                window.evolutionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Posts Criados',
                            data: postsData,
                            borderColor: '#E55A2B',
                            backgroundColor: 'rgba(229, 90, 43, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Holofotes Recebidos',
                            data: holofotesData,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de evolu√ß√£o criado com dados reais');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de evolu√ß√£o:', error);
                
                // Fallback para dados mock em caso de erro
                const mockData = {
                    dates: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    posts: [0, 0, 0, 0],
                    holofotes: [0, 0, 0, 0]
                };
                
                window.evolutionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: mockData.dates,
                        datasets: [{
                            label: 'Posts Criados',
                            data: mockData.posts,
                            borderColor: '#E55A2B',
                            backgroundColor: 'rgba(229, 90, 43, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Holofotes Recebidos',
                            data: mockData.holofotes,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            }
        }

        function generatePersonalizedInsights(metrics) {
            const insights = [];

            // Reciprocidade - 3 faixas
            if (metrics.reciprocity >= 70) {
                insights.push("üéâ Excelente! Voc√™ tem alta reciprocidade na sua rede!");
            } else if (metrics.reciprocity >= 40) {
                insights.push("üëç Boa reciprocidade! Algumas pessoas retribuem seus destaques.");
            } else {
                insights.push("üí° Dica: Destaque mais pessoas para aumentar sua reciprocidade.");
            }

            // Engajamento - 3 faixas
            if (metrics.engagement >= 2.0) {
                insights.push("üöÄ Seus posts t√™m alto engajamento! Continue assim.");
            } else if (metrics.engagement >= 1.0) {
                insights.push("üìä Engajamento moderado. Seus posts est√£o gerando algumas intera√ß√µes.");
            } else {
                insights.push("üìà Tente criar posts mais envolventes para aumentar intera√ß√µes.");
            }

            // Impacto - 3 faixas
            if (metrics.impact >= 2.0) {
                insights.push("üåü Voc√™ est√° impactando muitas pessoas diferentes!");
            } else if (metrics.impact >= 1.0) {
                insights.push("üéØ Bom impacto! Voc√™ est√° alcan√ßando pessoas diversas.");
            } else {
                insights.push("üå± Foque em criar conte√∫do que ressoe com mais pessoas.");
            }

            // Alcance - 3 faixas
            if (metrics.reach >= 60) {
                insights.push("‚ö° Excelente alcance! A maioria dos seus posts gera intera√ß√£o.");
            } else if (metrics.reach >= 30) {
                insights.push("üìà Alcance moderado. Metade dos seus posts gera engajamento.");
            } else {
                insights.push("üìä Poucos posts est√£o gerando intera√ß√£o. Analise o que funciona melhor.");
            }

            // Rede - 3 faixas
            if (metrics.network >= 15) {
                insights.push("üîó Voc√™ tem uma rede de engajamento robusta!");
            } else if (metrics.network >= 5) {
                insights.push("üåê Sua rede est√° crescendo bem! Continue expandindo conex√µes.");
            } else {
                insights.push("üå± Sua rede est√° no in√≠cio. Continue destacando e interagindo!");
            }

            // Altru√≠smo - sempre gera insight gen√©rico motivacional
            if (metrics.altruism.type === "giving") {
                insights.push("üíù Voc√™ √© muito altru√≠sta! Continue espalhando holofotes.");
            } else if (metrics.altruism.type === "received") {
                insights.push("üèÜ Voc√™ √© muito reconhecido pela comunidade!");
            } else {
                insights.push("‚öñÔ∏è Voc√™ tem um equil√≠brio perfeito entre dar e receber!");
            }

            // Garantir m√≠nimo de 3 insights
            if (insights.length < 3) {
                insights.push("üéØ Continue usando o HoloSpot para desenvolver sua presen√ßa!");
                insights.push("üìä Cada intera√ß√£o contribui para o crescimento da comunidade!");
            }

            return insights;
        }

        function updateProgressBars(postsCount, reactionsCount) {
            // First highlight achievement
            const firstProgress = Math.min(postsCount / 1 * 100, 100);
            const firstProgressEl = document.getElementById('firstHighlightProgress');
            if (firstProgressEl) firstProgressEl.style.width = firstProgress + '%';
            const firstTextEl = document.getElementById('firstHighlightText');
            if (firstTextEl) firstTextEl.textContent = `${Math.min(postsCount, 1)}/1`;
            
            // Multiplier achievement
            const multiplierValue = 1.0 + (Math.min(postsCount, 10) * 0.1);
            const multiplierProgress = Math.min(postsCount / 10 * 100, 100);
            const multiplierProgressEl = document.getElementById('multiplierProgress');
            if (multiplierProgressEl) multiplierProgressEl.style.width = multiplierProgress + '%';
            const multiplierTextEl = document.getElementById('multiplierText');
            if (multiplierTextEl) multiplierTextEl.textContent = `${multiplierValue.toFixed(1)}x`;
            
            // Inspirer achievement
            const inspirerProgress = Math.min(reactionsCount / 50 * 100, 100);
            const inspirerProgressEl = document.getElementById('inspirerProgress');
            if (inspirerProgressEl) inspirerProgressEl.style.width = inspirerProgress + '%';
            const inspirerTextEl = document.getElementById('inspirerText');
            if (inspirerTextEl) inspirerTextEl.textContent = `${Math.min(reactionsCount, 50)}/50`;
            
            // Monthly goal
            const monthlyProgress = Math.min(postsCount / 20 * 100, 100);
            const monthlyProgressEl = document.getElementById('monthlyGoalProgress');
            if (monthlyProgressEl) monthlyProgressEl.style.width = monthlyProgress + '%';
            const monthlyTextEl = document.getElementById('monthlyGoalText');
            if (monthlyTextEl) monthlyTextEl.textContent = `${Math.min(postsCount, 20)}/20`;
            
            // Engagement
            const engagementRate = postsCount > 0 ? Math.min((reactionsCount / postsCount) * 10, 100) : 0;
        }

        function updatePersonalizedTip(postsCount, reactionsCount) {
            let tip = '';
            
            if (postsCount === 0) {
                tip = 'Comece destacando algu√©m especial! Cada pessoa merece reconhecimento pelo que faz de bom.';
            } else if (postsCount < 5) {
                tip = 'Voc√™ est√° no caminho certo! Continue destacando pessoas que fazem a diferen√ßa na sua vida.';
            } else if (reactionsCount < postsCount * 2) {
                tip = 'Seus posts est√£o inspirando pessoas! Tente adicionar fotos para aumentar o engajamento.';
            } else {
                tip = 'Incr√≠vel! Voc√™ est√° criando uma onda de positividade. Continue espalhando reconhecimento!';
            }
            
            const tipEl = document.getElementById('personalizedTip');
            if (tipEl) tipEl.textContent = tip;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return 'Agora mesmo';
            } else if (diffInMinutes < 60) {
                return `H√° ${diffInMinutes} minuto${diffInMinutes > 1 ? 's' : ''}`;
            } else if (diffInMinutes < 1440) { // 24 hours
                const hours = Math.floor(diffInMinutes / 60);
                return `H√° ${hours} hora${hours > 1 ? 's' : ''}`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `H√° ${days} dia${days > 1 ? 's' : ''}`;
            }
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return 'agora';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes}m`;
            } else if (diffInMinutes < 1440) { // 24 hours
                const hours = Math.floor(diffInMinutes / 60);
                return `${hours}h`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `${days}d`;
            }
        }

        async function showFollowingModal() {
            console.log('üë• Abrindo modal de seguindo...');
            
            // Verificar se j√° existe modal de seguindo e fechar apenas ele
            const existingFollowingModal = document.getElementById('followingModal');
            if (existingFollowingModal) {
                console.log('‚ö†Ô∏è Modal de seguindo j√° existe, fechando antes de abrir novo');
                existingFollowingModal.remove();
            }
            
            const followingList = await Promise.all(following.map(async f => {
                // Tentar buscar dados reais do usu√°rio incluindo avatar
                let userName = 'Usu√°rio';
                let userAvatar = '';
                
                try {
                    const userQuery = supabase
                        .from('profiles')
                        .select('name, email, avatar_url')
                        .eq('id', f.following_id)
                        .single();
                    
                    const { data: userData } = await withTimeout(userQuery, 1000);
                    if (userData) {
                        userName = userData.name || userData.email || 'Usu√°rio';
                        userAvatar = userData.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                    } else {
                        // Fallback com nome baseado no ID
                        const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                        const nameIndex = f.following_id.charCodeAt(0) % names.length;
                        userName = names[nameIndex];
                        userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                    }
                } catch (error) {
                    // Fallback com nome baseado no ID
                    const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                    const nameIndex = f.following_id.charCodeAt(0) % names.length;
                    userName = names[nameIndex];
                    userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=667eea&color=fff`;
                }
                
                return `
                    <div class="follow-item">
                        <img src="${userAvatar}" 
                             alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                        <span>${userName}</span>
                    </div>
                `;
            }));
            
            const modal = `
                <div id="followingModal" class="modal-overlay" onclick="closeFollowingModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Seguindo (${following.length})</h3>
                            <button class="modal-close" onclick="closeFollowingModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="follow-list">
                                ${followingList.length > 0 ? followingList.join('') : '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Voc√™ ainda n√£o segue ningu√©m.</p></div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function showFollowersModal() {
            console.log('üë• Abrindo modal de seguidores...');
            
            // Verificar se j√° existe modal de seguidores e fechar apenas ele
            const existingFollowersModal = document.getElementById('followersModal');
            if (existingFollowersModal) {
                console.log('‚ö†Ô∏è Modal de seguidores j√° existe, fechando antes de abrir novo');
                existingFollowersModal.remove();
            }
            
            const followersList = await Promise.all(followers.map(async f => {
                // Tentar buscar dados reais do usu√°rio incluindo avatar
                let userName = 'Usu√°rio';
                let userAvatar = '';
                
                try {
                    const userQuery = supabase
                        .from('profiles')
                        .select('name, email, avatar_url')
                        .eq('id', f.follower_id)
                        .single();
                    
                    const { data: userData } = await withTimeout(userQuery, 1000);
                    if (userData) {
                        userName = userData.name || userData.email || 'Usu√°rio';
                        userAvatar = userData.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                    } else {
                        // Fallback com nome baseado no ID
                        const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                        const nameIndex = f.follower_id.charCodeAt(0) % names.length;
                        userName = names[nameIndex];
                        userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                    }
                } catch (error) {
                    // Fallback com nome baseado no ID
                    const names = ['Ana Silva', 'Jo√£o Santos', 'Maria Oliveira', 'Pedro Costa', 'Carla Mendes', 'Lucas Ferreira'];
                    const nameIndex = f.follower_id.charCodeAt(0) % names.length;
                    userName = names[nameIndex];
                    userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=764ba2&color=fff`;
                }
                
                return `
                    <div class="follow-item">
                        <img src="${userAvatar}" 
                             alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                        <span>${userName}</span>
                    </div>
                `;
            }));
            
            const modal = `
                <div id="followersModal" class="modal-overlay" onclick="closeFollowersModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Seguidores (${followers.length})</h3>
                            <button class="modal-close" onclick="closeFollowersModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="follow-list">
                                ${followersList.length > 0 ? followersList.join('') : '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>Voc√™ ainda n√£o tem seguidores.</p></div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function closeModal() {
            // Close dynamic modals (remove from DOM)
            const dynamicModal = document.querySelector('.modal-overlay');
            if (dynamicModal) {
                dynamicModal.remove();
            }
            
            // Close static modals (hide with display: none)
            const staticModals = ['postsReceivedModal', 'commentsReceivedModal', 'feedbacksReceivedModal', 'holofotesRecebidosModal', 'pessoasQueTeDestacaramModal'];
            staticModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function closeFollowingModal() {
            const modal = document.getElementById('followingModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeFollowersModal() {
            const modal = document.getElementById('followersModal');
            if (modal) {
                modal.remove();
            }
        }

        // Sistema de Men√ß√µes - Fun√ß√£o para carregar usu√°rios
        async function loadMentionUsers() {
            try {
                console.log('üë• Carregando usu√°rios para men√ß√µes...');
                
                const userQuery = supabase
                    .from('profiles')
                    .select('id, name, email, avatar_url')
                    .limit(50);
                
                const { data: users, error } = await withTimeout(userQuery, 3000);
                
                if (users && !error) {
                    mentionUsers = users.map(user => ({
                        id: user.id,
                        name: user.name || user.email || 'Usu√°rio',
                        username: user.email ? user.email.split('@')[0] : 'usuario',
                        avatar: user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email || 'Usuario')}&background=667eea&color=fff`
                    }));
                    console.log(`‚úÖ ${mentionUsers.length} usu√°rios carregados para men√ß√µes`);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar usu√°rios, mantendo array vazio');
                    mentionUsers = [];
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios para men√ß√µes:', error);
                mentionUsers = [];
            }
        }

        // Sistema de Coment√°rios
        async function loadCommentsForPost(postId) {
            try {
                console.log('üí¨ Carregando coment√°rios para post:', postId);
                
                const commentsQuery = supabase
                    .from('comments')
                    .select('*')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: false }); // Ordem decrescente - mais recente primeiro
                
                const { data: comments, error } = await withTimeout(commentsQuery, 5000);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar coment√°rios:', error.message);
                    return [];
                }
                
                console.log(`‚úÖ ${comments?.length || 0} coment√°rios carregados para post ${postId}`);
                return comments || [];
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar coment√°rios:', error.message);
                return [];
            }
        }

        async function updateCommentsCount(postId) {
            try {
                const comments = await loadCommentsForPost(postId);
                const commentsCount = comments.length;
                
                const commentsElement = document.getElementById(`comments-${postId}`);
                if (commentsElement) {
                    // Sempre permitir clique, mesmo com 0 coment√°rios
                    commentsElement.innerHTML = `üí¨ ${commentsCount}`;
                    // Usar a mesma cor dos bot√µes de rea√ß√£o zerados quando n√£o h√° coment√°rios
                    commentsElement.style.background = commentsCount > 0 ? 'linear-gradient(135deg, #2196f3, #1976d2)' : '#f5f5f5';
                    commentsElement.style.color = commentsCount > 0 ? 'white' : '#666';
                    commentsElement.style.textShadow = 'none'; // Remover sombra fixa
                    commentsElement.style.cursor = 'pointer';
                    commentsElement.onclick = () => openCommentsModal(postId);
                    // Adicionar sombra no hover igual aos bot√µes de rea√ß√£o
                    commentsElement.onmouseover = () => {
                        commentsElement.style.transform = 'scale(1.05)';
                        commentsElement.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    };
                    commentsElement.onmouseout = () => {
                        commentsElement.style.transform = 'scale(1)';
                        commentsElement.style.boxShadow = 'none';
                    };
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao atualizar contador de coment√°rios:', error.message);
            }
        }

        async function openCommentsModal(postId) {
            try {
                console.log('üí¨ Abrindo modal de coment√°rios para post:', postId);
                
                // Verificar se j√° existe modal de coment√°rios e fechar apenas ele
                const existingCommentsModal = document.getElementById('commentsModal');
                if (existingCommentsModal) {
                    console.log('‚ö†Ô∏è Modal de coment√°rios j√° existe, fechando antes de abrir novo');
                    existingCommentsModal.remove();
                }
                
                // Carregar coment√°rios
                const comments = await loadCommentsForPost(postId);
                
                // Buscar dados dos usu√°rios que comentaram
                const userIds = [...new Set(comments.map(c => c.user_id))];
                let usersData = {};
                
                try {
                    const usersQuery = supabase
                        .from('profiles')
                        .select('id, name, email, avatar_url')
                        .in('id', userIds);
                    
                    const { data: users, error } = await withTimeout(usersQuery, 5000);
                    
                    if (users) {
                        users.forEach(user => {
                            usersData[user.id] = user;
                        });
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar dados dos usu√°rios:', error.message);
                }
                
                // Criar HTML dos coment√°rios existentes
                const commentsHtml = comments.length > 0 ? comments.map(comment => {
                    const user = usersData[comment.user_id] || {};
                    const userName = user.name || 'Usu√°rio';
                    const userEmail = user.email || '';
                    const username = userEmail ? userEmail.split('@')[0] : 'usuario';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="color: #1565c0; font-weight: bold; font-size: 13px;">
                                    üí¨ ${userName} (@${username})
                                </div>
                                <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                    ${formatDateShort(comment.created_at)}
                                </div>
                            </div>
                            <div style="color: #0d47a1; line-height: 1.4; font-size: 14px;">
                                ${comment.content || comment.text || comment.message}
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">Seja o primeiro a comentar!</div>';
                
                // Criar modal com coment√°rios acima e box de escrita embaixo
                const modal = document.createElement('div');
                modal.id = 'commentsModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: linear-gradient(135deg, #FFB700, #E55A2B); color: white; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; color: white;">üí¨ Coment√°rios (${comments.length})</h3>
                            <button onclick="closeCommentsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">&times;</button>
                        </div>
                        
                        <div id="commentsContainer" style="flex: 1; overflow-y: auto; padding: 20px; max-height: 400px;">
                            ${commentsHtml}
                        </div>
                        
                        <div style="padding: 20px; border-top: 1px solid #eee; flex-shrink: 0;">
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <textarea id="newCommentText" placeholder="Escreva seu coment√°rio..." style="flex: 1; min-height: 60px; max-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; font-family: inherit; font-size: 14px;" rows="3"></textarea>
                                <button onclick="sendComment('${postId}')" style="background: linear-gradient(135deg, #FFB700, #E55A2B); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focar no textarea
                setTimeout(() => {
                    const textarea = document.getElementById('newCommentText');
                    if (textarea) textarea.focus();
                }, 100);
                
                // Fechar modal clicando fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeCommentsModal();
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de coment√°rios:', error);
                alert('Erro ao carregar coment√°rios. Tente novamente.');
            }
        }

        function closeCommentsModal() {
            const modal = document.getElementById('commentsModal');
            if (modal) {
                modal.remove();
            }
        }

        async function sendComment(postId) {
            try {
                const textarea = document.getElementById('newCommentText');
                const commentText = textarea.value.trim();
                
                if (!commentText) {
                    alert('Por favor, escreva um coment√°rio antes de enviar.');
                    return;
                }
                
                console.log('üí¨ Enviando coment√°rio para post:', postId);
                
                // Salvar coment√°rio no banco
                const commentData = {
                    post_id: postId,
                    user_id: currentUser.id,
                    content: commentText,
                    created_at: new Date().toISOString()
                };
                
                const { data: savedComment, error } = await supabase
                    .from('comments')
                    .insert([commentData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao salvar coment√°rio:', error);
                    alert('Erro ao enviar coment√°rio. Tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Coment√°rio salvo no banco');
                
                // Criar notifica√ß√£o para o autor do post
                try {
                    // Buscar dados do post para pegar o autor
                    const { data: post } = await supabase
                        .from('posts')
                        .select('user_id')
                        .eq('id', postId)
                        .single();
                    
                    if (post && post.user_id !== currentUser.id) {
                        const userName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Usu√°rio';
                        const userEmail = currentUser.email || '';
                        const username = userEmail ? userEmail.split('@')[0] : 'usuario';
                        
                        const notificationData = {
                            user_id: post.user_id,
                            type: 'comment',
                            message: `${userName} (@${username}) comentou no seu post!`,
                            created_at: new Date().toISOString(),
                            read: false
                        };
                        
                        console.log('üîî Criando notifica√ß√£o:', notificationData);
                        
                        const { error: notifError } = await supabase
                            .from('notifications')
                            .insert([notificationData]);
                        
                        if (notifError) {
                            console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o:', notifError.message);
                        } else {
                            console.log('‚úÖ Notifica√ß√£o criada no banco');
                        }
                    }
                } catch (notifError) {
                    console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o de coment√°rio:', notifError.message);
                }
                
                // Adicionar coment√°rio imediatamente no topo do modal
                const commentsContainer = document.getElementById('commentsContainer');
                if (commentsContainer) {
                    const userName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Usu√°rio';
                    const userEmail = currentUser.email || '';
                    const username = userEmail ? userEmail.split('@')[0] : 'usuario';
                    const userAvatar = currentUser.user_metadata?.avatar_url || '';
                    
                    const newCommentHtml = `
                        <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="color: #1565c0; font-weight: bold; font-size: 13px;">
                                    üí¨ ${userName} (@${username})
                                </div>
                                <div style="color: #999; font-size: 11px; margin-left: 10px;">
                                    Agora
                                </div>
                            </div>
                            <div style="color: #0d47a1; line-height: 1.4; font-size: 14px;">
                                ${commentText}
                            </div>
                        </div>
                    `;
                    
                    // Verificar se h√° mensagem "Seja o primeiro a comentar" e remov√™-la
                    const firstCommentMsg = commentsContainer.querySelector('div');
                    if (firstCommentMsg && firstCommentMsg.textContent.includes('primeiro a comentar')) {
                        firstCommentMsg.remove();
                        console.log('‚úÖ Mensagem "primeiro a comentar" removida');
                    }
                    
                    // Adicionar o novo coment√°rio no topo IMEDIATAMENTE
                    commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
                    console.log('‚úÖ Coment√°rio adicionado imediatamente no topo do modal');
                    
                    // Atualizar contador de coment√°rios no post
                    updateCommentCounter(postId);
                    
                    // Atualizar m√©tricas do usu√°rio
                    updateSimpleMetrics();
                }
                
                // Limpar textarea
                textarea.value = '';
                
                // Atualizar contador na interface principal
                setTimeout(() => {
                    updateCommentsCount(postId);
                    // Atualizar m√©tricas do perfil em tempo real
                    if (typeof updateSimpleMetrics === 'function') {
                        updateSimpleMetrics();
                        
                        
                        console.log('‚úÖ M√©tricas do perfil atualizadas ap√≥s coment√°rio');
                    }
                }, 500);
                
                console.log('‚úÖ Coment√°rio enviado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar coment√°rio:', error);
                alert('Erro ao enviar coment√°rio. Tente novamente.');
            }
        }

        // Fun√ß√£o para atualizar contadores de coment√°rios ap√≥s carregar posts
        async function updateAllCommentsCounters() {
            try {
                const postElements = document.querySelectorAll('[id^="comments-"]');
                for (const element of postElements) {
                    const postId = element.id.replace('comments-', '');
                    await updateCommentsCount(postId);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao atualizar contadores de coment√°rios:', error.message);
            }
        }

        // Sistema de Men√ß√µes - Configurar event listeners
        function setupMentionsSystem() {
            const input = document.getElementById('personName');
            const autocomplete = document.getElementById('mentionsAutocomplete');
            
            if (!input || !autocomplete) {
                console.warn('‚ö†Ô∏è Elementos de men√ß√£o n√£o encontrados');
                return;
            }
            
            console.log('‚úÖ Configurando sistema de men√ß√µes no campo Nome da pessoa...');
            
            input.addEventListener('input', handleMentionInput);
            input.addEventListener('keydown', handleMentionKeydown);
            
            // Fechar autocomplete ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !autocomplete.contains(e.target)) {
                    hideMentionsAutocomplete();
                }
            });
        }

        // Sistema de Men√ß√µes - Detectar @ no input
        function handleMentionInput(event) {
            const textarea = event.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // Procurar por @ antes do cursor
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);
            
            if (atMatch) {
                console.log('üéØ @ detectado, query:', atMatch[1]);
                mentionStartPos = cursorPos - atMatch[0].length;
                currentMentionQuery = atMatch[1].toLowerCase();
                showMentionsAutocomplete(currentMentionQuery);
            } else {
                hideMentionsAutocomplete();
            }
        }

        // Sistema de Men√ß√µes - Mostrar lista de usu√°rios
        function showMentionsAutocomplete(query) {
            const autocomplete = document.getElementById('mentionsAutocomplete');
            
            // Filtrar usu√°rios baseado na query E excluir o usu√°rio atual
            const filteredUsers = mentionUsers.filter(user => {
                // Excluir o pr√≥prio usu√°rio logado
                if (currentUser && (user.id === currentUser.id || user.username === (currentUser.email ? currentUser.email.split('@')[0] : ''))) {
                    return false;
                }
                
                // Filtrar por query
                return user.name.toLowerCase().includes(query) || 
                       user.username.toLowerCase().includes(query);
            }).slice(0, 5); // M√°ximo 5 resultados
            
            if (filteredUsers.length === 0) {
                hideMentionsAutocomplete();
                return;
            }
            
            console.log(`üìã Mostrando ${filteredUsers.length} usu√°rios para men√ß√£o (excluindo usu√°rio atual)`);
            
            const html = filteredUsers.map((user, index) => `
                <div class="mention-item" data-index="${index}" onclick="selectMention(${index})">
                    <img src="${user.avatar}" alt="${user.name}">
                    <div class="mention-info">
                        <div class="mention-name">${user.name}</div>
                        <div class="mention-username">@${user.username}</div>
                    </div>
                </div>
            `).join('');
            
            autocomplete.innerHTML = html;
            autocomplete.style.display = 'block';
            selectedMentionIndex = 0;
            updateMentionSelection();
        }

        // Sistema de Men√ß√µes - Esconder autocomplete
        function hideMentionsAutocomplete() {
            const autocomplete = document.getElementById('mentionsAutocomplete');
            autocomplete.style.display = 'none';
            selectedMentionIndex = -1;
            mentionStartPos = -1;
            currentMentionQuery = '';
        }

        // Sistema de Men√ß√µes - Atualizar sele√ß√£o visual
        function updateMentionSelection() {
            const items = document.querySelectorAll('.mention-item');
            items.forEach((item, index) => {
                if (index === selectedMentionIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Sistema de Men√ß√µes - Navega√ß√£o por teclado
        function handleMentionKeydown(event) {
            const autocomplete = document.getElementById('mentionsAutocomplete');
            if (autocomplete.style.display === 'none') return;
            
            const items = autocomplete.querySelectorAll('.mention-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
                    updateMentionSelection();
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedMentionIndex = Math.max(selectedMentionIndex - 1, -1);
                    updateMentionSelection();
                    break;
                    
                case 'Enter':
                case 'Tab':
                    if (selectedMentionIndex >= 0) {
                        event.preventDefault();
                        selectMention(selectedMentionIndex);
                    }
                    break;
                    
                case 'Escape':
                    hideMentionsAutocomplete();
                    break;
            }
        }

        // Sistema de Men√ß√µes - Selecionar usu√°rio
        function selectMention(index) {
            const input = document.getElementById('personName');
            
            // Filtrar usu√°rios novamente para pegar o correto (excluindo usu√°rio atual)
            const filteredUsers = mentionUsers.filter(user => {
                // Excluir o pr√≥prio usu√°rio logado
                if (currentUser && (user.id === currentUser.id || user.username === (currentUser.email ? currentUser.email.split('@')[0] : ''))) {
                    return false;
                }
                
                // Filtrar por query
                return user.name.toLowerCase().includes(currentMentionQuery) || 
                       user.username.toLowerCase().includes(currentMentionQuery);
            }).slice(0, 5);
            
            if (index >= filteredUsers.length) return;
            
            const selectedUser = filteredUsers[index];
            const text = input.value;
            const beforeMention = text.substring(0, mentionStartPos);
            const afterCursor = text.substring(input.selectionStart);
            
            // Substituir @query por @username
            const newText = beforeMention + `@${selectedUser.username} ` + afterCursor;
            input.value = newText;
            
            // Posicionar cursor ap√≥s a men√ß√£o
            const newCursorPos = mentionStartPos + selectedUser.username.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            console.log(`‚úÖ Usu√°rio @${selectedUser.username} mencionado no campo Nome`);
            
            hideMentionsAutocomplete();
            input.focus();
        }

        // Listen for auth state changes
        let isInitialLoad = true;
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                showApp();
                
                // S√≥ carrega dados na primeira vez ou se n√£o h√° dados
                if (isInitialLoad || posts.length === 0) {
                    console.log('üîÑ Carregamento inicial ou dados vazios, carregando tudo...');
                    await loadUserData();
                    await loadPosts();
                    await loadNotifications();
                    updateStats();
                    isInitialLoad = false;
                } else {
                    console.log('‚úÖ Dados j√° carregados, pulando recarregamento desnecess√°rio');
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                showLogin();
                isInitialLoad = true; // Reset para pr√≥ximo login
            }
         });
        
        // Modal de Pessoas Destacadas
        function openPeopleHighlightedModal() {
            console.log('üîç Tentando abrir modal de pessoas destacadas...');
            console.log('Current user:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.error('‚ùå currentUser n√£o est√° definido ou n√£o tem ID');
                alert('Erro: Usu√°rio n√£o identificado. Tente fazer login novamente.');
                return;
            }
            
            const modal = document.getElementById('peopleHighlightedModal');
            if (modal) {
                modal.style.display = 'flex';
                loadPeopleHighlightedInModal();
            } else {
                console.error('‚ùå Modal peopleHighlightedModal n√£o encontrado');
            }
        }

        function closePeopleHighlightedModal() {
            const modal = document.getElementById('peopleHighlightedModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadPeopleHighlightedInModal() {
            try {
                console.log('üë• Carregando pessoas destacadas no modal...');
                
                if (!currentUser || !currentUser.id) {
                    console.error('‚ùå currentUser n√£o est√° definido em loadPeopleHighlightedInModal');
                    throw new Error('Usu√°rio n√£o identificado');
                }
                
                if (!posts || !Array.isArray(posts)) {
                    console.error('‚ùå Array posts n√£o est√° definido ou n√£o √© um array');
                    throw new Error('Dados de posts n√£o dispon√≠veis');
                }
                
                const userPosts = posts.filter(post => post.user_id === currentUser.id);
                const peopleHighlighted = new Set();
                const peopleDetails = [];
                
                // Extrair pessoas mencionadas com @username (incluindo pontos e underscores)
                userPosts.forEach(post => {
                    const personName = post.celebrated_person_name || post.person_name;
                    if (personName && personName.includes('@')) {
                        // Regex melhorada para capturar usernames com pontos, underscores e h√≠fens
                        const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                        if (usernameMatch) {
                            usernameMatch.forEach(match => {
                                const username = match.substring(1); // Remove o @
                                if (username && !peopleHighlighted.has(username)) {
                                    peopleHighlighted.add(username);
                                    peopleDetails.push({
                                        username: username,
                                        displayName: personName,
                                        postCount: userPosts.filter(p => 
                                            (p.celebrated_person_name || p.person_name || '').includes(`@${username}`)
                                        ).length
                                    });
                                }
                            });
                        }
                    }
                });

                console.log('üîç Usernames encontrados:', peopleDetails.map(p => p.username));

                // Buscar dados REAIS dos usu√°rios mencionados na tabela profiles
                if (peopleDetails.length > 0) {
                    const usernames = peopleDetails.map(p => p.username);
                    console.log('üîç Buscando perfis reais para:', usernames);
                    
                    // Primeiro, vamos descobrir a estrutura da tabela profiles
                    console.log('üîç Verificando estrutura da tabela profiles...');
                    const { data: sampleProfile, error: sampleError } = await supabase
                        .from('profiles')
                        .select('*')
                        .limit(1);
                    
                    console.log('üìã Estrutura da tabela profiles:', sampleProfile);
                    console.log('‚ùå Erro na amostra:', sampleError);
                    
                    // Tentar diferentes possibilidades de campo username
                    let realUsers = null;
                    let error = null;
                    
                    // Tentar com 'email' (comum em auth)
                    try {
                        const result = await supabase
                            .from('profiles')
                            .select('id, email, name, avatar_url')
                            .filter('email', 'in', `(${usernames.map(u => u + '@example.com').join(',')})`);
                        
                        if (!result.error) {
                            realUsers = result.data;
                            console.log('‚úÖ Encontrado usando campo email:', realUsers);
                        }
                    } catch (e) {
                        console.log('‚ùå Tentativa com email falhou:', e);
                    }
                    
                    // Se n√£o funcionou com email, tentar buscar todos os profiles e filtrar manualmente
                    if (!realUsers || realUsers.length === 0) {
                        console.log('üîç Tentando buscar todos os profiles para filtrar manualmente...');
                        const { data: allProfiles, error: allError } = await supabase
                            .from('profiles')
                            .select('*');
                        
                        console.log('üìä Todos os perfis encontrados:', allProfiles);
                        console.log('‚ùå Erro na busca geral:', allError);
                        
                        if (!allError && allProfiles) {
                            // Filtrar manualmente baseado em qualquer campo que contenha o username
                            realUsers = allProfiles.filter(profile => {
                                return usernames.some(username => {
                                    // Verificar em diferentes campos poss√≠veis
                                    const email = profile.email || '';
                                    const name = profile.name || '';
                                    const displayName = profile.display_name || '';
                                    
                                    return email.includes(username) || 
                                           name.toLowerCase().includes(username.toLowerCase()) ||
                                           displayName.toLowerCase().includes(username.toLowerCase());
                                });
                            });
                            
                            console.log('‚úÖ Perfis filtrados manualmente:', realUsers);
                        }
                    }

                    if (realUsers && realUsers.length > 0) {
                        // Combinar dados reais com os dados extra√≠dos
                        peopleDetails.forEach(person => {
                            const realUser = realUsers.find(u => {
                                const email = u.email || '';
                                const name = u.name || '';
                                const displayName = u.display_name || '';
                                
                                return email.includes(person.username) || 
                                       name.toLowerCase().includes(person.username.toLowerCase()) ||
                                       displayName.toLowerCase().includes(person.username.toLowerCase());
                            });
                            
                            if (realUser) {
                                person.userId = realUser.id;
                                person.realName = realUser.name || realUser.display_name;
                                person.avatarUrl = realUser.avatar_url;
                                console.log(`‚úÖ Dados REAIS encontrados para @${person.username}:`, {
                                    id: realUser.id,
                                    name: realUser.name,
                                    avatar: realUser.avatar_url
                                });
                            } else {
                                console.log(`‚ö†Ô∏è Perfil REAL n√£o encontrado para @${person.username}`);
                            }
                        });
                    }
                }

                const modalContent = document.getElementById('modalPeopleHighlightedContent');
                
                if (peopleDetails.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                            <p>Voc√™ ainda n√£o destacou ningu√©m com @username</p>
                            <p style="font-size: 14px; margin-top: 10px;">Use @username ao destacar pessoas para elas aparecerem aqui!</p>
                        </div>
                    `;
                } else {
                    // Ordenar por n√∫mero de destaques (maior para menor)
                    peopleDetails.sort((a, b) => b.postCount - a.postCount);
                    
                    modalContent.innerHTML = peopleDetails.map(person => {
                        // Usar avatar real se dispon√≠vel
                        const avatarHtml = person.avatarUrl && person.avatarUrl.trim() !== '' 
                            ? `<img src="${person.avatarUrl}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 1rem;" onerror="console.log('‚ùå Erro ao carregar avatar:', '${person.avatarUrl}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 1rem;">
                                ${person.username.charAt(0).toUpperCase()}
                               </div>`
                            : `<div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff6600 0%, #9c27b0 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 1rem;">
                                ${person.username.charAt(0).toUpperCase()}
                               </div>`;
                        
                        // Usar nome real se dispon√≠vel, sen√£o username
                        const displayName = person.realName && person.realName.trim() !== '' 
                            ? person.realName 
                            : person.username;
                        
                        return `
                            <div style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee;">
                                ${avatarHtml}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 0.2rem;">
                                        ${displayName}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        @${person.username}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #999; margin-top: 0.3rem;">
                                        ${person.postCount} ${person.postCount === 1 ? 'destaque' : 'destaques'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log('‚úÖ Pessoas destacadas carregadas no modal:', peopleDetails.length);
                console.log('üìã Detalhes completos:', peopleDetails);
            } catch (error) {
                console.error('‚ùå Erro ao carregar pessoas destacadas:', error);
                document.getElementById('modalPeopleHighlightedContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>‚ùå Erro ao carregar pessoas destacadas</p>
                        <p style="font-size: 12px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ===== EVENT LISTENERS ROBUSTOS PARA CARDS DE ESTAT√çSTICAS =====
        function setupStatCardListeners() {
            console.log('üîß Configurando event listeners dos cards de estat√≠sticas...');
            
            // Posts Criados
            const postsCreatedCard = document.getElementById('postsCreatedCard');
            if (postsCreatedCard) {
                postsCreatedCard.removeEventListener('click', openPostsModal); // Remove listener anterior se existir
                postsCreatedCard.addEventListener('click', openPostsModal);
                console.log('‚úÖ Event listener configurado para Posts Criados');
            } else {
                console.warn('‚ö†Ô∏è Elemento postsCreatedCard n√£o encontrado');
            }
            
            // Pessoas Destacadas
            const peopleHighlightedCard = document.getElementById('peopleHighlightedCard');
            if (peopleHighlightedCard) {
                peopleHighlightedCard.removeEventListener('click', openPeopleHighlightedModal); // Remove listener anterior se existir
                peopleHighlightedCard.addEventListener('click', openPeopleHighlightedModal);
                console.log('‚úÖ Event listener configurado para Pessoas Destacadas');
            } else {
                console.warn('‚ö†Ô∏è Elemento peopleHighlightedCard n√£o encontrado');
            }
            
            // Holofotes Recebidos
            const postsReceivedCard = document.getElementById('postsReceivedCard');
            if (postsReceivedCard) {
                postsReceivedCard.removeEventListener('click', openHolofotesRecebidosModal); // Remove listener anterior se existir
                postsReceivedCard.addEventListener('click', openHolofotesRecebidosModal);
                console.log('‚úÖ Event listener configurado para Holofotes Recebidos');
            } else {
                console.warn('‚ö†Ô∏è Elemento postsReceivedCard n√£o encontrado');
            }
            
            // Pessoas que te Destacaram
            const peopleWhoHighlightedCard = document.getElementById('peopleWhoHighlightedCard');
            if (peopleWhoHighlightedCard) {
                peopleWhoHighlightedCard.removeEventListener('click', openPessoasQueTeDestacaramModal); // Remove listener anterior se existir
                peopleWhoHighlightedCard.addEventListener('click', openPessoasQueTeDestacaramModal);
                console.log('‚úÖ Event listener configurado para Pessoas que te Destacaram');
            } else {
                console.warn('‚ö†Ô∏è Elemento peopleWhoHighlightedCard n√£o encontrado');
            }
            
            console.log('‚úÖ Event listeners dos cards de estat√≠sticas configurados');
        }

        // ===== FUN√á√ïES DOS MODAIS DE M√âTRICAS RECEBIDAS =====

        function openHolofotesRecebidosModal() {
            const modal = document.getElementById('holofotesRecebidosModal');
            if (modal) {
                modal.style.display = 'flex';
                loadHolofotesRecebidosInModal();
            }
        }

        function openPessoasQueTeDestacaramModal() {
            const modal = document.getElementById('pessoasQueTeDestacaramModal');
            if (modal) {
                modal.style.display = 'flex';
                loadPessoasQueTeDestacaramInModal();
            }
        }

        // Fun√ß√£o para carregar contadores de um post espec√≠fico
        async function loadPostCounts(postId) {
            try {
                // Buscar contadores de rea√ß√µes, coment√°rios e feedbacks
                const [reactionsResult, commentsResult, feedbacksResult] = await Promise.all([
                    supabase.from('reactions').select('type', { count: 'exact' }).eq('post_id', postId),
                    supabase.from('comments').select('id', { count: 'exact' }).eq('post_id', postId),
                    supabase.from('feedbacks').select('id', { count: 'exact' }).eq('post_id', postId)
                ]);

                // Contar rea√ß√µes por tipo
                const reactionCounts = { heart: 0, gratitude: 0, inspiration: 0 };
                reactionsResult.data?.forEach(reaction => {
                    if (reaction.type === 'heart') reactionCounts.heart++;
                    else if (reaction.type === 'gratitude') reactionCounts.gratitude++;
                    else if (reaction.type === 'inspiration') reactionCounts.inspiration++;
                });

                // Atualizar elementos na interface
                const heartElement = document.getElementById(`heart-count-${postId}`);
                const gratitudeElement = document.getElementById(`gratitude-count-${postId}`);
                const inspirationElement = document.getElementById(`inspiration-count-${postId}`);
                const commentElement = document.getElementById(`comment-count-${postId}`);
                const feedbackElement = document.getElementById(`feedback-count-${postId}`);

                if (heartElement) heartElement.textContent = reactionCounts.heart;
                if (gratitudeElement) gratitudeElement.textContent = reactionCounts.gratitude;
                if (inspirationElement) inspirationElement.textContent = reactionCounts.inspiration;
                if (commentElement) commentElement.textContent = commentsResult.count || 0;
                if (feedbackElement) feedbackElement.textContent = feedbacksResult.count || 0;

            } catch (error) {
                console.error('‚ùå Erro ao carregar contadores do post:', error);
            }
        }

        async function loadHolofotesRecebidosInModal() {
            try {
                console.log('üì® Carregando holofotes recebidos no modal...');
                
                // Recarregar posts onde o usu√°rio atual foi mencionado
                const { data: userPosts, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('mentioned_user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar holofotes recebidos:', error);
                    throw error;
                }
                
                console.log('üìä Holofotes recebidos encontrados:', userPosts?.length || 0);
                
                const postsContainer = document.getElementById('modalHolofotesRecebidosContent');
                
                if (!userPosts || userPosts.length === 0) {
                    postsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì®</div>
                            <p>üì® Nenhum holofote recebido ainda</p>
                            <p style="font-size: 14px; margin-top: 10px;">Quando algu√©m te destacar, aparecer√° aqui!</p>
                        </div>
                    `;
                    return;
                }

                // Recarregar rea√ß√µes para os posts recebidos
                const postIds = userPosts.map(p => p.id);
                let allReactions = [];
                
                if (postIds.length > 0) {
                    try {
                        const { data: reactionsData } = await supabase
                            .from('reactions')
                            .select('*')
                            .in('post_id', postIds);
                        allReactions = reactionsData || [];
                    } catch (reactionError) {
                        console.log('Erro ao carregar rea√ß√µes:', reactionError);
                    }
                }

                // Buscar dados dos autores dos posts
                const authorIds = [...new Set(userPosts.map(post => post.user_id))];
                let authors = [];
                
                if (authorIds.length > 0) {
                    try {
                        const { data: authorsData, error: authorsError } = await supabase
                            .from('profiles')
                            .select('id, name, email, avatar_url')
                            .filter('id', 'in', `(${authorIds.join(',')})`);
                        
                        if (authorsError) {
                            console.error('‚ùå Erro ao buscar autores:', authorsError);
                        } else {
                            authors = authorsData || [];
                        }
                    } catch (error) {
                        console.error('‚ùå Erro na query de autores:', error);
                    }
                }

                const authorMap = {};
                authors?.forEach(author => {
                    authorMap[author.id] = author;
                });

                // Usar o mesmo c√≥digo do renderPosts do in√≠cio
                const postsHtml = [];
                for (const post of userPosts) {
                    // Adicionar rea√ß√µes ao post
                    post.reactions = allReactions.filter(r => r.post_id === post.id);
                    
                    // Usar dados do autor do post (n√£o do usu√°rio atual)
                    const author = authorMap[post.user_id] || {};
                    post.user_data = {
                        name: author.name || 'Usu√°rio',
                        email: author.email || 'usuario@example.com',
                        avatar_url: author.avatar_url || ''
                    };
                    
                    const typeEmojis = {
                        'gratidao': 'üôè', 'gratitude': 'üôè',
                        'memoria': 'üí≠', 'memory': 'üí≠',
                        'conquista': 'üèÜ', 'achievement': 'üèÜ',
                        'inspiracao': '‚ú®', 'inspiration': '‚ú®',
                        'apoio': 'ü§ù', 'support': 'ü§ù',
                        'admiracao': 'üåü', 'admiration': 'üåü'
                    };

                    const typeNames = {
                        'gratidao': 'Gratid√£o', 'gratitude': 'Gratid√£o',
                        'memoria': 'Mem√≥ria', 'memory': 'Mem√≥ria',
                        'conquista': 'Conquista', 'achievement': 'Conquista',
                        'inspiracao': 'Inspira√ß√£o', 'inspiration': 'Inspira√ß√£o',
                        'apoio': 'Apoio', 'support': 'Apoio',
                        'admiracao': 'Admira√ß√£o', 'admiration': 'Admira√ß√£o'
                    };
                    
                    // Contar feedbacks para este post
                    let feedbacksCount = 0;
                    try {
                        const { data: feedbacksData } = await supabase
                            .from('feedbacks')
                            .select('id')
                            .eq('post_id', post.id);
                        feedbacksCount = feedbacksData ? feedbacksData.length : 0;
                    } catch (error) {
                        console.log('Erro ao contar feedbacks:', error);
                    }
                    
                    // Contar coment√°rios para este post
                    let commentsCount = 0;
                    try {
                        const { data: commentsData } = await supabase
                            .from('comments')
                            .select('id')
                            .eq('post_id', post.id);
                        commentsCount = commentsData ? commentsData.length : 0;
                    } catch (error) {
                        console.log('Erro ao contar coment√°rios:', error);
                    }
                    
                    const feedbacksSection = await getFeedbacksForAuthorPost(post);
                    
                    const postHtml = `
                        <div class="post">
                            <div class="post-header">
                                <img class="post-avatar" src="${post.user_data?.avatar_url || ''}" alt="Avatar">
                                <div class="post-author">
                                    <div class="post-author-name">${post.user_data?.name || 'Usu√°rio'}</div>
                                    <div class="post-author-meta">
                                        <span class="post-author-username">@${author.email?.split('@')[0] || 'usuario'}</span>
                                        <span class="post-time-separator">‚Ä¢</span>
                                        <span class="post-time">${formatDateShort(post.created_at)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="post-content">
                                <div class="post-person">Holofotes para: ${post.celebrated_person_name || post.person_name}</div>
                                ${post.type || post.highlight_type ? `
                                    <div class="post-type">
                                        ${typeEmojis[post.type || post.highlight_type] || '‚ú®'} ${typeNames[post.type || post.highlight_type] || 'Destaque'}
                                    </div>
                                ` : ''}
                                <div class="post-story">${post.content || post.story}</div>
                                ${post.photo_url ? `<img class="post-image" src="${post.photo_url}" alt="Foto do post">` : ''}
                            </div>
                            
                            <div class="post-reactions">
                                <button onclick="reactToPost('${post.id}', 'touched')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    ‚ù§Ô∏è ${post.reactions.filter(r => r.type === 'touched').length}
                                </button>
                                <button onclick="reactToPost('${post.id}', 'grateful')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#f39c12'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    üôè ${post.reactions.filter(r => r.type === 'grateful').length}
                                </button>
                                <button onclick="reactToPost('${post.id}', 'inspired')" class="reaction-btn" style="display: flex; align-items: center; gap: 3px; padding: 6px 10px; background: #f5f5f5; border: none; border-radius: 20px; color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#9b59b6'; this.style.color='white';" onmouseout="this.style.background='#f5f5f5'; this.style.color='#666';">
                                    ‚ú® ${post.reactions.filter(r => r.type === 'inspired').length}
                                </button>
                            </div>
                            
                            <div class="post-footer">
                                <span class="comments-display" id="comments-${post.id}" ${commentsCount > 0 ? `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"` : `onclick="openCommentsModal('${post.id}')" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üí¨ ${commentsCount}
                                </span>
                                <span class="feedback-display" onclick="openPostFeedbackModal('${post.id}', 'holofotes_recebidos')" ${feedbacksCount > 0 ? `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: linear-gradient(135deg, #e55a2b, #ffb700); color: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : `style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #f5f5f5; color: #666; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"`}>
                                    üîÑ ${feedbacksCount}
                                </span>
                            </div>
                            
                            ${feedbacksSection}
                        </div>
                    `;
                    
                    postsHtml.push(postHtml);
                }

                postsContainer.innerHTML = postsHtml.join('');
                console.log('‚úÖ Holofotes recebidos carregados no modal');
                
                // Renderizar estado inicial das rea√ß√µes para cada post
                for (const post of userPosts) {
                    await updateModalReactions(post.id);
                }
                
                // Atualizar contadores de coment√°rios ap√≥s carregar posts
                setTimeout(() => {
                    updateAllCommentsCounters();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar holofotes recebidos:', error);
                document.getElementById('modalHolofotesRecebidosContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>‚ùå Erro ao carregar holofotes recebidos</p>
                        <p style="font-size: 14px;">Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

         async function loadPessoasQueTeDestacaramInModal() {
            try {
                console.log('üë• Carregando pessoas que te destacaram no modal...');
                
                // Encontrar posts que mencionaram o usu√°rio atual usando mentioned_user_id
                const postsAboutUser = posts.filter(post => {
                    return post.mentioned_user_id === currentUser.id;
                });

                // Extrair IDs √∫nicos dos autores que destacaram o usu√°rio
                const authorIds = [...new Set(postsAboutUser.map(post => post.user_id))];
                
                if (authorIds.length === 0) {
                    const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhuma pessoa te destacou ainda</div>
                            <div style="font-size: 14px;">Quando algu√©m criar um post mencionando voc√™, aparecer√° aqui!</div>
                        </div>
                    `;
                    return;
                }

                // Buscar dados reais dos usu√°rios da tabela profiles
                const { data: authorsData, error } = await supabase
                    .from('profiles')
                    .select('id, name, email, avatar_url')
                    .filter('id', 'in', `(${authorIds.join(',')})`);

                if (error) {
                    console.error('‚ùå Erro ao buscar dados dos autores:', error);
                    throw error;
                }

                console.log('üìä Dados dos autores encontrados:', authorsData?.length || 0);

                // Criar mapa de autores para acesso r√°pido
                const authorMap = {};
                authorsData?.forEach(author => {
                    authorMap[author.id] = author;
                });

                // Criar lista de pessoas com dados reais
                const peopleDetails = [];
                
                authorIds.forEach(authorId => {
                    const author = authorMap[authorId];
                    const authorPosts = postsAboutUser.filter(p => p.user_id === authorId);
                    
                    if (author) {
                        const userName = author.name || author.email?.split('@')[0] || 'Usu√°rio';
                        const userEmail = author.email || '';
                        const username = userEmail ? userEmail.split('@')[0] : author.id;
                        const userAvatar = author.avatar_url || '';
                        
                        peopleDetails.push({
                            id: authorId,
                            name: userName,
                            username: username,
                            avatar: userAvatar,
                            lastMention: new Date(authorPosts[0].created_at).toLocaleDateString('pt-BR'),
                            postsCount: authorPosts.length
                        });
                    }
                });

                const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                
                if (peopleDetails.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Nenhuma pessoa te destacou ainda</div>
                            <div style="font-size: 14px;">Quando algu√©m criar um post mencionando voc√™, aparecer√° aqui!</div>
                        </div>
                    `;
                    return;
                }

                // Ordenar por n√∫mero de posts (quem mais destacou primeiro)
                peopleDetails.sort((a, b) => b.postsCount - a.postsCount);

                // Gerar HTML das pessoas com fotos e dados reais
                const peopleHtml = peopleDetails.map(person => `
                    <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                            ${person.avatar ? 
                                `<img src="${person.avatar}" alt="${person.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<span style="color: white; font-weight: bold; font-size: 18px;">${person.name.charAt(0).toUpperCase()}</span>`
                            }
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${person.name}</div>
                            <div style="color: #666; font-size: 13px; margin-bottom: 4px;">@${person.username}</div>
                            <div style="color: #999; font-size: 12px;">
                                ${person.postsCount} ${person.postsCount === 1 ? 'destaque' : 'destaques'}
                            </div>
                        </div>
                    </div>
                `).join('');

                modalContent.innerHTML = peopleHtml;
                console.log('‚úÖ Pessoas que te destacaram carregadas no modal');

            } catch (error) {
                console.error('‚ùå Erro ao carregar pessoas que te destacaram:', error);
                const modalContent = document.getElementById('modalPessoasQueTeDestacaramContent');
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Erro ao carregar pessoas</div>
                        <div style="font-size: 14px;">Tente novamente em alguns instantes.</div>
                    </div>
                `;
            }
        }

        // ===== FIM DAS FUN√á√ïES DOS NOVOS MODAIS =====

        // Atualizar m√©tricas reais
        async function updateSimpleMetrics() {
            try {
                console.log('üìä Atualizando m√©tricas reais...');

                // 1. Buscar posts do usu√°rio diretamente do Supabase (mesma l√≥gica do modal)
                const { data: userPosts, error: postsError } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (postsError) {
                    console.error('‚ùå Erro ao buscar posts do usu√°rio:', postsError);
                    return;
                }
                
                console.log('üìä Posts do usu√°rio encontrados para m√©tricas:', userPosts?.length || 0);
                
                // Atualizar contador de Posts Criados
                document.getElementById('userPostsCount').textContent = userPosts?.length || 0;
                
                // 2. Pessoas Destacadas (contar corretamente com regex melhorada)
                const uniquePeople = new Set();
                
                userPosts.forEach(post => {
                    const personName = post.celebrated_person_name || post.person_name;
                    if (personName && personName.includes('@')) {
                        // Regex melhorada para capturar usernames com pontos, underscores e h√≠fens
                        const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                        if (usernameMatch) {
                            usernameMatch.forEach(match => {
                                const username = match.substring(1); // Remove o @
                                if (username) {
                                    uniquePeople.add(username);
                                }
                            });
                        }
                    }
                });
                
                document.getElementById('userPeopleHighlighted').textContent = uniquePeople.size;

                // Buscar m√©tricas de reconhecimento DADO
                const [commentsResult, feedbacksResult, reactionsResult] = await Promise.all([
                    supabase.from('comments').select('id', { count: 'exact' }).eq('user_id', currentUser.id),
                    supabase.from('feedbacks').select('id', { count: 'exact' }).eq('mentioned_user_id', currentUser.id), // Feedbacks Dados: fui mencionado, vou dar feedback
                    supabase.from('reactions').select('id', { count: 'exact' }).eq('user_id', currentUser.id)
                ]);

                console.log('üìä Contagens das consultas:', {
                    comments: commentsResult.count,
                    feedbacks: feedbacksResult.count,
                    reactions: reactionsResult.count
                });

                const commentsCount = commentsResult.count || 0;
                const feedbacksCount = feedbacksResult.count || 0;
                const reactionsCount = reactionsResult.count || 0;

                // Atualizar elementos separadamente
                document.getElementById('userCommentsGiven').textContent = commentsCount;
                document.getElementById('userFeedbacksGiven').textContent = feedbacksCount;
                document.getElementById('userReactionsGiven').textContent = reactionsCount;
                
                // Declarar currentStreak no escopo correto
                let currentStreak = 0;
                
                try {
                    // Buscar todas as atividades do usu√°rio
                    const [postsData, commentsData, feedbacksData, reactionsData] = await Promise.all([
                        supabase.from('posts').select('created_at').eq('user_id', currentUser.id),
                        supabase.from('comments').select('created_at').eq('user_id', currentUser.id),
                        supabase.from('feedbacks').select('created_at').eq('mentioned_user_id', currentUser.id), // Feedbacks dados: fui mencionado
                        supabase.from('reactions').select('created_at').eq('user_id', currentUser.id)
                    ]);
                    
                    // Combinar todas as atividades
                    const allActivities = [
                        ...(postsData.data || []),
                        ...(commentsData.data || []),
                        ...(feedbacksData.data || []),
                        ...(reactionsData.data || [])
                    ];
                    
                    console.log(`üìà Total de atividades encontradas: ${allActivities.length}`);
                    
                    // Agrupar atividades por data (YYYY-MM-DD)
                    const activitiesByDate = {};
                    allActivities.forEach(activity => {
                        const date = new Date(activity.created_at).toISOString().split('T')[0]; // YYYY-MM-DD
                        activitiesByDate[date] = true;
                    });
                    
                    const activeDates = Object.keys(activitiesByDate).sort().reverse(); // Mais recente primeiro
                    console.log('üìÖ Dias com atividade:', activeDates);
                    
                    // Calcular streak consecutivo a partir de hoje
                    const today = new Date().toISOString().split('T')[0];
                    currentStreak = 0; // Reset para recalcular
                    let checkDate = new Date();
                    
                    // Verificar dias consecutivos a partir de hoje
                    while (true) {
                        const dateStr = checkDate.toISOString().split('T')[0];
                        
                        if (activitiesByDate[dateStr]) {
                            currentStreak++;
                            console.log(`‚úÖ Atividade encontrada em ${dateStr} - Streak: ${currentStreak}`);
                        } else {
                            console.log(`‚ùå Sem atividade em ${dateStr} - Streak quebrado`);
                            break;
                        }
                        
                        // Ir para o dia anterior
                        checkDate.setDate(checkDate.getDate() - 1);
                        
                        // Limite de seguran√ßa para evitar loop infinito
                        if (currentStreak >= 365) {
                            console.log('üèÜ Streak m√°ximo de 365 dias atingido!');
                            break;
                        }
                    }
                    
                    console.log(`üî• Streak final calculado: ${currentStreak} dias consecutivos`);
                    
                    // Atualizar todas as barras de progresso individuais
                    const progressBar7 = document.getElementById('engagementStreakProgress7');
                    const progressBar30 = document.getElementById('engagementStreakProgress30');
                    const progressBar182 = document.getElementById('engagementStreakProgress182');
                    const progressBar365 = document.getElementById('engagementStreakProgress365');
                    
                    const progressText7 = document.getElementById('engagementStreakText7');
                    const progressText30 = document.getElementById('engagementStreakText30');
                    const progressText182 = document.getElementById('engagementStreakText182');
                    const progressText365 = document.getElementById('engagementStreakText365');
                    
                    // Calcular percentuais para cada per√≠odo
                    const streak7 = Math.min(currentStreak, 7);
                    const streak30 = Math.min(currentStreak, 30);
                    const streak182 = Math.min(currentStreak, 182);
                    const streak365 = Math.min(currentStreak, 365);
                    
                    const percentage7 = (streak7 / 7) * 100;
                    const percentage30 = (streak30 / 30) * 100;
                    const percentage182 = (streak182 / 182) * 100;
                    const percentage365 = (streak365 / 365) * 100;
                    
                    // Atualizar barras de progresso
                    if (progressBar7) progressBar7.style.width = `${percentage7}%`;
                    if (progressBar30) progressBar30.style.width = `${percentage30}%`;
                    if (progressBar182) progressBar182.style.width = `${percentage182}%`;
                    if (progressBar365) progressBar365.style.width = `${percentage365}%`;
                    
                    // Atualizar textos
                    if (progressText7) progressText7.textContent = `${streak7}/7`;
                    if (progressText30) progressText30.textContent = `${streak30}/30`;
                    if (progressText182) progressText182.textContent = `${streak182}/182`;
                    if (progressText365) progressText365.textContent = `${streak365}/365`;
                    
                    console.log('‚úÖ Barras de progresso do streak atualizadas:', {
                        streak7, streak30, streak182, streak365,
                        percentage7: `${percentage7.toFixed(1)}%`,
                        percentage30: `${percentage30.toFixed(1)}%`,
                        percentage182: `${percentage182.toFixed(1)}%`,
                        percentage365: `${percentage365.toFixed(1)}%`
                    });
                    
                } catch (streakError) {
                    console.error('‚ùå Erro ao calcular streak:', streakError);
                    
                    // Fallback: zerar todos os streaks em caso de erro
                    const progressElements = ['7', '30', '182', '365'];
                    progressElements.forEach(period => {
                        const progressBar = document.getElementById(`engagementStreakProgress${period}`);
                        const progressText = document.getElementById(`engagementStreakText${period}`);
                        
                        if (progressBar) progressBar.style.width = '0%';
                        if (progressText) progressText.textContent = `0/${period}`;
                    });
                }

                // ===== C√ÅLCULOS DAS M√âTRICAS RECEBIDAS =====

                // 1. Holofotes Recebidos (posts que mencionaram o usu√°rio)
                console.log('üîç Buscando holofotes recebidos usando mentioned_user_id...');
                console.log('Current user ID:', currentUser?.id);
                
                const postsAboutUser = posts.filter(post => {
                    return post.mentioned_user_id === currentUser.id;
                });
                
                console.log('Posts about user encontrados:', postsAboutUser.length);
                console.log('Posts details:', postsAboutUser);
                
                document.getElementById('userHolofotesReceived').textContent = postsAboutUser.length;

                // 2. Pessoas que te Destacaram (pessoas √∫nicas que mencionaram o usu√°rio)
                const peopleWhoHighlighted = new Set();
                postsAboutUser.forEach(post => {
                    peopleWhoHighlighted.add(post.user_id);
                });
                document.getElementById('userPeopleWhoHighlighted').textContent = peopleWhoHighlighted.size;

                // 3. Consultas para m√©tricas recebidas (rea√ß√µes, coment√°rios, feedbacks nos posts do usu√°rio)
                const userPostIds = userPosts.map(post => post.id);
                
                const [reactionsReceivedResult, commentsReceivedResult, feedbacksReceivedResult] = await Promise.all([
                    userPostIds.length > 0 ? supabase.from('reactions').select('id', { count: 'exact' }).in('post_id', userPostIds) : { count: 0 },
                    userPostIds.length > 0 ? supabase.from('comments').select('id', { count: 'exact' }).in('post_id', userPostIds).neq('user_id', currentUser.id) : { count: 0 },
                    userPostIds.length > 0 ? supabase.from('feedbacks').select('id', { count: 'exact' }).in('post_id', userPostIds) : { count: 0 } // Feedbacks nos posts do usu√°rio
                ]);

                // 4. Atualizar elementos das m√©tricas recebidas
                document.getElementById('userReactionsReceived').textContent = reactionsReceivedResult.count || 0;
                document.getElementById('userCommentsReceived').textContent = commentsReceivedResult.count || 0;
                document.getElementById('userFeedbacksReceived').textContent = feedbacksReceivedResult.count || 0;

                console.log('‚úÖ M√©tricas reais atualizadas:', {
                    pessoas: uniquePeople.size,
                    usernames: Array.from(uniquePeople),
                    comentarios: commentsResult.count || 0,
                    reacoes: reactionsResult.count || 0,
                    streak: currentStreak,
                    // M√©tricas recebidas
                    holofotesRecebidos: postsAboutUser.length,
                    pessoasQueTeDestacaram: peopleWhoHighlighted.size,
                    reacoesRecebidas: reactionsReceivedResult.count || 0,
                    comentariosRecebidos: commentsReceivedResult.count || 0,
                    feedbacksRecebidos: feedbacksReceivedResult.count || 0
                });
                
                // Reconfigurar event listeners ap√≥s atualizar m√©tricas
                setupStatCardListeners();
            } catch (error) {
                console.error('‚ùå Erro ao atualizar m√©tricas reais:', error);
                // Em caso de erro, manter valores existentes
            }
        }

        // Modal functions for received metrics
        function openPostsReceivedModal() {
            const modal = document.getElementById('postsReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadPostsReceivedInModal();
            }
        }

        function openCommentsReceivedModal() {
            const modal = document.getElementById('commentsReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadCommentsReceivedInModal();
            }
        }

        function openFeedbacksReceivedModal() {
            const modal = document.getElementById('feedbacksReceivedModal');
            if (modal) {
                modal.style.display = 'block';
                loadFeedbacksReceivedInModal();
            }
        }

        async function loadPostsReceivedInModal() {
            try {
                const userPostsReceived = posts.filter(post => {
                    const personName = post.celebrated_person_name || post.person_name;
                    if (personName && personName.includes('@')) {
                        const usernameMatch = personName.match(/@([a-zA-Z0-9._-]+)/g);
                        if (usernameMatch) {
                            return usernameMatch.some(match => {
                                const username = match.substring(1);
                                return username === currentUser.username;
                            });
                        }
                    }
                    return false;
                });

                const modalContent = document.getElementById('postsReceivedModalContent');
                if (!modalContent) return;

                if (userPostsReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum post recebido ainda.</p>';
                    return;
                }

                let html = '';
                for (const post of userPostsReceived) {
                    const timeAgo = getTimeAgo(post.created_at);
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${post.celebrated_person_name || post.person_name}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${post.content || post.story || ''}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                }
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar posts recebidos:', error);
            }
        }

        async function loadCommentsReceivedInModal() {
            try {
                const userPostIds = posts.filter(post => post.user_id === currentUser.id).map(post => post.id);
                
                if (userPostIds.length === 0) {
                    const modalContent = document.getElementById('commentsReceivedModalContent');
                    if (modalContent) {
                        modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum coment√°rio recebido ainda.</p>';
                    }
                    return;
                }

                const { data: commentsReceived, error } = await supabase
                    .from('comments')
                    .select('*, profiles(name, username)')
                    .in('post_id', userPostIds)
                    .neq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                const modalContent = document.getElementById('commentsReceivedModalContent');
                if (!modalContent) return;

                if (error || !commentsReceived || commentsReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum coment√°rio recebido ainda.</p>';
                    return;
                }

                let html = '';
                commentsReceived.forEach(comment => {
                    const timeAgo = getTimeAgo(comment.created_at);
                    const userName = comment.profiles?.name || 'Usu√°rio';
                    const username = comment.profiles?.username || '';
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">üí¨ ${userName} ${username ? `(@${username})` : ''}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${comment.content}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                });
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar coment√°rios recebidos:', error);
            }
        }

        async function loadFeedbacksReceivedInModal() {
            try {
                const { data: feedbacksReceived, error } = await supabase
                    .from('feedbacks')
                    .select('*, profiles(name, username)')
                    .eq('mentioned_user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                const modalContent = document.getElementById('feedbacksReceivedModalContent');
                if (!modalContent) return;

                if (error || !feedbacksReceived || feedbacksReceived.length === 0) {
                    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Nenhum feedback recebido ainda.</p>';
                    return;
                }

                let html = '';
                feedbacksReceived.forEach(feedback => {
                    const timeAgo = getTimeAgo(feedback.created_at);
                    const userName = feedback.profiles?.name || 'Usu√°rio';
                    const username = feedback.profiles?.username || '';
                    html += `
                        <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">üîÑ ${userName} ${username ? `(@${username})` : ''}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${feedback.content}</div>
                            <div style="color: #999; font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                });
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Erro ao carregar feedbacks recebidos:', error);
            }
        }
        
        console.log('‚úÖ HoloSpot v8 carregado com sucesso!');
    </script>

    <!-- Modals for Received Metrics -->
    <div id="postsReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üì® Posts Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="postsReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="commentsReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üí¨ Coment√°rios Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="commentsReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="feedbacksReceivedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üîÑ Feedbacks Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="feedbacksReceivedModalContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Novos Modais para M√©tricas Recebidas -->
    <div id="holofotesRecebidosModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><img src="https://github.com/holospotadm/holospot/blob/main/public/holofote.png?raw=true" alt="Holofote" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Holofotes Recebidos</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalHolofotesRecebidosContent">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="pessoasQueTeDestacaramModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üë• Pessoas que te Destacaram</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPessoasQueTeDestacaramContent" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Posts Criados -->
    <div id="postsModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üìù Seus Posts</h2>
                <button class="close-btn" onclick="closePostsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPostsContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Posts ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pessoas Destacadas -->
    <div id="peopleHighlightedModal" class="modal-overlay" style="display: none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>üë• Pessoas Destacadas</h2>
                <button class="close-btn" onclick="closePeopleHighlightedModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPeopleHighlightedContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Pessoas destacadas ser√£o carregadas aqui -->
                </div>
            </div>
        </div>
    </div>

</body>
</html>
